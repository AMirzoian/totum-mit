App.blink=function(e,t,n){let i=t||8,a=!0,o=function(){a?e.css("background-color",n):e.css("background-color",""),a=!a,--i>0&&setTimeout(o,300)};setTimeout(o,300)},App.mobilePanel=function(e,t,n){return n=n||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"mobile-panel "+(n.buttons?" with-buttons":"")},n))},App.panelTimer=function(e,t,n){let i,a=t,o=$("<div>");o.html(a);let l=BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:e,message:o,buttons:[{action:function(e){i&&clearTimeout(i),e.close()},label:"Отмена"}]}),s=function(){--a<=0?(l.close(),n()):(o.html(a),i=setTimeout(s,1e3))};s()},App.panel=function(e,t,n){return n=n||{},window.top.BootstrapDialog.show($.extend({type:"edit",message:t,draggable:!0,title:e,cssClass:"web-panel "+(n.buttons?" with-buttons ":"")+(n.class||"")},n))},App.setSessionStorage=function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},BootstrapDialog.BUTTON_SIZES[BootstrapDialog.SIZE_NORMAL]="btn-m",BootstrapDialog.defaultOptions.animate=!1,BootstrapDialog.defaultOptions.closeByBackdrop=!1,BootstrapDialog.defaultOptions.nl2br=!1,BootstrapDialog.BootstrapDialogModal.prototype.resetScrollbar=function(){0===this.getGlobalOpenedDialogs().length&&this.$body.css("padding-right",5)},function(){let e=0,t=-1;App.showLInks=function(n,i){n.forEach(function(n){if(-1!==["top-iframe","iframe"].indexOf(n.target)&&window.top!=window)return void window.top.App.showLInks([n],i);let a=function(o){"use strict";if(n.postData){let t,l="_self";if("iframe"===o||"top-iframe"===o){let o="iframe"+ ++e;l=o;let s,r=BootstrapDialog.show({message:s=$('<iframe style="width: 100%; '+(n.width?"":"min-width: 500px;")+' height: 70vh; border: none" name = "'+o+'"></iframe>'),size:BootstrapDialog.SIZE_WIDE,title:n.title,draggable:!0,cssClass:"target-iframe",onhidden:function(){if(n.refresh){$("#table").data("pctable");i.refresh()}},onshown:function(e){if(n.width){let t=500;n.width>t&&(t=n.width),e.$modalDialog.width(t)}let t=s.get(0).contentWindow,i=function(){try{t.App&&t.App.setSessionStorage?t.App.setSessionStorage.call(t,"linkObject",n):setTimeout(i,200)}catch(e){}};i()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload(),t.detach()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){a("self")}},{label:"Во вкладке",cssClass:"btn-m btn-default",action:function(e){try{s.get(0).contentWindow.sessionStorage.linkObject&&(n=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("blank"),e.close()}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}]});s.on("load",function(){let e=s.get(0).contentWindow;try{e.closeMe=function(){r.close()}}catch(e){}})}else"blank"===o?l="_blank":"parent"===o?l="_parent":"top"===o?l="_top":window.parent!==window&&(sessionStorage.linkObject=JSON.stringify(n));t=$("<form>",{method:"post",action:n.uri,target:l});const s=function(e,n){"boolean"==typeof n&&(n=!0===n?"true":"false"),"string"==typeof n||"number"==typeof n||null===n?t.append($("<input>",{type:"hidden",name:e,value:n})):$.each(n,function(t,n){s(e+"["+t+"]",n)})};$.each(n.postData,function(e,t){s(e,t)}),t.appendTo("body").submit(),t.detach()}else switch(o){case"top":window.top.location.href=n.uri;break;case"parent":window.parent.location.href=n.uri;break;case"blank":let e=$('<a href="'+n.uri+'" target="_blank">link</a>');e.appendTo("body"),e.get(0).click(),e.remove();break;case"iframe":case"top-iframe":let l=n.uri;if(n.elseData){let e=[];!1===n.elseData.header&&e.push("param"),!1===n.elseData.footer&&e.push("footer"),l+="#"+encodeURIComponent(JSON.stringify({wc:e}))}let s=$('<iframe src="'+l+'" style="width: 100%; height: 70vh; border: none"></iframe>'),r=BootstrapDialog.show({message:s,draggable:!0,size:BootstrapDialog.SIZE_WIDE,title:n.title,cssClass:"target-iframe",onhidden:function(){n.refresh&&i.refresh(),t--},onshown:function(e){n.width&&e.$modalDialog.width(n.width),++t&&e.$modalDialog.css("margin-top",30+20*t);let i=s.get(0).contentWindow,a=function(){try{i.App&&i.App.setSessionStorage?i.App.setSessionStorage.call(i,"linkObject",n):setTimeout(a,200)}catch(e){}};a()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){try{s.get(0).contentWindow.sessionStorage.linkObject&&(n=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("self")}},{label:"Во вкладке",cssClass:"btn-m btn-default",action:function(e){try{s.get(0).contentWindow.sessionStorage.linkObject&&(n=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject))}catch(e){}a("blank"),e.close()}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}]});s.on("load",function(){let e=s.get(0).contentWindow;try{e.closeMe=function(){r.close()}}catch(e){}});break;default:window.parent!=window&&(sessionStorage.linkObject=JSON.stringify(n)),window.location.href=n.uri}};a(n.target)})},App.showDatas=function(e,t){let i=[],a=this;return e.forEach(function(e){switch(e[0]){case"buttons":let o={...e[1],buttons:[],class:"linkButtons"};e[1].buttons.forEach(function(t,n){o.buttons.push({id:"link-btn"+n,label:t.text,action:function(t){a.buttonsClick(e[1].hash,n).then(function(){e[1].buttons[n].refresh&&a.refresh(),t.close()})},icon:t.icon?"fa fa-"+t.icon:null,background:t.background})}),screen.width<=window.MOBILE_MAX_WIDTH?App.mobilePanel(e[0].title,$("<div>").html(e[0].html),o):(!o.width&&o.html||(o.onshown=function(e){o.width&&e.$modalDialog.width(o.width),o.html||e.$modalBody.remove(),o.buttons.forEach(t=>{t.background&&e.getButton(t.id).css("background-color",t.background)})}),App.panel(e[0].title,$("<div>").html(e[1].html),o));break;case"table":if(window.top!=window)return window.top.App.showDatas.call(a,[e]);i.push(function(e,t){let i;e.height&&(i=e.height,/^\d+$/.test(e.height)&&(i+="px"));let a="/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash;/^\/Table|Main\//.test(window.location.pathname)||(a=e.table_id+"?sess_hash="+e.sess_hash);let o=$('<iframe style="width: 100%; height: '+(i||"80vh")+'; border: none;" src="'+a+'">');$("body").append(o);let l=[];$("#table").data("pctable")&&$("#table").data("pctable").isCreatorView&&l.push({label:"В новой вкладке",cssClass:"btn-m btn-danger",action:function(e){window.open(a,"_blank");e.close()}});let s=n(e.title,o,e.width,e.refresh,BootstrapDialog.TYPE_PRIMARY,t,l);o.on("load",function(){let e=o.get(0).contentWindow;e.closeMe=function(){s.close()}})}(e[1],a));break;case"text":i.push(function(e,t){n(e.title,e.text,e.width,e.refresh,null,t)}(e[1],a));break;case"print":i.push(function(e,t,n){if(App.fullScreenProcesses.showCog(),n){var i=new Blob([atob(n)],{type:"application/pdf"}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.target="_blank",document.body.appendChild(o),o.click()}else{let n=$('<iframe style="width: 500px; height: 200px; position: absolute; top: -1000px; background: #fff;">').appendTo("body"),i=n[0],a=i.contentWindow?i.contentWindow:i.contentDocument.defaultView;a.document.head.innerHTML="<style>"+t+"</style>",a.document.body.innerHTML=e;let o=a.document.body,l=$.Deferred(),s=0;const r=function(){o.scrollTop=o.scrollHeight+100,++s<100&&o.scrollTop>=o.scrollHeight?setTimeout(r,50):setTimeout(function(){l.resolve()},3e3)},c=function(){++s<100&&o.scrollHeight<200?setTimeout(c,50):(s=0,r())};c(),l.then(function(){App.fullScreenProcesses.hideCog(),setTimeout(function(){a.focus(),a.print()},250),setTimeout(function(){},1e4)})}}(e[1].body,e[1].styles));break;case"notification":if(e[1].text){let n=$.notify({message:"<div>"+e[1].text+"</div>"},{offset:{x:20,y:50},type:"warning",allow_dismiss:!0,delay:0,onClose:function(){a.notificationUpdate(t,"deactivate").then(function(){n.$ele.trigger("hide.bs.modal")})}});n.$ele.find("button.close").before('<button class="timer"><i class="fa fa-clock-o"></i></button>'),n.$ele.on("click",".timer",function(){a.notificationUpdate(t,"later").then(function(){n.$ele.trigger("hide.bs.modal"),n.$ele.remove()})}),i.push({$modal:n.$ele,simpleClose:function(){n.$ele.remove()}})}else i.push(function(e){if(e.table_id){let t=$('<iframe style="width: 100%; height: 100%; border: none;" src="/html.html?rand='+Math.round(1e4*Math.random())+'">'),n=$('<div class="notificationTable"></div>').appendTo("body").append(t).css({width:e.width,height:e.height});return t.on("load",function(){let i=t.get(0).contentWindow;e.ROLESLIST=window.ROLESLIST||$("#table").data("pctable").ROLESLIST,i.data=e,i.closeMe=function(){n.trigger("hide.bs.modal"),n.remove()},t.contents().find("body").append('<div class="page_content tree-minifyed"><div id="table"></div></div><script>let table_id=window.data.table_id; App.getPcTableById(table_id, {sess_hash: window.data.sess_hash}, $("#table"), {beforeSpaceHide: true, ROLESLIST: window.data.ROLESLIST, withoutScrolls: true, data: window.data.data, f: window.data.f, data_params: window.data.data_params, withHeader: !(window.data.elseData && window.data.elseData.header===false), withFooter: !(window.data.elseData && window.data.elseData.footer===false)})<\/script>')}),{$modal:n,simpleClose:function(){n.remove()}}}}(e[1]))}}),i},App.getPcTableById=function(e,t,n,i){let a=$.Deferred();return new App.models.table("/Table/0/"+e.toString(),{},{}).getTableData(t?t.sess_hash:null).then(function(o){if(i&&(!1===i.withHeader||!1===i.withFooter)){Object.values(o.fields).forEach(function(e,t){"param"===e.category&&!1===i.withHeader?delete o.fields[e.name]:"footer"===e.category&&!1===i.withFooter&&delete o.fields[e.name]}),delete i.withHeader,delete i.withFooter}o.model=new App.models.table("/Table/0/"+e.toString(),$.extend({updated:o.updated},t||{})),$.extend(!0,o,i);let l=new App.pcTableMain(n,o);a.resolve(l)}),a.promise()},App.showPanels=function(e){if(window.top!=window)return window.top.App.showPanels.call(window.top,e);let t={},n=$.Deferred();const i=function(){let a=e.shift(),o={};a.id?o.id=a.id:a.field&&(o=a.field);const l=function(t){new EditPanel(t.tableRow.id,BootstrapDialog.TYPE_PRIMARY,o,e.length>0).then(function(t,o){if(t&&a.refresh){$("#table").data("pctable").model.refresh()}else if((t||o)&&e.length)return void i();n.resolve()})};a.uri!==window.location.pathname?t[a.uri]?l(t[a.uri]):new App.models.table(a.uri,{},{}).getTableData().then(function(e){e.model=new App.models.table(a.uri,{updated:e.updated}),t[a.uri]=new App.pcTableMain(null,e),l(t[a.uri])}):l($("#table").data("pctable"))};return i(),n};let n=function(e,n,i,a,o,l,s){return(s=s||[]).push({label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}),BootstrapDialog.show({message:n,title:e,type:o||null,draggable:!0,onhidden:function(){a&&("strong"===a?window.location.reload():l.refresh()),t--},onshown:function(e){i&&e.$modalDialog.width(i),++t&&e.$modalDialog.css("margin-top",30+20*t)},buttons:s})}}(),Object.equals=function(e,t){let n=[];return function e(t,i){if(t===i)return!0;if(t instanceof Date&&i instanceof Date)return+t==+i;if("object"!=typeof t||"object"!=typeof i||null===i||null===t)return!1;if(function(e,t){for(var i=n.length;i--;)if(!(n[i][0]!==e&&n[i][0]!==t||n[i][1]!==t&&n[i][1]!==e))return!0;return!1}(t,i))return!0;if(n.push([t,i]),Array.isArray(t)!==Array.isArray(i))return!1;if(Array.isArray(t)){if(t.length!==i.length)return!1;let n=t.length;for(;n--;)if(!e(t[n],i[n]))return!1}else{let n=Object.keys(t),a=n.length;if(Object.keys(i).length!==a)return!1;for(;a--;)if(!e(t[n[a]],i[n[a]]))return!1}return!0}(e,t)},Object.getPath=function(e,t,n){let i=e;for(let e=0;e<t.length;e++){let a=t[e];if("object"!=typeof i||!(a in i))return n;i=i[a]}return i},String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},App.confirmation=function(e,t,n){let i=[];return Object.keys(t).forEach(function(e){i.push({label:e,action:t[e]})}),BootstrapDialog.show({type:"edit",title:n,message:e,buttons:i,draggable:!0,onshow:function(e){e.$modalContent.css({width:"70vw",maxWidth:"800px"})},onshown:function(e){e.$modalContent.position({of:window})}})},App.copyMe=function(e){let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},App.dateFormats={base:"DD.MM.YY",db:"YYYY-MM-DD",covert:function(e,t,n){return moment(e,t).format(n)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},App.dateTimeFormats={base:"DD.MM.YY HH:mm",db:"YYYY-MM-DD HH:mm",covert:function(e,t,n){return moment(e,t).format(n)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},function(){let e="fa-cog",t=$("#big_loading i"),n=0;App.fullScreenProcesses={showCog:function(){1===++n&&App.fullScreenProcesses.show("fa-cog",!0)},hideCog:function(){--n<1&&(n=0,App.fullScreenProcesses.hide())}},App.fullScreenProcesses.show=function(n,i){i=i||!1,$("body").addClass("lock"),i&&!t.is(".fa-spin")?t.addClass("fa-spin"):!i&&t.is(".fa-spin")&&t.removeClass("fa-spin"),e!=n&&(t.removeClass(e).addClass(n),e=n),$("#big_loading").show().animate({opacity:1},250)},App.fullScreenProcesses.hide=function(e){$("body").removeClass("lock"),$("#big_loading").animate({opacity:0},250,function(){$("#big_loading").hide()})}}(),App.hexToRGB=function(e,t){var n=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return t?"rgba("+n+", "+i+", "+a+", "+t+")":"rgb("+n+", "+i+", "+a+")"},$.fn.extend({isAttached:function(){return 1===$(this).closest("html").length}}),App.isTopWindow=function(){let e=!1;try{e=window!=window.top||document!=top.document||self.location!=top.location}catch(t){e=!0}return!e},App.logOutput=function(e){let t=$('<div style="overflow-x: auto">'),n=[{label:"Развернуть все",cssClass:"btn-m btn-default",action:function(e){t.jstree("open_all")}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];"string"==typeof e&&n.splice(0,1),window.top.BootstrapDialog.show({message:t,type:BootstrapDialog.TYPE_DANGER,title:"Схема расчета",buttons:n,draggable:!0,onshown:function(n){n.$modalContent.position({of:window.top}),"string"==typeof e?t.html('<div style="color: white; ">'+e+"</div>"):t.jstree({state:{key:"leftTree"},core:{check_callback:!0,open_parents:!0,data:e,themes:{name:"default-dark"}},types:{folder:{},code:{icon:"fa fa-cog"},cogs:{icon:"fa fa-cogs"},error:{icon:"fa fa-exclamation-triangle"},list:{icon:"fa fa-code"},fixed:{icon:"fa fa-hand-rock-o"},param:{icon:"fa fa-hashtag"},execcode:{icon:"fa fa-magic"},recalcs:{icon:"fa fa-recycle"},clocks:{icon:"fa fa-clock-o"},mbs:{icon:"fa fa-database"},selects:{icon:"fa fa-navicon"},"!":{icon:"fa fa-exclamation"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles},plugins:["types","themes"]})},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t}),e.$modalContent.find(".modal-body").css("background-color","#333")}})},App.modal=function(e,t,n){var i=$('<div class="modal fade" id="appNotify" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"> </div> </div> </div> </div>');if((o={body:i.find(".modal-body"),header:i.find(".modal-header"),title:i.find(".modal-title"),footer:i.find(".modal-footer"),block:i}).block.on("hidden.bs.modal",function(){$(this).remove()}),"object"==typeof e&&e instanceof jQuery?o.body.empty().append(e):o.body.html(e),t?o.title.html(t):o.header.hide(),n)if("object"==typeof n){var a=$("<div>"),o=o;$.each(n,function(e,t){if("close"!=t){var n="default";"object"==typeof t&&(t.class&&(n=t.class),t.func&&(t=t.func));var i=$('<button type="button" class="btn btn-'+n+'">'+e+"</button>");a.append(i),t&&"function"==typeof t&&i.on("click",function(){t(o.block)})}else a.append('<button type="button" class="btn btn-default" data-dismiss="modal">'+e+"</button>")}),o.footer.html(a.children())}else o.footer.html(n);else o.footer.hide();return o.block.modal("show").css("z-index","10000"),o.block},$.expr.pseudos.multiincludes=function(e,t,n){let i=$(e).find("a"),a=(i.data("tokens")||i.text()).toString().toUpperCase().replace("ё","е");return!n[3].toUpperCase().replace("ё","е").split(" ").some(function(e){return-1===a.indexOf(e)})},App.notify=function(e,t,n){BootstrapDialog.show({message:e,type:BootstrapDialog.TYPE_DEFAULT,title:t,buttons:[{label:"Закрыть",action:function(e){e.close()}}],onshow:function(e){t||e.$modalHeader.remove()}})},App.topNotify=function(e,t,n){t=t||"",$("#notifies").append('<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>'+t+"</strong>"+e+"</div>")},App.popNotify=function(e,t,n,i,a){let o,l="bottom",s={},r={};return e.isParams&&(s=e,e.element&&(t=e.element),e.timeout&&(n=e.timeout),e.container&&(i=e.container),e.trigger&&(a=e.trigger),e.placement&&(l=e.placement),e.class&&(o=e.class),e=e.$text),n=n||void 0,i=i||t.closest(".pcTable-scrollwrapper, .InsertPanel"),a=a||"manual",r=$.extend(r,{html:!0,content:e,trigger:a,container:i,placement:l,width:"70vw",animation:!1}),"default"==n&&(n=2e3),t.on("shown.bs.popover",function(){let e=t.data("bs.popover"),n=parseInt(e.$tip.css("left")),a=parseInt(e.$arrow.css("left"));if(n<0&&(e.$tip.css("left",0),e.$arrow.css("left",a+n+"px")),"bottom"===l){let n=t.offset().top+t.outerHeight(),a=e.$tip.offset().top,o=i.scrollTop()-i.offset().top;a-n>10&&e.$tip.css("top",n+2+o+(i.is(".InsertPanel")?$(".modal-dialog").offset().top:0))}}),t.popover(r),"manual"==a&&(t.popover("show"),o&&$("#"+t.attr("aria-describedby")).addClass(o)),t.on("remove destroy",function(){t&&t.attr("aria-describedby")&&t.popover("destroy")}),e.on&&e.on("remove destroy",function(){t.length&&t.attr("aria-describedby")&&$("#"+t.attr("aria-describedby")).length&&t.popover("destroy")}),n&&setTimeout(function(){t&&t.attr("aria-describedby")&&t.popover("destroy")},n),t.attr("aria-describedby")},App.ksort=function(e){var t=Object.keys(e).sort(),n={};for(var i in t)n[t[i]]=e[t[i]];return n},App.values=function(e){let t=[];for(let n in e)t.push(e[n]);return t},App.keys=function(e){let t=[];for(let n in e)t.push(n);return t},App.isEmpty=function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!=typeof e)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},App.filter=function(e,t){let n={};return Object.keys(e).forEach(function(i){t(i,e[i])&&(n[i]=e[i])}),n},App.openInIframe=function(e,t,n){n=n||"newIframe";let i=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+n+'"></iframe>');BootstrapDialog.show({message:i.attr("src",t),size:BootstrapDialog.SIZE_WIDE,title:e,buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(e){let a;a=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+n+'"></iframe>').attr("src",t),i.replaceWith(a),i=a}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){$("<a>").attr("href",t).hide().appendTo("body").get(0).click(),e.close()}},{label:"Во вкладке",cssClass:"btn-m btn-default",action:function(e){let n=$("<a>").attr("href",t).attr("target","_blank").hide().appendTo("body");n.get(0).click(),n.remove(),e.close()}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}]})},App.aInIframe=function(e){return e=$(e),App.openInIframe(e.text(),e.attr("href")),!1},App.reUserInterface=function(e,t){let n=$("#UserFio");n.css("cursor","pointer"),t&&App.blink(n,10,"#ffe486");const i=function(){let t=$('<div class="tech-table" style="height: 220px; width: 200px;"><div class="select-btn"></div><div></div></div>'),a=$('<select data-size="6" class="open" title="Выберите пользователя" data-style="btn-sm btn-default" data-live-search="true" data-width="100%">');Object.keys(e).forEach(function(t){a.append($("<option>").text(t).data("content",e[t]))});let o=t.find(".tech-table");t.find(".select-btn").append(a),n.popover({html:!0,content:t,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),a.selectpicker("render").selectpicker("toggle"),a.data("container",o),a.on("hide.bs.select",function(){return a.val()&&function(e){let t=App.models.table("/Main/",{},{}),n=$("#table").data("pctable")||{isCreatorView:!0};t.addPcTable(n),t.reUser(e)}(a.val()),$("body").off("click.FioPopover"),!1}),setTimeout(function(){a.selectpicker("render"),n.popover("show"),$("#"+n.attr("aria-describedby")).css("top","45px"),a.data("selectpicker").$searchbox.focus(),$("body").one("click.FioPopover",function(e){void 0!==e.altKey&&(n.popover("destroy"),n.one("click",i))})},50)};n.one("click",i)},App.rgb2hex=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},App.tableTypes={simple:{icon:"fa fa-table",title:"Простая"},version:{icon:"fa fa-calendar",title:"Версионная"},calcs:{icon:"fa fa-calculator",title:"Расчетная в цикле"},globcalcs:{icon:"fa fa-calculator",title:"Расчетная"},tmp:{icon:"fa fa-clock-o",title:"Временная"},cycles:{icon:"fa fa-circle-o",title:"Циклы"}},App.textWithLinks=function(e){return $("<div>").text(e).html().replace(/(https?:\/\/[^\s]+)/g,function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"})},function(){var e=0;App.getUn=function(){return e++}}(),$.fn.datetimepicker.defaults.icons.close="glyphicon glyphicon-ok",$.fn.datetimepicker.defaults.tooltips.close="Применить и закрыть",function(){window.Hlps||(window.Hlps={});var e=window.Hlps;e.selectpicker={},e.selectpicker.open=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];(t=$(t)).attr("aria-expanded")&&"false"!==t.attr("aria-expanded")||t.click()},e.selectpicker.focus=function(e){var t=function(){var n=e.data("this");if(n&&e.is(".selectpicker")){var i=n.$newElement.children()[0];(i=$(i)).focus()}else{var a=0;setTimeout(function(){if(!(++a<4))return!1;t()},1+100*a)}};t()},e.selectpicker.getButton=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];return t=$(t)}}(),LOGINJS=function(){let e=$('<div><div class="form-group"><label>Email:</label><input id="elseEmail"  type="text"\n                                                                      name="login"\n                                                                      value=""\n                                                                      class="form-control"\n                /></div></div>');if($("body").on("click","#recover",function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="recover" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Новый пароль",buttons:t,draggable:!0})}),$("body").on("click","#register",function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="register" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Зарегистрировать и отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Регистрация",buttons:t,draggable:!0})}),sessionStorage.getItem("browserConfirm")||navigator.userAgent.match(/(chrome|safari|firefox|yandex(?=\/))\/?\s*(\d+)/i)&&!navigator.userAgent.match(/BlackBerry|iPod|Opera Mini|IEMobile/i))$("#auth_form").show();else{let e=$("#auth_form");$("body").html('<div style="width: 600px; margin: auto; padding-top: 50px; font-size: 16px; text-align: center;" id="comeinBlock"><img src="/imgs/start.png" alt=""><div style="padding-bottom: 10px;">Сервис оптимизирован под броузеры Chrome, Safari, Yandex, FireFox последних версий.</div><div><a href="#" id="comein" class="btn-default btn">Все равно хочу посмотреть</a></div></div>'),$("#comein").on("click",function(){sessionStorage.setItem("browserConfirm",!0),$("#comeinBlock").remove(),$("body").html(e),e.show()})}},restModel=function(e){return{url:e,create:function(){return $.ajax({url:this.url,method:"post",data:data})},get:function(e){return $.ajax({url:this.url,method:"get",data:{id:e}})},save:function(e,t){return $.ajax({url:this.url,method:"PUT",data:$.extend(t,{id:e})})}}},$(function(){if(App.isTopWindow()){let e=$("#bell-notifications");if(e.length){let t=App.models.table("/Main/");t.addPcTable({model:t}),e.on("click",function(){t.getNotificationsTable()});let n={},i={},a=e.data("periodicity")||0;if(a>0){const e=function(){switch(document.visibilityState){case"hidden":n.jqXHR&&n.jqXHR.abort&&n.jqXHR.abort(),n={};break;case"visible":t.checkForNotifications(a,Object.keys(i),n).then(function(n){if(n.notifications&&n.notifications.length){i[n.notification_id]=App.showDatas.call(t,n.notifications,n.notification_id);let e=[];i[n.notification_id].forEach(function(t){if(t){let n=$.Deferred();t.$modal.on("hide.bs.modal",function(){n.resolve()}),e.push(n)}}),$.when(...e).then(function(){delete i[n.notification_id]})}n.deactivated&&n.deactivated.forEach&&n.deactivated.forEach(function(e){i[e]&&(i[e].forEach(function(e){e.simpleClose()}),delete i[e])}),e()}).fail(function(t){t&&t.error&&document.removeEventListener("visibilitychange",e)})}};document.addEventListener("visibilitychange",e),e()}}}}),$(function(){let e=$("#docs-link");const t=function(){let n=$(this).data("type"),i=$('<div class="tech-table" id="DocsPopover" data-type="'+n+'" style="min-height: 250px"></div>');$.post("https://docs.totum.online/index_"+n+".json",function(e){e&&e.length&&e.forEach(function(e){i.append('<div style="'+(e[2]||"")+'"><i class="fa fa-external-link"></i> <a href="http://docs.totum.online'+e[1]+'" target="totum-docs">'+e[0]+"</a></div>")})}),e.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),setTimeout(function(){e.popover("show"),$("#"+e.attr("aria-describedby")).css("top","45px"),$("body").one("click.DocsPopover",function(n){void 0!==n.altKey&&(e.popover("destroy"),e.one("click",t))})},50)};e.one("click",t)}),function(e,t){const n=e.MOBILE_MAX_WIDTH=1199,i="#ee0c1f",a="#3fbf46",o="pcTableInsertRowPanel";var l=0;!function(){let n=App.functions||[],i=[];n.forEach(function(e){e.d||i.push(e.name)});let a={};n.forEach(function(e){a[e.name.toLowerCase()]=[e.t,0,e.p,e.n,e.m]});let o=["where","order","field","sfield","bfield","tfield","preview","parent","section","table","filter","fieldtitle"];CodeMirror.defaults.scrollbarStyle="overlay",CodeMirror.defineInitHook(function(n){try{if(!n.options.bigOneDialog&&screen.width>e.MOBILE_MAX_WIDTH){let i,a=t('<i class="fa fa-expand codemirror-expander" style="position: absolute;\n    right: 10px;\n    bottom: 10px;\n    z-index: 10000;\n    font-family: FontAwesome; cursor: pointer"></i>');t(n.display.wrapper).append(a),a.on("click",function(){i=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');let a,o=n.getValue();e.top.BootstrapDialog.show({message:i,type:null,title:"Правка текстового поля",cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){n.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),e.$modalHeader.find("button.close").css("font-size","16px").html('<i class="fa fa-compress"></i>')},onshown:function(t){a=CodeMirror(i.get(0),{mode:n.options.mode,value:o,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t}),n.table&&(a.table=n.table);let l=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=l+"px",i.find(".CodeMirror").css("min-heught",l),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})})}}catch(e){n.setValue(e.message)}});function l(e){if(e.getOption("disableInput")||"totum"!==e.getOption("mode"))return CodeMirror.Pass;var t=e.listSelections(),n=[];let i=!1;for(let r=0;r<t.length;r++){if(!t[r].empty())return CodeMirror.Pass;var o=t[r].head,l=e.getTokenAt(o,!0);if(l.state&&l.state.inFuncName||"function"==l.type||"error"==l.type){let c,d=l.string.toLowerCase(),f="";if(-1!==d.indexOf("/")?(c=d.substring(0,d.indexOf("/")),f=d.substring(d.indexOf("/"))):c=d.trimRight(),c=a[c]){let e="",t=0;if(f.length){e="(";let n=1,a=!0;f.split("/").forEach(function(t){if(0===t.length);else{a||(e+="; "),a=!1;let i=-1!==t.indexOf(":")&&""!==t.slice(t.indexOf(":")+1).trim();e+=t+(-1===t.indexOf(":")?": ":""),1!==n||i||(n=e.length)}}),1===n?n=e.length:i=!0,t+=n,e+=")"}else if(e=c[0],/:/.test(e)){let n=e.indexOf(":"),a=e.substring(n),o=a.substring(0,a.indexOf(";")||a.indexOf(")"));t+=n,-1!==o.indexOf("'")?t+=o.indexOf("'")+1:t+=2,i=!0}else t+=e.length;n[r]={text:e,newPos:CodeMirror.Pos(o.line,o.ch-f.length+t),replace:CodeMirror.Pos(o.line,o.ch-f.length)}}else n[r]={text:"()",newPos:CodeMirror.Pos(o.line,o.ch+1),replace:CodeMirror.Pos(o.line,o.ch)};let p=n[r];if(p){e.replaceRange(p.text,p.replace,t[r].anchor,"+insert");var s=e.listSelections().slice(0);s[r]={head:p.newPos,anchor:p.newPos},e.setSelections(s),i&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}}else e.replaceRange("()",CodeMirror.Pos(o.line,o.ch),t[r].anchor),e.setSelections([{head:CodeMirror.Pos(o.line,o.ch+1),anchor:CodeMirror.Pos(o.line,o.ch+1)}])}}CodeMirror.defineMode("totum",function(){return{startState:function(){return{inString:!1,isStart:!0,inFunction:!1,lineName:""}},token:function(e,n){function i(){return e.string.substring(e.start,e.pos)}function l(){"use strict";return e.skipToEnd(),"error"}n.lineNames=[];try{e.lineOracle.doc.cm.getValue().split("\n").forEach(function(e){return 0===e.trim().length||0===e.indexOf("//")?"":n.lineNames.push(e.replace(/^\s*~?\s*([a-zA-Z_0-9=]+)\s*:.*/,"$1"))})}catch(e){}if(0===e.pos||!0===n.isStart){if(e.string.match("^[\ts]*//"))return e.skipToEnd(),n.isStart=!1,"comment";let a="start";if(n.isStart=!0,/[\t\n]/.test(e.peek())&&e.next()){for(;/[\t\n]/.test(e.peek())&&e.next(););return"start-tabs"}return e.skipTo(":")?(n.lineName=i().trim(),"~"===n.lineName.substring(0,1)&&(a+=" fixed",n.lineName=n.lineName.substring(1)),/^[a-z0-9_]+\s*$/i.test(n.lineName)||"="===n.lineName||/^f[0-9]+\s*=\s*$/i.test(n.lineName)?(e.next(),t(e.lineOracle.doc.cm.getWrapperElement()).find(".cm-var-not-in").each(function(){let e=t(this).text();(e=e.replace(/\[.*/,""))!=="$"+n.lineName&&e!=="#$"+n.lineName&&e!=="$$"+n.lineName||t(this).removeClass("cm-var-not-in")}),n.lineNames.filter(function(e){return e===n.lineName}).length>1&&(a+=" dubbled"),n.isStart=!1,a):l()):l()}if(n.isStart=!1,e.match(/(math|json)`[^`]*`/))return"spec";switch(e.peek()){case" ":return e.next(),null;case"{":return e.next(),e.skipTo("}")?(e.next(),"inVars"):l();case'"':let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):l();case"#":e.next();let i="db_name";for(;/[a-z0-9_А-Яа-я\-\[\]\$\#".]/.test(e.peek())&&e.next(););let a=e.string.substring(e.start+1,e.pos);return/[^0-9a-z._]/.test(a.replace(/\[.*/g,"").slice(1))&&(i+=" tmp-error"),""===a?l():("$"===a[0]&&(a=a.replace(/\[.*/g,"").slice(1).trim(),-1===n.lineNames.indexOf(a)&&(i+=" var-not-in")),i);case"@":e.next();let o,s=e.peek();for(;/[a-z0-9_.\[\$\#"A-Z\]]/.test(o=e.peek())&&e.next();)s+=o;return/^[a-z0-9_]{3,}\.[a-z0-9_]{2,}(\[[a-zA-Z0-9_\$\#"]+\])*$/i.test(s)?"db_name":l();case"$":if(e.next(),"#"===e.peek()){for(e.next();/[a-z0-9_\-\[\]\$\#"]/i.test(e.peek())&&e.next(););return"code-var"}{for(;/[a-zA-Z0-9_\[\]\$\#"]/i.test(e.peek())&&e.next(););let t=e.string.substring(e.start,e.pos),i="variable",a=(t=t.replace(/\[.*/g,"")).substring(1);return"$"===a[0]&&(i+=" dollar-dollar",a=a.substring(1)),-1===n.lineNames.indexOf(a)&&(i+=" var-not-in"),i}case"t":if("true"===e.string.substring(e.start,e.start+4))return e.skipTo("e"),e.next(),"boolean";break;case"f":if("false"===e.string.substring(e.start,e.start+5))return e.skipTo("e"),e.next(),"boolean"}if(n.inFuncName=!1,!n.inFunction&&/[a-zA-Z]/.test(e.peek())){if(n.inFuncName=!0,e.skipTo("(")?n.inFunction=!0:e.skipToEnd(),!/^[a-zA-Z]+[0-9]*\s*$/.test(i()))return l();let t=a[i().trim().toLowerCase()];return t?(n.func=t,e.next(),"function"):l()}if(n.inFunction){if(")"===e.peek())return e.next(),n.inFunction=!1,n.functionParam="","function";if(!n.functionParam&&/[a-z_]/.test(e.peek())){if(e.skipTo(":")){let t=e.string.substring(e.start,e.pos);if(/^[a-z_]+\s*$/.test(t)){if(n.functionParam=t,e.next(),-1===n.func[2].indexOf(t))return l();let i="functionParam";return-1!==o.indexOf(t)&&(i+=" fieldParam"),-1!==n.func[3].indexOf(t)&&(i+=" reqParam"),n.func[4]&&-1!==n.func[4].indexOf(t)&&(i+=" multiParam"),i}return l()}return e.skipTo(")")?"error fieldParam":l()}if(!n.functionParam)return l();if(";"===e.peek())return e.next(),n.functionParam="","";if("order"===n.functionParam&&/[ad]/.test(e.peek())){if("asc"===e.string.substring(e.start,e.start+3))return e.next(),e.next(),e.next(),"";if("desc"===e.string.substring(e.start,e.start+4))return e.next(),e.next(),e.next(),e.next(),""}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string-name"):l()}}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):l()}if(/\d|%/.test(e.peek())){for(e.next();/[0-9.%]/.test(e.peek())&&e.next(););return/^\d+(\.\d+)?%?$/.test(e.string.substring(e.start,e.pos))?"number":l()}return/[+-\/*!<>=]/.test(e.peek())?(e.next(),"operator"):l()}}}),CodeMirror.registerHelper("hint","totumVars",function(e,n){return function(e,n,l,r){var f=e.getCursor(),u=l(e,f);if("error"!==u.type&&"string-name"!==u.type&&/\b(?:string|comment)\b/.test(u.type))return;var h=CodeMirror.innerMode(e.getMode(),u.state);if("json"===h.mode.helperType)return;u.state=h.state,u.inString=u.string,u.state.isDb_name=!1,u.state.showAll=!0,r.inStart=!0;let m,b=function(e,t,n){void 0!==n&&null!==n&&(e.replaceRange(n.text||n,t.from,t.to),n.curPos&&e.setCursor({line:t.from.line,ch:n.curPos}),n.showHint&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{}))};if(n=n.slice(),u.state.isStart||0===f.ch){n=[],u.string=u.string.replace(/^[\t]+/,"");let i="";/^~/.test(u.string)&&(u.string.replace(/^~/,""),i="~"),t(e.getWrapperElement()).find(".cm-var-not-in").each(function(){let e=t(this).text().replace(/^(\#|\$)?\$/,"").replace(/\[.*/,"");n.push({text:i+e+": ",displayText:e})})}else if(/^'.*?'?$/.test(u.string)&&-1!==o.indexOf(u.state.functionParam))if(u.state.showAll=!0,"''"===u.string?(u.end=u.end,u.start+=1,u.string=""):/'[a-z_0-9]+'/.test(u.string)?(u.start+=1,u.string=u.string.slice(1,f.ch-u.start)):(u.string=u.string.slice(1,f.ch-u.start),u.start+=1,u.end=f.ch,"'"===e.getLine(f.line)[f.ch]&&u.end++),"table"===u.state.functionParam){let e=c();n=[],Object.keys(e).forEach(function(t){n.push({text:t+"'",textVis:t,title:e[t].t,render:d,type:"item-string-name",hint:b,tab:!0})})}else{let t,i=e.getLine(f.line),a=i.substring(0,f.ch),o=i.substring(f.ch),l=o.substring(0,o.indexOf(")"));if(a=a.substring(a.lastIndexOf("("))+l,t=a.match(/table:\s*((\$#ntn)|'([a-z_0-9]*)')/)){let i=t[2]?e.table:t[3];n=[],Object.keys(s[i].f).forEach(function(e){n.push({text:e+"'",textVis:e,title:s[i].f[e],render:d,type:"item-string-name",curPos:f.ch+e.length+1,tab:!0})}),n.push({text:"id'",textVis:"id",title:"",render:d,type:"item-string-name",curPos:f.ch+3,tab:!0})}}else if(u.end>f.ch&&(u.end=f.ch,u.string=u.string.slice(0,f.ch-u.start)),0===u.string.indexOf("@")){r.inStart=!1,n=[];let e,t=c();if(u.string=u.string.slice(1,f.ch-u.start),u.start=u.start+1,u.end=f.ch,e=u.string.match(/^([a-z_0-9]+)\./)){let i=e[1];u.start+=(i+".").length,u.string=u.string.slice((i+".").length),t[i]&&t[i]["@"].length&&t[i]["@"].forEach(function(e){n.push({text:e,title:t[i].f[e],render:d,type:"item-db_name"})})}else Object.keys(t).forEach(function(e){t[e]["@"].length&&n.push({text:e+".",textVis:e,title:t[e].t,render:d,type:"item-db_name",showHint:!0,hint:b})})}else if("$#"===u.string.slice(0,2)){n=[{text:"$#lc",title:"Пустой лист",render:d,type:"item-code-var"},{text:"$#nd",title:"дата - Y-m-d",render:d,type:"item-code-var"},{text:"$#ndt",title:"дата-время - Y-m-d H:i",render:d,type:"item-code-var"},{text:"$#ndts",title:"дата-время с секундами - Y-m-d H:i:s",render:d,type:"item-code-var"},{text:"$#nu",title:"id пользователя",render:d,type:"item-code-var"},{text:"$#nr",title:"ids ролей пользователя",render:d,type:"item-code-var"},{text:"$#nti",title:"id таблицы",render:d,type:"item-code-var"},{text:"$#ntn",title:"NAME таблицы",render:d,type:"item-code-var"},{text:"$#nth",title:"HASH врем. таблицы",render:d,type:"item-code-var"},{text:"$#nci",title:"Cycle расчетной таблицы",render:d,type:"item-code-var"},{text:"$#nf",title:"NAME поля",render:d,type:"item-code-var"},{text:"$#nl",title:"Новая строка",render:d,type:"item-code-var"},{text:"$#ids",title:"id отмеченных галочками полей",render:d,type:"item-code-var"},{text:"$#nfv",title:"Значение текущего поля (для селектов/действий/форматов)",render:d,type:"item-code-var"},{text:"$#onfv",title:"Прошлое значение текущего поля",render:d,type:"item-code-var"},{text:"$#nh",title:"Текущий хост-name",render:d,type:"item-code-var"}];const e=function(e){let t=n.slice(),i=[];return t=t.filter(function(t){if(-1===e.indexOf(t.text))return!0;i.push(t)}),t=i.concat(t)};switch(u.state.functionParam){case"table":n=e(["$#ntn"]);break;case"cycle":n=e(["$#nci"]);break;case"field":n=e(["$#nf","$#nfv"])}}else if(m=u.string.match(/^(#?\$)/))n=[],u.string=u.string.slice(m[1].length,f.ch-u.start),u.start=u.start+m[1].length,u.end=f.ch,u.state.lineNames.forEach(function(e){-1===e.indexOf("=")&&n.push(e)});else if(m=u.string.match(/^\#/))n=[],u.string=u.string.slice(1,f.ch-u.start),u.start=u.start+1,u.end=f.ch,(m=u.string.match(/^([a-z]{1,3}\.)/))&&(u.string=u.string.slice(m[1].length),u.start+=m[1].length),e.table&&s[e.table]&&(Object.keys(s[e.table].f).forEach(function(t){n.push({text:t,title:s[e.table].f[t],render:d,type:"item-db-name"})}),n.push({text:"id",title:"",render:d,type:"item-db-name"}));else if(u.state.inFuncName){if(!u.state.inFunction)if(m=u.string.match(/^([a-zA-Z]+)\//)){let e;if(u.state.showAll=!0,e=a[m[1].toLowerCase()]){let t=u.start;u.start=u.start+u.string.lastIndexOf("/")+1,u.string=u.string.slice(u.string.lastIndexOf("/")+1,f.ch-t),u.end=f.ch,n=[],e[2].forEach(function(t){let i="";-1!==e[3].indexOf(t)&&(i+=" item-reqParam"),-1!==e[4].indexOf(t)&&(i+=" item-multiParam"),-1!==o.indexOf(t)&&(i+=" item-fieldParam"),n.push({text:t+": ",textVis:t,title:"",render:d,type:i})})}}else(n=i.slice()).push("true"),n.push("false")}else u.state.func&&("error fieldParam"===u.type||/(\(|;\s*)$/.test(e.getLine(f.line).slice(0,u.start)))?(n=[],u.state.func[2].forEach(function(t){let i="",a="";")"!==e.getLine(f.line).slice(f.ch).trim()&&(a="; "),-1!==u.state.func[3].indexOf(t)&&(i+=" item-reqParam"),-1!==u.state.func[4].indexOf(t)&&(i+=" item-multiParam"),-1!==o.indexOf(t)&&(i+=" item-fieldParam"),n.push({text:t+": "+a,textVis:t,title:"",render:d,type:i,hint:b,curPos:u.start+(t+": "+a).length-a.length})})):(n=["true","false"],"order"===u.state.functionParam&&(n=n.concat(["asc","desc"])));return{list:function(e,t,n){var i=[],a=[],o=e.string.toLowerCase();n&&n.globalScope;if(!e.state.showAll&&""===o)return found;return t.forEach(function(e){let t,l="";"string"==typeof e?t=e.toLowerCase():(t=e.text.toLowerCase(),e.title&&(l=e.title.toLowerCase())),p(i,t)||p(a,t)||(0===t.lastIndexOf(o,0)?i.push(e):0===l.lastIndexOf(o,0)?i.push(e):-1!==l.indexOf(o,0)?a.push(e):n.inStart||-1===t.indexOf(o)||a.push(e))}),1===i.length&&i[0]===o?[]:1===i.length&&i[0].text===o?[]:1===a.length&&a[0]===o?[]:1===a.length&&a[0].text===o?[]:i.concat(a)}(u,n,r),from:CodeMirror.Pos(f.line,u.start),to:CodeMirror.Pos(f.line,u.end)}}(e,f,function(e,t){return e.getTokenAt(t)},n)});let s=[],r=!1;const c=function(){return 0!==s.length||r||(r=!0,t("#table").data("pctable").model.getAllTables().then(function(e){s=e.tables})),s},d=function(e,n,i){t(e).append('<span class="'+i.type+'">'+(i.textVis||i.text)+(""===i.title?"":' <span class="descr">'+i.title+"</span>")+"</span>")};let f=[];function p(e,t){return-1!==e.indexOf(t)}CodeMirror.defineOption("autoCloseFunctions",!1,function(e){if("totum"!==e.getOption("mode"))return!1;c();var n={name:"autoCloseFunctions"};n["'('"]=l,e.addKeyMap(n),e.on("keydown",function(e,t){"9"===(t.keyCode||t.which).toString()&&function(e,t,n){var i=e.getCursor();if(e.getTokenAt(i).state.inFunction){let a,o,l=e.getLine(i.line);if(n){for(";"===l[a=i.ch]&&a--;l[a]&&-1===[";","("].indexOf(l[a]);)a--;for(o=a;l[a]&&-1===[":","("].indexOf(l[a]);)a--;":"===l[a]&&" "===l[++a]&&a++,o=i.ch}else{for(a=i.ch;l[a]&&-1===[":",")"].indexOf(l[a]);)a++;for(":"===l[a]&&" "===l[++a]&&a++," "===l[a]&&a++,o=a;l[o]&&-1===[";",")"].indexOf(l[o]);)o++;t&&(a=i.ch)}return e.setSelection({line:i.line,ch:a},{line:i.line,ch:o}),!0}}(e,t.altKey,t.shiftKey)&&t.preventDefault()}),e.on("keyup",function(e,t){e.options.bigOneDialog&&t.ctrlKey&&"83"===(t.keyCode||t.which).toString()?(t.stopPropagation(),e.options.bigOneDialog.close()):t.ctrlKey&&"191"===(t.keyCode||t.which).toString()&&CodeMirror.commentMe(e),"27"===(t.keyCode||t.which).toString()?(e.state.completionActive&&e.state.completionActive.close(),t.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(t.keyCode||t.which).toString()]||CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}),e.on("dblclick",function(n){var i=e.getCursor(),a=e.getTokenAt(i).state;let o,l=t(e.getWrapperElement()),s=e.getLine(i.line),r=s.substring(0,i.ch);if(/^\s*~?\s*?[a-zA-Z0-9_]+$/.test(r))o=a.lineName;else{let e=i.ch-1;if(/[a-zA-Z0-9_]/.test(s[e])){for(;--e&&e>=0&&/[a-zA-Z0-9_]/.test(s[e]););if("$"===s[e]){let t=e+1;for(e=i.ch-1;++e&&s.length>e&&/[a-zA-Z0-9_]/.test(s[e]););o=s.substring(t,e)}}}if(o){new RegExp("^s*~?s*"+o+"s*:").test(l.find(".cm-start.light").text())?(l.find(".cm-variable").removeClass("light"),l.find(".cm-start").removeClass("light")):(l.find(".cm-variable").removeClass("light").each(function(){let e=t(this);e.text()==="$"+o&&e.addClass("light")}),l.find(".cm-start").removeClass("light").each(function(){let e=t(this);e.text().trim().replace("~","").replace(":","")===o&&e.addClass("light")}))}})}),function(){"use strict";function t(e,t,n){this.cm=e,this.getHints=t,this.options=n,this.widget=this.onClose=null}function n(e){return"string"==typeof e?e:e.text}function i(t,i){this.completion=t,this.data=i;var a=this,o=t.cm,l=t.options,s=this.hints=e.top.document.createElement("ul");s.className="CodeMirror-hints",this.selectedHint=0;for(var r=i.list,c=0;c<r.length;++c){var d=s.appendChild(e.top.document.createElement("li")),f=r[c],p="CodeMirror-hint"+(c?"":" CodeMirror-hint-active");null!=f.className&&(p=f.className+" "+p),d.className=p,f.render?f.render(d,i,f):d.appendChild(e.top.document.createTextNode(f.displayText||n(f))),d.hintId=c}var u=o.cursorCoords(!1!==l.alignWithWord?i.from:null),h=u.left,m=u.bottom+3,b=!0;s.style.left=h+"px",s.style.top=m+"px";var g,_=e.innerWidth||Math.max(e.top.document.body.offsetWidth,e.top.document.documentElement.offsetWidth),v=e.innerHeight||Math.max(e.top.document.body.offsetHeight,e.top.document.documentElement.offsetHeight),w=s.getBoundingClientRect(),y=w.right-_,x=w.bottom-v;if(y>0&&(w.right-w.left>_&&(s.style.width=_-5+"px",y-=w.right-w.left-_),s.style.left=(h=u.left-y)+"px"),x>0){var k=w.bottom-w.top;w.top-(u.bottom-u.top)-k>0?(x=k+(u.bottom-u.top),b=!1):k>v&&(s.style.height=v-5+"px",x-=k-v),s.style.top=(m=u.bottom-x)+"px"}((l.container||e.top.document.body).appendChild(s),o.addKeyMap(this.keyMap=function(e,t){var n={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize())},PageDown:function(){t.moveFocus(t.menuSize())},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length)},Enter:t.pick,Esc:t.close},i=e.customKeys?{}:n;function a(e,a){var o;o="string"!=typeof a?function(e){return a(e,t)}:n.hasOwnProperty(a)?n[a]:a,i[e]=o}if(e.customKeys)for(var o in e.customKeys)e.customKeys.hasOwnProperty(o)&&a(o,e.customKeys[o]);if(e.extraKeys)for(var o in e.extraKeys)e.extraKeys.hasOwnProperty(o)&&a(o,e.extraKeys[o]);return i}(l,{moveFocus:function(e){a.changeActive(a.selectedHint+e)},setFocus:function(e){a.changeActive(e)},menuSize:function(){return a.screenAmount()},length:r.length,close:function(){t.close()},pick:function(){a.pick()}})),!1!==l.closeOnUnfocus)&&(o.on("blur",this.onBlur=function(){g=setTimeout(function(){t.close()},100)}),o.on("focus",this.onFocus=function(){clearTimeout(g)}));var C=o.getScrollInfo();return o.on("scroll",this.onScroll=function(){var n=o.getScrollInfo(),i=o.getWrapperElement().getBoundingClientRect(),a=m+C.top-n.top,l=a-(e.pageYOffset||(e.top.document.documentElement||e.top.document.body).scrollTop);if(b||(l+=s.offsetHeight),l<=i.top||l>=i.bottom)return t.close();s.style.top=a+"px",s.style.left=h+C.left-n.left+"px"}),CodeMirror.on(s,"click",function(e){for(var t=e.target||e.srcElement;"SPAN"===t.nodeName;)t=t.parentNode;null!=t.hintId&&(a.changeActive(t.hintId),a.pick())}),CodeMirror.on(s,"mousedown",function(){setTimeout(function(){o.focus()},20)}),CodeMirror.signal(i,"select",r[0],s.firstChild),!0}CodeMirror.showHint=function(e,n,i){if(!e.somethingSelected()&&(null==n&&(n=e.getHelper(e.getCursor(),"hint")),null!=n)){e.state.completionActive&&e.state.completionActive.close();var a=e.state.completionActive=new t(e,n,i||{});if(CodeMirror.signal(e,"startCompletion",e),!a.options.async)return a.showHints(n(e,a.options));n(e,function(e){a.showHints(e)},a.options)}},CodeMirror.commentMe=function(e){var t=e.getCursor(),n=(e.getTokenAt(t).state,e.lineInfo(t.line));let i;(i=n.text.match(/^([\t\s]*)\/\//))?e.replaceRange("",{line:t.line,ch:i[1].length},{line:t.line,ch:i[0].length}):(i=n.text.match(/^[\t\s]*/),e.replaceRange("//",{line:t.line,ch:i[0].length},{line:t.line,ch:i[0].length}))},t.prototype={close:function(){this.active()&&(this.widget&&this.widget.close(),this.onClose&&this.onClose(),this.cm.state.completionActive=null,CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(e,t){var i=e.list[t];i.hint?i.hint(this.cm,e,i):this.cm.replaceRange(n(i),e.from,e.to),this.close();this.cm},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.showWidget(e)},showWidget:function(e){this.widget=new i(this,e),CodeMirror.signal(e,"shown");var t,n=null,a=this,o=this.options.closeCharacters||/[\s()\[\]{};:>,]/,l=this.cm.getCursor(),s=this.cm.getLine(l.line).length;function r(){t||(t=!0,a.close(),a.cm.off("cursorActivity",p),CodeMirror.signal(e,"close"))}function c(){return!!t||(a.widget?void 0:(r(),!0))}function d(){c()||(a.options.async?a.getHints(a.cm,f,a.options):f(a.getHints(a.cm,a.options)))}function f(e){if(!c()){if(!e||!e.list.length)return r();a.widget.close(),a.widget=new i(a,e)}}function p(){clearTimeout(n);var e=a.cm.getCursor(),t=a.cm.getLine(e.line);e.line!=l.line||t.length-e.ch!=s-l.ch||e.ch<l.ch||a.cm.somethingSelected()||e.ch&&o.test(t.charAt(e.ch-1))?a.close():n=setTimeout(d,170)}this.cm.on("cursorActivity",p),this.onClose=r}},i.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(e){if(e=Math.max(0,Math.min(e,this.data.list.length-1)),this.selectedHint!=e){var t=this.hints.childNodes[this.selectedHint];t.className=t.className.replace(" CodeMirror-hint-active",""),(t=this.hints.childNodes[this.selectedHint=e]).className+=" CodeMirror-hint-active",t.offsetTop<this.hints.scrollTop?this.hints.scrollTop=t.offsetTop-3:t.offsetTop+t.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=t.offsetTop+t.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],t)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}()}(),function(){const e=function(e){return{doc:e.doc}};CodeMirror.extendMode("css",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t){return/^[;{}]$/.test(t)}}),CodeMirror.extendMode("javascript",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t,n,i){return this.jsonMode?/^[\[,{]$/.test(t)||/^}/.test(n):(";"!=t||!i.lexical||")"!=i.lexical.type)&&(/^[;{}]$/.test(t)&&!/^;/.test(n))}}),CodeMirror.extendMode("xml",{commentStart:"\x3c!--",commentEnd:"--\x3e",newlineAfterToken:function(e,t,n){return"tag"==e&&/>$/.test(t)||/^</.test(n)}}),CodeMirror.defineExtension("commentRange",function(e,t,n){var i=this,a=CodeMirror.innerMode(i.getMode(),i.getTokenAt(t).state).mode;i.operation(function(){if(e)i.replaceRange(a.commentEnd,n),i.replaceRange(a.commentStart,t),t.line==n.line&&t.ch==n.ch&&i.setCursor(t.line,t.ch+a.commentStart.length);else{var o=i.getRange(t,n),l=o.indexOf(a.commentStart),s=o.lastIndexOf(a.commentEnd);l>-1&&s>-1&&s>l&&(o=o.substr(0,l)+o.substring(l+a.commentStart.length,s)+o.substr(s+a.commentEnd.length)),i.replaceRange(o,t,n)}})}),CodeMirror.defineExtension("autoIndentRange",function(e,t){var n=this;this.operation(function(){for(var i=e.line;i<=t.line;i++)n.indentLine(i,"smart")})}),CodeMirror.defineExtension("autoFormatRange",function(t,n){var i=this,a=i.getMode(),o=i.getRange(t,n).split("\n"),l=CodeMirror.copyState(a,i.getTokenAt(t).state),s=i.getOption("tabSize"),r="",c=0,d=0==t.ch;function f(){r+="\n",d=!0,++c}for(var p=0;p<o.length;++p){for(var u=new CodeMirror.StringStream(o[p],s,e(i));!u.eol();){var h=CodeMirror.innerMode(a,l),m=a.token(u,l),b=u.current();u.start=u.pos,d&&!/\S/.test(b)||(r+=b,d=!1),!d&&h.mode.newlineAfterToken&&h.mode.newlineAfterToken(m,b,u.string.slice(u.pos)||o[p+1]||"",h.state)&&f()}!u.pos&&a.blankLine&&a.blankLine(l),d||f()}i.operation(function(){i.replaceRange(r,t,n);for(var e=t.line+1,a=t.line+c;e<=a;++e)i.indentLine(e,"smart");i.setSelection(t,i.getCursor(!1))})}),t(function(){})}();let s={};var r={sortable:!1,width:50,icon:"fa-font",editable:!1,required:!0,insertable:!1,type:"string",getPanelVal:e=>e,getEditVal:function(e){var t,n=e.val().trim(),i=!1;(!this.required||void 0!==n&&""!==n&&null!==n||(t="Поле "+this.title+" должно быть заполнено",i=!0),this.regexp&&""!==n)&&(new RegExp(this.regexp).test(n)||(t=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"',t='Ошибка заполнения поля "'+this.title+'": '+t,i=!0));if(i)throw t;return n},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="text" class="form-control" name="cell_edit" autocomplete="off" autocorrect="off" />');void 0!==s&&r.attr("tabindex",s);var c=this;return n=n.v,r.val(n).on("keyup",function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),c.focusElement(r)}break;case 27:o(t(this),e)}}),r.on("blur",function(e){l(r,e)}),r.select()},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{let t=this.warningEditRegExp.match(/^\/(.*?)\/([a-z]*)$/);return new RegExp(t[1],t[2]).test(e)}catch(e){return!0}},getCellText:function(e){if(!0===this.url&&e){let n=this.openIn||"window";switch(n){case"window":n="_self";break;case"newWindow":n="_blank"}let i=t('<a class="uri" target="'+n+'">').attr("href",e).text(e);return"iframe"===n&&i.attr("onclick","return App.aInIframe(this);"),i}return e},getPanelText:function(e,t,n){return this.getCellText(e,t,n)},getCopyText:function(e,n){let i=this.getPanelText(e.v,null,n);if("string"==typeof i)return i;const a=function(e){if(e&&e.each&&"[object Function]"==={}.toString.call(e.each)){let n="";return e.each(function(){""!==n&&(n+="\n"),n+=t(this).text()}),n}return e};if(null===i)return"";if("object"==typeof i&&!(i instanceof jQuery)){let e=t.Deferred();return i.done(function(t){e.resolve(a(t))}).fail(function(){e.resolve("Не удалось загрузить данные")}),e}return a(i)},focusElement:function(e){e.focus()},isDataModified:function(e,t){return t+="","null"===(e+="")&&(e=""),"null"===t&&(t=""),t===(this.errorText||"ОШБК!")&&(t=""),"undefined"===t&&(t=""),e!==t},getFilterDataByValue:function(e){let t=[];return this.addDataToFilter(t,e),Object.keys(t)[0]},addDataToFilter:function(e,t){let n;e[n=null===t.v?"null".hashCode():t.v.toString().hashCode()]="string"==typeof t.v?t.v.replace(/"/g,"&quot;"):t.v},checkIsFiltered:function(e,t){let n=e.v;var i=!1;return t.forEach(function(e){if(e===(null==n?"null":n.toString()).hashCode().toString())return i=!0,!1}),i},getCellTextInPanel:function(e,t,n){return this.getCellText(e,t,n)}};s.text={width:50,icon:"fa-align-left",type:"Text",isPanelField:!0,getEditVal:function(e){return e.data("val").trim()},getCellText:function(e){if("string"!=typeof e)return"";let n=e.length;return t("<div>").text(e.substring(0,this.viewTextMaxLength)+(n>this.viewTextMaxLength?"...":"")).text()},getValue:function(e,n,i){"use strict";if(i||"string"==typeof e&&e.length<this.viewTextMaxLength){let n=t.Deferred();return setTimeout(function(){e||(e=""),n.resolve({value:e})},20),n}let a={fieldName:this.name};return n.id&&(a.rowId=n.id),this.pcTable.model.getValue(a,this.table_id)},getPanelTextWithLinks:function(e){if("text"===this.textType){let n=t("<div>");n.html(App.textWithLinks(e)),e=n}else e=t("<div>").text(e);return e},getPanelText:function(e,n,i){if("string"!=typeof e)return"";let a=this;if(e.length<=this.viewTextMaxLength)return a.getPanelTextWithLinks.call(a,e);let o=t.Deferred();return this.getValue(e,i,!1).then(function(e){o.resolve(t("<div>").append(a.getPanelTextWithLinks.call(a,e.value)))}).fail(function(){o.reject()}),o.promise()},getEditElement:function(n,i,a,o,l,s,r,c){let d,f=this,p=t("<div>"),u=t("<div>").css("min-height",200),h=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){f.getValue(i,a,!c).then(function(n){let i;if(p.append(h),h.empty().appendTo(u),"json"===f.textType){i=new JSONEditor(h.get(0),{});try{""!==n.value&&i.setText(n.value)}catch(e){App.modal("Ошибка формата JSON ")}h.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){let n=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n),o=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(e){try{i.setText(a.val()),e.close()}catch(e){App.modal("Ошибка формата JSON")}}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];return f.pcTable.isMobile?App.mobilePanel("Ручное изменение json-поля",n,{buttons:o}):BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:o,cssClass:"fieldparams-edit-panel",draggable:!0,onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});h.find(".jsoneditor-menu").append(a)}else{let e="text";switch(f.textType){case"html":e="text/html";break;case"totum":e="totum";break;case"markdown":e="text/x-markdown";break;case"xml":e="application/xml";break;case"css":e="text/css";break;case"javascript":e="text/javascript"}let o=t("<div>").appendTo(h),l={value:n.value,mode:e,minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0};"text"===e&&(l.lineNumbers=!1,l.lineWrapping=!0),(i=CodeMirror(o.get(0),l)).on("paste",function(e,t){setTimeout(function(){i.refresh()},1)}),f.pcTable&&"tables"===f.pcTable.tableRow.name&&(i.table=a.name.v||a.name),i.getScrollerElement().style.minHeight="350px",i.focus()}h.data("editor",i)})};const b=function(e,t,n){"json"===f.textType?p.data("val",JSON.stringify(h.data("editor").get())):p.data("val",h.data("editor").getValue()),n||(o(p,{}),e.close())};d=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},_={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){l(p,{}),e.close()}};-1!==["xml","html"].indexOf(f.textType)&&d.unshift({label:"Форматировать",action:function(){let e=h.data("editor"),t=e.lineCount(),n=e.getValue().length;e.autoFormatRange({line:0,ch:0},{line:t,ch:n})}});let v="Текст поля <b>"+this.title+", "+f.textType+"</b>",w="ctrlS.textedit";if(c){let e=!1;setTimeout(function(){let n=p.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&b(t,0,!0),i.click({}),e=!0,t.close()},d.push(i)}),n.popover("destroy")):(d.push(g),d.push(_)),f.pcTable.isMobile?App.mobilePanel(v,u,{buttons:d,onhide:function(n){t("body").off(w),e||s(p,{})},onshown:function(e){m()},onshow:function(e){t("body").on(w,function(t){b(e)})}}):BootstrapDialog.show({message:u,type:null,title:v,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:d,onhide:function(n){t("body").off(w),e||s(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"100%"}),t("body").on(w,function(t){b(e)})}})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{p.on("focus click","button",function(){let e=d.splice();e.push(g),e.push(_);var n=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(v,u,{buttons:e,onhide:function(e){t("body").off(w),l(n,e)},onshown:function(e){m(),t("body").on(w,function(t){b(e)})}}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:v,buttons:e,draggable:!0,onhide:function(e){t("body").off(w),l(n,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),m(),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать текст");r&&e.attr("tabindex",r),p.append(e),setTimeout(function(){if(0!==p.closest(".InsertPanel").length&&""!=i){let e=t("<div/>").text(f.getCellText(i,p,a));e.css("padding-bottom","5px"),p.prepend(e)}},10)}return p.data("val",i)},getCellTextInPanel:function(e,n,i){return t("<div>").append(this.getCellText(e,n,i)).css("white-space","pre-wrap")}},s.checkbox={icon:"fa-check-square",getEditVal:function(e){return!!e.is(":checked")},getCellText:function(e){return!0===e?"✓":!1===e?"-":""},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="checkbox" name="cell_edit"/>');s&&r.attr("tabindex",s),r.on("keyup",function(e){13==e.keyCode&&setTimeout(function(){a(r,e)},20)});return!0===n.v&&r.prop("checked",!0),r.on("click",function(e){a(r,e)}),r}},s.string={},s.number={icon:"fa-hashtag",getEditVal:function(e){let t=e.val().trim();if(this.required&&(void 0===t||""===t||null===t))throw"Поле "+this.title+" должно быть заполнено";if(this.regexp&&!new RegExp(this.regexp).test(t)){let e=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"';throw e='Ошибка заполнения поля "'+this.title+'": '+e}if(""===t)return"";let n=t.replace(/[^\-()\d/*+.,%:\/]/g,"");if(!/^(\+|\*|\%|\/|\:)?(\-?[\d]+((\.|\,)[\d]+)?)%?$/.test(n))throw"Здесь должно быть число";return t=t.replace(/,/,".")},getCopyText:function(e,t,n){return null===e||void 0===e||""===e||null===e.v?"":e.v.toString().replace(/\./g,",")},getCellText:function(e,t,n){if(null===e||void 0===e||""===e)return"";if(this.currency){let t={};return this.dectimalPlaces&&(t.minimumFractionDigits=this.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)}return e}},s.date={icon:"fa-calendar-o",getEditVal:function(e){if(this.required&&""==e.val().trim())throw"Поле должно быть заполнено";if(!e.val().trim())return"";let t=e.data("calendar").data("DateTimePicker").date();return this.getDbString(t)},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="text" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" />');s&&r.attr("tabindex",s);var c=this;let d=this.getFormat();r.data("AppUin",App.getUn()),n=n.v,r.val(this.getViewString(n));let f,p=t("<div>");this.dateTime&&(f="date-popover");var u=t("<div></div>").appendTo(p);let h,m,b;u.on("dp.change",function(e){if(null!==e.oldDate||!c.dateTime||r.val()&&""!==r.val())r.val(e.date.format(d));else{let t=e.date,n=moment();t.format("HH:mm")===n.format("HH:mm")&&(t=t.hours(0).minutes(0)),r.val(t.format(d)),g()}}),r.on("keyup",function(e){h&&clearTimeout(h),13===e.keyCode?(g(),a(t(this),e)):27===e.keyCode?o(t(this),e):e.keyCode>=48&&(h=setTimeout(function(){g()},2e3))});const g=function(){"use strict";let e=r.val();e=e?moment(e,d):"";try{u.data("DateTimePicker").date(e)}catch(e){}};if(setTimeout(function(){let e=r.closest("td").find(".cdiv");e.length>0?(p.append(e.data("bs.popover").options.content),e.popover("destroy"),b=t("#"+App.popNotify({$text:p,element:e,container:c.pcTable._container,isParams:!0,placement:"bottom",class:f})),r.on("focus click",function(){b.show()})):r.on("focus click",function(){b||(m=App.popNotify(p,r),b=t("#"+m)),u.data("DateTimePicker").show(),b.show(),g()})},20),r.on("blur",function(e){setTimeout(function(){b&&b.is(":visible")&&(b.hide(),g(),l(r,e))},200)}),u.datetimepicker({inline:!0,format:d,useCurrent:!1,showClose:!1,locale:"ru",sideBySide:!0,collapse:!1}),n)try{u.data("DateTimePicker").date(c.getMoment(n))}catch(e){}else r.val("");return r.data("calendar",u),r},getCellText:function(e){return e&&null!==e?this.getViewString(e):""},getViewString:function(e){return e?this.dateTime?App.dateTimeFormats.covertFromDb(e,this.getFormat()):App.dateFormats.covertFromDb(e,this.getFormat()):""},getDbString:function(e){return e?this.dateTime?App.dateTimeFormats.covertToDb(e,this.getFormat()):App.dateFormats.covertToDb(e,this.getFormat()):""},getMoment:function(e){return this.dateTime?moment(e,App.dateTimeFormats.db):moment(e,App.dateFormats.db)},addDataToFilter:function(e,t){let n;n=null===t.v?"null".hashCode():t.v.toString().hashCode();let i=this.dateTime?App.dateTimeFormats:App.dateFormats;e[n]="string"==typeof t.v?i.covertFromDb(t.v):t.v},getFormat:function(){let e=this.dateFormat;e||(e=this.dateTime?"d.m.y H:i":"d.m.y");let t={d:"DD",D:"ddd",j:"M",z:"DDD",W:"W",m:"MM",M:"MMM",n:"M",y:"YY",Y:"YYYY",H:"HH",i:"mm",s:"ss"},n="";for(let i=0;i<e.length;i++){let a=e[i];n+=t[a]||a}return n}},s.unic={icon:"fa-fire"},s.file={icon:"fa-file-image-o",getSize:function(e){return e>102400?" "+(Math.round(e/1048576*10)/10).toLocaleString()+"Mb":" "+Math.round(e/1024).toLocaleString()+"Kb"},getCellText:function(e){if(!e||null===e||0==e.length)return"";let n=t('<span style=""></span>');const i=function(e){let i;i=-1!==["png","jpg"].indexOf(e.ext)?'<img src="/fls/'+e.file+'_thumb.jpg" style="max-height: 24px; padding-right: 3px;"/>':'<img src="/imgs/file_ico.png" style="max-height: 24px; padding-right: 3px;"/>';let a=t('<a href="/fls/'+e.file+'" download="'+t("<div>").text(e.name).html()+'" style="padding-right: 5px">'+i+"</a>");a.append(e.name),n.append(a)};return e.length&&e.forEach&&e.forEach(i),n},getCopyText:function(t,n){if(!(t=t.v)||null===t||0==t.length)return"";let i=this,a="";return t.forEach(function(t){""!==a&&(a+="\n"),a+=t.name+" "+e.location.protocol+"//"+e.location.host+"/fls/"+t.file+" "+i.getSize(t.size)}),a},getPanelText:function(n){if(!n||null===n||0==n.length)return"";let i=t('<div class="file-mini-panel">'),a=this,o="",l=Math.random();return n.forEach(function(n){let s="",r="";-1!==["jpg","png"].indexOf(n.ext)&&(s='<img src="/fls/'+n.file+"_thumb.jpg?rand="+l+'"/>',r="with-img"),t("<div>").addClass(r).appendTo(i).append(t(s+'<br/><a href="/fls/'+n.file+'" download="'+t("<div>").text(n.name).html()+'">').text(n.name)).append(a.getSize(n.size)),""!==o&&(o+="\n"),o+=e.location.protocol+"//"+e.location.host+"/fls/"+n.file}),i.data("text",o)},getEditVal:function(e){if(this.required&&""==e.data("val"))throw"Поле должно быть заполнено";return e.data("val")},getEditElement:function(e,n,i,a,o,l,s,r){let c,d,f=this,p=t("<div>"),u=t("<div>").css("min-height",200),h=n.v||[],m=!1;const b=function(e){let n=t('<div class="filePart"><div><span class="name"></span><span class="size"></span><button class="btn btn-danger btn-xs remove"><i class="fa fa-remove"></i></button></div></div>'),a={name:e.name,type:e.type,tmpfile:e.tmpfile,size:e.size,file:e.file,ext:e.ext},o=new RegExp("^"+f.pcTable.tableRow.id+"_"+(i.id?i.id:""));if(e.file&&!o.test(e.file)&&n.find(".remove").remove(),n.data("file",a),n.find(".name").text(e.name),n.find(".size").text(f.getSize(e.size)),e.file){let i=t("<a>").attr("href","/fls/"+e.file).attr("download",e.name);n.find(".name").wrap(i),-1!==["jpg","png"].indexOf(e.ext)&&(t("<img>").attr("src","/fls/"+e.file+"_thumb.jpg?rand="+Math.random()).insertBefore(n.find(".name")),n.addClass("with-img"))}else n.append('<div class="progressbar">&nbsp;</div>');if(e.tmpfile){n.addClass("addFile"),n.find(".progressbar").text("Требуется сохранение элемента для привязки файла")}return n},g=function(e){d.$modalFooter.find("button:first").prop("disabled",e)},_=function(){u.empty();let e=t("<div>").appendTo(u),n=t('<button class="btn btn-default btn-sm">Добавить файл'+(f.multiple?"ы":"")+"</button>");e.append(n),n.wrap('<div class="addFilesButton">');const i=function(){f.multiple||(u.find(".filePart").length>0?n.prop("disabled",!0):n.prop("disabled",!1))};h.forEach(function(e){let t=b(e).appendTo(u);t.on("click",".remove",function(){t.remove(),i()})}),i(),n.on("click",function(){let e=t('<input type="file" name = "file" '+(f.multiple?"multiple":"")+' accept="'+f.accept+'" style="display: block; position: absolute; top: -3000px"/>');t("body").append(e),e.click(),e.on("change",function(){if(this.files){let e=[];g(!0);for(let n=0,a=this.files.length;n<a;n++){let a=this.files[n],o=b(a).addClass("addFile").appendTo(u);i();let l=o.find(".progressbar");if(a.size>10485760){l.text("Ошибка - файл больше 10 Mb").css({"box-shadow":"none","background-color":"#ffe486"}),o.on("click",".remove",function(){o.remove(),i()});continue}let s=new XMLHttpRequest,r=t.Deferred();o.on("click",".remove",function(){o.remove(),s.abort(),r.resolve(),i()}),s.upload.onprogress=function(e){l.css("box-shadow","inset "+Math.round(parseInt(l.width())*e.loaded/e.total).toString()+"px 0px 0 0 #85FF82"),e.loaded===e.total&&l.text("Проверка файла сервером")},s.onload=s.onerror=function(e){if(r.resolve(),200===this.status)try{let e=JSON.parse(this.responseText);if(e.fname)return l.text("Готово"),void(o.data("file").tmpfile=e.fname)}catch(e){}o.data("file",null),l.text("Ошибка").css({"box-shadow":"none","background-color":"#ffe486"})},s.open("POST","/Table/",!0);let c=new FormData;c.append("file",a),c.append("method","tmpFileUpload"),s.send(c),e.push(r.promise())}t.when(...e).then(function(){g(!1)})}})})},v=function(e){let n=[];e.$modalContent.find(".filePart").each(function(){let e=t(this).data("file");e&&n.push(e)}),p.data("val",n),h=n,m=!0,a(p,{}),e.close()};c=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:v},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];let w="Форма файлов <b>"+this.title+"</b>",y="ctrlS.textdialog",x=function(e){d=f.pcTable.isMobile?App.mobilePanel(w,u,{buttons:c,onhide:function(n){t("body").off(y),m||o(e,n)},onshown:function(e){_(),t("body").on(y,function(t){v(e)})}}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:w,draggable:!0,buttons:c,onhide:function(n){t("body").off(y),m||o(e,n)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:600}),_(),t("body").on(y,function(t){v(e)})}})};if(r)x(p),p.text("Редактирование в форме").addClass("edit-in-form");else{p.on("focus click","button",function(){x(t(this).closest("div"))});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать поле");s&&e.attr("tabindex",s),p.append(e),setTimeout(function(){if(0!==p.closest(".InsertPanel").length){let e=t("<div/>").html(f.getCellTextInPanel(n.v));e.css("padding-bottom","5px"),p.prepend(e)}},10)}return p.data("val",h)},getCellTextInPanel:function(e){let n=t('<div class="panel-preview"></div>');return e&&e.length&&e.forEach&&e.forEach(function(e){let i;i=-1!==["png","jpg"].indexOf(e.ext)?'<img src="/fls/'+e.file+'_thumb.jpg" />':'<img src="/imgs/file_ico.png" />';let a=t('<div><a href="/fls/'+e.file+'" download="'+t("<div>").text(e.name).html()+'">'+i+"</a></div>");a.append(e.name),n.append(a)}),n},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))}},s.n=t.extend({},s.default,{name:"n",width:52,title:"Порядок",category:"column",hidden:!0,showInWeb:!0,getCellText:function(e,n,i){let a=i.f||{};return n.addClass("n"),!i.id||a.block||a.blockOrder||i.__inserted?"":t('<span class="btns"><button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button> <button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button></span>')}}),s.listRow=t.extend({},s.default,{icon:"fa-code",isPanelField:!0,getPanelTextAsTable:function(e){if("object"==typeof e&&null!==e&&e.settings&&e.data&&e.settings.columns&&e.settings.columns.length){const n=t('<table class="json-table">');let i=e.settings,a=i.columns;try{if(i.headRow){const e=t("<tr>").appendTo(n);"boolean"==typeof i.headRow?a.forEach(function(n){t("<td>").text(n).appendTo(e).addClass("head")}):a.forEach(function(n){t("<td>").text(i.headRow[n]).appendTo(e).addClass("head")})}return e.data.forEach(function(e){const o=t("<tr>").appendTo(n);a.forEach(function(n){let i=e[n];"string"==typeof i&&""!==i||(i=JSON.stringify(i));t("<td>").text(i).appendTo(o)}),i.headColumn&&o.find("td:first").addClass("head")}),n}catch(e){console.log(e)}}},getPanelText:function(e,n,i){let a=t.Deferred(),o=this;const l=function(e){let n=o.getPanelTextAsTable.call(o,e);if(n)return n.copyText=JSON.stringify(e),void a.resolve(n);a.resolve(t("<div>").text(JSON.stringify(e,null,2)))};return"string"!=typeof e?l(e):this.getValue(e,i,!1).then(function(e){l(e.value)}).fail(function(){a.reject()}),a.promise()},getValue:function(e,n,i){"use strict";let a=t.Deferred();if(i||"filter"===this.category||"object"==typeof e||!e)return a.resolve({value:e}),a;{let e={fieldName:this.name};n.id&&(e.rowId=n.id),this.pcTable.model.getValue(e,this.table_id).then(function(e){a.resolve(e)})}return a},getEditElement:function(n,i,a,o,l,s,r,c){let d,f=this,p=t("<div>"),u=t("<div>").css("min-height",200),h=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){f.getValue(i,a,!c).then(function(n){let i;p.append(h),h.empty().appendTo(u),i=new JSONEditor(h.get(0),{});try{""!==n.value&&i.setText(JSON.stringify(n.value))}catch(e){App.modal("Ошибка формата JSON ")}h.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){let n=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n),o="Ручное изменение json-поля",l=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(e){try{i.setText(a.val()),e.close()}catch(e){App.modal("Ошибка формата JSON")}}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];return f.pcTable.isMobile?App.mobilePanel(o,n,{buttons:l}):BootstrapDialog.show({message:n,type:null,title:o,draggable:!0,cssClass:"fieldparams-edit-panel",buttons:l,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});h.find(".jsoneditor-menu").append(a),h.data("editor",i)})};const b=function(e,t,n){p.data("val",h.data("editor").get()),n||(o(p,{}),e.close())};d=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},_={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){l(p,{}),e.close()}},v="Текст поля <b>"+this.title+"</b>",w="ctrlS.textedit";if(c){let e=!1;setTimeout(function(){let n=p.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&b(t,0,!0),i.click({}),e=!0,t.close()},d.push(i)}),n.popover("destroy")):(d.push(g),d.push(_)),f.pcTable.isMobile?App.mobilePanel(v,u,{buttons:d,onhide:function(n){t("body").off(w),e||s(p,{})},onshown:function(e){m()},onshow:function(e){t("body").on(w,function(t){b(e)})}}):BootstrapDialog.show({message:u,type:null,title:v,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:d,onhide:function(n){t("body").off(w),e||s(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{p.on("focus click","button",function(){let e=d.splice();e.push(g),e.push(_);var n=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(v,u,{buttons:e,onhide:function(e){t("body").off(w),l(n,e)},onshown:function(e){m(),t("body").on(w,function(t){b(e)})}}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:v,draggable:!0,buttons:e,onhide:function(e){t("body").off(w),l(n,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),m(),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать список/json");r&&e.attr("tabindex",r),p.append(e)}return p.data("val",i)},isDataModified:function(e,t){return""===e&&(e=null),""===t&&(t=null),t!==e&&!Object.equals(e,t)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return"string"!=typeof e?JSON.stringify(e):e}}),s.password={icon:"fa-lock",getEditVal:function(e){var t=e.val().trim(),n=!1;if(void 0!==t&&""!==t&&null!==t||(notify="Поле "+this.title+" должно быть заполнено",n=!0),n)throw notify;return t},getCellText:function(e){return"**PASSWORD**"},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="password" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" placeholder="'+(n?"Поменять пароль":"Новый пароль")+'"/>');r.on("save-me",function(e){a(t(this),e)}),s&&r.attr("tabindex",s);var c=this;n=n.v,r.on("keyup",function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),c.focusElement(r)}break;case 27:o(t(this),e)}});return r.one("blur",function(e){setTimeout(function(){!function(e){l(r,e)}(e)},50)}),r.select()}},s.select={icon:"fa-th-list",getEditVal:function(e){if(e.data("input")){var t=e.data("input").selectpicker("val");return null===t&&this.multiple&&(t=[]),t}},loadPreviewPanel(n,i,a,o){let l=t.Deferred();return n.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),this.pcTable.model.loadPreviewHtml(i,a,o).then(function(i){if(n){let a=t("<div>");i.previews.forEach(function(n){let i=t('<div class="preview">');switch(n[2]){case"file":e.imgRand=e.imgRand||Math.random(),Array.isArray(n[1])&&n[1].forEach(function(n){-1!==["jpg","png"].indexOf(n.ext)&&i.append(t('<a href="/fls/'+n.file+'" target="_blank">').html('<img src="/fls/'+n.file+"_thumb.jpg?rand="+e.imgRand+'"/><br/>')),i.append(t('<a href="/fls/'+n.file+'" target="_blank">').text(n.name+" "+Math.round(n.size/1024).toLocaleString("ru-RU")+" Kb"))});break;case"html":i.text(n[0]);break;case"text":i.text(App.textWithLinks(n[0]));break;case"currency":case"number":if("currency"===n[2])try{i.text(parseFloat(n[1]).toLocaleString("ru-RU"))}catch(e){i.text(n[1])}else i.text(n[1]);n[3].unitType&&i.append(" "+n[3].unitType);break;case"url":i=t("<div>").append(t('<a target="_blank">').text(n[1]).attr("href",n[1]));break;default:i=t("<div>").text(n[1])}a.append(t('<div class="title">').text(n[0])),a.append(i)}),n.empty().append(a)}l.resolve()}).fail(function(){l.reject()}),l},previewPanel:function(e,n){let i=t('<div id="selectPanel" class="text preview" style="white-space: pre-wrap; height: 200px;">'),a={};a="column"===this.category?e.data("id")?this.pcTable._getItemById(e.data("id")):this.pcTable._insertItem:this.pcTable.data_params,n.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto right",animation:!1}).popover("show");let o=t("#"+n.attr("aria-describedby")).css("z-index",1e4);const l=function(){n.attr("aria-describedby")&&o.length&&(n.off(".preview"),o.off(".preview"),o.remove())};n.on("mouseout.preview",function(){setTimeout(function(){o&&!o.is(":hover")&&l()},300)}),o.on("mouseout.preview",function(){o.is(":hover")||!n||n.is(":hover")||l()}),n.one("remove destroy",function(){n.attr("aria-describedby")&&n.popover("destroy")}),this.loadPreviewPanel(i,e.data("field"),a,e.data("val")).then(function(){const e=function(){n&&!n.height()?l():setTimeout(e,500)};e()})},getEditElement:function(n,i,a,o,l,s,r){"use strict";i||(i={});let c,d,f,p=this,u=i.v||null;if(p.multiple&&"string"==typeof u)try{u=JSON.parse(u)}catch(e){u=[]}n&&n.data("input")?((c=(d=n).data("input")).data("is-rendered",!0),f=c.data("LISTs")):(d=t("<div>"),f={isListForLoad:!0,innerList:[],innerIndexed:[],isSliced:!0,isPreview:!1},p.list&&(f=p.list));let h=function(e){let n=t.Deferred(),i={};return Object.keys(a).forEach(function(e){/^\$/.test(e)||("id"===e?i[e]=a[e]:null!==a[e]&&"object"==typeof a[e]&&-1!==Object.keys(a[e]).indexOf("v")?i[e]=a[e].v:i[e]=a[e])}),d.isAttached()&&d.append('<i class="fa fa-cog fa-spin fa-3x loading" style="position: absolute; z-index: 1    right: 1px;    top: 1px;    font-size: 8px;"/>'),p.pcTable.model.getEditSelect(i,p.name,e,null).then(function(t){d.find(".loading").remove(),f.innerList=t.list?t.list:[],f.innerIndexed=t.indexed?t.indexed:{},f.isSliced=t.sliced,f.isPreview=t.previewdata,p.codeSelectIndividual||null!==e&&""!==e&&void 0!==e||f.isSliced||(p.list=f,f.isListForLoad=!1),n.resolve()},function(){n.reject()}),n.promise()};setTimeout(function(){d.length&&d.isAttached()&&d.find(".mark-loading").length&&d.find(".mark-loading").html('<i class="fa fa-spinner"/>')},200);let m=0;const b=function(){a[p.name]&&a[p.name].replaceViewValue&&f.innerIndexed[a[p.name].v]&&(a[p.name].replaceViewValue(f.innerIndexed[a[p.name].v]),delete a[p.name].replaceViewValue);let t=d.closest("body");if(t&&t.length){let i=t.get(0).ownerDocument==document?e.$:e.top.$;const m=function(e,t){let n={"Выбранное":i('<optgroup label="Выбранное">'),"":i('<optgroup label="">')},o=n["Выбранное"];const l=function(e,t,n,o){o=o?i('<small class="text-muted">').text(o):"";let l=i("<option>").text(e),s=i("<div>").text(null===t||""===t?"["+e+"]":t);if(o&&s.append(o),s=s.html(),n)l.attr("data-content",'<span class="text" style="text-decoration: line-through">'+s+"</span>");else{let t=i('<span class="text" >'+s+"</span>");f.isPreview&&(t.addClass("select-with-preview"),t.attr("data-id",a.id),t.attr("data-field",p.name),t.attr("data-val",e)),l.data("content",t.get(0).outerHTML)}return l};let s=function(){return!0};if(t&&""!==t){let e=t.toLowerCase().replace("ё","е").split(" ");s=function(t){let n=null!==t?t.toString().toLowerCase().replace("ё","е"):"";return!e.some(function(e){return-1===n.indexOf(e)})}}let r,d={};if(e||"filter"===p.category){const t=function(e){null===e&&(e="");let t,n=f.innerIndexed[e];return t=n?l(e,n[0],!1,n[1]):l(e,e,!0,null),o.append(t),d[e]=1,!!n&&(s(n[0])||t.addClass("hidden"),!0)};p.multiple?Array.isArray(e)?(e.forEach(t),r=Object.keys(d)):void 0!==e&&(t(e),r=[e]):(t(e),r=e)}if("onlyVals"!==t){p.multiple||p.withEmptyVal&&""!==p.withEmptyVal.trim()&&"filter"!==p.category&&n[""].append(i("<option>").data("content",p.withEmptyVal).text(""));for(let e in f.innerList){let t=f.innerList[e];if(1===d[t])continue;let a=f.innerIndexed[t];if(!f.isSliced&&!s(a[0]))continue;let o=l(t,a[0]),r=a[1]?a[1]:"";n[r]||(n[r]=i('<optgroup label="'+r+'">')),n[r].append(o)}}if(c.empty(),Object.keys(n).forEach(function(e){c.append(n[e])}),!0===f.isSliced){let e=l(0,"Данные не полны. Воспользуйтесь поиском!");e.prop("disabled",!0),e.css("text-align","center"),c.append(e)}return c.selectpicker("refresh"),c.selectpicker("val",r),r};if(!n||!n.data("input")){const e=function(){let e="-----";return"filter"===p.category?(e="Пустое",p.selectFilterWithEmptyText&&(e=p.selectFilterWithEmptyText)):p.withEmptyVal&&""!==p.withEmptyVal.trim()&&(e=p.withEmptyVal),e};c=i('<select class="form-control" '+(1==p.multiple?"multiple ":"")+' data-size="auto" style="display: none;" name="cell_insert" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-title="'+e()+'">').width(p.width),d.append(c),d.append('<div class="text-center mark-loading"></div>'),r&&c.attr("tabindex",r),c.data("AppUin",App.getUn()),d.data("input",c),c.data("LISTs",f)}d.find(".mark-loading").remove();let b=0===c.closest(".modal-body").length?p.pcTable._container:c.closest(".modal-body");if(c.data("container",b),m(u),!c.data("is-rendered")){let e;c.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",function(e){e.stopPropagation()});let t="";c.data("selectpicker").$searchbox.on("keyup",function(n){if("Escape"===n.key)return c.data("selectpicker").$button.click(),!0;let a=i(this).val();t!==a&&(t=a,e&&clearTimeout(e),e=setTimeout(function(){f.isListForLoad||f.isSliced?h.call(p,a).then(function(){m.call(p,u,a)}):m.call(p,u,a)},750))});let n=i(p).closest("td, .cell");if(0===c.closest(".InsertRow, .InsertPanel").length){let e=c.data("container");c.on("remove",function(){e.off("click.selectContainer."+c.data("AppUin")),e.off("keydown.selectContainer."+c.data("AppUin"))}),e.on("click.selectContainer."+c.data("AppUin"),function(e){let t=i(e.target);t.closest("td").is(".editing")||t.closest(".bootstrap-select").length||s(d,e)}),e.on("keydown.selectContainer."+c.data("AppUin"),function(e){if(27===e.keyCode)return c.data("keyPressed","Esc"),l(d,e),!1;if(13===e.keyCode&&c.data("enterPressed",!0),9!==e.keyCode&&16!==e.keyCode&&n.data("edited"),e.altKey||e.shiftKey){let t=e.altKey?"altKey":!!e.shiftKey&&"shiftKey";c.data("keyPressed",t)}}).on("keyup",function(e){c.removeData("keyPressed"),c.removeData("enterPressed")}),p.focusElement(d)}c.on("hidden.bs.select",function(){let e=c.data("changed"),t={},n=c.data("keyPressed");n&&(t[n]=!0),p.multiple?e&&0===c.closest("td.edt").length&&o(d,t):setTimeout(function(){o(d,t)},200),c.data("changed",!1)}),c.on("show.bs.select",function(){m(u)}),c.on("shown.bs.select",function(){let e=c.data("selectpicker");e.$bsContainer.addClass("pcTable-selectpicker"),f.isPreview&&e.$bsContainer.addClass("select-with-preview"),e.$menuInner.height()<100&&e.$menuInner.find("li").length>6&&e.$menuInner.height(300),e.cropped||(e.cropped=!0,c.data("container").is(".pcTable-container")&&e.$menuInner.height(e.$menuInner.height()-4))}),c.on("changed.bs.select",function(){c.data("changed",!0);let e=[];if(u&&u.forEach&&u.forEach(function(t){e.push(t)}),u=c.val(),"filter"===p.category&&p.multiple){let t=u.length;if(e.length>u.length)0===u.length&&u.push("*NONE*");else{let t;u.some(function(n){if(-1===e.indexOf(n))return t=n,!0}),-1!==["*NONE*","*ALL*"].indexOf(t)?u=[t]:["*NONE*","*ALL*"].some(function(e){let t;if(-1!==(t=u.indexOf(e)))return u.splice(t,1),!0})}u.length!==t&&c.selectpicker("val",u)}}),c.on("remove",function(){c.data("selectpicker").$bsContainer.remove(),c.data("container").off("keydown.selectContainer."+c.data("AppUin")).off("click.selectContainer."+c.data("AppUin"))})}}else m<50&&(setTimeout(function(){b(c,u)},10*m+1),m++)};return!f||f.isListForLoad?h().then(function(){b.call(p)}):b(),d},getPanelText:function(e,n,i){let a=this,o=t("<div>"),l=i[a.name].v_;if(!a.multiple&&i[a.name].v_&&(l=[i[a.name].v_]),l)t.each(l,function(e,n){"use strict";let i=t("<div>").text(n[0]);n[1]?i.addClass("deleted_value"):1!==l.length&&i.add("select-item"),o.append(i)});else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let n=e;if(a.multiple||(n=[n]),n||(n=[]),a.list){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t].toString();for(let n=0;n<a.list.length;n++){let i=a.list[n];if(-1!==e.indexOf(i[2].toString())){let n=t("<span>").text(i[0]);i[1]?n.addClass("deleted_value"):1!==e.length&&n.add("select-item"),o.append(n)}}}}return o.children()},getCellText:function(e,n,i){let a=this,o=t("<div>"),l=i[a.name].v_;if(!a.multiple&&i[a.name].v_&&(l=[i[a.name].v_]),l)a.multiple&&l.length>1&&0==a.multySelectView?o.append('<span class="select-item">'+l.length+" элементов<span>"):0===l.length?o.append('<span class="select-item">'+this.getElementString(null)+"</span>"):t.each(l,function(n,i){"use strict";let s=t("<span>"),r=null;e&&(r="object"==typeof e?e[n]:e),s.text(a.getElementString(r,i)),i[1]?s.addClass("deleted_value"):1!==l.length&&s.add("select-item"),o.append(s)});else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let n=e;if(a.multiple||(n=[n]),n||(n=[]),a.list){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t].toString();for(let n=0;n<a.list.length;n++){let i=a.list[n];if(-1!==e.indexOf(i[2].toString())){let n=t("<span>").text(a.getElementString(i[2],i));i[1]?n.addClass("deleted_value"):1!==e.length&&n.add("select-item"),o.append(n)}}}}return o.children()},focusElement:function(e){let t=e.find("button"),n=this;0==t.length?setTimeout(function(){n.focusElement(e)},50):t.focus()},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))},checkIsFiltered:function(e,t){let n,i;return this.multiple?(n=[],e&&e.v_&&e.v_.length&&e.v_.forEach(function(e){n.push(e[0].hashCode().toString())}),i=function(e){if(-1!==n.indexOf(e))return!0}):(n=(n=null===e.v_[0]?"null":e.v_[0].toString()).hashCode().toString(),i=function(e){if(e===n)return!0}),t.some(i)},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{return this.multiple&&Array.isArray(e)?e.some(t=>new RegExp(this.warningEditRegExp).test(e)):new RegExp(this.warningEditRegExp).test(e)}catch(e){return!0}},addDataToFilter:function(e,t){const n=function(t){let n,i=t[0];null===i?n="null".hashCode():(n=i.toString().hashCode(),i=i.replace(/"/g,"&quot;")),e[n]=i};this.multiple?t&&t.v_.length&&t.v_.forEach(function(e){n(e)}):n(t.v_)},getElementString:function(e,t){"use strict";return null!==e&&void 0!==e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":t[0]:this.withEmptyVal||""}},s.tree={icon:"fa-tree",FullView:!1,getEditVal:function(e){return e.data("val")},getEditElement:function(e,n,i,a,o,l,s,r){let c,d,f=this,p=e||t("<div>"),u=p.data("dialog")||t("<div>").css("min-height",200);p.data("dialog",u),n=n.v||"";let h=function(e){f.treePanel.call(f,u,i,n,a,o)};const m=function(e,t,n){let i=[];u.data("jstree").jstree("get_selected",!0).forEach(function(e){i.push(e.id)}),f.multiple||(i=i[0]||""),p.data("val",i),n||(a(p,{}),e.close())};c=[];let b={label:"Сохранить",cssClass:"btn-m btn-warning",action:m},g={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){o(p,{}),e.close()}},_="<b>"+this.title+"</b>",v="ctrlS.commentdialog";const w=function(e){f.pcTable.isMobile||(e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:.8*t("body").width()>800?800:.8*t("body").width()})),0===e.$modalBody.find("textarea").length&&h(),t("body").on(v,function(t){m(e,0,!1)})};if(r){let e=!1;setTimeout(function(){let n=p.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){d=t(this);let n={};n.label=d.data("name"),n.cssClass=d.attr("class").replace("btn-sm","btn-m"),n.icon=d.find("i").attr("class"),n.save=d.data("save"),n.click=d.data("click"),n.action=function(t){n.save&&m(t,0,!0),n.click({}),e=!0,t.close()},c.push(n)}),n.popover("destroy")):(c.push(b),c.push(g)),f.pcTable.isMobile?App.mobilePanel(_,u,{buttons:c,onhide:function(n){t("body").off(v),e||l(p,{})},onshow:w}):BootstrapDialog.show({message:u,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(n){t("body").off(v),e||l(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:w})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{let e=!1;p.off().on("focus click","button",function(){if(e)return!1;e=!0;let n=c.slice(0);n.push(b),n.push(g);var i=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(_,u,{buttons:n,onhide:function(n){e=!1,t("body").off(v),o(i,n)},onshow:w}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:_,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:n,onhide:function(n){e=!1,t("body").off(v),o(i,n)},onshow:w})}),0===p.find("button").length&&(d=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактирование в форме"),s&&d.attr("tabindex",s),p.append(d))}return p.data("val",n)},treePanel:function(e,n,i,a,o,l){let s=this,r=["themes","json_data","search"];s.multiple&&r.push("checkbox");let c=t('<div class="tree-search"><input class="form-control" type="text"></div>'),d=c.find("input");setTimeout(function(){d.focus()},200);let f=t("<div></div>"),p=0,u=!1,h="";d.keyup(function(){u&&clearTimeout(u),u=setTimeout(function(){if(f.closest("body").length){let e=d.val();h!==e&&(h=e,f.jstree(!0).search(e,0===p))}},750)}),e.append(c).append(f),e.data("jstree",f),!this.multiple&&this.withEmptyVal&&f.on("click",'li.jstree-node[aria-selected="true"]',function(e){return f.jstree(!0).deselect_node(t(this)),!1}),f.on("init.jstree",function(e,t){t.instance.settings.checkbox.cascade=""}).jstree({search:{show_only_matches:!0,case_insensitive:!0,show_only_matches_children:!0,search_callback:function(e,t){if(!t)return!1;let n=e.toLowerCase().replace("ё","е").split(" "),i=t.text.toLowerCase().replace("ё","е");return!n.some(function(e){return-1===i.indexOf(e)})},ajax:function(e,t){var i=this;s.getEditSelect(n,e,null).then(function(e){t.call(i,e[0])})}},massload:function(e,t){var i=this;p-=1,s.getEditSelect(n,"",e).then(function(e){Object.values(e[0]).forEach(function(e){e.forEach(function(e){!0===e.children&&(p+=1)})}),t.call(i,e[0])})},core:{check_callback:!0,open_parents:!0,data:function(e,t){var i=this;p-=1,s.getEditSelect(n,"","#"==e.id?null:e.id).then(function(e){e[0].forEach(function(e){!0===e.children&&(p+=1)}),t.call(i,e[0])})},themes:{icons:!1,name:"default"}},checkbox:{},plugins:r}),s.multiple&&"filter"===s.category&&f.on("select_node.jstree",function(e,t){-1!==["*ALL*","*NONE*"].indexOf(t.node.id)?t.selected.length>1&&t.selected.forEach(function(e){e!==t.node.id&&t.instance.deselect_node(f.jstree(!0).get_node(e))}):["*ALL*","*NONE*"].forEach(function(e){-1!==t.selected.indexOf(e)&&t.instance.deselect_node(f.jstree(!0).get_node(e))})})},getEditSelect:function(e,n,i){let a=this,o=t.Deferred(),l={};return Object.keys(e).forEach(function(t){/^\$/.test(t)||("id"===t||null===e[t]||"object"!=typeof e[t]||-1===Object.keys(e[t]).indexOf("v")?l[t]=e[t]:l[t]=e[t].v)}),this.pcTable.model.getEditSelect(l,this.name,n,i,!0).then(function(e){let t=[e.list,e.indexed];a.codeSelectIndividual||(a.list=t),o.resolve(t)}),o},getPanelText:function(e,t,n){this.FullView=!0;let i=this.getCellText(e,t,n);return delete this.FullView,i},getCellText:function(e,n,i){let a=this,o=i[a.name].v_;if(e){if(a.multiple){if(Array.isArray(e)){if(0===e.length)return a.getElementSpan(null);if(1===e.length)return a.getElementSpan(e[0],o[0]);if("0"!==a.multySelectView||a.FullView){let n=t('<span class="select-item">');return e.forEach((e,t)=>n.append(a.getElementSpan(e,o[t]))),n}return t('<span class="select-item">'+e.length+" эл.<span>")}return a.getElementSpan(e,[e,0])}return a.getElementSpan(e,o)}return a.getElementString(null)},checkIsFiltered:function(e,t){let n,i;return this.multiple?(n=[],e&&e.v_&&e.v_.length&&e.v_.forEach(function(e){n.push(e[0].hashCode().toString())}),i=function(e){if(-1!==n.indexOf(e))return!0}):(n=(n=null===e.v_[0]?"null":e.v_[0].toString()).hashCode().toString(),i=function(e){if(e===n)return!0}),t.some(i)},addDataToFilter:function(e,t){const n=function(t){let n;n=null===t[0]?"null".hashCode():t[0].toString().hashCode(),e[n]=t[0].replace(/"/g,"&quot;")};this.multiple?t&&t.v_.length&&t.v_.forEach(function(e){n(e)}):n(t.v_)},getElementSpan:function(e,n){let i=t("<span>");return null!==e&&(i.text(this.getElementString(e,n)),1===n[1]&&i.addClass("deleted_value")),i},getElementString:function(e,t){"use strict";return null!==e&&void 0!==e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":this.FullView&&t[2]||t[0]:this.withEmptyVal||""}},s.json={__addInput:function(e,n,i){var a=(n=n||{}).type||typeof i[e],o=12;"checkbox"==a&&(o=3),n.width&&(o=n.width);var l,s=t('<div class="field form-group">').attr("data-name",e).addClass("col-sm-"+o);switch(a){case"string":l=t("<input>").val(i[e]?i[e]:n.default?n.default:"");break;case"json":l=t('<div class="JSONEditor">').height(300);var r=new JSONEditor(l.get(0),{}),c=t('<a href="#">editText</a>').on("click",function(){var e=t("<div>"),n=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(r.get(),null,2)).appendTo(e);return e.dialog({title:"Содержимое JSON-поля",width:500,height:600,buttons:{"Сохранить":function(){r.setText(n.val()),e.dialog("close")},"Закрыть":function(){e.dialog("close")}}}),!1});l.find(".jsoneditor-menu").append(c),l.data("editor",r),r.set(i[e]?i[e]:n.default?JSON.parse(n.default):{});break;case"html":l=t('<div class="HTMLEditor">').height(300);var d=t("<div>").appendTo(l);r=CodeMirror(d.get(0),{value:i[e]?i[e]:n.default?n.default:"",mode:"text/html",height:"250px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!0,indentWithTabs:!0,autoCloseTags:!0});setTimeout(function(){r.refresh()},20),l.data("editor",r);break;case"integer":l=t("<input>").val(i[e]?i[e]:n.default?n.default:"").attr("type","number"),void 0!==n.min&&l.attr("min",n.min),void 0!==n.max&&l.attr("max",n.max),void 0!==n.step&&l.attr("step",n.step);break;case"checkbox":l=t("<input>").attr("type","checkbox"),i[e]?l.prop("checked",!0):void 0===i[e]&&l.prop("checked",!0);break;case"select":l=t("<select>"),n.values&&t.each(n.values,function(e,n){l.append(t("<option>").attr("value",e).text(n))}),i[e]?l.val(i[e]):void 0===i[e]&&n.default&&l.val(n.default)}"checkbox"==a?(s.prepend(t("<label>").text(n.title?n.title:e).addClass("form-check-label")),l&&(l.data("type",a),s.find("label").prepend(l))):(s.prepend(t("<label>").text(n.title?n.title:e)),l&&l.data("type",a).addClass("form-control"),s.append(l)),s.data("type",a);var f=t(" <span>*</span>");return n.required?f.addClass("text-danger"):(f.text(""),f.addClass("glyphicon glyphicon-remove remove"),f.on("click",function(){var e=t(this).closest(".field");e.data("name");e.remove()})),s.find("label").after(f),s},getEditElement:function(e,n,i,a,o,l){var s,r=this,c=t("<div>"),d=t("<div>").css("min-height",200),f=t('<div class="jsonForm row">').appendTo(d);c.data("form",f),c.data("field",this);var p=this.jsonFields,u=n||{};"string"==typeof u&&(u=JSON.parse(u));var h=function(e){var t=r.__addInput(e,p[e],u);f.append(t)},m=t.extend({},u),b=0,g={"":[]};if(t.each(p,function(e,t){if(1==t.required||1==t.showInForm)h(e),void 0!==m[e]&&delete m[e];else if(void 0===m[e]){var n="";t.fGroup&&(n=t.fGroup,g[t.fGroup]||(g[t.fGroup]=[])),g[n].push(e),b++}}),t.each(m,function(e,t){h(e)}),b){var _=t('<div class="row elseFields">');element=t('<select class="selectpicker form-control dropup" data-size="5" data-title="--Выбрать поле--">'),1==App.keys(g).length?t.each(g[App.keys(g)[0]],function(e,n){element.append(t("<option>").attr("value",n).text(p[n].title?p[n].title:n))}):t.each(g,function(e,n){e=t('<optgroup label="'+e+'">');t.each(n,function(n,i){e.append(t("<option>").attr("value",i).text(p[i].title?p[i].title:i))}),element.append(e)}),_.prepend(t("<label>").text("Добавить поле")),element.addClass("form-control"),_.append(element),element.selectpicker("render"),element.on("change",function(){var e=t(this).val();element.find('option[value="'+e+'"]').remove(),h(e)}),d.append(_.wrap('<div style="padding:10px">').parent())}return s={"Сохранить":function(){var e={},n=f.find(".fullJSONEditor");1==n.length?e=n.data("editor").get():f.find("input, select, textarea, .JSONEditor, .HTMLEditor").not(".JSONEditor *").not(".HTMLEditor *").each(function(){var n=t(this),i=n.closest(".field").data("name");switch(n.closest(".field").data("type")){case"array":try{if(e[i]=n.data("editor").get(),!t.isArray(e[i]))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+i),"Ошибка структуры поля"}break;case"object":case"json":try{if(e[i]=n.data("editor").get(),"object"!=typeof e[i])throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+i),"Ошибка структуры поля"}break;case"html":e[i]=n.data("editor").getValue();break;case"checkbox":case"boolean":e[i]=!!n.is(":checked");break;case"integer":e[i]=parseInt(n.val());break;default:e[i]=n.val()}}),c.data("val",JSON.stringify(e)),a(c,event),d.remove()},"Закрыть":function(){d.dialog("close")},"Редактор":function(){var e=f.height(),n=t('<div class="fullJSONEditor">').height(e+100),i=new JSONEditor(n.get(0),{});i.set(u);var a=t('<a href="#">editText</a>').on("click",function(){var n=t("<div>"),a=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n);return n.dialog({title:"Содержимое JSON-поля",width:500,height:e+100,buttons:{"Сохранить":function(){i.setText(a.val()),n.dialog("close")},"Закрыть":function(){n.dialog("close")}}}),!1});f.empty().append(n),f.next().empty(),n.data("editor",i),n.find(".jsoneditor-menu").append(a)}},i.id?(d.dialog({title:(i&&i.id?i.id:"")+" "+this.title,width:700,modal:!0,close:function(e){o(c,e),d.remove()},buttons:s}),c.text("Редактирование в форме").addClass("edit-in-form")):(c.on("focus click","button",function(){var e=t(this).closest("div");d.dialog({title:r.title||r.name,width:700,modal:!0,close:function(t){o(e,t),d.remove()},buttons:s})}),c.append(t('<button class="btn btn-default">').text(n||"Редактирование"))),c.data("val",n)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return JSON.stringify(e)},focusElement:function(e){var t=e.find("button"),n=this;0===t.length?setTimeout(function(){n.focusElement(e)},50):t.focus()}},s.fieldParams=t.extend({},s.json,{icon:"fa-code",isPanelField:!0,isDataModified:function(e,t){return!Object.equals(t,e)},getEditElement:function(n,i,a,o,l,s,r,c){let d,f=this,p=t("<div>"),u=t("<div>").css("min-height",200),h=t('<div class="jsonForm">').appendTo(u);p.data("form",h),p.data("field",this);let m=function(e){let n=f.jsonFields;f.getValue(e,a,!c).then(function(e){let i=e.value;"string"==typeof i&&(i=JSON.parse(i));let o=t.extend({},i),l=function(e,t,i){let l=n.fieldSettings[e];if(!l)return!1;if(l.categories&&-1===l.categories.indexOf(a.category.v))return!1;let s={};if(void 0===o[e]||void 0===o[e].isOn?(s.isOn=void 0!==o[e],s.Val=o[e],void 0===s.Val&&(s.Val=l.default),l.parent||"checkbox"!==l.type||!0!==s.Val||(s.isOn=!0),o[e]=s):s=o[e],"codeSelect"===e){let e="=: selectRowListForTree(table: ''; field: ''; order: '' asc; where:  '' = ; parent: ''; disabled:)";"tree"===h.find('div[data-name="type"] select').val()?s.Val===l.default&&(s.Val=e):s.Val===e&&(s.Val=l.default)}let r=!1,c=(n.fieldSettings[l.parent],o[l.parent]);l.parent&&-1!==t.indexOf(l.parent)&&(c&&!0===c.isOnCheck||(r=!0)),s.changed=function(){"use strict";!0===this.isOnCheck?h.find('[data-parent="'+e.toLowerCase()+'"]').show():h.find('[data-parent="'+e.toLowerCase()+'"]').hide().find('input[type="checkbox"]').prop("checked",!1).trigger("change")};let d=f.__addInput.call(f,e,l,s,a);h.append(d),l.parent&&(d.attr("data-parent",l.parent.toLowerCase()),r&&d.hide());let p=i[e]();return d.css("padding-left",19*p),d},s="string";o.type&&(s=o.type.Val||o.type);let r=function(){u.find(".codeEditor, .HTMLEditor").each(function(){t(this).data("editor")&&t(this).data("editor").refresh()})};!function e(i){let s;h.empty(),"2"===a.table_id.v&&("data_src"===a.name.v||"data"===a.name.v)||a.table_name&&"tables_vidgets"===a.table_name.v&&("data_src"===a.name.v||"data"===a.name.v)?(s="data"===a.name.v?["width","showInWeb"]:["width","jsonFields","showInWeb","editable","insertable","required","logging","default","copyOnDuplicate"],i="fieldParams"):s=n.fieldListParams[i];let c={type:function(){return 0}};s.forEach(function(e){let t=n.fieldSettings[e];t.parent&&-1!==s.indexOf(t.parent)?c[e]=function(){return c[t.parent]()+1}:c[e]=function(){return 0}}),o.type={isOn:!0,Val:i},l("type",s,c).find("select").on("change",function(){e(t(this).val())}),s.forEach(function(e){l(e,s,c)}),r()}(s)})};const b=function(e){var n={},i=h.find(".fullJSONEditor");1===i.length?n=i.data("editor").get():h.find("input, select, textarea, .JSONEditor, .HTMLEditor, .codeEditor").not(".JSONEditor *").not(".HTMLEditor *").not(".codeEditor *").not('input[data-type="switcher"]').each(function(){var e=t(this);let i,a=e.closest(".field");var o=a.data("name");switch(e.closest(".field").data("type")){case"code":i=e.data("editor").getValue();break;case"json":try{if("object"!=typeof(i=e.data("editor").get()))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+o),"Ошибка структуры поля"}break;case"html":i=e.data("editor").getValue();break;case"checkbox":i=!!e.is(":checked");break;case"integer":i=parseInt(e.val());break;default:i=e.val()}let l;isOnCheckbox=a.find('input[data-type="switcher"]'),l=0===isOnCheckbox.length?e.is(":visible"):isOnCheckbox.is(":checked"),n[o]={isOn:l,Val:i}}),p.data("val",n),o(p,event),e.close()};d=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:b},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];let g="ctrlS.FieldParams";if(c)e.top.BootstrapDialog.show({message:u,type:BootstrapDialog.TYPE_DANGER,title:"Параметры поля <b>"+a.title.v+"</b>",buttons:d,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){l(p,e),t("body").off(g)},onshown:function(e){m(i.v),e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalDialog.width(1e3),t("body").on(g,function(t){b(e)})}}),p.text("Редактирование в форме").addClass("edit-in-form");else{let n=!1;p.on("focus click","button",function(){if(!n){n=!0;var o=t(this).closest("div");e.top.BootstrapDialog.show({message:u,type:BootstrapDialog.TYPE_DANGER,cssClass:"fieldparams-edit-panel",title:"Параметры поля <b>"+a.title.v+"</b>",buttons:d,draggable:!0,size:BootstrapDialog.SIZE_WIDE,onhide:function(e){l(o,e),t("body").off(g),n=!1},onshown:function(e){e.$modalDialog.width(1e3),e.$modalHeader.css("cursor","pointer"),m(i.v),t("body").on(g,function(t){b(e)})}})}});let o=t('<button class="btn btn-danger btn-sm text-edit-button">').text("Редактировать параметры");r&&o.attr("tabindex",r),p.append(o)}return p.data("val",i)},__addInput:function(n,i,a,o){var l=(i=i||{}).type;let r,c;r=a.Val,c=a.isOn;var d,f=t('<div class="field form-group">').attr("data-name",n);switch(l){case"code":d=t('<div class="codeEditor">');var p=t("<div>").appendTo(d);(u=CodeMirror(p.get(0),{value:r||(i.default?i.default:""),mode:"totum",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!1,indentWithTabs:!0})).getScrollerElement().style.minHeight="150px",d.data("editor",u),u.table=o.table_name&&o.table_name.v?o.table_name.v:null;break;case"string":d=t("<input>").val(void 0!==r?r:i.default?i.default:"");break;case"json":d=t('<div class="JSONEditor">').height(300);var u=new JSONEditor(d.get(0),{}),h=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){var n=t("<div>"),i=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(u.get(),null,2)).appendTo(n);return BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(e){try{u.setText(i.val()),e.close()}catch(e){App.modal("Ошибка формата JSON")}}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});d.find(".jsoneditor-menu").append(h),d.data("editor",u);let a="string"==typeof r?JSON.parse(r):r;u.set(a);break;case"html":d=t('<div class="HTMLEditor">');p=t("<div>").appendTo(d);(u=CodeMirror(p.get(0),{value:r||(i.default?i.default:""),mode:"text/html",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0})).getScrollerElement().style.minHeight="150px",d.data("editor",u);break;case"integer":d=t("<input>").val(void 0!==r?r:i.default?i.default:"").attr("type","number"),void 0!==i.min&&d.attr("min",i.min),void 0!==i.max&&d.attr("max",i.max),void 0!==i.step&&d.attr("step",i.step);break;case"checkbox":d=t("<input>").attr("type","checkbox").data("type",l),r&&d.prop("checked",!0);break;case"select":if(d=t("<select>"),i.values){let e,a=i.valIcons||{};i.valuesOrder&&(e=i.valuesOrder.slice(0)),"type"===n&&(o.table_name&&o.name&&"tables_fields"===o.table_name.v&&"data_src"===o.name.v&&(e=["fieldParams"]),t.each(e,function(e,t){s[t]&&(a[t]="fa "+s[t].icon)}));const l=function(e,n){let i=t("<option>").attr("value",e).text(n);a[e]&&i.data("icon",a[e]),d.append(i)};e?e.forEach(function(e){l(e,i.values[e])}):t.each(i.values,l)}i.multiple&&(d.attr("multiple","multiple"),d.attr("size","2")),setTimeout(function(){d.selectpicker()},20),r?d.val(r):void 0===r&&i.default&&d.val(i.default)}let m;return a.isOnCheck=!0,"checkbox"===l?(f.prepend(t('<label class="field-param-lable">').text(i.title?i.title:n).addClass("form-check-label").prepend(d).append('<a href="http://docs.totum.online/polya#fields-settings-'+n+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),f.addClass("checkbox"),m=d,d.is(":checked")||(a.isOnCheck=!1,f.addClass("disabled"))):(f.prepend(t('<label class="field-param-lable">').text(i.title?i.title:n).append('<a href="http://docs.totum.online/polya#fields-settings-'+n+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),d&&(d.data("type",l),d.data("editor")||d.addClass("form-control"),f.append(d)),!0!==i.required&&(m=t('<input type="checkbox" data-type="switcher"/>'),c?(a.isOnCheck=!0,m.prop("checked",!0)):(a.isOnCheck=!1,f.addClass("disabled")),f.find("label").prepend(m),f.addClass("checkbox"))),m&&m.on("change",function(){t(this).is(":checked")?!0!==a.isOnCheck&&(a.isOnCheck=!0,f.removeClass("disabled"),a.changed()):!1!==a.isOnCheck&&(a.isOnCheck=!1,f.addClass("disabled"),a.changed())}),f.data("type",l),f},getValue:function(e,n,i){"use strict";if(i){let n=t.Deferred();return n.resolve({value:e||{}}),n}let a={fieldName:this.name};return n.id&&(a.rowId=n.id),this.pcTable.model.getValue(a,this.table_id)},getPanelText:function(e){return JSON.stringify(e,null,2)},getCellText:function(e){return"Настройки поля"}}),s.button={icon:"fa-hand-pointer-o",getCellText:function(e,n,i){let a=this,o={};if("column"===this.category?i.id?o=t.extend({},a.pcTable.f||{},i.f||{},i[a.name].f||{}):o.block=!0:o=t.extend({},a.pcTable.f||{},i[a.name].f||{}),n&&n.addClass("cell-button"),o.block||!this.pcTable.control.editing&&!this.pressableOnOnlyRead){let e=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1" disabled>').text(this.buttonText||"Кнопочка");if(o.text&&e.text(o.text),o.comment){let n;n=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(n),n.attr("title",o.comment)}else o.icon&&e.prepend('<i class="cell-icon fa fa-'+o.icon+'"></i>');return e.wrap('<span class="cell-value">').parent()}let l=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1">').text(this.buttonText||"Кнопочка");if(o.text&&l.text(o.text),o.comment){let e;e=t('<i class="cell-icon fa fa-info"></i>'),l.prepend(e),e.attr("title",o.comment)}else o.icon&&l.prepend('<i class="cell-icon fa fa-'+o.icon+'"></i>');return l},btnOK:function(e){let t=e.find("button"),n=this;t.text("Выполнено"),e.data("clicked",!0),setTimeout(function(){e.removeData("clicked");let i=n.pcTable._getItemBytd.call(n.pcTable,e);t.replaceWith(n.getCellText.call(n,i[n.name],e,i))},2e3)}},s.link={icon:"fa-link"},s.comments={icon:"far fa-comments-o",getEditVal:function(e){return e.data("val")},getCellText:function(e){let n=this;if(0===e.n||!e.n)return"";let i=t("<span>"),a=t('<span class="comments">').text(e.c[0]+" "+e.c[1]+": "+e.c[2]).appendTo(i);return e.notViewed&&(a.addClass("notViewed"),n.decorationColor&&a.css("border-bottom-color",n.decorationColor)),i},getValue:function(e,n,i){"use strict";let a=this,o=t.Deferred();if(i)e||(e=[]),o.resolve({value:e});else if(0===e.n||1===e.n&&!e.cuted&&!e.notViewed)e||(e=[]),o.resolve({value:[e.c]});else{let e={fieldName:this.name};n.id&&(e.rowId=n.id),o=this.pcTable.model.getValue(e,this.table_id)}return o.then(function(e){if(n[a.name].v.notViewed||n[a.name].notViewed){let e=t.Deferred();e.then(function(){let e;delete n[a.name].v.notViewed,delete n[a.name].notViewed,n.id?e=a.pcTable._getTdByFieldName(a.name,a.pcTable.data[n.id].$tr):(e=a.pcTable._paramsBlock.find('td[data-field="'+a.name+'"]')).length||(e=a.pcTable._footersBlock.find('td[data-field="'+a.name+'"]')),e&&e.length&&(e.find(".notViewed-num").remove(),e.find(".notViewed").removeClass("notViewed"))}),n[a.name].notViewed?a.pcTable.model.setCommentsViewed(n[a.name].v.length,a.name,n.id).then(function(){e.resolve()}):e.resolve()}}),o},getPanelText:function(e,n,i){let a=this,o=t.Deferred(),l=i[a.name];return this.getValue(l,i,!1).then(function(e){let n=t('<div class="comments">');t.each(e.value,function(e,t){n.append(a.getCommentLine(t))}),o.resolve(n)}).fail(function(){o.reject()}),o.promise()},getCommentLine:function(e){let n=t('<div class="comments-line">');return n.append(t('<span class="com_dt">').text(e[0])),n.append(" "),n.append(t('<span class="com_author">').text(e[1])),n.append(" "),n.append(t('<span class="com_text">').html(App.textWithLinks(e[2]))),n},getPanelVal(e,t){if(t)return this.getEditVal(t)},getEditElement:function(e,n,i,a,o,l,s,r){let c,d,f=this,p=e||t("<div>"),u=p.data("dialog")||t("<div>").css("min-height",200);p.data("dialog",u),n=n.v||"";let h=function(e){f.getValue.call(f,n,i,!r).then(function(e){let n=t('<textarea type="text" style="height:90px;resize: vertical" class="form-control"/>');t.each(e.value,function(e,t){u.append(f.getCommentLine(t))}),u.append(t('<div class="comments-input">').append(n)),u.data("input",n),n.focus()})};const m=function(e,t,i){let o=u.find("textarea").val().trim();p.data("val",o),d&&(d.text(o),""!==o?d.css("color","red"):(d.html(f.getValPreview(n)),d.css("color",""))),i||(a(p,{}),e.close())};c=[];let b={label:"Сохранить",cssClass:"btn-m btn-warning",action:m},g={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){o(p,{}),e.close()}},_="Комментарии поля <b>"+this.title+"</b>",v="ctrlS.commentdialog";if(r){let e=!1;setTimeout(function(){let n=p.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&m(t,0,!0),i.click({}),e=!0,t.close()},c.push(i)}),n.popover("destroy")):(c.push(b),c.push(g)),f.pcTable.isMobile?App.mobilePanel(_,u,{buttons:c,onhide:function(n){t("body").off(v),e||l(p,{})},onshown:function(e){h()},onshow:function(e){t("body").on(v,function(t){m(e,0,!1)})}}):BootstrapDialog.show({message:u,type:null,title:_,cssClass:"fieldparams-edit-panel",draggable:!0,buttons:c,onhide:function(n){t("body").off(v),e||l(p,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),h()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(v,function(t){m(e,0,!1)})}})},1),p.text("Редактирование в форме").addClass("edit-in-form")}else{let e=!1;if(p.off().on("focus click","button",function(){if(e)return!1;e=!0;let n=c.slice(0);n.push(b),n.push(g);var i=t(this).closest("div");f.pcTable.isMobile?App.mobilePanel(_,u,{buttons:n,onhide:function(n){e=!1,t("body").off(v),o(i,n)},onshown:function(e){0===e.$modalBody.find("textarea").length&&h(),t("body").on(v,function(t){m(e,0,!1)})}}):BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:_,draggable:!0,size:BootstrapDialog.SIZE_WIDE,buttons:n,onhide:function(n){e=!1,t("body").off(v),o(i,n)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),0===e.$modalBody.find("textarea").length&&h(),e.$modalContent.css({width:900}),t("body").on(v,function(t){m(e,0,!1)})}})}),0===p.find("button").length){let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Добавить комментарий");s&&e.attr("tabindex",s),p.append(e),setTimeout(function(){0!==p.closest(".InsertPanel").length&&(d=t('<div class="val-preview"/>').html(n?f.getValPreview(n):""),p.data("val")&&d.text(p.data("val")),d.css("padding-bottom","5px"),p.prepend(d))},10)}}return p.data("val",null)},getValPreview(e){return this.getCellText({c:e[e.length-1],n:e.length})}},t.each(s,function(e,n){s[e]=t.extend({},r,n)}),App.pcTableMain=function(e,i){if(i=t.extend({},{tableRow:{},nSorted:!0,isCreatorView:!1,withCsvButtons:!1,withCsvEditButtons:!1,noDataRowClass:"pcTable-noDataRow",contanerClass:"pcTable-container",tableClass:"pcTable-table",width:null,checkIsUpdated:0,_containerId:"",scrollWrapper:null,tableWidth:0,control:{adding:!1,sorting:!1,deleting:!1,duplicating:!1},dataSorted:[],data:[],data_params:null,dataSortedVisible:[],mainFieldName:"id",insertRow:null,_container:null,_content:null,extraClastersBottom:null,extraClastersTop:null,dataSortedClasters:{t:[],m:[],b:[]},ScrollClasterized:null,_innerContainer:null,_header:null,_table:null,LogButton:null,model:null,fields:{},hidedFields:[],fieldCategories:{column:[],params:[],footer:[]},sorted:{field:"",direction:"asc"},_sorting:{},_filterable:!1,filtersClearButton:null,_indexes:{fieldByName:{}},beforeSpaceHide:!0},i),t.extend(this,i,!0),screen.width<=n&&(this.isCreatorView=!1,this.isMobile=!0),this.hidden_fields=this.hidden_fields||{},0===this.hidden_fields.length&&(this.hidden_fields={}),App.isTopWindow()&&(this.beforeSpaceHide=!1),e){this.refreshArraysFieldCategories(!0);let n=t(e);n.data("pctable",this),this._container=n,this._containerId=this._container.attr("id"),this._containerId||(this._containerId="pcTable"+l++,this._container.attr("id",this._containerId)),this._init(),this.render(i.addVars)}else this.initForPanel(i);return this.model.addPcTable(this),this};let c=0;e.EditPanel=function(n,i,a,o,l={}){if(e.top!==e)return e.top.EditPanel.call(e.top,n,i,a,l);let s=t.extend(!0,{},a),r=this;r.pcTable=n,r.panelId="panel"+c++;let d=t.Deferred();this.$panel=t('<div class="InsertPanel">'),this.isNewPanel=!0,this.blockedFields={},this.bootstrapPanel=null;let f,p=s.id?"checkEditRow":"checkInsertRow",u=s.id?"saveEditRow":"add";return this.panelType=s.id?"edit":"insert",this.editItem=s||{},t("body").trigger("pctable-opened",{type:"panel"}),r.resolved=!1,this.checkRow=function(){r.pcTable.model[p](this.getDataForPost(),Object.keys(l)).then(function(e){r.editRow.call(r,e)})},this.saveRow=function(n,i){r.pcTable.model[u](this.getDataForPost()).then(function(n){d.resolve(n),r.resolved=!0,t(e.top.document.body).trigger("pctable-closed",{type:"panel",json:n,method:r.panelType,tableId:r.pcTable.tableRow.id}),r.bootstrapPanel.close()}).fail(function(){if(i.length&&i.isAttached())n.$modal.find(".btn-save").prop("disabled",!1)})},this.editRow=function(e){"use strict";let n=!1;if(r.pcTable.f=e.f||{},r.editItem.f=e.row.f||{},r.pcTable.fieldCategories.column.forEach(function(i,a){if("n"===i.name)return;let o=r.$panel.find('div.cell[data-field-name="'+i.name+'"]'),s=r.editItem[i.name];r.editItem[i.name]=e.row[i.name],r.isEditable(i)&&(n=!0);let c=t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[i.name].f||{});if(o.length){o.parent().find(".btns:first");o.data("input")&&!c.block?(!s||i.isDataModified(r.editItem[i.name].v,s.v)||i.codeSelectIndividual||"insert"==r.panelType&&i.code&&!i.codeOnlyInAdd)&&r.createCell.call(r,o,i,a,c):r.createCell.call(r,o,i,a,c)}else{let e=t('<div class="cell-wrapper" style="position: relative">'),n=t("<label>").text(i.title||i.name).prependTo(e);i.unitType&&n.text(n.text()+", "+i.unitType),t('<div class="btns pull-right">').prependTo(e),r.$panel.append(e),o=r.createCell.call(r,o,i,a,c,e),r.pcTable.isMobile||e.width(390),setTimeout(()=>{let t=e.find(".btns").width();t>0&&(t+=3),n.css("max-width","calc(100% -  "+t+"px)")},2),i.linkToSelectTable&&e.append(' <a href="'+i.linkToSelectTable.link+'" class="color-primary-primary" style="font-size: 12px" target="_blank">'+i.linkToSelectTable.title+"</a> ")}if(c.hideinpanel?o.parent().css("display","none"):o.parent().css("display",""),o.attr("data-field-name",i.name),o.attr("data-field-type",i.type),"edit"===r.panelType){if(i.code&&!i.codeOnlyInAdd){let e=o.parent().find(".btns button.handled");e.length||(e=t('<button class="btn btn-sm btn-default handled" tabindex="'+(2*a+2)+'"></button>'),o.parent().find(".btns").prepend(e),r.isEditable(i)?(e.on("click",function(){!0===r.editItem[i.name].h?r.editItem[i.name].h=!1:r.editItem[i.name].h=!0,r.checkRow()}),e.prop("disabled",!1)):(e.prop("disabled","disabled"),r.editItem[i.name].h||e.remove())),e.removeClass("btn-warning").addClass("btn-default"),e.html('<i class="fa fa-hand-grab-o"/>'),r.editItem[i.name].h&&(e.addClass("btn-warning").removeClass("btn-default"),-1!==Object.keys(r.editItem[i.name]).indexOf("c")&&r.editItem[i.name].c!==r.editItem[i.name].v&&e.html('<i class="fa fa-hand-paper-o"/>'))}}else if(i.code&&!i.codeOnlyInAdd){let e=o.parent().find(".btns"),n=e.find(".handled");l[i.name]&&r.editItem[i.name].h?0===n.length&&(n=t('<button class="btn btn-sm btn-warning handled" tabindex="'+(2*a+2)+'"><i class="fa fa-hand-paper-o pull-right"></button>').on("click",()=>{delete l[i.name],r.checkRow()}),e.prepend(n)):1===n.length&&n.remove()}},r),r.isNewPanel){let t="";if("edit"===this.panelType){let i;if(r.pcTable.tableRow.main_field&&r.pcTable.fields[r.pcTable.tableRow.main_field]){let t=r.pcTable.tableRow.main_field;(i=r.editItem[t]||e.row[t])&&(i=i.v),i=' "'+i+'"'}i=i?"id "+(r.editItem.id||e.row.id)+" "+i:"id "+(r.editItem.id||e.row.id),t=!r.pcTable.control.editing||e.row.f.block&&!n?"Просмотр <b> "+i+"</b> таблицы <b>"+r.pcTable.tableRow.title+"</b>":"Редактирование <b> "+i+"</b> таблицы <b>"+r.pcTable.tableRow.title+"</b>"}else t="Добавление строки в таблицу <b>"+r.pcTable.tableRow.title+"</b>";r.cleateBootstrapPanel.call(r,t,i,"insert"===r.type||n),r.isNewPanel=!1}},this.cleateBootstrapPanel=function(n,i,a){let l=this,s=[];a&&s.push({action:function(e,t){"use strict";let n=e.$modal.find(".btn-save").prop("disabled","disabled");setTimeout(function(){r.pcTable.model.doAfterProcesses(function(){l.saveRow.call(l,e,n)})},250)},cssClass:"btn-warning btn-save",label:"Cохранить"}),o&&s.push({action:function(e){e.close()},label:"Закрыть"}),s.push({action:function(e){d.resolve(void 0,!0),r.resolved=!0,e.close()},label:"Закрыть"+(!0===o?" →":"")}),l.bootstrapPanel=BootstrapDialog.show({type:i||null,size:BootstrapDialog.SIZE_WIDE,message:l.$panel,cssClass:"edit-row-panel",title:n,buttons:s,draggable:!0,onhidden:function(){d.resolve(),r.resolved||t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),t(e.top.document.body).off("."+r.panelId)},onshown:function(e){"use strict";e.indexedButtons[Object.keys(e.indexedButtons)[0]].attr("tabindex",500),2===Object.keys(e.indexedButtons).length&&e.indexedButtons[Object.keys(e.indexedButtons)[1]].attr("tabindex",501)}})},this.createCell=function(i,a,o,s,c){let d=r.editItem||{};d[a.name]=d[a.name]||{},0===i.length?(i=t("<div data-name='"+a.name+"' class='cell'>").appendTo(c),a.code&&i.addClass("with-code")):c=i.parent();let f=c.find(".btns");if(f.find(".select-btns").remove(),!this.isEditable(a)){r.blockedFields[a.name]=!0;let e=t('<span class="'+("button"!==a.type?"form-control no-borders":"link")+'">');if("button"!==a.type&&s.text?e.text(s.text):e.append(a.getCellTextInPanel.call(a,r.editItem[a.name].v,i,r.editItem,r.pcTable)),"button"!==a.type)if(s.comment){let n;n=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(n),n.attr("title",s.comment)}else s.icon&&e.prepend('<i class="cell-icon fa fa-'+s.icon+'"></i>');return a.unitType&&e.append(" "+a.unitType),"button"===a.type&&r.pcTable&&i.on("click",function(){r.pcTable._buttonClick.call(r.pcTable,i,a,d)}),i.html(e).prepend(f).data("input",null),i}r.blockedFields[a.name]=!1;let p=function(e){let t;try{t=a.getEditVal(e)}catch(t){return App.popNotify(t,e,"default"),null}return t},u=!1,h=i.find("input,button").is(":focus"),m=function(e,t,s){u=!0;let c=p(e);null===c?r.FocusIt.call(r,o):(s||r.FocusIt.call(r,o+1),a.isDataModified(c,r.editItem[a.name].v)&&(r.editItem[a.name].v=c,a.code&&!a.codeOnlyInAdd&&(r.editItem[a.name].h=!0),a.code&&"insert"===r.panelType&&(l[a.name]=!0),2===n&&"table_id"==a.name&&delete l.version,!0===a.isPanelField&&r.createCell.call(r,i,a,50+o),r.checkRow())),u=!1},b=function(e,t){return setTimeout(function(){e&&e.length&&e.isAttached()&&(u?u=!1:m(e,0,!0))},40),!1},g=function(e,t){u=!0;let n=p(e);a.isDataModified(n,r.editItem[a.name].v)&&r.checkRow()},_=a.getEditElement(i.data("input"),r.editItem[a.name],r.editItem,m,g,b,50+o);if(_.isAttached()||i.html(_),i.data("input",_),h&&a.focusElement(_),"select"===a.type&&a.changeSelectTable){let n=function(){let n={};t.each(r.editItem,function(e,t){"$"!==e.substring(0,1)&&(n[e]=t)});let o=t(this).is(".source-add");o&&(n[a.name]=null);let l=0;t(e.top.document.body).on("pctable-opened.select-"+r.panelId,function(){l++}).on("pctable-closed.select-"+r.panelId,function(e,n){l--;let s=n&&"insert"===n.method&&n.json&&n.json.chdata&&n.json.chdata.rows;setTimeout(function(){if(0===l||s){let e=_;delete a.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),s&&(a.multiple?r.editItem[a.name].v.push(Object.keys(n.json.chdata.rows)[0]):r.editItem[a.name].v=Object.keys(n.json.chdata.rows)[0]),e.replaceWith(_=a.getEditElement(null,r.editItem[a.name],r.editItem,m,g,b)),i.data("input",_),r.checkRow(),!o&&r.pcTable.isMain&&r.pcTable.model.refresh(function(e){r.pcTable.table_modify.call(r.pcTable,e)}),t("body").off(".select-"+r.panelId)}},100)}),r.pcTable.model.selectSourceTableAction(a.name,n)},o=t('<span class="select-btns">').appendTo(f),l=t('<button class="btn btn-default-primary btn-sm"><i class="fa fa-edit"></i></button>');if(o.append(l),l.on("click",n),2===a.changeSelectTable){let e=t('<button class="btn btn-default-primary btn-sm source-add"><i class="fa fa-plus"></i></button>');o.append(e),e.on("click",n)}}return i},this.getDataForPost=function(){let e={};return r.editItem.id&&(e.id=r.editItem.id),r.pcTable.fieldCategories.column.forEach(function(t){"n"!==t.name&&(r.editItem[t.name]&&r.isEditable(t)?(e[t.name]={},"edit"===r.panelType?(e[t.name].v=r.editItem[t.name].v,t.code&&!t.codeOnlyInAdd&&(e[t.name].h=r.editItem[t.name].h||!1),e[t.name].v=t.getPanelVal.call(t,e[t.name].v,r.$panel.find('div.cell[data-field-name="'+t.name+'"]').data("input"))):(e[t.name]=r.editItem[t.name].v,e[t.name]=t.getPanelVal.call(t,e[t.name],r.$panel.find('div.cell[data-field-name="'+t.name+'"]').data("input")))):a[t.name]&&"insert"===r.panelType&&(e[t.name]=a[t.name].v))}),e},this.isEditable=function(e){if(!r.pcTable.control.editing)return!1;return!0!==t.extend({},r.pcTable.f||{},r.editItem.f||{},r.editItem[e.name].f||{}).block&&("insert"===this.panelType?e.insertable:e.editable)},this.FocusIt=function(e){f&&clearTimeout(f),f=setTimeout(function(){let t=!0;if(!r.$panel||!r.$panel.length)return!1;if(r.pcTable.fieldCategories.column.forEach(function(n,i){if("n"!==n.name&&e===i){if(!r.isEditable(n))return void++e;{let e=r.$panel.find('.cell[data-name="'+n.name+'"]').data("input");e&&n.focusElement(e)}return t=!1,!1}}),t){r.bootstrapPanel.indexedButtons[Object.keys(r.bootstrapPanel.indexedButtons)[0]].focus()}},50)},"object"!=typeof r.pcTable?App.getPcTableById(r.pcTable).then(function(e){r.pcTable=e,r.checkRow()}):r.pcTable[0]?App.getPcTableById(r.pcTable[0],{sess_hash:r.pcTable[1]}).then(function(e){e.model.setDataRows(r.pcTable[2]),r.pcTable=e,r.checkRow()}):r.checkRow(),d.promise()},function(){let n,i=!1;t.extend(App.pcTableMain.prototype,{switchContainerNideScroll:function(e){let t=this;n&&clearTimeout(n),n=setTimeout(()=>{e!==i&&(e?t._container.niceScroll({cursorwidth:7,mousescrollstep:90,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:-3}}):t._container.getNiceScroll().remove(),i=e)},100)},addScrollsRules:function(){let e=this;this._innerContainer.append(this._table),e.isMobile||(this._innerContainer.on("scroll",function(){"use strict";e._removeEditCell()}),e.withoutScrolls||t(function(){e.switchContainerNideScroll(!0)}))},Scroll:function(){let n=this,i={};n._content.offset().top;i.table=void 0;let a=!1,o=0,l=function(){let e=s();a!=(a=i.getClusterNum(e))&&i.insertToDOM(a);let o=t("table.pcTable-table");o.find("thead").height()+o.offset().top-t("#table").offset().top<=0?i.table?i.table.css({top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)}):function(){if(!i.table){i.table=t("<table>").appendTo(n._innerContainer),i.table.width(n.tableWidth),i.table.append(t("table.pcTable-table thead").clone(!0)).attr("class",t("table.pcTable-table").attr("class")),i.table.find("th:not(.id) div, th:not(.id) .btn").remove(),i.table.find('th.id .pcTable-filters button[data-action="checkbox"]').remove(),i.table.find("th").removeClass("with-filter");let e=t('<div class="btn btn-default btn-xxs "><i class="fa fa-arrow-up"></i></div>').on("click",function(){n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top)});if(i.table.find("th.id .pcTable-filters:first").append(e),i.table.find("th.n").length){let e=n._innerContainer.find("th.n").find("i.fa-save").parent().clone(!0);i.table.find("th.n").append(t('<div class="pcTable-filters">').append(e))}}i.table.css({position:"absolute",top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)})}():i.table&&(i.table.remove(),i.table=void 0,n._content.off("scroll"))},s=function(){try{return n._content.offset().top}catch(e){return 0}};n._container.on("scroll",function(){clearTimeout(o),o=setTimeout(function(){l.call(n)},50)});let r={top_offset:0,bottom_offset:0,rows:t()};return t.extend(i,{rows_in_block:4,item_height:35,getClusterNum:function(e){let t;return t=e>=0?0:Math.floor(-e/this.block_height),Math.max(t,0)},reloadScrollHead:function(){i.table&&(i.table.remove(),i.table=void 0),l.call(n)},generate:function(e){let t=n.dataSortedVisible,i=t.length;if(i<this.rows_in_block)return{top_offset:0,bottom_offset:0,rows:t};let a=Math.max(this.rows_in_block*e,0),o=a+this.rows_in_cluster+3*this.rows_in_block,l=Math.max(a*this.item_height,0),s=Math.max((i-o)*this.item_height,0),r=[];for(let e=a;e<o;e++)t[e]&&r.push(t[e]);return{top_offset:l,conteinerHeight:n._content.height(),i_start:a,bottom_offset:s,cluster_num:e,rows:r}},getRowsHeight:function(){0!==n.dataSortedVisible.length&&(this.block_height=this.item_height*this.rows_in_block,this.rows_in_cluster=Math.floor((e.innerHeight-n._container.offset().top)/this.item_height))},insertToDOM:function(e,t,i){if(n.isMobile)this.setHtml(n.dataSortedVisible,0,0,i);else{this.rows_in_cluster||this.getRowsHeight(),e||(e=this.getClusterNum(s()));let a=this.generate(e),o=a.rows.join(",");(i||this.checkChanges("data",o,r))&&this.setHtml(a.rows,a.top_offset,a.bottom_offset,i),t&&n._container.getNiceScroll&&n._container.getNiceScroll().resize()}},setHtml:function(e,i,a,o){n._content.find(".editing").each(function(e){n._removeEditing.call(n,e)});let l=n._content.empty().get(0);if(i&&l.appendChild(t('<tr style="height: '+i+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0)),0===n.dataSorted.length)l.appendChild(n._createNoDataRow().get(0));else if(0===n.dataSortedVisible.length)l.appendChild(n._createNoDataRow("По условиям фильтрации не выбрана ни одна строка").get(0));else for(let t in e){let i=e[t],a=n.data[i];a.$tr&&!o||n._createRow.call(n,a),a.$tr.data("item",a),l.appendChild(a.$tr.get(0))}a&&l.appendChild(t('<tr style="height: '+a+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0))},checkChanges:function(e,t,n){let i=t!=n[e];return n[e]=t,i}}),i}})}(),t.extend(App.pcTableMain.prototype,{sort:function(e,t){let n=this,i=e.name,a="number"===e.type,o=n.data;(n.nSorted="n"===e.name)||this._table.addClass("no-correct-n-filtered"),a?n.dataSorted=n.dataSorted.sort(function(e,n){let a,l,s=o[e][i].v,r=o[n][i].v,c=0;if(null===s)c=null===r?0:-t;else if(null===r)c=t;else{try{a=Big(s)}catch(e){a=Big(0)}try{l=Big(r)}catch(e){l=Big(0)}c=a.gt(l)?t:a.eq(l)?0:-t}return c}):"select"===e.type?n.dataSorted=n.dataSorted.sort(function(n,a){let l,s;const r=function(t){let n;return o[t][i].v_?e.multiple?(n="",o[t][i].v_.forEach(function(e){n+=e[0]})):n=o[t][i].v_[0]:n=o[t][i].v,n};return(l=r(n))===(s=r(a))?0:l>s?t:-t}):n.dataSorted=n.dataSorted.sort(function(e,n){let a,l;return(a=o[e][i].v||"")>(l=o[n][i].v||"")?t:a==l?0:-t}),this.dataSortedVisible=[],n.dataSorted.every(function(e){return n.data[e].$visible&&n.dataSortedVisible.push(e),!0}),n._refreshContentTable()}}),App.pcTableMain.prototype.isSelected=function(e,t){return!(!this.selectedCells||!this.selectedCells.ids[e]||-1===this.selectedCells.ids[e].indexOf(t))},App.pcTableMain.prototype._addSelectable=function(){var n=this;n.selectedCells={fieldName:null,ids:{},notRowCell:null,selectPanel:null,lastSelected:null,notRowCellEmpty:function(){if(this.notRowCell){this.notRowCell.removeClass("selected");let e=this.notRowCell.closest(".DataRow");1===e.length&&e.removeClass("selected"),this.notRowCell=null}},empty:function(){this.notRowCellEmpty();let e=this;Object.keys(this.ids).forEach(function(t){e.ids[t].forEach(function(e){let t=n._getItemById(e);t&&t.$tr&&(t.$tr.find(".selected").removeClass("selected"),t.$tr.removeClass("selected"))})}),this.ids={},this.lastSelected=null},getEditedData:function(e,t){let i={},a=!1;return Object.keys(n.selectedCells.ids).length>1&&(a=!0),Object.keys(n.selectedCells.ids).forEach(function(o){n.selectedCells.ids[o].forEach(function(l){let s=n.data[l],r=s[o].f?s[o].f.block:void 0;s.f.block&&!1!==r||r||!n.fields[o].editable||!n.fields[o].editGroup||a&&!n.fields[o].editGroupMultiColumns||(i[l]||(i[l]={}),i[l][o]=t?s[o].v:e)})}),i},remove:function(e,t){let i=this;if(!this.ids[t])return;let a={};this.ids[t].some(function(n,o){if(n==e)return i.ids[t].splice(o,1),0===i.ids[t].length&&delete i.ids[t],a[e]=!0,!0}),Object.keys(a).forEach(function(e){let t=!1;Object.keys(i.ids).some(function(n){if(-1!==i.ids[n].indexOf(parseInt(e)))return t=!0,!0}),t||n.data[e].$tr&&n.data[e].$tr.removeClass("selected")})},add:function(e,t){this.ids[t]||(this.ids[t]=[]),this.ids[t].push(e),n.data[e].$tr&&n.data[e].$tr.addClass("selected")},selectPanelDestroy:function(){let e=this;e.selectPanel&&(e.selectPanel.attr("aria-describedby")&&e.selectPanel.popover("destroy"),e.selectPanel=null),t("body").off(".selectPanelDestroy")},checkIfShowPanel:function(i){"use strict";let a=this;if(this.selectPanelDestroy(),i){let o,l=n._getFieldBytd(i),s=t('<div id="selectPanel" class="text">'),r=200,c=t('<div class="column-name"></div>').text(l.title);l.unitType&&c.append(", "+l.unitType),s.append(c),"text"===l.type&&c.append(", "+l.textType),s.append(c),o="column"===l.category?n._getItemBytd(i):n.data_params;let d="";if("column"===l.category){if(d='<span class="id-val">['+o.id+"]</span>",n.tableRow.main_field){let e=n.mainFieldName;void 0!==o[e].v_?"array"==typeof o[e].v_?o[e].v_.forEach(function(i,a){let l=t("<span>").text(n.fields[e].getElementString(o[e].v?o[e].v[a]:null,i));i[1]&&l.addClass("deleted_value"),d+=" "+l.html()}):d+=" "+t("<div>").text(n.fields[e].getElementString(o[e].v,o[e].v_)).html():d+=" "+t("<div>").text(o[e].v).html()}let e=t('<div class="row-name"></div>').html(d);s.append(e)}let f=o[l.name],p=t("<div>"),u=t('<div class="field-value"><div class="copytext-wrapper"><div class="copytext"></div></div></div>').css("white-space","pre-wrap");n.isMobile?u.height("auto").css("min-height",40):u.height(r),p.append(u).appendTo(s);let h,m=u.find(".copytext");if(l.unitType&&null!==f.v&&m.attr("data-unit",l.unitType),f.f&&(f.f.text&&u.prepend(t('<div class="sp-element"><i class="fa fa-font"></i> </div>').append(f.f.text)),f.f.comment&&u.prepend(t('<div class="sp-element"><i class="fa fa-info"></i> Комментарий: </div>').append(f.f.comment))),f.h)if(void 0!==f.c){let e=f.c;f.c_&&(e=f.c_[0],f.c[1]&&(e=t('<span class="deleted_value">').text(e))),u.append(t('<div><i class="fa fa-hand-paper-o"></i> Расчетное значение: </div>').append(e))}else u.append('<div><i class="fa fa-hand-grab-o pull-left"></i> Cовпадает с расчетным</div>');let b=t('<div class="buttons"></div>'),g=[];if(i.is(".edt")&&(g.push({label:'<i class="fa fa-pencil-square-o"></i>',action:function(e){e.close(),i.dblclick()}}),t('<button class="btn btn-sm btn-default"><i class="fa fa-pencil-square-o"></i></button>').on("click",function(){return i.dblclick(),!1}).appendTo(b)),(h=t('<button class="btn btn-sm btn-default copy_me" disabled data-copied-text="Скопировано" title="Копировать "><i class="fa fa-copy"></i></button>')).on("click",function(){m.data("text")?App.copyMe(m.data("text")):App.copyMe(m.text());let e=t(this);return e.width(e.width()),e.button("copied"),setTimeout(function(){e.button("reset")},1e3),e.blur(),!1}),b.append(h),"tmp"!==n.tableRow.type&&l.logButton&&(g.push({label:"Лог",action:function(e){let t;n.mainFieldName&&o.id&&(t=o[n.mainFieldName].v),n.model.getFieldLog(l.name,o.id,t),e.close()}}),t('<button class="btn btn-sm btn-default" title="Лог ручных изменений по полю">Лог</button>').on("click",function(){let e;n.mainFieldName&&o.id&&(e=o[n.mainFieldName].v),n.model.getFieldLog(l.name,o.id,e);let i=t(this).addClass("disabled");return setTimeout(function(){i.removeClass("disabled")},1e3),!1}).appendTo(b)),"column"===l.category&&l.filterable&&(n.isValInFilters.call(n,l.name,f)?(g.push({label:'<i class="fa fa-filter" style="color: #ffe486"></i>',action:function(e){a.selectPanelDestroy(),n.removeValueFromFilters.call(n,l.name,f),e.close()}}),t('<button class="btn btn-sm btn-warning" title="Удалить из фильтра"><i class="fa fa-filter"></i></button>').on("click",function(){return a.selectPanelDestroy(),n.removeValueFromFilters.call(n,l.name,f),!1}).appendTo(b)):(g.push({label:'<i class="fa fa-filter"></i>',action:function(e){a.selectPanelDestroy(),n.addValueToFilters.call(n,l.name,f),n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top),n.ScrollClasterized.insertToDOM.call(n.ScrollClasterized,0),e.close()}}),t('<button class="btn btn-sm btn-default" title="Добавить в фильтр"><i class="fa fa-filter"></i></button>').on("click",function(){return a.selectPanelDestroy(),n.addValueToFilters.call(n,l.name,f),n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top),n.ScrollClasterized.insertToDOM.call(n.ScrollClasterized,0),!1}).appendTo(b))),!n.isMobile){let n=t('<button class="btn btn-sm btn-default"><i class="fa fa-expand" style="padding-top: 3px;" aria-hidden="true"></i></button>');n.on("click",function(){e.top.BootstrapDialog.show({message:p,type:null,title:c.text()+(d?" / "+d:""),cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),a.selectPanelDestroy()},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})}),b.append(n),t('<button class="btn btn-sm btn-default" title="Закрыть панель"><i class="fa fa-times"></i></button>').on("click",function(){return a.selectPanelDestroy(),!1}).appendTo(b)}let _=l.getPanelText(f.v,s,o);if("select"===l.type){let e=t('<div class="previews">').appendTo(u);l.loadPreviewPanel(e,l.name,o,f.v)}n.isCreatorView&&-1!==["select","tree","date"].indexOf(l.type)&&u.append(t('<div class="creator-select-val">'+JSON.stringify(f.v)+"</div>"));const v=function(e){m.text(e),h.prop("disabled",!1)},w=function(e,t){m.html(e),e.data("text")?m.data("text",e.data("text")):m.data("text",t),h.prop("disabled",!1)},y=function(e){if("object"==typeof e&&null!==e)if(e instanceof jQuery){let n="";e.copyText?w(e,e.copyText):(e.each(function(){""!==n&&(n+="\n"),n+=t(this).text()}),""===n&&(n=e.text()),w(e,n))}else e.then?e.then(y):v(JSON.stringify(e));else v(e)};if(y(_),n.isCreatorView){let e;n.LOGS&&(e=n.LOGS,o&&o.id&&(e=n.LOGS[o.id]),e&&(e=e[l.name]));let i=t('<div style="padding-top: 10px">');if(e&&e.c){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');n.on("click",function(){App.logOutput(e.c)}),i.append(n)}if(e&&e.s){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> s</i></button>');n.on("click",function(){App.logOutput(e.s)}),i.append(n)}if(e&&e.a){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> a</i></button>');n.on("click",function(){App.logOutput(e.a)}),i.append(n)}if(e&&e.f){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> f</i></button>');n.on("click",function(){App.logOutput(e.f)}),i.append(n)}i.children().length&&b.append(i)}if(this.selectPanel=i.find("span:first"),n.isMobile||s.append(b),f.e&&u.append(t('<div style="padding-top: 5px;">').html(t("<span>").text(f.e).text().replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"))),n.isMobile)App.mobilePanel(c,s,{buttons:g});else{let e="right",t=this.selectPanel.offset().left,i=n._container.offset().left;n._container.width()-(t-i)-this.selectPanel.width()<(s.is(".text")?340:240)&&(e="left");let a={isParams:!0,$text:s,element:this.selectPanel,container:n._container,placement:e,trigger:"manual"};App.popNotify(a)}t("body").on("click.selectPanelDestroy",function(e){0===t(e.target).closest("#selectPanel").length&&a.selectPanelDestroy()}).on("keyup.selectPanelDestroy",function(e){27==e.which&&a.selectPanelDestroy()})}return!1},copySepected:function(e,n){let i=this,a="",o=[],l=[],s={},r=[];Object.keys(i.selectedCells.ids).forEach(function(e){let t=i.selectedCells.ids[e];o=o.concat(t),l.push(e),t.forEach(function(t){s[t]||(s[t]={});let n=i.fields[e].getCopyText.call(i.fields[e],i.data[t][e],i.data[t]);"object"==typeof n?(r.push(n),n.done(function(n){s[t][e]=n})):s[t][e]=n})}),o=Array.from(new Set(o)),o=i.dataSortedVisible.filter(e=>-1!==o.indexOf(e)),l=Array.from(new Set(l));let c=[];i.fieldCategories.visibleColumns.forEach(function(e){-1!==l.indexOf(e.name)&&c.push(e.name)}),l=c;e&&(a+="id",l.forEach(function(e){a+="\t",a+=i.fields[e].title}));let d=n;t.when(...r).done(function(){o.forEach(function(t){""!==a&&(a+="\n");let n=!0;e&&(a+=t,n=!1),l.forEach(function(e){!0===n?n=!1:a+="\t";let i=s[t][e];void 0===i&&(i=""),"string"==typeof i&&i.replace(/\t/g,"").match(/[\s"]/)&&(i='"'+i.replace(/"/g,'""')+'"'),a+=i})}),console.log(a),App.copyMe(a),setTimeout(d,400)})},click:function(e,i){let a=n._table;if(e.closest("table").is(".pcTable-filtersTable"))return!1;if(!0===a.data("moved"))return a.data("moved",!1),!1;(function(){if(e.is(".val")){if(this.notRowCell&&-1!==this.notRowCell.index(e))n.selectedCells.empty();else{n.selectedCells.empty(),this.notRowCell=e,this.notRowCell.addClass("selected");let t=this.notRowCell.closest(".DataRow");1===t.length&&t.addClass("selected")}return void t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}this.notRowCellEmpty();let a=e.closest("tr"),o=n._getItemByTr(a),l=n._fieldByTd(e,a),s=l.name;if(i.altKey)e.is(".selected")?(n.selectedCells.remove(o.id,s),e.removeClass("selected")):(n.selectedCells.add(o.id,s),e.addClass("selected"),this.lastSelected=[s,o.id]);else if(i.shiftKey&&Object.keys(n.selectedCells.ids).length){let e=this,t=[],i="before";n.dataSortedVisible.some(function(n){if("before"===i){if((n===o.id||n===e.lastSelected[1])&&(i="doIt",t.push(n),o.id===e.lastSelected[1]))return!0}else if("doIt"===i&&(t.push(n),n===o.id||n===e.lastSelected[1]))return!0}),i="before";let a=function(i){t.forEach(function(t){let a=n.data[t];n.isSelected(i.name,t)||(e.add(t,i.name),a.$tr&&n._getTdByFieldName(i.name,a.$tr).addClass("selected"))})};n.fieldCategories.column.some(function(t){if(t.showMeWidth>0)if("before"===i){if((t.name===s||t.name===e.lastSelected[0])&&(i="doIt",a(t),s===e.lastSelected[0]))return!0}else if("doIt"===i&&(a(t),t.name===s||t.name===e.lastSelected[0]))return!0}),this.lastSelected=[s,o.id]}else{let t=n.isSelected(l.name,o.id);n.selectedCells.empty(),t||(n.selectedCells.add(o.id,s),e.addClass("selected"),this.lastSelected=[s,o.id])}let r=Object.keys(n.selectedCells.ids);r.length>1?t("table.pcTable-table").addClass("selected-multi"):1===r.length&&Object.values(n.selectedCells.ids)[0].length>1?t("table.pcTable-table").removeClass("selected-multi").addClass("selected-column"):t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}).call(this)}},this._container.on("contextmenu",".DataRow td:not(.editing,.n,.id), td.val:not(.editing)",function(){let e=t(this);return n.selectedCells.selectPanel&&n.selectedCells.selectPanel.closest("td")[0]==e[0]?n.selectedCells.selectPanelDestroy():(n.selectedCells.selectPanelDestroy(),n.selectedCells.empty(),n.selectedCells.checkIfShowPanel(e),n.selectedCells.click(e,{})),!1}),this._container.on("click",".DataRow td:not(.editing,.id,.n), td.val:not(.editing)",function(e){let i=t(this);if(i.is(".cell-button")){let e=n._getFieldBytd(i);return n._buttonClick.call(n,i,e),!1}i.data("clicked")?i.removeData("clicked"):(i.data("clicked",1),setTimeout(function(){i.data("clicked")&&(i.removeData("clicked"),n.selectedCells.click(i,e))},200))}),this._container.on("click","th.id .for-selected button",function(){let e=t(this),i=e.html();e.text("Скопировано"),n.selectedCells.copySepected.call(n,e.data("names"),function(){e.html(i)})})},App.pcTableMain.prototype.filters={},App.pcTableMain.prototype.__getFilterButton=function(e){var n="btn-default";(this.filters[e]&&this.filters[e].length||this.filters[e+"/h"])&&(n="btn-warning");var i=t('<button class="btn btn-xxs btn-filter"><span class="fa fa-filter"></span></button>').addClass(n);return t('<span class="filter-in-head">').append(i)},App.pcTableMain.prototype.filtersEmpty=function(){this.filters={},this._refreshHead(),this.__applyFilters()},App.pcTableMain.prototype.sessionStorageFilters={url:location.protocol+"//"+location.host+location.pathname,setFilters:function(e){let t={};e=e||{};try{t=JSON.parse(sessionStorage.getItem("pcTableFilters"))||{}}catch(e){}t[this.url]=e,sessionStorage.setItem("pcTableFilters",JSON.stringify(t))},getFilters:function(){let e={};try{e=(e=JSON.parse(sessionStorage.getItem("pcTableFilters")))[this.url]||{}}catch(e){}return e}};let d=!0;App.pcTableMain.prototype.__applyFilters=function(){let e=this;App.fullScreenProcesses.show(),this.filtersClearButton&&("tmp"!==e.tableRow.type&&this.sessionStorageFilters.setFilters(this.filters),this.selectedCells.empty(),Object.equals(this.filters,{})?this.filtersClearButton.addClass("btn-default").removeClass("btn-warning").attr("disabled",!0):(this.filtersClearButton.removeClass("btn-default").addClass("btn-warning").removeAttr("disabled"),d&&(App.blink(e.filtersClearButton,8,"#fff"),d=!1)));let t=this.dataSortedVisible.slice(),n=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],i=this.data[t];this.__applyFiltersToItem(i),i.$visible&&n.push(t)}JSON.stringify(t)!==JSON.stringify(n)&&(this.dataSortedVisible=n,this._refreshContentTable(!1,!0),this._headCellIdButtonsState()),App.fullScreenProcesses.hide()},App.pcTableMain.prototype.__applyFiltersToItem=function(e,t){let n=this,i=!0;for(let t in n.filters){if(!n.filters[t]||0===n.filters[t].length)continue;let a=n.filters[t];if("id"===t)-1===a.indexOf(e.id.toString())&&(i=!1);else{let o=t.toString().split("/");if(t=o[0],!n.fields[t])continue;switch(o[1]||"v"){case"v":n._getFieldbyName(t).checkIsFiltered(e[t],a)||(i=!1);break;case"h":switch(a){case"h":!0!==e[t].h&&(i=!1);break;case"n":!0===e[t].h&&(i=!1);break;case"hf":(!0!==e[t].h||e[t].hasOwnProperty("c"))&&(i=!1);break;case"hc":!0===e[t].h&&e[t].hasOwnProperty("c")||(i=!1)}}}if(!i)break}(e.$visible=i)||this.row_actions_uncheck(e)},App.pcTableMain.prototype.addValueToFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n=this.fields[e];this.filters[e].push(n.getFilterDataByValue.call(n,t)),n.$th.find(".btn-filter").parent().replaceWith(this.__getFilterButton.call(this,e)),this.__applyFilters.call(this)},App.pcTableMain.prototype.isValInFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n=this.fields[e],i=n.getFilterDataByValue.call(n,t);return-1!==this.filters[e].indexOf(i)},App.pcTableMain.prototype.removeValueFromFilters=function(e,t){const n=this;n.filters[e]||(n.filters[e]=[]);let i,a=n.fields[e],o=a.getFilterDataByValue.call(a,t);for(;-1!==(i=n.filters[e].indexOf(o));)n.filters[e].splice(i,1);0===n.filters[e].length&&delete n.filters[e],a.$th.find(".btn-filter").parent().replaceWith(n.__getFilterButton.call(n,e)),n.__applyFilters.call(n)},App.pcTableMain.prototype.__addFilterable=function(){const e=this;var n={};"tmp"!=e.tableRow.type&&(n=e.sessionStorageFilters.getFilters()),e.filters=n||{},this._header.on("click",".pcTable-filters > span button.btn-filter:not(#checkS)",function(n){let i=t(this);if(i.attr("aria-describedby"))return!0;let a=i.closest("th"),o=a.is(".id")?"id":a.data("field"),l=t('<div class="filter-div-button">'),s=t('<select class="selectpicker" data-size="6" multiple title="Выберите значения" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-selected-text-format="count">').appendTo(l);const r=function(){try{i.popover("destroy")}catch(e){}};let c,d=!1;const f=function(n){if(c&&clearTimeout(c),!d){if("filterRemove"===n)return d=!0,r(),delete e.filters[o],i.removeClass("btn-warning").addClass("btn-default"),void e.__applyFilters.call(e);if("setInvertFilters"===n){let e=Object.values(s.selectpicker("val")),n=[];t.each(s.data("options"),function(t,i){-1===e.indexOf(i)&&n.push(i)}),s.selectpicker("val",n)}c=setTimeout(function(){r(),JSON.stringify(e.filters[o]||[])!==JSON.stringify(s.selectpicker("val"))&&(e.filters[o]=s.selectpicker("val"),0===e.filters[o].length&&delete e.filters[o],"id"!==o||i.closest(".pcTable-table").is(".pcTable-table:first")||e._header.find("th.id .btn-filter").parent().replaceWith(e.__getFilterButton.call(e,o)),i.parent().replaceWith(e.__getFilterButton.call(e,o)),e.__applyFilters.call(e))},10)}};l=t('<div class="pcTable-filter-select" style="height: 220px;">').append(l),s.data("container",l);var p={};t.each(e.data,function(t,n){"id"===o?p[t.toString()]=t.toString():e.fields[o].addDataToFilter(p,n[o])});var u={};t.each(p,function(e,t){u[t]=e}),u=App.ksort(u);let h={},m=e.filters[o]?[...e.filters[o]]:[];const b=function(e){h={"Выбранное":t('<optgroup label="Выбранное">'),"":t('<optgroup label="">')};let n=function(){return!0};if(e&&""!==e){let t=e.toLowerCase().replace("ё","е").split(" ");n=function(e){let n=null!==e?e.toString().toLowerCase().replace("ё","е"):"";return!t.some(function(e){return-1===n.indexOf(e)})}}let i=!1,a=0,o=0;t.each(u,function(e,t){if("null"===e&&(e="null "),-1!==m.indexOf(t.toString())){let i=n(e);h["Выбранное"].append('<option data-content="'+e+'" '+(i?"":'style="display: none"')+">"+t+"</option>"),o+=i?1:0}else{if(!n(e))return!0;a>=100?i=!0:(h[""].append('<option data-content="'+e+' ">'+t+"</option>"),a++)}}),s.empty(),o||h["Выбранное"].attr("label",""),s.append(h["Выбранное"]),s.append(h[""]),i&&s.append('<option data-content="Данные не полны. Пользуйтесь поиском" disabled = disabled style="text-align: center; cursor: pointer">0</option>'),s.data("options",u),s.selectpicker("val",m),s.selectpicker("refresh")};s.on("change.bs.select",function(){m=s.val()}),b();let g=i.popover({html:!0,content:l,trigger:"manual",container:e._container,placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'});s.selectpicker("render").selectpicker("toggle");let _=t('<div class="buttons" style="position: absolute; bottom: -4px; width: 100%; text-align: center">');if(t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Прим.</span></span>').appendTo(_).on("click",function(){f("setSelectedFilters")}),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Инверт.</span></span>').appendTo(_).on("click",function(){f("setInvertFilters")}),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px">Отмен.</span>').appendTo(_).on("click",function(){f("filterRemove")}),e.fields[o]&&e.fields[o].code&&!e.fields[o].codeOnlyInAdd){let n=t('<select data-title="Все" data-dropup-auto="false" class="dropup" data-container=".popover" data-style="btn btn-xxs '+(e.filters[o+"/h"]?"btn-warning":"btn-default")+' "><option value="">Все</option><option value="n">Без руки</option><option value="h">С рукой все</option><option value="hf">С рукой как в расчете</option><option value="hc">С рукой отличающиеся</option></select>').appendTo(_).on("change",function(){return e.filters[o+"/h"]=n.selectpicker("val"),""===e.filters[o+"/h"]&&delete e.filters[o+"/h"],r(),i.parent().replaceWith(e.__getFilterButton.call(e,o)),e.__applyFilters.call(e),!1}).wrap('<span id="filterHand">');setTimeout(function(){n.selectpicker("render").selectpicker("val",e.filters[o+"/h"]||"");try{n.data("selectpicker").$menu.offset({bottom:15,left:-90}).css("border","1px solid grey")}catch(e){}},100)}_.appendTo(l),s.on("hidden.bs.select",function(){f("setSelectedFilters")}),e.filters[o]&&s.selectpicker("val",e.filters[o]),setTimeout(function(){if(g&&g.length){let n;g.popover("show"),l.on("mouseenter","li",function(){let e=t(this);e.attr("title")||e.attr("title",e.text())}),"id"===o&&t("#"+i.attr("aria-describedby")).position({my:"left top",at:"left-3px bottom+10px",of:i}).find(".arrow").css("left","12px"),s.data("selectpicker")._searchStyle=function(){return"multiincludes"},s.data("selectpicker").$searchbox.focus(),s.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",function(e){e.stopPropagation()}),s.data("selectpicker").$searchbox.on("keydown",function(e){if("Escape"===e.key)return s.data("selectpicker").$button.click(),!0});let a="";s.data("selectpicker").$searchbox.on("keyup",function(e){let i=t(this).val();a!==i&&(a=i,n&&clearTimeout(n),n=setTimeout(function(){b(a)},750))}),e._container.one("click.filter filterPressed.filter",function(n){0!==t(n.target).closest("#filterHand").length||"filterPressed"!==n.type&&void 0===n.altKey||!t("#"+i.attr("aria-describedby")).is(":visible")||(e._container.off(".filter"),f("setSelectedFilters"))}),e._innerContainer.one("scroll.filter",function(n){t("#"+i.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),f("setSelectedFilters"))})}},50),e._container.trigger("filterPressed")})},t.extend(App.pcTableMain.prototype,{_addEditable:function(){var n=this;this._container.on("dblclick","td.val:not(.editing), td.edt:not(.editing), .dataRows td:not(.editing,.id,.n)",function(i){let a=t(this),o=a.closest("tr");if(o.length&&o.is(".InsertRow"))return!1;if(a.is(".footer-name, .id, .footer-empty"))return!1;if(a.is(".edt"))n._createEditCell.call(n,a,!0);else{if(o.is(".DataRow")&&"cycles"===n.tableRow.type&&n.tableRow.__firstUserTable)return e.location.href=e.location.pathname+("/"===e.location.pathname.substr(-1)?"":"/")+n._getItemByTr(o).id+"/"+n.tableRow.__firstUserTable,!1;let t=a.html();a.html("Заблокировано"),setTimeout(function(){a.html(t)},500)}}).on("click",".editCellsBlock .btn, td.edt .ttm-edit, td .ttm-panel",function(e){return t(this).is(".ttm-edit")?(t(this).closest("td").trigger("dblclick"),!1):t(this).is(".ttm-panel")?(t(this).closest("td").trigger("contextmenu"),!1):void t(this).data("click")(e)})},goToEditNextCell:function(e){return next},_buttonClick:function(n,i,a){if(n.data("clicked"))return!1;const o=function(){"use strict";let o,s={},r=n.parent();n.data("clicked",!0),"column"===i.category?(a=a||l._getItemBytd(n),o=a.id,s.item=o,s.fieldName=i.name):(s.item="params",s.fieldName=i.name),s.checked_ids=l.row_actions_get_checkedIds(),n.height(n.height()),n.find("button").hide();let c=t('<div class="text-center"><i class="fa fa-spinner"/></div>');n.append(c),l._saving=!0,l.model.click(s).then(function(t){if(l.table_modify.call(l,t),n.length&&n.isAttached())c.remove(),n.find("button").show();else if("column"===i.category){let e=l._getItemById(o).$tr;n=l._getTdByFieldName(i.name,e)}else n=r.find('[data-field="'+i.name+'"]');i.uncheckAfterClick&&l.row_actions_uncheck_all(),i.closeIframeAfterClick&&e.closeMe&&e.closeMe(),i.btnOK.call(i,n)}).fail(function(){n.length&&n.isAttached()&&(c.remove(),n.find("button").show(),n.removeData("clicked"))}).always(function(){l._saving=!1})};let l=this;if(i.warningEditPanel){let e={"Ок":function(e){e.close(),o()},"Отмена":function(e){e.close()}};App.confirmation(i.warningEditText||"Точно изменить?",e,"Подтверждение")}else o()},_saveEdited:function(e,n,i){let a=this;!0!==a._saving&&(a._saving=!0,this.model.save(n).then(function(t){a.table_modify.call(a,t,void 0,e),e.closest("table").length&&e.is("tr.DataRow")&&a.refreshRow(e),i&&i()}).always(function(){a._saving=!1,e.is("tr.DataRow")&&1===e.closest("table").length&&e.find(".editing").length?e.each(function(){a.refreshRow(t(this))}):e.is("td")&&e.find(".fa-spinner").length&&e.closest("table").length>0&&e.each(function(){let e=t(this),n=a._getItemBytd(e),i=a._getFieldBytd(e),o=a._createCell(n,i);"button"===i.type&&i.btnOK.call(i,o),e.replaceWith(o)})}))},_editFocusIndex:0,_editItem:null,_editPanel:null,_row_edit:function(e){let t=this;if(0===e.length)return!1;let n=e.shift();new EditPanel(t,BootstrapDialog.TYPE_PRIMARY,{id:n},e.length>0).then(function(n,i){(n||i)&&(n&&t.table_modify.call(t,n),t._row_edit.call(t,e))}).then(function(){0===e.length&&t.row_actions_uncheck_all()})},_currentEditCellIndex:0,_removeEditing:function(e){e||(e=this._content.find("td.editing"));var t=this._createCell(this._getItemBytd(e),this._getFieldBytd(e));let n;return(n=e.attr("rowspan"))&&t.attr("rowspan",n),(n=e.data("field"))&&t.data("field",n),e.is(".val")&&t.addClass("val"),e.replaceWith(t),t},_saveEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._editCell.data("SaveMe")&&this._editCell.data("SaveMe")()},_removeEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._removeEditing(this._editCell),this._editCell=null},_setEditCell:function(e){this._saveEditCell(),this._editCell=e,e.addClass("editCell")},_setTdSaving:function(e){e.html('<div class="text-center"><i class="fa fa-spinner"/></div>')},_createEditCell:function(n,a,o){let l=this,s=this._getFieldBytd(n);this._setEditCell(n),n.height(n.height());let r=n.closest("tr"),c=l._getColumnIndexByTd(n,r),d=function(e){if(!e)return!1;let t;switch(e){case"right":for(t=l._getTdByColumnIndex.call(l,r,++c);t.length;){if(!0===l._getFieldBytd.call(l,t).editable){t.trigger("dblclick");break}t=t.next("td")}break;case"down":for(t=r.next("tr");t.length&&t.is(".Blocked");)t=t.next("tr");l._getTdByColumnIndex.call(l,t,c).trigger("dblclick")}};if(!s.editable)return!1;let f=(o=o||this._getItemBytd(n)).id,p=t('<div class="editCellsBlock">');n.addClass("editing");let u,h,m=o[s.name],b=!1,g=function(e,t,n){let a=n||e.closest("td"),o=t||{};if(!a.length||!a.closest("tr").length)return!1;var s=l._removeEditing.call(l,a);l._colorizeElement(s,i),d(o.altKey?"right":!!o.shiftKey&&"down")},_=function(e){l._removeEditing.call(l,n),d(e)};l.isSelected(s.name,o.id)?Object.keys(l.selectedCells.ids).length>1?(h=!0,u=!0):l.selectedCells.ids[s.name].length>1&&(u=!0):l.selectedCells.empty();let v=function(e,t,i){if(!i&&s.warningEditPanel&&s.checkEditRegExp.call(s,e))return void App.confirmation(s.warningEditText||"Точно изменить?",{"ОК":function(n){v(e,t,!0),n.close()},"Отменить":function(e){_(),e.close()}},"Предупреждение при изменении");n.html('<div class="text-center"><i class="fa fa-spinner"/></div>');let a={};a[s.name]=e;let r={};o.id?r[o.id]=a:r.params=a,l._saveEdited.call(l,n,r,function(){d(t.altKey?"right":!!t.shiftKey&&"down")})},w=function(e,t){setTimeout(function(){if(b)return b=!1,!1;y(e,t)},150)},y=function(e,n,i){if(b=!0,!(i=i||!1)&&u)return!1;let a,o=e.closest("td");try{a=s.getEditVal(x)}catch(e){return t("#"+App.popNotify(e,o,"default")).css("z-index",1e3),void(b=!1)}let r=l._getItemBytd(o),c=n.altKey?"right":!!n.shiftKey&&"down";s.isDataModified(a,r[s.name].v)?v(a,n):_(c)};var x=s.getEditElement(void 0,m,o,y,g,w,null,a);n.html(x),n.data("SaveMe",function(e){y(x,e=e||{})}),n.data("input",x);var k=t('<div class="cdiv">').css({height:0,width:"100%",position:"absolute",bottom:"0px"});n.append(k);var C=t('<button class="btn btn-sm btn-default" data-save="true" data-name="Сохранить"><i class="fa fa-save"/></button>').data("click",function(e){b=!0,y(x,e,!0)});p.append(C);C=t('<button class="btn btn-sm btn-default" data-name="Закрыть"><i class="fa fa-undo"/></button>').data("click",function(e){b=!0;let t=e.altKey?"right":!!e.shiftKey&&"down";_(t)});if(p.append(C),u&&(h?s.editGroupMultiColumns:s.editGroup)){let e=function(){let e;b=!0;try{e=s.getEditVal(x)}catch(e){return void App.popNotify(e,n,"default")}let t=l._container.find("td.selected");l._setTdSaving(t);let i=l.selectedCells.getEditedData(e);l._saveEdited.call(l,t,i,!1)};(C=t('<button class="btn btn-sm btn-warning" data-save="true" data-name="Применить к выделенным"><i class="fa fa-database" title="Применить к выделенным"/></button>')).data("click",function(){s.warningEditPanel?App.confirmation(s.warningEditText,{"ОК":function(t){e(),t.close()},"Отменить":function(e){_(),e.close()}},"Предупреждение при изменении"):e()}),p.append(C),s.code&&!s.codeOnlyInAdd&&((C=t('<button class="btn btn-sm btn-warning" data-name="Фиксировать выделенные"><i class="fa fa-hand-rock-o" title="Фиксировать"/></button>')).data("click",function(){b=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData(null,!0);l._saveEdited.call(l,e.closest("tr"),t,!1)}),p.append(C),(C=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручные"><i class="fa fa-eraser" title="Сбросить ручные"/></button>')).data("click",function(){b=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData("NULL");t.setValuesToDefaults=!0,l._saveEdited.call(l,e.closest("tr"),t,!1)}),p.append(C))}else o[s.name]&&1==o[s.name].h?((C=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручное"><i class="fa fa-eraser" title="Сбросить ручное"/></button>')).data("click",function(){b=!0,n.html('<div class="text-center"><i class="fa fa-spinner"/></div>');let e={};parseInt(f)||(f="params"),e[f]={},e[f][s.name]="NULL",e.setValuesToDefaults=!0,l._saveEdited.call(l,n,e,!1)}),p.append(C)):s.code&&!s.codeOnlyInAdd&&((C=t('<button class="btn btn-sm btn-default" data-name="Фиксировать"><i class="fa fa-hand-rock-o" title="Фиксировать"/></button>')).data("click",function(){b=!0,n.html('<div class="text-center"><i class="fa fa-spinner"/></div>');let e={};parseInt(f)||(f="params"),e[f]={},e[f][s.name]="params"===f?l.data_params[s.name].v:l.data[f][s.name].v,l._saveEdited.call(l,n,e,!1)}),p.append(C));if(s.changeSelectTable){let n=function(){b=!0;let n={};t.each(o,function(e,t){"$"!==e.substring(0,1)&&(n[e]=t)}),t(this).data("add-button")&&(n[s.name]=null);let i=0;return t(e.top.document.body).on("pctable-opened.select-"+s.name,function(){i++}).on("pctable-closed.select-"+s.name,function(e,n){i--;let a=n&&"insert"===n.method&&n.json&&n.json.chdata&&n.json.chdata.rows;setTimeout(function(){if(0===i||a){let e=x;delete s.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),o=t.extend(!0,{},o),a&&(s.multiple?o[s.name].v.push(Object.keys(n.json.chdata.rows)[0]):o[s.name].v=Object.keys(n.json.chdata.rows)[0]),a||"column"!==s.category||l.model.refresh(function(e){l.table_modify.call(l,e)}),o[s.name].replaceViewValue=function(e){"column"!=s.category&&(l.data_params[s.name].v_=e)},e.replaceWith(x=s.getEditElement(e,o[s.name],o,y,g,w)),t("body").off(".select-"+s.name)}},100)}),l.model.selectSourceTableAction(s.name,n),!1};(C=t('<button class="btn btn-sm btn-primary"><i class="fa fa-edit" title="Изменить в таблице-источнике"/></button>')).on("click",n),p.append(C),2===s.changeSelectTable&&(C=t('<button class="btn btn-sm btn-primary" data-add-button="true"><i class="fa fa-plus" title="Добавить в таблицу-источник"/></button>'),p.append(C),C.on("click",n))}let T=p.find("button").length;p.width(31*T);let S=t("#"+App.popNotify({$text:p,element:k,container:this._container,isParams:!0,placement:"bottom"})),I=parseInt(S.css("top"))-4;S.css("top",-1e7),setTimeout(function(){S.length&&S.isAttached()&&S.css("top",I)},3),s.focusElement(x)}}),function(e,t){t.extend(App.pcTableMain.prototype,{_orderSaveBtn:void 0,row_actions_add:function(){let e=this;e._table.on("click",".DataRow .id",function(){e.isMobile&&e.row_actions_panel_show.call(e,t(this))}),e._table.on("click",".DataRow .id button.dropdown",function(){e.row_dropdown.call(e,t(this))}),e._table.on("click",".DataRow .id .btn.chbox",function(n){return e._row_actions_checkbox_click.call(e,t(this).closest("tr"),n.shiftKey),!1}),e._table.on("mouseleave",function(){return t(this).blur(),!1}),e._table.on("click",".DataRow .id button.edit",function(){e.rows_edit.call(e,t(this).closest("tr"))}),e._container.on("click",".row_delete, .row_duplicate, .row_refresh, .cycle_refresh",function(){let n=t(this);n.is(".row_delete")?e.rows_delete.call(e,t(this).data("tr")):n.is(".row_duplicate")?e.row_duplicate.call(e,t(this).data("tr")):n.is(".row_refresh")?e.row_refresh.call(e,t(this).data("tr")):n.is(".cycle_refresh")&&e.isCreatorView&&"cycles"===e.tableRow.type&&e.cycle_refresh.call(e,t(this).data("tr"))})},_idCheckButton:t('<button class="btn btn-xxs chbox btn-default" data-action="checkbox"><span class="fa fa-square-o"></span></button>'),_checkStatusBar:t('<div class="check-status-bar"><span class="check-mark">✓ </span><span data-name="count_checked_rows">0</span><span class="from-mark"> из </span><span data-name="count_visible_rows">0</span></div>'),_headCellIdButtonsState:function(){"use strict";let e=this;this.row_actions_get_checkedIds().length>0?t("table.pcTable-table").addClass("with-checks"):t("table.pcTable-table").removeClass("with-checks"),this.dataSortedVisible.length!==this.__checkedRows.length?e._idCheckButton.html('<span class="fa fa-square-o"></span>'):e._idCheckButton.html('<span class="fa fa-check"></span>'),this._refreshCheckedStatus(),e.ScrollClasterized.reloadScrollHead.call(e.ScrollClasterized)},_addCellId:function(e,n){let i=t('<td class="id"><span class="nm">'+e.id+"</span></td>");return i.appendTo(n),this.row_actions_icons_add(i),!0===e.$checked&&this.row_actions_check(e,!0),i},_addCellNo:function(e,n){let i=t('<td class="No">--</td>');return i.appendTo(n),i},row_actions_uncheck_all:function(){"use strict";let e=this,t=this.row_actions_get_checkedIds();for(let n=0;n<t.length;n++){let i=e._getItemById(t[n]);e.row_actions_uncheck.call(e,i,!0)}this.__checkedRows=[],this._headCellIdButtonsState()},_refreshCheckedStatus:function(){this._checkStatusBar.find('[data-name="count_checked_rows"]:first').text(this.__checkedRows.length),this._checkStatusBar.find('[data-name="count_visible_rows"]:first').text(this.dataSortedVisible.length)},_row_actions_checkbox_click:function(e,n){let i=this,a=e.closest("tr"),o=this._getItemByTr(a),l=t.extend({},i._lastcheckAction||{});if(i._lastcheckAction={id:o.id,isCheck:!o.$checked},n){let e,t=[];if(l.id&&!o.$checked===l.isCheck&&-1!==(e=i.dataSortedVisible.indexOf(l.id))){let n=i.dataSortedVisible.indexOf(o.id);t=e<n?i.dataSortedVisible.slice(e+1,n+1):i.dataSortedVisible.slice(n,e)}else i.dataSortedVisible.some(function(e){if(i.data[e].$checked?t=[]:t.push(e),e===o.id)return!0});o.$checked?t.forEach(function(e){i.__checkedRows.splice(i.__checkedRows.indexOf(e),1),i.row_actions_uncheck(i.data[e],!0)}):t.forEach(function(e){i.__checkedRows.push(e),i.row_actions_check(i.data[e],!0)}),this._headCellIdButtonsState()}else o.$checked?this.row_actions_uncheck(o):this.row_actions_check(o)},row_actions_get_checkedIds:function(){return this.__checkedRows},row_actions_check:function(e,t){if(e.$checked=!0,e.$tr){e.$tr.find(".id:first").addClass("checked")}t||(this.__checkedRows.push(e.id),this._headCellIdButtonsState())},row_actions_uncheck:function(e,t){e.$checked&&(e.$checked=!1,e.$tr&&($tdId=e.$tr.find(".id"),$tdId.removeClass("checked"),$tdId.find(".chbox i").attr("class","fa fa-square-o")),t||(this.__checkedRows.splice(this.__checkedRows.indexOf(e.id),1),this._headCellIdButtonsState()))},row_actions_icons_add:function(e){"use strict";let n,i;n=this.tableRow.panel?t('<button class="btn btn-default edit"><i class="fa fa-th-large"/></button>').on("mouseleave",function(){return t(this).blur(),!1}).css("margin-left",2):t(),this.control.editing&&(i=t('<button class="btn btn-default btn-xxs dropdown"  tabindex="-1" style=" margin-left: 2px;"><i class="fa fa-caret-down" style="font-size: 10px; width: 7px;"/></button>'));let a=t('<button class="btn btn-default btn-xxs chbox"><i class="fa fa-square-o"/></button>'),o=t('<span class="btn-group-xxs">');e.append(o).append(" ").append(a),i&&o.append(i),n&&o.append(n)},row_actions_panel_show:function(e){let n=e.closest("tr"),i=this._getItemByTr(n),a=i.id;const o=this;let l=t('<div id="row-mobile-panel"></div>');!0!==this.tableRow.panel?l.append(t('<div class="menu-item"><i class="fa fa-th-large"/> Открыть панель</div>').css("color","gray")):l.append(t('<div class="menu-item row_panel"><i class="fa fa-th-large"/> Открыть панель</div>').attr("data-tr",a)),!0!==this.control.duplicating||this.f.blockduplicate||i.f.blockduplicate?l.append(t('<div class="menu-item"><i class="fa fa-clone"/> Дублировать</div>').css("color","gray")):l.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"/> Дублировать</div>').attr("data-tr",a)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?l.append(t('<div class="menu-item"><i class="fa fa-refresh"/> Пересчитать</div>').css("color","gray")):l.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"/> Пересчитать</div>').attr("data-tr",a)),!this.control.deleting||this.f.blockdelete||i.f&&(i.f.block||i.f.blockdelete)?l.append(t('<div class="menu-item"><i class="fa fa-times"/> Удалить</div>').css("color","gray")):l.append(t('<div class="menu-item row_delete"><i class="fa fa-times"/> Удалить</div>').attr("data-tr",a));let s=App.mobilePanel(i[this.mainFieldName].v||"id: "+a,l);l.on("click",".row_delete, .row_duplicate, .row_refresh, .row_panel",function(){let e=t(this);e.is(".row_delete")?o.rows_delete.call(o,a):e.is(".row_duplicate")?o.row_duplicate.call(o,a):e.is(".row_refresh")?o.row_refresh.call(o,a):e.is(".row_panel")&&o.rows_edit.call(o,n),s.close()})},table_modify:function(e,n,i){"use strict";let a=this,o=0,l=0,s=i?i.data("field"):void 0;if(n&&(o=a.dataSorted.indexOf(n)+1,l=a.dataSortedVisible.indexOf(n)+1),e.chdata){let i=e.chdata.deleted||[],r=[];if(e.chdata.rows&&(e.refresh&&e.chdata.rows&&Object.keys(a.data).forEach(function(t){void 0===e.chdata.rows[t]&&i.push(parseInt(t))}),t.each(e.chdata.rows,function(e,t){let n=a._getItemById(t.id);void 0===n?r.push(t):a.refreshRow(n.$tr,n,t)}),r.length&&(App.isEmpty(a.data)&&a._content&&a._content.find(".pcTable-noDataRow").remove(),t.each(r,function(e,t){t.$visible=!0,t.$checked=!1,o||!a.tableRow.with_order_field||a.tableRow.new_row_in_sort||(t.__inserted=!0),a.data[t.id]=t;let i=o,s=l;!t.__after||n&&n.id===t.__after||(i=a.dataSorted.indexOf(t.__after)+1,s=a.dataSortedVisible.indexOf(t.__after)+1),a.dataSorted.splice(i,0,t.id),a.dataSortedVisible.splice(s,0,t.id),o++,l++}),n&&!a.isMobile&&setTimeout(function(){t.each(r,function(e,t){a.row_actions_check(a.data[t.id])})},50))),i.length&&(t.each(i,function(e,t){a._deleteItemById.call(a,t)}),App.isEmpty(a.data)&&a._content&&0===a._content.find("."+this.noDataRowClass).length&&a._content.append(a._createNoDataRow())),i.length||r.length||e.chdata.nsorted_ids&&a.nSorted&&!Object.equals(e.chdata.nsorted_ids,a.dataSorted)){if(e.chdata.nsorted_ids&&a.nSorted){let t=a.dataSortedVisible;a.dataSorted=e.chdata.nsorted_ids,t.length===a.dataSorted.length?a.dataSortedVisible=a.dataSorted:(a.dataSortedVisible=[],a.dataSorted.forEach(function(e){-1!==t.indexOf(e)&&a.dataSortedVisible.push(e)}))}this.ScrollClasterized.insertToDOM(void 0,!0)}let c={};if(e.chdata.params&&t.each(e.chdata.params,function(e,t){["v","v_","f","e","h","c"].forEach(function(n){(void 0!==t[n]||a.data_params[e][n])&&(Object.equals(a.data_params[e][n],t[n])&&e!==s||(c[e]=!0,a.data_params[e][n]=t[n]))})}),e.chdata.fields&&t.each(e.chdata.fields,function(e,n){n.list&&!Object.equals(a.fields[e].list,n.list)&&(c[e]=!0,t.extend(a.fields[e],n))}),(e.chdata.params||e.chdata.fields)&&(a._refreshParamsBlock(c,!0),a._refreshFootersBlock(c,!0)),e.chdata.f){let t=e.chdata.f;["blockadd","blockdelete","blockorder","background","blockduplicate","block","tabletitle","rowstitle","fieldtitle"].forEach(function(e){if(t[e]||a.f[e])if("object"==typeof t[e]){if(!Object.equals(t[e],a.f[e])){let n=Object.assign({},a.f[e]);a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a,t[e],n)}}else t[e]!==a.f[e]&&(a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a,t[e]))})}App.isEmpty(a.data)&&a._content&&a._content.empty().append(this._createNoDataRow())}e.updated&&(a.model.tableData.updated=JSON.parse(e.updated),a._refreshTitle()),e.filtersString&&a._refreshFiltersBlock.call(a,e),a._headCellIdButtonsState()},rows_edit:function(e){"use strict";let t=this,n=this.row_actions_get_checkedIds();return e&&-1===n.indexOf(t._getItemByTr(e).id)&&(this.row_actions_check(t._getItemByTr(e)),n=this.row_actions_get_checkedIds()),t._row_edit.call(t,n.slice()),!1},row_dropdown:function(e){"use strict";let n=t("<div>"),i=this._getItemByTr(e.closest("tr")),a=i.id;!0!==this.control.duplicating||this.f.blockduplicate||i.f.blockduplicate?n.append(t('<div class="menu-item"><i class="fa fa-clone"/> Дублировать</div>').css("color","gray")):n.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"/> Дублировать</div>').attr("data-tr",a)),-1!==["calcs","globcalcs"].indexOf(this.tableRow.type)?n.append(t('<div class="menu-item"><i class="fa fa-refresh"/> Пересчитать</div>').css("color","gray")):n.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"/> Пересчитать</div>').attr("data-tr",a)),this.isCreatorView&&"cycles"===this.tableRow.type&&n.append(t('<div class="menu-item cycle_refresh color-danger"><i class="fa fa-refresh"/> Пересчитать цикл</div>').attr("data-tr",a)),!this.control.deleting||this.f.blockdelete||i.f&&(i.f.block||i.f.blockdelete)?n.append(t('<div class="menu-item"><i class="fa fa-times"/> Удалить</div>').css("color","gray")):n.append(t('<div class="menu-item row_delete"><i class="fa fa-times"/> Удалить</div>').attr("data-tr",a));let o=App.popNotify({isParams:!0,$text:n,element:e,container:this._container,trigger:"manual",placement:"bottom"});return t("#"+o).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",function(){n.remove()}).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px"),!1},__getCheckedRowsIds:function(e,n,i){"use strict";let a=this,o=this.row_actions_get_checkedIds();if(e&&-1===o.indexOf(e)){let t=a.data[e];this.row_actions_check(t),o=this.row_actions_get_checkedIds()}if(n){let e=!1;if(o.some(function(t){if(a.data[t].f&&(a.data[t].f.block||a.data[t].f[i]))return e=a.data[t],!0}),e){let n="";"id"!==a.mainFieldName&&(n=' "'+(n=e[a.mainFieldName]._v?e[a.mainFieldName]._v:e[a.mainFieldName].v)+'"');let i=t("<span>").html("Строка <b>id "+e.id+"</b>");if(""!==n){let e=i.find("b");e.text(e.text()+n)}return i.append(" заблокирована"),App.notify(i,"Действие не выполнено"),!1}}return o},row_refresh:function(e){"use strict";let t=this,n=this.__getCheckedRowsIds(e,!1),i=1===n.length?n[0]:null;if(n&&n.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_rows(n).then(function(n){t.table_modify.call(t,n),e.close(),t.row_actions_uncheck_all()})}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+n.length+" строк?",title:"Пересчет",buttons:e,onhidden:function(){1===n.length&&n[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}},cycle_refresh:function(e){"use strict";let t=this,n=this.__getCheckedRowsIds(e,!1);if(n&&n.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_cycles(n).then(function(n){t.table_modify.call(t,n),e.close(),t.row_actions_uncheck_all()})}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+n.length+" циклов?",title:"Пересчет",buttons:e,draggable:!0})}},row_duplicate:function(e){"use strict";let n=this,i=this.__getCheckedRowsIds(e,!1);if(i&&i.length){let a=[{label:"Дублировать",cssClass:"btn-danger",action:function(a){let o={},l=[],s=[];n.dataSortedVisible.forEach(function(e){-1!==i.indexOf(e)&&s.push(e)}),i=s;const r=function(t){n.model.duplicate(i,o,e).then(function(i){n.table_modify.call(n,i,e),t&&t.close(),a.close(),n.row_actions_uncheck_all()})};for(let e in n.fieldCategories.column){let t=n.fieldCategories.column[e];"unic"===t.type&&l.push(t.name)}if(l.length){let e,s=t('<table class="simpleTable"><thead><tr><td class="id">id</td></tr></thead><tbody></tbody></table>'),c=s.find("thead tr"),d=s.find("tbody");"id"!==n.mainFieldName&&("unic"!==(e=n.fields[n.mainFieldName]).type?c.append(t("<td></td>").text(e.title)):e=null);for(let e in l){let i=n.fields[l[e]];c.append(t("<td></td>").text(i.title))}for(let a in i){let s=i[a],r=n.data[s],c=t("<tr>");o[s]={},c.append(t('<td class="id"></td>').text(s)),e&&c.append(t("<td></td>").text(r[e.name].v));for(let e in l){let i,a=n.fields[l[e]],d=t('<td class="input"></td>'),f=t("<input>").val(r[a.name].v);o[s][a.name]=r[a.name].v,f.on("keyup",function(){let e=t(this).val();o[s][a.name]=e,i&&(clearTimeout(i),i=null),""!==e?i=setTimeout(function(){n.model.checkUnic(a.name,e).then(function(e){e.ok?d.addClass("ok"):d.removeClass("ok")})},300):a.required?d.removeClass("ok"):d.addClass("ok")}),d.html(f),c.append(d)}d.append(c)}let f=[{label:"Дублировать",cssClass:"btn-m btn-warning",action:function(e){r(e)}},{label:"Отмена",action:function(e){e.close(),a.close()}}];BootstrapDialog.show({message:s,title:"Заполните значения для уникальных полей",buttons:f,draggable:!0})}else r()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно дублировать "+i.length+" строк?",title:"Дублирование",buttons:a,draggable:!0})}},rows_delete:function(e){let t=this,n=this.__getCheckedRowsIds(e,!0,"blockdelete"),i=1===n.length?n[0]:null;if(n&&n.length){let e="Точно удалить "+n.length+" строк?",a="Удаление "+n.length+" строк?";if(1==n.length){let i="id-"+n[0];"id"!=t.mainFieldName&&(i=t.data[n[0]][t.mainFieldName],i="id-"+n[0]+' "'+(i.v_&&i.v_[0]?i.v_[0]:i.v)+'"'),e="Точно удалить строку "+i+"?",a="Удаление строки "+i+"?"}let o=[{label:"Удалить",cssClass:"btn-danger",action:function(e){e.close();const i=function(){t.model.delete(n).then(function(e){t.table_modify.call(t,e)})};t.tableRow.delete_timer>0?App.panelTimer(a,t.tableRow.delete_timer,i):i()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:"Удаление",buttons:o,onhidden:function(){1===n.length&&n[0]==i&&t.row_actions_uncheck_all()},draggable:!0})}}})}(0,jQuery),t.extend(App.pcTableMain.prototype,{_insertItem:null,_insertRow:null,_insertButtons:null,_currentInsertCellIndex:0,_addInsert:function(e){var t=this;this.control.adding&&(this._insertRow&&this._insertRow.length||(e&&(this._insertItem={},this.fieldCategories.column.forEach(function(n){e[n.name]&&(t._insertItem[n.name]={v:e[n.name]})})),this._insertRow=this._createInsertRow(null,0),this._insertButtonsChangeStatuses(),this._beforebody.prepend(this._insertRow),this._table.addClass("with-adding-row")))},_insertButtonsChangeStatuses:function(){this._insertRow?(this._insertButtons.find('[data-action="add"]').removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled")):(this._insertButtons.find('[data-action="add"]').addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"),0===this.dataSortedVisible.length&&this._table.find(".pcTable-noDataRow button").addClass("btn-warning").removeClass("btn-default").removeAttr("disabled"))},_InsertAddInsertBtnsPanel:function(e){let n,i=this,a={};a['<span id="saveInsertRow" tabindex="'+i.fieldCategories.column.length+'">Сохранить</span>']=function(){n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i,"close").always(function(){n.removeClass("onSaving")})})},a['<i class="fa fa-save"  tabindex="'+(i.fieldCategories.column.length+1)+'"/>']=function(){n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i).then(function(){n.removeClass("onSaving")})})},a['<i class="fa fa-paste"  tabindex="'+(i.fieldCategories.column.length+2)+'"/>']=function(){n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i,"notClean").then(function(){n.removeClass("onSaving")})})},a['<i class="fa fa-times" tabindex="'+(i.fieldCategories.column.length+3)+'"/>']=function(){i._closeInsertRow.call(i,t(this).closest("#"+o))},n=this._addRowPanel(o,e,a)},__insertRowActionsStack:[],__insertRowActions:function(e,t){"use strict";let n=this;-1!==["saveInsertRow","clickSourceButton"].indexOf(e)&&setTimeout(function(){let e;(e=n.model.getDefferedProcess())?e.then(t):t()},450)},_saveInsertRow:function(e){let n=this,i={},a=t.Deferred();return n.model.doAfterProcesses(function(){t.each(n._insertItem,function(e,t){"n"!==e&&(i[e]=t.v)}),n.model.add(i).then(function(t){switch(n.table_modify.call(n,t),n._currentInsertCellIndex=0,e){case"notClean":break;case"close":n._closeInsertRow();break;default:n._insertItem=null,n._insertRow.html('<td class="id"></td>'),n._createInsertRow(n._insertRow,0)}}).always(function(){a.resolve()})}),a.promise()},_addInsertRow:function(){let t=this;"cycles"===this.tableRow.type?t.model.add({}).then(function(n){n.firstTableId?e.location.href=e.location.pathname+"/"+n.chdata.rows[0].id+"/"+n.firstTableId:t.table_modify(n)}):t.isMobile?t._addInsertWithPanel():t._addInsert()},_getInsertButtons:function(){let n,i,a=this;return"cycles"===this.tableRow.type?i=n=function(){a.model.add({}).then(function(t){t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:a.table_modify(t)})}:(n=function(){a.isMobile?a._addInsertWithPanel():a._addInsert()},i=function(){a._addInsertWithPanel()}),this._insertButtons=t("<span>"),t('<button data-action="add" class="btn btn-sm btn-warning">Добавить</button>').width(80).on("click",n).appendTo(this._insertButtons),!a.isMobile&&this.tableRow.panel&&t('<button class="btn btn-warning btn-sm"><i class="fa fa-th-large"/></button>').on("click",i).appendTo(this._insertButtons).css("margin-left",5),this._insertButtons},_addInsertWithPanel:function(){let e=this;new EditPanel(e,BootstrapDialog.TYPE_PRIMARY,{}).then(function(t){t&&e.table_modify.call(e,t)})},_closeInsertRow:function(){this._insertPanel?this._insertPanel=null:(this._insertRow.find("td").each(function(){t(this).remove()}),this._insertRow.remove(),this._insertRow=null),this._insertItem=null,this._insertButtonsChangeStatuses(),this._currentInsertCellIndex=0,this._table.removeClass("with-adding-row")},_createInsertRow:function(e,n,i){var o=this,l=o._insertItem||(o._insertItem={});e||(this.insertRow=e=t('<tr class="InsertRow" style="height: 35px;"><td class="id"></td></tr>'),this._InsertAddInsertBtnsPanel(e),this.insertRow.editedFields={}),o._currentInsertCellIndex||(o._currentInsertCellIndex=0);let s={};t.each(o._insertItem,function(e,t){"n"!==e&&(s[e]=t.v)});let r=[];return o.fieldCategories.visibleColumns.forEach(function(e){r.push(e.name)}),o.model.checkInsertRow(s,Object.keys(this.insertRow.editedFields)).then(function(n){l=n.row,t.each(o.fieldCategories.column,function(t,n){if(!n.showMeWidth)return void(o._insertItem[n.name]=l[n.name]);let s=r.indexOf(n.name);var c=e.find("td:eq("+(s+1)+")");let d=o._insertItem[n.name],f=o._insertItem[n.name]&&o._insertItem[n.name].force;if(o._insertItem[n.name]=l[n.name],c.length){let t="n"===n.name||o._insertItem[n.name].f&&!0===o._insertItem[n.name].f.block;if(c.data("input")&&!t){n.name;let t=!1;t=!f&&(null===l[n.name].v&&""==d.v||Object.equals(l[n.name].v,d.v)&&!n.codeSelectIndividual),(void 0===d||!t||"data_src"==n.name||"comments"==n.type||n.code&&!n.codeOnlyInAdd)&&(o._createInsertCell.call(o,c,n,e,s,"td",o._createInsertRow),i===n.name&&o._colorizeElement(c,a))}else c.replaceWith(o._createInsertCell.call(o,null,n,e,s,"td",o._createInsertRow))}else e.append(c=o._createInsertCell.call(o,null,n,e,s,"td",o._createInsertRow))}),o._insertFocusIt.call(o)}),e},_createInsertCell:function(n,a,o,l,s,r){s=s||"td";n=n||t("<"+s+">");var c=this;a.code&&n.addClass("with-code"),void 0===c._insertItem[a.name]&&(c._insertItem[a.name]=null);let d=c._insertItem[a.name]&&c._insertItem[a.name].f||{};if(!a.insertable||!0===d.block){let e=c._insertItem[a.name];if(e&&(e=e.v),n.empty().append(t("<span>").html(d.text||a.getCellText(e,n,c._insertItem))),d.comment){let e=t('<i class="fa fa-info pull-right" style="padding: 3px;">');e.attr("title",d.comment),n.prepend(e)}else if(d.icon){let e=t('<i class="fa fa-'+d.icon+' pull-right" style="padding: 3px;">');n.prepend(e)}return n.on("contextmenu",()=>{let i=t("<div>"),o=t("<div>").text(e).appendTo(i);if(d.icon){let e=t('<i class="fa fa-'+d.icon+'" style="padding: 3px;">');o.prepend(e)}if(d.text){let e=t('<div><i class="fa fa-font" style="padding: 3px;"> </div>');e.append(d.text),i.append(e)}if(d.comment){let e=t('<div><i class="fa fa-info" style="padding: 3px;"> </div>');e.append(d.comment),i.append(e)}if(!c.isMobile){let e="right",a=i.offset().left,o=c._container.offset().left;c._container.width()-(a-o)-i.width()<(i.is(".text")?340:240)&&(e="left");let l={isParams:!0,$text:i,element:n,container:c._container,placement:e,trigger:"manual"};App.popNotify(l);let s="keyup.insertPanelDestroy",r="click.insertPanelDestroy";const d=function(){t("body").off(".selectPanelDestroy"),n.popover("destroy")};return t("body").on(r,function(e){0===t(e.target).closest("#selectPanel").length&&d()}).on(s,function(e){27==e.which&&d()}),!1}App.mobilePanel(a.title,i)}),n}a.help&&n.on("focus","input,button,select",function(e){let n=c._table.find("thead th #field-help-"+a.name),i=t(e.target);setTimeout(function(){n.trigger("open"),i.one("blur remove",function(){n.trigger("close")})},120)});var f=function(e){var t;try{t=a.getEditVal(e)}catch(t){return App.popNotify(t,e,"default"),null}return t},p=function(e,t){var i=f(e);null===i?c._insertFocusIt.call(c):(c._currentInsertCellIndex=l+1,a.isDataModified(i,c._insertItem[a.name].v)?(c.insertRow.editedFields[a.name]=!0,c._insertItem[a.name].v=i,!0===a.isPanelField&&c._createInsertCell.call(c,n,a,o,l,s,r),r.call(c,o,c._currentInsertCellIndex,a.name)):c._insertFocusIt.call(c))},u=function(e,t){setTimeout(function(){let t=e.closest("td");if(!t.length||!t.closest("tr").length)return!1;let n=f(e);null===n?c._insertFocusIt.call(c):a.isDataModified(n,c._insertItem[a.name].v)&&(c.insertRow.editedFields[a.name]=!0,c._insertItem[a.name].v=n,!0===a.isPanelField&&c._createInsertCell.call(c,t,a,o,l,s,r),r.call(c,o,c._currentInsertCellIndex,a.name))},150)},h=function(e,t){let n=e.closest("td");if(!n.length||!n.closest("tr").length)return!1;let d=f(e),p=c._insertItem[a.name].v+"";a.isDataModified(d,p)&&(c._createInsertCell(n,a,o,l,s,r),c._colorizeElement(n,i))};let m=a.getEditElement(n.data("input"),c._insertItem[a.name],c._insertItem,p,h,u);if(n.on("click focus","input,button,select",function(e){c._currentInsertCellIndex=l}),n.on("click focus",function(){c._currentInsertCellIndex=l}),m.isAttached()||n.html(m).data("input",m),a.code&&!a.codeOnlyInAdd){let e=n.find(".fa-hand-paper-o");this.insertRow.editedFields[a.name]&&c._insertItem[a.name].h?0===e.length&&(e=t('<i class="fa fa-hand-paper-o pull-right">').on("click",()=>{delete this.insertRow.editedFields[a.name],r.call(c,o,c._currentInsertCellIndex+1,a.name)}),n.prepend(e).addClass("ins-handed")):(1===e.length&&e.remove(),n.removeClass("ins-handed"))}if("select"===a.type&&2===a.changeSelectTable){n.addClass("with-source-add-button");let i=t('<button class="btn btn-default btn-sm source-add" tabindex="-1"><i class="fa fa-plus"></i></button>');n.prepend(i);let l=function(){let i={},l=c._insertItem;t.each(l,function(e,t){"$"!==e.substring(0,1)&&(i[e]=t)});i[a.name]=null;let s=0;return t(e.top.document.body).on("pctable-opened.select-add-"+a.name,function(){s++}).on("pctable-closed.select-add-"+a.name,function(e,i){s--;let d=i&&"insert"===i.method&&i.json&&i.json.chdata&&i.json.chdata.rows;if(0===s||d){let e=m;delete a.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),d&&(a.multiple?l[a.name].v.push(Object.keys(i.json.chdata.rows)[0]):l[a.name].v=Object.keys(i.json.chdata.rows)[0]),e.replaceWith(m=a.getEditElement(e,l[a.name],l,p,h,u)),t("body").off(".select-add-"+a.name),n.data("input",m),r.call(c,o,c._currentInsertCellIndex,a.name)}}),c.model.selectSourceTableAction(a.name,i),!1};i.on("click",function(){c.__insertRowActions("clickSourceButton",l)})}return n},_insertFocusIt:function(e){let n=this;if(!e)return setTimeout(function(){n._insertFocusIt.call(n,1)},10),!1;let i=!0,a=!!this._insertPanel,o=this.insertRow;if(a){if(!n._insertPanel)return!1;o=n._insertPanel.$modalBody}if(!o||!o.length)return!1;if(t.each(n.fieldCategories.visibleColumns,function(e,t){if(n._currentInsertCellIndex==e)return!t.insertable||n._insertItem&&n._insertItem[t.name]&&n._insertItem[t.name].f&&!0===n._insertItem[t.name].f.block?void n._currentInsertCellIndex++:(a?t.focusElement(o.find(".cell:eq("+e+")").data("input")):t.focusElement(n._getTdByColumnIndex(o,e+1).data("input")),i=!1,!1)}),i)if(a){n._insertPanel.indexedButtons[Object.keys(n._insertPanel.indexedButtons)[0]].focus()}else t("#saveInsertRow").parent().focus()}}),function(){let n=!1;t.extend(App.pcTableMain.prototype,{_rerenderColumnsFooter:function(){let e=this._createFootersBlock();this._footersBlock.replaceWith(e[0]),this._footersBlock=e[0]},_rerendParamsblock:function(){this._paramsBlock.replaceWith($block=this._createParamsBlock()),this._paramsBlock=$block,this._refreshParamsBlock()},_rerendFiltersBlock:function(){this._filtersBlock.replaceWith($block=this._createFiltersBlock()),this._filtersBlock=$block,this._refreshFiltersBlock(this.data_params)},_rerendFooters:function(){let e=this._createFootersBlock();this._footersSubTable.replaceWith(e[1]),this._footersSubTable=e[1],this._footersBlock.replaceWith(e[0]),this._footersBlock=e[0],this._refreshFootersBlock()},_renderTable:function(){let n=this;this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._table.append(this._createHead()).append(this._createFirstBody()).append(this._createBody()).append(this._createAfterBody());let i=this._createFootersBlock();this._footersBlock=i[0],this._footersSubTable=i[1],this._table.append(this._footersBlock),this._popovers=t('<div class="popovers">'),1===this.fieldCategories.column.length&&n._container.addClass("no-fields");let a=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");a.append(this._createBeforeSpace()).append(this._createTableText()),this.isCreatorView&&a.append(this._refreshHiddenFieldsBlock()),a.append(this._paramsBlock=this._createParamsBlock());let o=t('<div class="pcTable-rowsWrapper">').appendTo(a);o.append(this._createRowsTitle(o)).append(this._createFiltersBlock()).append(this._rowsButtons()).append(this._innerContainer),a.append(this._footersSubTable).append(this._popovers),n._container.height(e.innerHeight-n._container.offset().top-20),this.addScrollsRules(),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},_refreshHiddenFieldsBlock:function(){let e=this._hiddenFieldsBlock();return this.HiddenFieldsBlock&&this.HiddenFieldsBlock.replaceWith(e),this.HiddenFieldsBlock=e,this.HiddenFieldsBlock},_hiddenFieldsBlock:function(){let e,n,i=this,a=0,o=t('<div class="pcTable-hiddenFieldsTables">'),l=0;if(this.beforeSpaceHide||!this._hideHell_storage.getOpened.call(this))return o;let s=this._container.width()-100;return t.each(i.hidden_fields||[],function(r,c){a++;let d=c.width>0?c.width:100;(0===l||s<l+d)&&(e&&e.width(l),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),o.append(e),l=0,n=e.find("thead tr")),n.append(i._createHeadCell(r,c)),l+=c.width}),i.isCreatorView&&Object.keys(i.fields).forEach(function(r,c){let d=i.fields[r];if(d.showInWeb&&d.showMeWidth<1&&"n"!==d.name){a++;let r=d.width>0?d.width:100;(0===l||s<l+r)&&(e&&e.width(l),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),o.append(e),l=0,n=e.find("thead tr")),n.append(i._createHeadCell(c,d)),l+=d.width}}),e&&e.width(l),a?o:t('<div class="pcTable-hiddenFieldsTables">')},_clickstoCopyMe:function(){this._container.on("click",".copy_me",function(){let e=t(this);return!e.data("clicked")&&(e.data("clicked",!0),e.width(e.width()),e.data("text")?App.copyMe(e.data("text")):App.copyMe(e.text()),e.button("copied"),setTimeout(function(){e.button("reset"),e.removeData("clicked")},2e3),e.blur(),!1)})},_clicksToCodeView:function(){let n=this;this._container.on("click","th .roles",function(){let i=t(this);if(i.hasClass(".fa-sun-o")||i.hasClass("fa-certificate")){let a,o=n._getFieldBytd(i.closest("th")),l=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');BootstrapDialog.show({message:l,type:null,title:"Просмотр кода поля "+o.title,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){mirror.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"})},onshown:function(t){a=CodeMirror(l.get(0),{mode:"totum",value:o.code[0],theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t,readOnly:!0}),mirror.table&&(a.table=mirror.table);let n=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=n+"px",l.find(".CodeMirror").css("min-heught",n),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e})}})}})},_seeCalcucatedValData:function(){var e=this;this._container.on("mouseover","td .fa-hand-paper-o",function(){if(!e.isMobile){var n=t(this),i=n.closest("td");if(i.closest("tr").is(".InsertRow"))return!1;var a=e._getItemBytd(i),o=e._getFieldBytd(i),l=t("<div>");let s="";null===a[o.name].c||""===a[o.name].c||void 0===a[o.name].c?s="":"select"===o.type?o.multiple?t.each(a[o.name].c,function(e,t){""!==s&&(s+=", "),s+=o.getElementString(a[o.name].c[e],a[o.name].c_[e])}):s=o.getElementString(a[o.name].c,a[o.name].c_):"object"==typeof(s=o.getCellText(a[o.name].c,null,a,e))&&(s=s.text()),l.append(t("<div>Расчетное значение: </div>").append(t("<code>").text(s))),n.one("mouseout",function(){l.length&&(l.remove(),l=null)}),setTimeout(function(){l&&l.length&&App.popNotify(l,n)},500)}})},_seeSelectPreview:function(){var e=this;this._container.on("mouseover",".select-with-preview li",function(n){let i=t(this),a=setTimeout(function(){if(i.is(":hover")){let t=i.find("span.select-with-preview");e.fields[t.data("field")]&&e.fields[t.data("field")].previewPanel.call(e.fields[t.data("field")],t,i)}},300);i.one("mouseout",function(){a&&clearTimeout(a)})})},_getFavoriteStar:function(){let e=this.tableRow.__is_in_favorites=this.tableRow.__is_in_favorites||!1,n=t("#favorite-start"),i=this;return null===e?t():(0===n.length&&(n=t('<button class="btn btn-default btn-sm" id="favorite-start"></button>').on("click",function(){i.model.setTableFavorite(!n.is(".stared")).then(function(e){i.tableRow.__is_in_favorites=e.status,i._getFavoriteStar.call(i)})})),e?n.addClass("stared").text("★"):n.removeClass("stared").text("☆"),n)},_createBeforeSpace:function(){let n,i=this;if(this._beforeSpace=t('<div class="pcTable-beforeSpace">'),!i.beforeSpaceHide){i.LogButton=t(),n=t('<div class="pcTable-topButtons">');let e=t("#TOTUM_FOOTER");if(e.length&&n.append(e),i.isCreatorView){let a=t('<div class="creator-log-buttons">'),o=t('<button class="btn btn-danger btn-sm"><i class="fa" style="width: 12px"></i> Показать логи</button>').appendTo(a).on("click",function(){let e;const n=function(){let n=[];e.find("input:checked").each(function(e,i){n.push(t(i).attr("name"))}),n.length>0?o.find("i").attr("class","fa fa-check-square-o"):o.find("i").attr("class","fa fa-square-o"),t.cookie("pcTableLogs",JSON.stringify(n),{path:"/"}),i.FullLOGS=[],i.LOGS={},o.popover("destroy")};if(o.is("[aria-describedby]"))e=t("#"+o.attr("aria-describedby")),n();else{let a=t.cookie("pcTableLogs")||"[]";a=JSON.parse(a),(e=t("<div>")).append('<div><input type="checkbox" name="c"/> Код</div>'),e.append('<div><input type="checkbox" name="a"/> Код-действия</div>'),e.append('<div><input type="checkbox" name="s"/> Селекты</div>'),e.append('<div><input type="checkbox" name="f"/> Форматирование</div>'),e.append('<div><input type="checkbox" name="recalcs"/> Пересчеты и селекты</div>');let l=t('<button class="btn btn-xs"><i class="fa fa-table"></i></button>').on("click",function(){i.FieldLOGS?i.model.calcFieldsLog(JSON.stringify(i.FieldLOGS),i.FieldLOGSName||"Расчет вывода таблицы"):App.notify("Лог расчета полей пуст")});e.append(t('<div><input type="checkbox" name="flds"/> Время расчета полей </div>').append(l)),e.append('<div style="padding-top: 10px;"><button class="btn btn-sm btn-default">Применить</button></div>'),e.find("input").each(function(e,n){n=t(n),-1!==a.indexOf(n.attr("name"))&&n.prop("checked","checked")}),e.on("click","button",function(){n()}),o.popover({trigger:"manual",placement:"bottom",content:e,html:!0,animation:!1,container:i._container,onhide:function(){}}).popover("show")}}),l=o.find("i"),s=t.cookie("pcTableLogs")||"[]";(s=JSON.parse(s)).length>0?l.addClass("fa-check-square-o"):l.addClass("fa-square-o");let r=t('<button class="btn btn-danger btn-sm">Лог</button>').appendTo(a);i.LogButton=r,r.on("click",function(){i.FullLOGS&&0!==i.FullLOGS.length?App.logOutput(i.FullLOGS):App.logOutput("Лог пуст. Включите логирование и перегрузите страницу")}),e.length?e.append(a):a.appendTo(n),t('<button class="btn btn-danger btn-sm"><i class="fa fa-eraser" style="width: 13px"></i></button>').on("click",function(){i.FullLOGS=[],i.LOGS={}}).appendTo(a)}}let a=t('<span class="common-table-title">');if(!i.isMobile){a.append(this.fieldsHiddingGetButton(!0));t('<button class="btn btn-default btn-sm"><i class="fa fa-print"></i></button>').on("click",function(){i._print.call(i)}).appendTo(a);if(i.withCsvButtons){let e=t('<button class="btn btn-default btn-sm">CSV-экспорт</button>').on("click",function(){i._csvExport.call(i)});a.append(e)}if(i.withCsvEditButtons&&this.control.editing){let e=t('<button class="btn btn-default btn-sm">CSV-импорт</button>').on("click",function(){i._csvImportClick.call(i)});a.append(e)}}if(this.isAnonim||i.beforeSpaceHide||a.append(this._getFavoriteStar()),this.isCreatorView&&this.isMain){let a=t('<div class="creator-buttons">');t('<button class="btn btn-default btn-xxs field_name copy_me" data-copied-text="Скопировано"/>').text(this.tableRow.name).appendTo(a),t('<button class="btn btn-danger btn-xxs" title="Редактировать настройки таблицы"/>').html('<i class="fa fa-pencil-square-o"/>').on("click",function(){new EditPanel(1,BootstrapDialog.TYPE_DANGER,{id:i.tableRow.id}).then(function(t){t&&e.location.reload(!0)})}).appendTo(a);let o={fl_name:[this.tableRow.id]};if(t('<a href="/Table/'+this.Tables.branchId+"/"+this.Tables.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть список таблиц"/>').html('<i class="fa fa-external-link"/>').appendTo(a),o={f_table_categories:this.tableRow.category,f_table:this.tableRow.id},this.tableRow.__version&&(o.fl_version=this.tableRow.__version),t('<a href="/Table/'+this.Tables.branchId+"/"+this.TableFields.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть состав таблиц"/>').html('<i class="fa fa-external-link-square"/>').appendTo(a),"calcs"===this.tableRow.type){a.append(" ");let e=t('<a href="/Table/'+this.TablesVersions.branchId+"/"+this.TablesVersions.id+"/?"+t.param({f:this.TablesVersions.version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Создание версий таблиц"><i class="fa fa-code-fork"></i></a>');a.append(e),a.append(" "),e=t('<a href="/Table/'+this.TablesCyclesVersions.branchId+"/"+this.TablesCyclesVersions.id+"/?"+t.param({f:this.TablesCyclesVersions.version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Изменение версий таблиц цикла"><i class="fa fa-random"></i></a>'),a.append(e)}let l=t('<div class="color-danger creator-table-title">'+ +this.tableRow.sort+' <i class="'+App.tableTypes[this.tableRow.type].icon+'"/> '+App.tableTypes[this.tableRow.type].title+"</div>");a.append(l),"calcs"===this.tableRow.type&&l.append(" / Версия "+this.tableRow.__version+" / Цикл "+this.cycle);t('<button class="btn btn-danger btn-sm" id="hide-hell" disabled><i class="fa fa-times"></i></span></button>').on("click",function(){i._hideHell_storage.switchOpened.call(i)}).appendTo(a);a.appendTo(n);t('<button class="btn btn-danger btn-sm">Добавить поле</span></button>').width(113).on("click",function(){let t={table_id:{v:i.tableRow.id}};i.tableRow.__version&&(t.version={v:i.tableRow.__version}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,t).then(function(t){t&&e.location.reload(!0)})}).appendTo(a);a.appendTo(n)}if(i.beforeSpaceHide?this._beforeSpace_title=t('<div class="pcTable-title"><span class="bttns"/></div>').prependTo(this._beforeSpace):(this._beforeSpace.append(n),this._beforeSpace_title=t('<div class="pcTable-title"><span class="title"/><span class="bttns"/><div class="updated"/></div>').prependTo(this._beforeSpace)),this._beforeSpace_title.find(".bttns").append(a),this.tableRow.description){let e=t('<a class="btn btn-default btn-sm"><i class="fa fa-info"/></a>'),n=t('<div class="table-description"/>').html(this.tableRow.description);e.appendTo(a);let i="table_description_switcher"+this.tableRow.id,o=localStorage.getItem(i)||localStorage.setItem(i,"1")||localStorage.getItem(i);const l=t=>{switch(t&&(o="1"===o?"0":"1"),o){case"1":n.show(),e.removeClass("btn-warning").addClass("btn-default");break;default:n.hide(),e.addClass("btn-warning").removeClass("btn-default")}localStorage.setItem(i,o),t&&this.ScrollClasterized.insertToDOM(0,!0)};l(),e.on("click",l),this._beforeSpace.append(n)}return this._beforeSpace},__$rowsButtons:null,_rowsButtons:function(){let e,n=this;if(this.__$rowsButtons?e=this.__$rowsButtons.empty():(e=t('<div class="pcTable-buttons">'),this.__$rowsButtons=e),this.fieldCategories.column.length){if(this.control.adding&&!this.f.blockadd){let t=n._getInsertButtons();e.append(t)}let i=t('<button class="btn btn-default btn-sm" style="margin-left: 5px;" disabled>Сбросить <span class="fa fa-filter"></span></button>').width(82).on("click",function(){setTimeout(function(){n.filtersEmpty.call(n)},50)});e.append(i),this.filtersClearButton=i}if(this.f.tablecomment){let i=t('<div class="pcTable-tableComment">').on("click",function(){App.panel("Комментарий строчной части таблицы",n.f.tablecomment)});e.prepend(i.text(this.f.tablecomment)),setTimeout(function(){let e=0;e+=i.parent().find(">span").width()||0,e+=90,i.css("width","calc(100% - "+e+"px)")},1)}return e},_refreshContentTable:function(e,t){let n=this._content;t=t||!1,n.data("state","refreshing");App.fullScreenProcesses.showCog();this.ScrollClasterized.insertToDOM(0,t,e),App.fullScreenProcesses.hideCog(),n.data("state","ready"),n.trigger("refreshed"),this._popovers.empty()},_refreshTitle:function(){if(!this.beforeSpaceHide&&(this._beforeSpace_title.find(".title").text(this.f.tabletitle||this.tableRow.title),this.model.tableData&&this.model.tableData.updated)){let e;this.isAnonim||(e=moment(this.model.tableData.updated.dt,"YYY-MM-DD HH:mm").format("DD.MM HH:mm")+" (code: "+this.model.tableData.updated.code+")");let n=t('<div class="small">').text(e);this.tableRow.__blocked?n.append('<div class="">Блокирована'+(this.tableRow.license_error?": "+this.tableRow.license_error:"")+"</div>"):!1===this.control.editing&&n.append('<div class="">Только чтение</div>'),this._beforeSpace_title.find(".updated").html(n)}},_createTableText:function(){return this.tableText=t('<div class="pcTable-tableText"></div>').text(this.f.tabletext),this.tableText},_refreshTableText:function(){this.tableText.text(this.f.tabletext)},_createRowsTitle:function(e){let n=this;n.__sectionsCloses=n.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}");let i=n.tableRow.id+"/"+(n.tableRow.__version||0)+"/rows",a=t('<div class="pcTable-rowsTitle"></div>').on("click","i, span",function(){let e=t(this).closest(".pcTable-rowsWrapper");e.is(".pcTable-rowsClose")?(e.removeClass("pcTable-rowsClose"),delete n.__sectionsCloses[i]):(e.addClass("pcTable-rowsClose"),n.__sectionsCloses[i]=1),n.ScrollClasterized.insertToDOM(0,!0),localStorage.setItem("sectionCloses",JSON.stringify(n.__sectionsCloses))});return e.is(".pcTable-rowsClose")&&!n.__sectionsCloses[i]?e.removeClass("pcTable-rowsClose"):!e.is(".pcTable-rowsClose")&&n.__sectionsCloses[i]&&e.addClass("pcTable-rowsClose"),this.f.rowstitle?a.html(t("<span>").text(this.f.rowstitle)).prepend('<i class="fa">'):a.text(),a},_createFiltersBlock:function(){let n=this;t("<div>");if(this._filtersBlock=t("<div>"),this._filtersBlock.addClass("pcTable-filtersTables pcTable-section"),n.fieldCategories.filter.length){let i,a,o;this.___createClosedSection(this._filtersBlock,t('<div class="pcTable-sectionTitle"><span>Фильтры</span></div>').appendTo(this._filtersBlock),"flt"),this._filtersBlock.addClass("pcTable-filtersTables");let l,s=0,r=this._container.width()-100;const c=function(){if(i){const l=function(){let i;i=t(this).is(".eraser")?"?":"?"+t.param({f:n._filtersBlock.data("cryptoFilters")||n.filterDataCrypted}),n.isMobile&&(i+="#go-buttons");const a=function(){e.location.href=i};return setTimeout(function(){n.model.doAfterProcesses(a)},500),!0};if(n.isMobile)i.after(t('<table class="pcTable-filtersTable" id="go-buttons"><tr><td><button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go "><i class="fa fa-eraser"></i></button></td></tr></td></table>').on("click",".button-go",l));else{a.append('<th style="width: 69px;"></th>');let e=t('<td class="buttons-go">').html('<button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go"><i class="fa fa-eraser"></i></button>').appendTo(o);i.width(s+69),e.on("click",".button-go",l)}}},d=(e,d)=>{d.hidden||((n.isMobile||0===s||r<s+d.width||d.tableBreakBefore)&&(n.isMobile||c(),i=t("<table class='pcTable-filtersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>").appendTo(this._filtersBlock),s=0,a=i.find("thead tr"),o=i.find("tbody tr")),void 0!==d.panelColor&&(l=d.panelColor),a.append(n._createHeadCell(e,d,l)),t("<td>").attr("data-field",d.name).appendTo(o),s+=d.width)};t.each(n.fieldCategories.filter,d),c()}return this._filtersBlock},_refreshFiltersBlock:function(e){let n=this;(e=e||{}).params?(t.each(n.fieldCategories.filter,function(t,i){n.data_params[i.name]=e.params[i.name]}),n._filtersBlock.data("cryptoFilters",e.filtersString)):n.filterData||(n.filterData={},t.each(n.fieldCategories.filter,function(e,i){n.filterData[i.name]=t.extend(!0,{},n.data_params[i.name])}),n.model.addFiltersData({filters:n.filterDataCrypted}));let i=[],a=[];return t.each(n.fieldCategories.filter,function(e,t){if(t.hidden)return;let o=n._createCell(n.data_params,t);n._filtersBlock.find('td[data-field="'+t.name+'"]').replaceWith(o),Object.equals(n.data_params[t.name].v,n.filterData[t.name].v)||i.push(o),"select"!==t.type||!n.data_params[t.name].v||"*NONE*"!==n.data_params[t.name].v&&"*NONE*"!==n.data_params[t.name].v[0]||a.push(o)}),i.length>0?(i.forEach(function(e){e.addClass("warning-backg")}),n._filtersBlock.removeClass("with_danger").addClass("with_changed")):a.length>0?(a.forEach(function(e){e.addClass("danger-backg")}),n._filtersBlock.removeClass("with_changed").addClass("with_danger")):(n._filtersBlock.removeClass("with_danger, with_changed"),n._filtersBlock.find(".danger-backg, .warning-backg").removeClass("danger-backg, warning-backg")),this._filtersBlock},_createParamsBlock:function(){let e=t("<div>"),n=this;if(n.fieldCategories.param){let i,a,o;e.addClass("pcTable-paramsTables");let l,s,r=0,c=this._container.width()-100,d="";t.each(n.fieldCategories.param,function(f,p){void 0!==p.panelColor&&(l=p.panelColor),void 0!==p.sectionTitle&&(d=p.sectionTitle),p.showMeWidth&&((n.isMobile||0===r||c<r+p.showMeWidth||p.tableBreakBefore)&&(i&&!n.isMobile&&i.width(r),i=t("<table class='pcTable-paramsTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>"),n.isMobile&&"button"===p.type&&(i=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),s&&!d||(s=t('<div class="pcTable-section">').appendTo(e),d&&n.___createClosedSection(s,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(d)).appendTo(s),"p")),d="",s.append(i),r=0,a=i.find("thead tr"),o=i.find("tbody tr")),a.append(n._createHeadCell(f,p,l)),o.append('<td data-field="'+p.name+'">'),r+=p.showMeWidth)}),i&&!n.isMobile&&i.width(r)}return e},_refreshParamsBlock:function(e,n){var i=this;return i.fieldCategories.param&&t.each(i.fieldCategories.param,function(t,o){if(!o.showMeWidth||e&&!0!==e[o.name])return!0;let l=i._createCell(i.data_params,o);i._paramsBlock.find('td[data-field="'+o.name+'"]').replaceWith(l),n&&i._colorizeElement(l,a)}),this._paramsBlock},_createFootersBlock:function(){let e,n,i=this;if(i.fieldCategories.footer){e=t("<tbody class='pcTable-footers'></tbody>"),n=t("<div>"),i.columnsFooters={};var a=0;t.each(i.fieldCategories.footer,function(e,t){t.showMeWidth&&(t.column||(t.column=""),i.columnsFooters[t.column]||(i.columnsFooters[t.column]=[]),i.columnsFooters[t.column].push(t),t.column&&a<i.columnsFooters[t.column].length&&(a=i.columnsFooters[t.column].length))});for(var o=t(),l=0,s=0;l<a;){var r=t('<tr><td class="id"></td></tr>'),c=t('<tr><td class="id"></td></tr>').data("pctableitemid","footers").data("pctablettemtndex","footers"+s++);t.each(i.fieldCategories.column,function(e,n){if(n.showMeWidth){let a=t("<td>");if(!i.columnsFooters[n.name]||!i.columnsFooters[n.name][l])return a.attr("rowspan",2),r.append(a),void a.addClass("footer-empty");if(a=i._createHeadCell(e,i.columnsFooters[n.name][l],i.columnsFooters[n.name][l].panelColor).addClass("footer-name"),r.append(a),i.columnsFooters[n.name]&&i.columnsFooters[n.name][l]){let e=i.columnsFooters[n.name][l],t=i._createCell(i.data_params,e);t.attr("data-field",e.name),c.append(t)}}}),o=(o=o.add(r)).add(c),l++}e.html(o);let d,f,p,u,h,m=0,b=this._container.width()-100,g="";t.each(i.columnsFooters[""],function(e,a){void 0!==a.panelColor&&(u=a.panelColor),void 0!==a.sectionTitle&&(g=a.sectionTitle),a.showMeWidth&&((i.isMobile||0===m||b<m+a.showMeWidth||a.tableBreakBefore)&&(d&&!i.isMobile&&d.width(m),d=t("<table class='pcTable-footersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>"),i.isMobile&&"button"===a.type&&(d=t("<table class='pcTable-paramsTable'><tbody><tr></tr></tbody></table>")),h&&!g||(h=t('<div class="pcTable-section">').appendTo(n),g&&i.___createClosedSection(h,t('<div class="pcTable-sectionTitle"></div>').html(t("<span>").text(g)).appendTo(h),"f")),g="",h.append(d),m=0,f=d.find("thead tr"),p=d.find("tbody tr")),f.append(i._createHeadCell(e,a,u)),p.append('<td data-field="'+a.name+'">'),m+=a.showMeWidth)}),d&&!i.isMobile&&d.width(m)}return[e,n]},___createClosedSection(e,n,i){const a=this;let o=e.parent().find("div").index(e)+2,l=a.tableRow.id+"/"+(a.tableRow.__version||0)+"/"+i+"/"+o;a.__sectionsCloses=a.__sectionsCloses||JSON.parse(localStorage.getItem("sectionCloses")||"{}"),a.__sectionsCloses[l]&&e.addClass("closed"),t('<span class="btn-i"><i class="fa"></i></span>').prependTo(n),n.on("click","i, span",function(){let e=t(this).closest(".pcTable-section");e.is(".closed")?(e.removeClass("closed"),delete a.__sectionsCloses[l]):(e.addClass("closed"),a.__sectionsCloses[l]=1),localStorage.setItem("sectionCloses",JSON.stringify(a.__sectionsCloses))})},_refreshFootersBlock:function(e,n){let i=this,o=i._footersBlock.add(i._footersSubTable);return i.fieldCategories.footer&&t.each(i.fieldCategories.footer,function(t,l){if(!l.showMeWidth||e&&!0!==e[l.name])return!0;let s=i._createCell(i.data_params,l);s.attr("data-field",l.name),o.find('td[data-field="'+l.name+'"]').replaceWith(s),n&&i._colorizeElement(s,a)}),this._paramsBlock},_createHead:function(){return this._header=t("<thead>").append(this._createHeadRow()),this._header},_refreshHead:function(){return this._header.empty().append(this._createHeadRow()),this._header},_createFirstBody:function(){return this._beforebody=t("<tbody class='beforeRows'>").append('<tr class="extra-clasters">'),this.extraClastersTop=this._beforebody.find(".extra-clasters"),this._beforebody},_createAfterBody:function(){return this._afterbody=t("<tbody class='afterRows'>").append('<tr class="extra-clasters">'),this.extraClastersBottom=this._afterbody.find(".extra-clasters"),this._afterbody},_createBody:function(){return this._content=t("<tbody class='dataRows'>"),this._content},_createHeadRow:function(){let e=this,n=t("<tr>");e._createHeadCellId().appendTo(n);let i,a=n.find(".id").width();return t.each(this.fieldCategories.visibleColumns,function(t,o){let l;void 0!==o.panelColor&&(i=o.panelColor),(l="n"===o.name?e._createHeadCellNo():e._createHeadCell(t,o,i)).appendTo(n),a+=parseInt(o.showMeWidth)}),this.tableWidth=a,this._table.width(this.tableWidth),n},_createHeadCellId:function(){let e=this,n=t('<th class="id"><span>id</span></th>');if(null===e.tableRow.order_field||"id"===e.tableRow.order_field){let t=n.find("span").css("font-weight","bold");e.isCreatorView&&(!0===e.tableRow.order_desc?t.append(' <i class="fa fa-sort-amount-desc roles"></i>'):t.append(' <i class="fa fa-sort-amount-asc roles"></i>'))}let i=t('<div class="pcTable-filters"></div>'),a=t('<button class="btn btn-default btn-xxs"><i class="fa fa-sort"></i></button>').on("click",function(){e.fieldCategories.visibleColumns.some(function(e){return"n"===e.name})?(e.fieldsHiddingHide.call(e,"n"),a.removeClass("btn-warning")):(e.fieldsHiddingHide.call(e,"n",!0),a.addClass("btn-warning"))});if(e.fieldCategories.visibleColumns.some(function(e){return"n"===e.name})&&a.addClass("btn-warning"),e.isMobile);else{let t=this._getIdFilterButton();i.append(a).append(" ").append(t).append(" ").append(e._idCheckButton)}return n.append(this._checkStatusBar),n.append(i),e._idCheckButton.off().on("click",function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else{for(let t=0;t<e.dataSortedVisible.length;t++){let n=e.dataSortedVisible[t],i=e._getItemById(n);e.row_actions_check.call(e,i,!0)}e.__checkedRows=e.dataSortedVisible.slice()}e._headCellIdButtonsState()}),i=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"/></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"/></button></div>'),n.append(i),this._refreshCheckedStatus(),n},_getIdFilterButton:function(){let e,n=this,i=t("<span>");return e=t('<button class="btn btn-xxs btn-filter" id="checkS"><span class="fa fa-circle-o"></span></button>').on("click",function(){e.is(".btn-warning")?(e.addClass("btn-default").removeClass("btn-warning").find("span").removeClass("fa-circle").addClass("fa-circle-o"),delete n.filters.id,i.find(".btn-filter:not(#checkS)").parent().replaceWith(n.__getFilterButton("id"))):(e.removeClass("btn-default").addClass("btn-warning").find("span").removeClass("fa-circle-o").addClass("fa-circle"),n.filters.id=n.__checkedRows.slice().map(function(e){return e.toString()})),n.__applyFilters(),n._headCellIdButtonsState()}),n.filters.id&&n.filters.id.length?e.addClass("btn-warning").removeClass("btn-default"):e.addClass("btn-default").removeClass("btn-warning"),i.append(e),i.append(n.__getFilterButton("id")),i},_createHeadCellNo:function(){let e=this,n=e.fields.n,i=t('<span class="cell-title">').text(n.title?n.title:n.name).attr("title",n.title),a=t('<button class="btn btn-default btn-xxs" style="width: 45px"><i class="fa fa-save"></i></button>'),o=t('<th class="n">').width(n.userWidth||n.width).append(i);return e.isCreatorView&&("n"===e.tableRow.order_field&&(!0===e.tableRow.order_desc?i.before('<i class="fa fa-sort-amount-desc roles"></i>'):i.before('<i class="fa fa-sort-amount-asc roles"></i>')),i.before("<br/>")),e._orderSaveBtn=a,!e.tableRow.with_order_field||e.f.blockorder||e.tableRow.__blocked?(a.prop("disabled",!0),this._table.addClass("no-correct-n-filtered")):a.on("click",function(){e.reOrderRowsSave.call(e)}),o.append(t('<div class="pcTable-filters">').append(a))},_createHeadCell:function(i,a,o){let l=this,s=a.showMeWidth||a.width||100;"column"!==a.category&&s&&l.isMobile&&(s=100);let r=t("<th>").data("field",a.name);l.isMobile&&("column"===a.category&&a.editable&&(s+=20),s+=20),s&&r.width(s),l.fields[a.name]&&(l.fields[a.name].$th=r),void 0!==o&&""!==o&&r.css("background-color",o),a.webRoles&&1===a.webRoles.length&&"1"===a.webRoles[0].toString()&&r.addClass("admin-see"),"footer"===a.type&&a.column&&(r=t("<td>"));let c=Object.getPath(l.f,["fieldtitle",a.name],a.title?a.title:a.name),d=t('<span class="cell-title">').text(c).attr("title",c).appendTo(r);if(l.isCreatorView){const e=function(e){let t="";switch(e){case"param":t="fa-hand-o-up";break;case"column":t="fa-hand-o-right";break;case"filter":t="fa-hand-o-left";break;case"footer":t="fa-hand-o-down"}return t};!a.isHiddenField&&a.showMeWidth||d.before('<i class="fa '+e(a.category)+' roles"></i>'),!a.showInWeb||a.isHiddenField||a.showMeWidth||r.addClass("eye-hidden"),a.linkTableName&&d.before('<i class="fa fa-chain roles"></i>'),d.before('<i class="fa '+a.icon+' roles"></i>');let n=t('<i class="roles">'+(a._ord||a.ord)+"</i>");if(d.before(n),a._ord&&(n.addClass("reordered"),n.before('<i class="roles">'+a.ord+"</i>")),a._category&&n.before('<i class="fa '+e(a._category)+' roles reordered fa-bold"></i>'),"column"===a.category&&l.tableRow.order_field===a.name&&(n.css("font-weight","bold"),!0===l.tableRow.order_desc?d.before('<i class="fa fa-sort-amount-desc roles"></i>'):d.before('<i class="fa fa-sort-amount-asc roles"></i>')),a.codeAction){let e=t('<i class="fa fa-star roles"></i>');d.before(e);let n="";a.CodeActionOnAdd&&(""!==n&&(n+="\n"),n+="При добавлении"),a.CodeActionOnChange&&(""!==n&&(n+="\n"),n+="При изменении"),a.CodeActionOnDelete&&(""!==n&&(n+="\n"),n+="При удалении"),"button"===a.type&&(""!==n&&(n+="\n"),n+="При клике"),""===n&&e.removeClass("fa-star").addClass("fa-star-o"),e.attr("title",n)}a.code&&(a.codeOnlyInAdd?d.before('<i class="fa fa-cog-o roles"></i>'):d.before('<i class="fa fa-cogs roles"></i>'));const i=function(e){let t="";return e.forEach(function(e){""!==t&&(t+="\n"),t+=l.ROLESLIST[e.toString()]}),t};if(a.webRoles&&d.before(t('<i class="fa fa-eye roles"></i>').attr("title",i(a.webRoles))),"button"!==a.type){let e=!1;a.addRoles?d.before(t('<i class="fa fa-plus roles"></i>').attr("title",i(a.addRoles))):a.insertable||("column"===a.category?a.editable?d.before(t('<i class="fa fa-plus roles"></i>').attr("title","Добавление запрещено")):(d.before(t('<i class="fa fa-lock roles"></i>').attr("title","Добавление и редактирование запрещено")),e=!0):a.editable||(d.before(t('<i class="fa fa-lock roles"></i>').attr("title","Редактирование запрещено")),e=!0)),a.editRoles?d.before(t('<i class="fa fa-pencil roles"></i>').attr("title",i(a.editRoles))):a.editable||e||d.before(t('<i class="fa fa-pencil roles"></i>').attr("title","Редактирование запрещено")),a.logRoles&&d.before(t('<i class="fa fa-archive roles"></i>').attr("title",i(a.logRoles)))}if(a.showInXml){let e="";a.xmlRoles&&(e=i(a.xmlRoles)),d.before(t('<i class="fa fa-exchange roles"></i>').attr("title",e))}d.before("<br/>")}a.unitType&&d.append(", "+a.unitType);let f,p=t('<div class="pcTable-filters">');if(a.help&&a.help.length){f=t('<span class="btn btn-xxs btn-default cell-help" tabindex="-1" id="field-help-'+a.name+'"><i class="fa fa-info"/></span>'),l.isCreatorView&&/^\s*<admin>.*?<\/admin>\s*$/s.test(a.help)&&f.addClass("danger-backg"),f.appendTo(p);let e,i=t('<div class="i-inner-div">').html(a.help).width(230);l.isMobile?f.on("click",function(){App.mobilePanel("Поле "+a.title,a.help)}):f.on("click open close",function(n){let o=t(this);o.data("bs.popover")?"open"!==n.type&&(e&&clearTimeout(e),e=setTimeout(()=>{o.attr("aria-describedby")&&t("#"+o.attr("aria-describedby").length)&&o.popover("destroy")},120)):"close"!==n.type&&(f.popover({trigger:"manual",content:i,html:!0,placement:()=>{let e="bottom",t=300,n=l._container,s=o.offset().top-n.offset().top;return"column"===a.category&&l.insertRow||s>n.height()/2?(e="top",t=s-40):t=n.height()-s-70,i.css("max-height",t),e},container:l.scrollWrapper}),o.popover("show"))}),n||(n=!0,l._container.on("click escPressed",function(e){l._container.find('[id^="field-help"][aria-describedby^="popover"]').each(function(){t(this).attr("id")===e.target.id||t(e.target).closest("#"+t(this).attr("id")).length||t(this).trigger("close")})}))}"column"===a.category&&a.filterable&&a.showMeWidth>0&&(r.addClass("with-filter2"),this.__getFilterButton(a.name).appendTo(p)),!l.isCreatorView&&(!1===a.dropdownView||!a.linkToSelectTable&&"filter"===a.category||l.isMobile&&"column"!=a.category)||(r.addClass("with-filter"),function(){let n=t('<div class="cell-header-dropdown">'),i=t('<button class="btn btn-default btn-xxs"  tabindex="-1"><i class="fa fa-caret-down"/></button>');a.pcTable?!1===a.dropdownView&&i.addClass("field_name"):i.addClass("field_name");const o=function(t){t&&e.location.reload()};if(l.isCreatorView){let s=t('<div class="menu-item color-danger">');s.append('<i class="fa fa-pencil-square-o"/> Изменить'),n.append(s);const r=function(){return new EditPanel(2,BootstrapDialog.TYPE_DANGER,{id:a.id}).then(o),!1};s.on("click",r),i.on("contextmenu",r),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-clone"/> Дублировать'),n.append(s),s.on("click",function(){App.getPcTableById(2).then(function(e){e.model.checkEditRow({id:a.id}).then(function(e){let n,i={};t.each(e.row,function(e,t){"object"==typeof t&&(i[e]=t)}),i.version.v&&(n={version:!0}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,i,!1,n).then(o)})})}),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-plus"/> Вставить после'),n.append(s),s.on("click",function(){App.getPcTableById(2,{afterField:a.ord}).then(function(e){let t={};t.ord={v:a.ord+10},t.category={v:a.category},t.table_id={v:l.tableRow.id},l.tableRow.__version&&(t.version={v:l.tableRow.__version}),new EditPanel(e,BootstrapDialog.TYPE_DANGER,t).then(o)})}),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-refresh"/> Изменить NAME'),n.append(s),s.on("click",function(){l.model.renameField(a.name)}),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-times"/> Удалить'),n.append(s),s.on("click",function(){let t=a.title;BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:"Удалить поле "+t+" из таблицы "+l.tableRow.title+"?",buttons:[{action:function(n,i){"use strict";n.close(),App.getPcTableById(2).then(function(n){App.panelTimer("Удаление поля "+t+" из таблицы "+l.tableRow.title,n.tableRow.delete_timer,function(){n.model.delete(a.id).then(function(){e.location.reload(!0)})})})},cssClass:"btn-warning",label:"Удалить"},{action:function(e){e.close()},label:"Отмена"}],draggable:!0})})}if("filter"!==a.category&&a.pcTable&&!l.isMobile){let e=t('<div class="menu-item">');e.append('<i class="fa fa-eye-slash"/> Скрыть'),e.on("click",function(){i.popover("hide"),l.fieldsHiddingHide.call(l,a.name)}),e.appendTo(n),(e=t('<div class="menu-item">')).append('<i class="fa fa-arrows-h"/> Ширина поля'),e.on("click",function(){i.popover("hide");let e=t('<div><input type="number" class="form-control" value="'+a.showMeWidth+'" style="padding-left: 2px;"/></div>');BootstrapDialog.show({message:e,title:"Ширина поля "+a.title,onshown:function(t){let n=e.find("input");n.focus(),n.on("keydown",function(n){13===n.keyCode&&(a.pcTable.setColumnWidth.call(a.pcTable,a.name,parseInt(e.find("input").val())),t.close())}),t.$modalDialog.width(500)},buttons:[{label:"Применить",action:function(t){let n=parseInt(e.find("input").val());t.close(),a.pcTable.setColumnWidth.call(a.pcTable,a.name,n)}},{label:"Отмена",action:function(e){e.close()}}],draggable:!0})}),e.appendTo(n)}if(a.showMeWidth>0&&"column"===a.category){{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-asc"/> Сортировать А-Я'),n.append(e),e.on("click",function(){l.sort(a,1)})}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-desc"/> Сортировать Я-А'),n.append(e),e.on("click",function(){l.sort(a,-1)})}if("column"===a.category&&"number"===a.type){let e=t('<div class="menu-item">');e.append('<i class="fa fa-diamond"/> Математические операции'),n.append(e),e.on("click",function(){let e=t("<div>"),n=0,i=0,o=null,s=null,r=0;l.dataSortedVisible.some(function(e){try{let t=Big(l.data[e][a.name].v);n=Big(n).plus(t),++i,null===o?o=t:t.gt(o)&&(o=t),null===s?s=t:t.lt(s)&&(s=t)}catch(e){++r}});let c=t('<table class="totum-math-operations"><thead><tr><th>Операция</th><th>Значение</th></tr></thead>').appendTo(e),d=t("<tbody>").appendTo(c),f=function(e,t){let n="";if(t=t||!1,a.unitType&&!t&&(n=" "+a.unitType),a.currency){let t={};return a.dectimalPlaces&&(t.minimumFractionDigits=a.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)+n}return e+n};t("<tr><td>Сумма</td><td>"+f(n)+"</td></tr>").appendTo(d),t("<tr><td>Кол-во чисел</td><td>"+f(i,!0)+"</td></tr>").appendTo(d),t("<tr><td>Среднее</td><td>"+f(Big(n).div(i).round(a.dectimalPlaces||0))+"</td></tr>").appendTo(d),t("<tr><td>Максимальное</td><td>"+f(o)+"</td></tr>").appendTo(d),t("<tr><td>Минимальное</td><td>"+f(s)+"</td></tr>").appendTo(d),t("<tr><td>Нечисл. элементов</td><td>"+f(r,!0)+"</td></tr>").appendTo(d);let p=a.title+(a.unitType?", "+a.unitType:"");l.isMobile?App.mobilePanel(p,e):BootstrapDialog.show({title:p,type:"edit",message:e,draggable:!0,onshown:function(e){e.$modalDialog.width(400)},buttons:[{action:function(e){e.close()},label:"Закрыть"}]})})}}if(a.linkToSelectTable){let i=a.linkToSelectTable,o=t('<div class="menu-item color-primary">');o.append('<i class="fa fa-external-link"/> '+i.title),n.append(o),o.on("click",function(){return e.open(i.link,"_blank").focus(),!1})}return i.popover({html:!0,content:n,trigger:"manual",container:l._container,placement:"auto bottom"}),i.on("click",function(){let e=t(this);e.data("bs.popover").tip().hasClass("in")||(e.popover("show"),setTimeout(function(){l._container.one("click",function(){e.popover("hide")})},20))}),i}().appendTo(p)),p.appendTo(r);let u=20*p.find(".btn").length+5;if(this.isCreatorView){let e=t('<div class="th-left-bottom-buttons">').appendTo(r);"footer"===a.category&&a.column&&this.fields[a.column]&&!l.hidden_fields[a.name]&&(s=this.fields[a.column].width);t('<div class="btn  btn-xxs field_name copy_me"  tabindex="-1" data-copied-text="Скопировано">').text(a.name).appendTo(e).css("max-width",s-u)}return l.isMobile&&d.css("max-width",s-u-5),r},_createNoDataRow:function(e){var n=0;t.each(this.fields,function(e,t){n++});let i=this,a=t();return this.control.adding&&!this.f.blockadd&&(a=t('<button class="btn btn-warning btn-xxs">Добавить строку</button>').width(120).on("click",function(){i._addInsertRow()})),e=e||"Таблица пуста ",t("<tr>").addClass(this.noDataRowClass).append('<td class="id">').append(t("<td>").attr("colspan",n).append(e).append(a))},_createRow:function(e,n){n=n||[];let i=this;e.$tr||(e.$tr=t("<tr>"),e.$tr.height(35),e.$tr.data("item",e));let o=e.$tr.empty();o.attr("class","DataRow"),o.attr("data-pctableitemid",e.id),e.e_data&&1==e.e_data.b&&o.addClass("BlockedRow"),e.InsDel&&o.addClass("insDeleted"),this._addCellId(e,o);let l=0,s=this.fieldCategories.visibleColumns.length;if(this.fieldCategories.visibleColumns[l]&&"n"===this.fieldCategories.visibleColumns[l].name){let n=this.fieldCategories.visibleColumns[l],i=t("<td>");o.append(i.append('<span class="cell-value">').append(n.getCellText(null,i,e))),++l}for(;l<s;++l){let t,s=this.fieldCategories.visibleColumns[l];o.append(t=i._createCell(e,s)),n.indexOf(s.name)>-1&&i._colorizeElement(t,a)}},refreshRow:function(e,n,i){if(e&&e.is(".DataRow")||n){n||(n=this._getItemByTr(e));let o=[];if(i){for(var a in i)null!==i[a]&&"object"==typeof i[a]?i[a].changed?(o.push(a),delete i[a].changed):Object.equals(i[a],n[a])||o.push(a):i[a]!=n[a]&&o.push(a),n[a]=i[a];t.extend(n,i)}e&&this._createRow(n,o)}else this._isParamsArea(e)?this._refreshParamsBlock():this._isFootersArea(e)&&this._refreshFootersBlock()},_createCell:function(e,n){let i=this;var a=t("<td>");let o,l="";e[n.name]||(console.log("Не найдено поле "+n.name),console.log(e));try{o=t.extend({},i.f||{},e.f||{},e[n.name].f||{})}catch(t){console.log(t,e,n.name),o={}}!n.editable||!this.control.editing&&"filter"!==n.category||o.block||(a.addClass("edt"),n.editGroup&&(n.editGroupMultiColumns?a.addClass("e-gm").addClass("e-g"):a.addClass("e-g")),-1===["button","fieldParams"].indexOf(n.type)&&(i.isMobile||o.editbutton)&&(l='<button class="fa fa-edit pull-right ttm-edit ibtn"></button>')),i.isMobile&&(l='<button class="fa fa-ellipsis-h ttm-panel pull-right ibtn"></button>'+l),o.block&&a.addClass("blocked"),"column"!==n.category&&a.attr("data-field",n.name);var s=t('<span class="cell-value">'),r=e[n.name];let c,d;if(n.code&&!n.codeOnlyInAdd&&a.addClass("with-code"),"column"!==n.category&&a.data("field",n.name).addClass("val"),r){if(c=r.e,r.h&&(d=void 0!==r.c&&r.v!=r.c?t('<i class="fa fa-hand-paper-o pull-right" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right" aria-hidden="true"></i>'),i.isMobile&&d.addClass("ttm-panel")),r.d&&a.addClass("deleted_value"),r.e)if(n.errorText)s.text(n.errorText);else{let e=t('<i class="fa fa-exclamation-triangle pull-right" aria-hidden="true"></i>');i.isMobile?e.addClass("ttm-panel"):e.attr("title",r.e),a.append(e)}if(o.text&&"button"!=n.type)s.text(o.text);else if(!r.e||!n.errorText){var f=n.getCellText.call(n,r.v,a,e,i);"object"==typeof f?s.html(f):s.text(f)}}if(o.comment&&"button"!=n.type&&a.append(t('<i class="cell-icon fa fa-info pull-right"></i>').attr("title",o.comment)),d&&a.append(d),l&&a.append(l),s.appendTo(a),o.text||!n.unitType||c||null===r.v||s.attr("data-unit-type"," "+n.unitType),n.css&&a.addClass(n.css),this.isSelected(n.name,e.id)&&a.addClass("selected"),o.background&&a.css("background-color",o.background),o.color&&a.css("color",o.color),o.bold&&a.css("font-weight","bold"),o.align?a.css("text-align",o.align):o.tab&&a.css("padding-left",o.tab+"px"),o.decoration&&a.css("text-decoration",o.decoration),o.italic&&a.css("font-style","italic"),"button"!==n.type&&o.icon&&a.prepend('<i class="cell-icon fa fa-'+o.icon+'"></i>'),o.progress&&o.progresscolor){let e=function(){if(s.isAttached()){let e=Math.round(s.width()*parseInt(o.progress)/100);s.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+o.progresscolor)}else setTimeout(e,50)};e()}return a},_getLoadingSpinner:function(){return t('<div class="text-center"><i class="fa fa-spinner"/></div>')},_colorizeElement:function(e,t,n){let i=10,a=function(){0===i?e.css("box-shadow",""):(e.css("box-shadow","inset 0 0 100px 100px "+App.hexToRGB(t,i/10)),i--,setTimeout(a,50))};a()},_TmpColorize:function(e,t,n){var i,a=this,o=0;t=t||"#ff0000";"#"!=(n=n||"#ffffff").substr(0,1)&&(n=App.rgb2hex(n));10==++o?i=n:(i=function(e,t,n){var i=parseInt(e.slice(1),16),a=(n=parseInt(n.slice(1),16),t<0?0:n>>16),o=t<0?0:n>>8&255,l=t<0?0:255&n,s=t<0?-1*t:t,r=i>>16,c=i>>8&255,d=255&i;return"#"+(16777216+65536*(Math.round((a-r)*s)+r)+256*(Math.round((o-c)*s)+c)+(Math.round((l-d)*s)+d)).toString(16).slice(1)}(t,.1,n))==t&&(i=n),e.css("background-color",i),i!=n?setTimeout(function(){a._TmpColorize(e,i,n)},50):e.data("backgroundcolor")||e.attr("style",e.attr("style").replace(/(background\-color:[^;"]+;?)/,""))}})}(),t.extend(App.pcTableMain.prototype,{_addHorizontalDraggable:function(){this._innerContainer.off("mousedown.HorizontalDraggable mouseout").on("mousedown.HorizontalDraggable",function(e){for(var n=e;n;){if(t(e.target).is("input"))return!0;if(n==e.originalEvent)break;n=e.originalEvent}return t(this).data("x",e.clientX).data("scrollLeft",this.scrollLeft),!1}).on("mousemove",function(e){if(0===t(e.target).closest(".InsertRow").length&&"INPUT"!==e.target.tagName&&1===e.buttons&&0===e.button&&Math.abs(t(this).data("x")-e.clientX)>20){let n;t(this).data("moved",!0),n&&clearTimeout(n),n=setTimeout(function(){t(this).data("moved",!1)},200),this.scrollLeft=t(this).data("scrollLeft")+t(this).data("x")-e.clientX}})}}),App.pcTableMain.prototype._addRowPanel=function(e,n,i){var a=t('<div style="width: 165px;"><div class="buttons"></div></div>');if(void 0!==i){var o=a.find(".buttons").empty();t.each(i,function(e,n){if("function"==typeof n)var i=t('<button class="btn btn-sm btn-default">').html(e).on("click",n);else"object"==typeof n&&"checkbox"==n.type&&(i=t('<input type="checkbox">'),n.id&&i.attr("id",n.id),n.func&&i.on("change",n.func),i=i.wrap('<span style="font-size: 10px; padding-left: 8px;" >').parent().append(' <span style="padding-top: 2px;">'+e+"</span>"));o.append(" "),o.append(i)})}n.on("remove",function(){a.remove()});let l=this;return setTimeout(function(){let e={isParams:!0,$text:a,element:n,container:l._container,placement:"bottom",trigger:"manual"};App.popNotify(e);let i=n.attr("aria-describedby"),o=t("#"+i).addClass("warning-bg");o.find(".arrow").css("left","80%"),l._positionPanel.call(l,o,n),a.show()},50),a},App.pcTableMain.prototype._positionPanel=function(e,t){var n=t.position();this.tableWidth;return this._innerContainer.width()>this.tableWidth?e.position({my:"right top",at:"right+2px bottom+12px",of:t}):e.position({my:"right top",at:"right+2px top+"+(n.top+47)+"px ",of:this._innerContainer})},t.extend(App.pcTableMain.prototype,{_csvExport:function(){"use strict";let e=this;this.model.csvExport(e.dataSortedVisible,Object.keys(App.filter(e.fields,(e,t)=>!!t.showMeWidth))).then(function(t){if(t.csv){let n=new Blob([t.csv],{type:"text/csv;charset=utf-8"});saveAs(n,e.tableRow.title+"."+e.model.tableData.updated.dt+".csv")}})},_csvImportClick:function(){let e=this;t('<input type="file" accept="text/csv">').on("change",function(){if(this.files&&this.files[0]){let t=new FileReader;t.onload=function(t){let n=t.target.result;e._csvImportUpload.call(e,n)},t.onerror=function(e){console.log(e.target.error)},t.readAsDataURL(this.files[0])}}).click()},_csvImportUpload:function(e){let t=this,n={},i=function(){t.model.csvImport(e,n).then(function(e){e.question?App.modal(e.question[1],"Вопрос про csv-загрузку",{"Отменить":"close","Загружаем":function(t){"use strict";t.modal("hide"),n[e.question[0]]=1,i()}}):e.ok&&t.table_modify.call(t,e)})};i()}}),function(){t.extend(App.pcTableMain.prototype,{___fieldsHiddingShowAllButton:null,_hideHell_storage:{isset_fields:!1,opened:null,blinkIt:!1,getOpened:function(){return null===this._hideHell_storage.opened&&(this._hideHell_storage.opened=i.getSavedOpenedVal(this.tableRow),!1===this._hideHell_storage.opened&&(this._hideHell_storage.blinkIt=!0)),this._hideHell_storage.opened},checkIssetFields:function(e){if(this.isCreatorView&&this._beforeSpace){let t=this._hideHell_storage.isset_fields;if(this._hideHell_storage.isset_fields=Object.keys(this.hidden_fields).length||Object.keys(this.fields).some(e=>"n"!==e&&(!this.fields[e].showMeWidth||this.fields[e].showMeWidth<1)),e||t!==this._hideHell_storage.isset_fields){let e=this._beforeSpace.find("#hide-hell").removeClass("btn-contour");this._hideHell_storage.isset_fields?(e.removeAttr("disabled"),this._hideHell_storage.opened?(e.find("i").addClass("fa-arrow-up").removeClass("fa-arrow-down").removeClass("fa-times"),e.addClass("btn-contour")):(e.find("i").removeClass("fa-arrow-up").addClass("fa-arrow-down").removeClass("fa-times"),this._hideHell_storage.blinkIt&&(App.blink(e,8,"#fff"),this._hideHell_storage.blinkIt=!1))):(e.attr("disabled","disabled"),e.find("i").addClass("fa-times").removeClass("fa-arrow-up").removeClass("fa-arrow-down"))}}},switchOpened:function(){this._hideHell_storage.opened=!this._hideHell_storage.opened,this._hideHell_storage.checkIssetFields.call(this,!0),i.saveOpenedVal(this.tableRow,this._hideHell_storage.opened),this._refreshHiddenFieldsBlock()}},fieldsHiddingHide:function(e,t){let n=a.get(this.tableRow)||{};t?n[e]=this.fields[e].width:delete n[e],this.setVisibleFields(n)},setVisibleColumns:function(){let e=this;this.fieldCategories.visibleColumns=[],this.fieldCategories.column.forEach(function(t){t.showMeWidth&&e.fieldCategories.visibleColumns.push(t)})},setColumnWidth:function(e,t){let n=a.get(this.tableRow)||{};n[e]=t,this.setVisibleFields(n)},loadVisibleFields:function(){let e={},t=a.getDate(this.tableRow);!t||""!=this.tableRow.fields_actuality&&this.tableRow.fields_actuality>t?(console.log("visibleFields updated"),this.setVisibleFields(e,!0,moment().format(App.dateTimeFormats.db))):(e=a.get(this.tableRow)||{},this.setVisibleFields(e,!0))},setVisibleFields:function(e,n,i){let o=this;e&&0===Object.keys(e).length?(e={},Object.values(o.fields).forEach(function(t){o.fields[t.name].showMeWidth=t.hidden?0:t.width,e[t.name]=o.fields[t.name].showMeWidth})):Object.values(o.fields).forEach(function(t){"filter"===t.category?o.fields[t.name].showMeWidth=t.width:void 0!==e[t.name]?o.fields[t.name].showMeWidth=parseInt(e[t.name]):o.fields[t.name].showMeWidth=n&&!t.hidden?t.width:0,e[t.name]=o.fields[t.name].showMeWidth}),a.set(e,this.tableRow,i),this.setVisibleColumns(),t.each(this.data,function(e,t){delete o.data[e].$tr}),this._header&&(this._refreshHead(),this._refreshContentTable(!0),this._rerenderColumnsFooter(),this.fieldsHiddingGetButton(),this.isCreatorView&&(this._hideHell_storage.checkIssetFields.call(o),this._refreshHiddenFieldsBlock()),this.setWidthes(),this.ScrollClasterized.insertToDOM(null,!0)),this._insertRow&&this._closeInsertRow()},hideAdminViewFields:function(){let e=this,t=a.get(this.tableRow)||{};Object.keys(t).forEach(function(n){if(t[n]>0){let i=e.fields[n];(!i||i.webRoles&&1===i.webRoles.length&&"1"==i.webRoles[0])&&delete t[n]}}),this.setVisibleFields(t)},setDefaultVisibleFields:function(){let e={};Object.values(this.fields).forEach(function(t){t.hidden?e[t.name]=0:e[t.name]=t.width}),this.setVisibleFields.call(this,e)},fieldsHiddingShowPanel:function(){let e,n,i=this,a=t('<div class="hidding-form">');const l=function(e){e=e||t("#defaultEyeGroups"),s=i.tableRow.fields_sets||[],e.empty().append("<b>Наборы по умолчанию:</b> "),s.forEach(function(n,a){let o=t('<a href="#">').text(n.name).data("index",a);e.append(o.wrap("<span>").parent()),i.isCreatorView&&(a>0&&o.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-arrow-left"></i></button>').data("index",a)),o.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-remove"></i></button>').data("index",a)))}),e.off(),i.isCreatorView&&e.on("click",".btn",function(){if(t(this).find("i").is(".fa-remove")){let e=t(this);i.model.removeEyeGroupSet(e.data("index")).then(function(e){i.tableRow.fields_sets=e.sets,l()})}else{let e=t(this);i.model.leftEyeGroupSet(e.data("index")).then(function(e){i.tableRow.fields_sets=e.sets,l()})}}),e.on("click","a",function(){let e=t(this).data("index"),a=s[e].fields;if(Array.isArray(a)){let e={};a.forEach(function(t){i.fields[t]&&(e[t]=i.fields[t].width)}),a=e}i.setVisibleFields.call(i,a),n.close()})};let s=o.getNames(i.tableRow);if(s&&s.length){let e=t('<div class="fieldsHiddenSets">').appendTo(a);e.append("<b>Наборы:</b> "),s.forEach(function(n){let a=t('<a href="#">').text(n).data("name",n);e.append(a.wrap("<span>").parent());let o=a.parent();o.append(t('<button class="btn btn-xxs" data-action="remove"><i class="fa fa-remove"></i></button>').data("name",n)),i.isCreatorView&&o.append(t('<button class="btn btn-xxs field_name" data-action="addDefaultSet" title="Сохранить как набор по умолчанию"><i class="fa fa-save"></i></button>').data("name",n))}),e.on("click",".btn",function(){let e=t(this),n=e.data("name");if(i.isCreatorView&&"addDefaultSet"===t(this).data("action")){let t=o.get(i.tableRow,n)||[];i.model.AddEyeGroupSet(n,t).then(function(t){i.tableRow.fields_sets=t.sets,l(),o.remove(i.tableRow,n),e.parent().remove()})}else o.remove(i.tableRow,n),e.parent().remove()}),e.on("click","a",function(){let e=t(this).data("name"),a=o.get(i.tableRow,e)||[];i.setVisibleFields.call(i,a),n.close()})}s=i.tableRow.fields_sets||[];let r=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(a);s&&s.length&&l(r),a.on("click",'input[type="checkbox"]',function(n){let i=t(this),a=i.closest(".hidding-form");if(n.shiftKey){a.find("input").index(i);let n=a.find("input").index(t(this));a.find("input").each(function(a){(n<=a&&a<e||n>=a&&a>e)&&t(this).prop("checked",!!i.is(":checked")&&"checked").trigger("change")})}else e=a.find("input").index(t(this))});let c=[{label:"Применить",action:function(e){let n={};a.find("input:checked").each(function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null}),i.setVisibleFields.call(i,n),e.close()}},{label:"По умолчанию",action:function(e){e.close(),i.setDefaultVisibleFields.call(i)}},{label:"Показать все",action:function(e){e.close();let t={};Object.values(i.fields).forEach(function(e){t[e.name]=e.width}),i.setVisibleFields.call(i,t)}},{label:"Создать набор",action:function(e){let n={};a.find("input:checked").each(function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null}),i.setVisibleFields.call(i,n),e.close();let l=t("<div></div>");l.append('<div style="padding-top: 10px;"><label>Название набора</label><input type="text" id="fieldsSetName" class="form-control"/></div>'),BootstrapDialog.show({message:l,title:"Сохранить набор полей",buttons:[{label:"Сохранить",action:function(e){let t=l.find("#fieldsSetName");""===t.val().trim()?t.addClass("error"):(o.set(i.tableRow,n,t.val().trim()),e.close())}},{label:"Закрыть",action:function(e){e.close()}}],draggable:!0})}},{label:"Отмена",action:function(e){e.close()}}];i.isCreatorView&&(c[1].label="C админ полями",c[1].icon="fa fa-angle-right",c.splice(1,0,{label:"Без админ полей",icon:"fa fa-angle-double-right",action:function(e){e.close(),i.hideAdminViewFields.call(i)}}));let d={param:"Хэдер",column:"Колонки",footer:"Футер"};Object.keys(d).forEach(function(e){i.fieldCategories[e]&&i.fieldCategories[e].length&&(a.append('<div class="category-name">'+d[e]+"</div>"),t.each(i.fieldCategories[e],function(e,n){let i="";n.hidden&&(i=" (Скрыто по умолчанию)");let o=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+n.name+'" class="form-check-input"> '+n.title+i+'</label> <input type="number" placeholder="'+n.width+'" value="'+(n.showMeWidth&&n.showMeWidth!==n.width?n.showMeWidth:n.width)+'"/></div>');n.showMeWidth&&(o.find("input").prop("checked",!0),o.attr("data-checked",!0)),o.appendTo(a)}))}),a.on("change",'input[type="checkbox"]',function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")}),n=BootstrapDialog.show({message:a,title:"Видимость полей",buttons:c,draggable:!0,onshow:function(e){i.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingGetButton:function(e){"use strict";let n=this;if(!this.___fieldsHiddingShowAllButton){let e;this.___fieldsHiddingShowAllButton=t('<button class="btn btn-sm"><span class="fa fa-eye-slash"></span></button>').on("click",function(){n.fieldsHiddingShowPanel.call(n)}).on("contextmenu",function(){return n.isCreatorView?e?(clearTimeout(e),e=null,n.hideAdminViewFields.call(n,!0)):e=setTimeout(function(){n.setDefaultVisibleFields.call(n),e=null},500):n.setDefaultVisibleFields.call(n),!1})}return Object.values(n.fields).some(function(e){if(e.showInWeb&&!e.hidden&&!e.showMeWidth)return!0})?(this.___fieldsHiddingShowAllButton.addClass("btn-warning"),this.___fieldsHiddingShowAllButton.removeClass("btn-default"),e&&App.blink(this.___fieldsHiddingShowAllButton,8,"#fff")):(this.___fieldsHiddingShowAllButton.addClass("btn-default"),this.___fieldsHiddingShowAllButton.removeClass("btn-warning")),this.___fieldsHiddingShowAllButton}});let e="pcTableShowFieldsWithDates",n=function(e){let t=e.id;return"calcs"===e.type&&(t+="$"+e.__version),t},i={saveOpenedVal:function(e,t){localStorage.setItem(this.getKeyString(e),t.toString())},getKeyString:function(e){return e.id+"/"+e.__version},getSavedOpenedVal:function(e){let t=localStorage.getItem(this.getKeyString(e));return!t||JSON.parse(t)}},a={set:function(t,i,a){let o=n(i),l={},s=t||{};try{l=JSON.parse(localStorage.getItem(e))||{}}catch(e){}a||!l[o]?l[o]=[s,a]:l[o][0]=s,localStorage.setItem(e,JSON.stringify(l))},get:function(e){let t=n(e);return a.getInner(t)[0]},getDate:function(e){let t=n(e);return a.getInner(t)[1]},getInner:function(t){let n;try{n=JSON.parse(localStorage.getItem(e))||{}}catch(e){n={}}return n[t]||[]}},o={set:function(e,t,i){let a=[],o="pcTableShowFieldsSets"+n(e),l=t||[];try{a=JSON.parse(localStorage.getItem(o))||{}}catch(e){}a[i]=l,localStorage.setItem(o,JSON.stringify(a))},get:function(e,t){let i,a="pcTableShowFieldsSets"+n(e);try{i=(i=JSON.parse(localStorage.getItem(a)))[t]}catch(e){}return null!==i&&void 0!==i||(i=void 0),i},getNames:function(e){let t,i="pcTableShowFieldsSets"+n(e);try{return t=JSON.parse(localStorage.getItem(i)),Object.keys(t)}catch(e){}return null!==t&&void 0!==t||(t=void 0),t},remove:function(e,t){let i,a="pcTableShowFieldsSets"+n(e);try{delete(i=JSON.parse(localStorage.getItem(a)))[t],localStorage.setItem(a,JSON.stringify(i))}catch(e){}}}}(),App.pcTableMain.prototype._print=function(){"use strict";let e=t('<div class="hidding-form">');const n=function(e){if(e.showMeWidth)return!0};this.fieldCategories.param.length&&this.fieldCategories.param.some(n)&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="params" class="form-check-input" checked="checked"> Параметры</label></div>'),this.fieldCategories.filter.length&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="filters" class="form-check-input" checked="checked"> Фильтры</label></div>'),this.fieldCategories.column.length&&this.fieldCategories.column.some(n)&&this.dataSortedVisible.length&&(e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="rows" class="form-check-input" checked="checked"> Строчную часть</label></div>'),e.append('<div class="form-check no-bold" style="padding-left: 20px;"><label class="form-check-label"><input type="checkbox" name="with-id" class="form-check-input"> с id</label></div>')),this._footersBlock.find(".val").length&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="column-footers" class="form-check-input" checked="checked"> Футеры колонок</label></div>'),this._footersSubTable.find(".val").length&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="other-footers" class="form-check-input" checked="checked"> Футеры вне колонок</label></div>');let i=this,a=[{label:"Печать",action:function(n){let a=[];e.find("input:checked").each(function(){a.push(t(this).attr("name"))}),n.close(),i._printTable.call(i,a)}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:"Печать",buttons:a,draggable:!0})},App.pcTableMain.prototype._printTable=function(e){let t=this,n={fields:{}};-1!==e.indexOf("with-id")&&(n.fields.id=50);let i={params:t.fieldCategories.param,filters:t.fieldCategories.filter,rows:t.fieldCategories.column,"column-footers":t.fieldCategories.footer.filter(function(e){return""!==e.column}),"other-footers":t.fieldCategories.footer.filter(function(e){return""===e.column})};Object.keys(i).forEach(function(t){-1!==e.indexOf(t)&&i[t].forEach(function(e){"button"===e.type||e.showMeWidth<1||!e.showMeWidth||(n.fields[e.name]=e.showMeWidth)})}),-1!==e.indexOf("rows")&&(n.ids=t.dataSortedVisible),n.sosiskaMaxWidth=1100,t.model.printTable(n)},App.pcTableMain.prototype.reOrderRows=function(e,n){let i,a=this;if(a.tableRow.with_order_field&&!a.nSorted)return App.notify("Для работы поля порядок перезагрузите таблицу"),!1;let o,l=[];if(0===this.row_actions_get_checkedIds().length){if(l.push(e),(i=this.dataSorted.indexOf(e)+("after"===n?1:-1))<0)return}else{if(-1!==a.row_actions_get_checkedIds().indexOf(e))return App.notify("В качестве якоря для перемещения нужно выбрать не отмеченную строку"),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some(function(e,n){if(0===t)return!0;a.data[e].$checked&&(l.push(e),--t)})}l.forEach(function(e){a.dataSorted.splice(a.dataSorted.indexOf(e),1)}),o=void 0!==i?i:this.dataSorted.indexOf(e)+("after"===n?1:0),a.dataSorted.splice(o,0,...l),this.dataSortedVisible=[],a.dataSorted.forEach(function(e){a.data[e].$visible&&a.dataSortedVisible.push(e)}),a._refreshContentTable(),a.tableRow.with_order_field&&t("table.pcTable-table").addClass("reordered"),a.row_actions_uncheck_all()},App.pcTableMain.prototype.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.dataSorted).then(function(n){e.table_modify(n),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")})},App.pcTableMain.prototype.addReOrderRowBind=function(){let e=this;e._innerContainer.on("click","td.n button",function(n){let i=t(this);e.tableRow.with_order_field&&!e.__getCheckedRowsIds(void 0,!0,"blockorder")||e.reOrderRows.call(e,e._getItemByTr.call(e,i.closest("tr")).id,1===i.find(".fa-angle-up").length?"before":"after")})},App.pcTableMain.prototype.__formatFunctions={blockadd:function(){this._rowsButtons()},tablecomment:function(){this._rowsButtons()},blockorder:function(){this._refreshHead()},block:function(){this._refreshParamsBlock(),this._refreshContentTable(!0),this._refreshFootersBlock()},tabletitle:function(){this._refreshTitle()},text:function(){this._refreshTableText()},rowstitle:function(){this._container.find(".pcTable-rowsTitle:first").replaceWith(this._createRowsTitle())},fieldtitle:function(e,t){let n={};for(const i in e)this.fields[i]&&e[i]!==t[i]&&(n[this.fields[i].category]=!0);for(const i in t)this.fields[i]&&e[i]!==t[i]&&(n[this.fields[i].category]=!0);for(const e in n)switch(e){case"param":this._rerendParamsblock();break;case"filter":this._rerendFiltersBlock();break;case"column":this._refreshHead();break;case"footer":this._rerendFooters()}}},t.extend(App.pcTableMain.prototype,{setWidthes:function(){"use strict";let n;this.isMobile?(n=5,this.switchContainerNideScroll(!1)):(n=t("body>.page_content:first").is(".tree-minifyed")?5:300,this.switchContainerNideScroll(!0)),this.width=t("body").width()-n,this._container.width(this.width),this.isMobile?this._innerContainer.width("auto"):this._innerContainer.width(this.width-80),this._rerendParamsblock(),this._rerendFiltersBlock(),this._refreshHead(),this._rerendFooters(),this.tableWidth<this._innerContainer.width()?this.isMobile?this.__$rowsButtons.width(this._table.width()):this.__$rowsButtons.width(this._table.width()-70):this.isMobile||this.__$rowsButtons.width(this._innerContainer.width()-5),this._container.width()<this._table.width()&&this._addHorizontalDraggable(),this._container.height(e.innerHeight-this._container.offset().top-20)},initForPanel:function(e){t.extend(!0,this,e),this.refreshArraysFieldCategories(!1);let n={};this.__checkedRows=[],this.data.map(function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),n[e.id]=e,n[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)},this),this.data=n,this.model.setDataRows(this.data)},_init:function(){let n=this;this._container.addClass(this.contanerClass).addClass("pcTable-type-"+this.tableRow.type);let i=t("#nav-top-line");i.addClass("pcTable-type-"+this.tableRow.type),"tmp"===this.tableRow.type&&i.text("Будьте внимательны - это временная таблица"),this._innerContainer=t('<div class="innerContainer">'),t("body").on("keyup",function(e){27===e.which&&n._container.trigger("escPressed")}),this._container.append(this._innerContainer),this.addReOrderRowBind();let a,o={};this.__checkedRows=[],this.data.map(function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),o[e.id]=e,o[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)},this),this.data=o,this.model.setDataRows(this.data),t(e).resize(function(){a&&clearTimeout(a),a=setTimeout(function(){n.setWidthes()},500)})},refreshArraysFieldCategories:function(n){"use strict";n=n||!1;let i=this;i.hidden_fields=i.hidden_fields||{},t.each(i.hidden_fields,function(e,n){i.hidden_fields[e]=t.extend({},n,s[n.type],n),i.hidden_fields[e].isHiddenField=!0}),i.mainFieldName="id",i.fieldCategories={},["param","column","filter","footer"].forEach(function(e){i.fieldCategories[e]=[]});let a=[];try{a=(a=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]"))&&a.wc?a.wc:[]}catch(e){}let o=!1;const l=function(e,n){n.pcTable=i,-1===a.indexOf(n.category)&&((n=s[n.type]?t.extend({},r,s[n.type],n):t.extend({},r,n)).showInWebOtherOrd&&(n._ord=n.ord,n.ord=n.showInWebOtherOrd,o=!0),n.showInWebOtherPlacement&&(n._category=n.category,n.category=n.showInWebOtherPlacement,o=!0),i.fields[e]=n,n.showInWeb?i.fieldCategories[n.category].push(n):n.name&&(i.hidden_fields[n.name]=n))};if(n){l("n",{type:"n"});let e=t.extend({},this.fields);delete e.n,t.each(e,l)}else t.each(this.fields,l);o&&["param","column","filter","footer"].forEach(function(e){i.fieldCategories[e].sort(function(e,t){return e.ord-t.ord})}),this.tableRow.main_field&&this.fields[this.tableRow.main_field]&&(i.mainFieldName=this.tableRow.main_field)},render:function(e){let t=this;if(this.loadVisibleFields(),this._renderTable(),this._sorting.addSortable&&this._sorting.addSortable(this),this._addSelectable(),this._addEditable(),this._addSave(),this.row_actions_add(),this.__addFilterable(),this._refreshHead(),this.ScrollClasterized=this.Scroll(),t.checkIsUpdated>0){let e=2e3*parseInt(t.checkIsUpdated);setTimeout(function(){t.checkTableIsChanged.call(t,e)},e)}this.refresh(),this.setWidthes(),this.__applyFilters(),e&&t._addInsert(e)},_addSave:function(){t("body").on("keyup",function(e){(e.ctrlKey||e.metaKey)&&"s"===String.fromCharCode(e.which).toLowerCase()&&0===t("#bigOneCodemirror").length&&t("body").trigger("ctrlS")})},reloaded:function(){let e=t("#refresh-notify");e.length&&(e.closest(".alert").remove(),this.checkTableIsChanged(2e3*parseInt(this.checkIsUpdated)))},checkTableIsChanged:function(e){let n=this;document.hidden?setTimeout(function(){n.checkTableIsChanged.call(n,e)},1e3):n.model.checkTableIsChanged.call(n.model).then(function(i){if(i.no||n.model.tableData.updated.code===i.code)n.checkTableIsChanged.call(n,e);else{let a=function(){n.model.tableData.updated.code===i.code?n.checkTableIsChanged.call(n,e):(t.notify({message:'<div id="refresh-notify"><button class="btn btn-warning btn-sm" style="margin-right: 20px;">Обновить</button> <span>Таблица была изменена пользователем <b>'+i.username+"</b> в <b>"+App.dateFormats.covert(i.dt,"YY-MM-DD HH:mm","HH:mm DD.MM")+"</b> </span></div>"},{type:"warning",allow_dismiss:!1,delay:0}),t("#refresh-notify button").on("click",function(){n.model.refresh()}))};n.model.doAfterProcesses(function(){setTimeout(a,200)})}})},_getTableMainFieldName:function(e,t){let n;return Object.keys(e).some(function(i){let a=e[i];if(a.id==t)return n=a.name,!0}),n},_getFieldbyName:function(e){return this.fields[e]},_getColumnIndexByTd:function(e,t){return(t=t||e.closest("tr")).find("td").index(e)},_fieldByTd:function(e,t){let n=this._getColumnIndexByTd(e,t);return this.fieldCategories.visibleColumns[n-1]},_getRowIndexById:function(e){let t=this;for(let n in t.data)if(t.data[n].id==e)return n;return null},_getFieldBytd:function(e){return e.closest("tr").is(".DataRow")?this.fieldCategories.visibleColumns[e.closest("tr").find(e.prop("tagName")).index(e)-1]:this.fields[e.data("field")]},_isParamsArea:function(e){return e.closest("table").is(".pcTable-paramsTable")},_isFootersArea:function(e){return e.closest("tbody").is(".pcTable-footers")},_getItemBytd:function(e){let t=e.closest("tr");return this._getItemByTr(t)},_getItemByTr:function(e){return e.is(".DataRow")?this.data[e.data("pctableitemid")]:this.data_params},_getItemById:function(e){return this.data[e]},_deleteItemById:function(e){let t=this._getItemById(e);t&&t.$tr&&t.$tr.remove(),["dataSorted","dataSortedVisible","__checkedRows"].some(function(t){let n=this[t].indexOf(e);-1!==n&&this[t].splice(n,1)},this),delete this.data[e]},_getTdByFieldName:function(e,t){let n=0;return this.fieldCategories.visibleColumns.every(function(t,i){return e!=t.name||(n=i,!1)}),this._getTdByColumnIndex(t,n+1)},_getTdByColumnIndex:function(e,t){return e.find("td:eq("+t+")")},refresh:function(){this._refreshTitle(),this._refreshParamsBlock(),this._refreshFiltersBlock(this.data_params),this._refreshFootersBlock(),this._refreshContentTable()}})}(window,jQuery),App.models||(App.models={}),App.models.table=function(e,t,n){let i,a,o=!1,l=null;return n=n||{},{setDataRows:function(e){i=e},addFiltersData:function(e){"use strict";n=$.extend(!0,{},n,e)},tableData:t,url:e,isInProcess:function(){return o},doAfterProcesses:function(e){let t=this;setTimeout(function(){let n;(n=t.getDefferedProcess())?n.then(e):e()},50)},getDefferedProcess:function(){if(!o)return!1;let e=$.Deferred();const t=function(){o?setTimeout(t,50):e.resolve()};return t(),e.promise()},showLinks:function(e){App.showLInks(e.links,a.model),delete e.links},shoInterfaceDatas:function(e){App.showDatas.call(a.model,e.interfaceDatas),delete e.interfaceDatas},showPanels:function(e){App.showPanels(e.panels),delete e.panels},addPcTable:function(e){a=e},__ajax:function(e,s,r,c,d){"use strict";let f=this.url,p=$.Deferred();d=d||{};let u=!1,h=!1,m=$.extend(!0,{},s,{tableData:t,ajax:!0},n,d);"checkTableIsChanged"===s.method||"checkForNotifications"===s.method?"checkForNotifications"===s.method?f="/Table/0/0/":(m=$.extend({},s,{code:t.updated.code,ajax:!0},n),t.sess_hash&&(m.tableData={sess_hash:t.sess_hash})):(o=!0,c||setTimeout(function(){u||(App.fullScreenProcesses.showCog(),h=!0)},1e3)),void 0!==m.data&&"object"==typeof m.data&&(m.data=JSON.stringify(m.data)),i&&(m.ids=JSON.stringify(Object.keys(i)));let b=this,g=function(e){let t={edit:"Изменение",checkInsertRow:"Предварительное добавление",duplicate:"Дублирование",refresh_rows:"Пересчет строк",getTableData:"Загрузка информации о таблице",refresh:"Обновление данных таблицы",checkEditRow:"Предварительный расчет панели",saveEditRow:"Сохранение панели",save:"Изменение поля",click:"Нажатие кнопки",selectSourceTableAction:"Вызов панели",add:"Добавление строки",getEditSelect:"Загрузка селекта",delete:"Удаление"},n=$("#table").data("pctable");if(n){if(e.LOGS&&(n.LOGS||(n.LOGS={}),n.LOGS=$.extend(n.LOGS,e.LOGS)),e.FullLOGS){n.FullLOGS||(n.FullLOGS=[]);let i={text:t[m.method]||m.method};i.children=e.FullLOGS,e.FullLOGS.length&&(n.FullLOGS.push(i),App.blink(n.LogButton,8,"#fff"))}e.FieldLogs&&(n.FieldLOGSName=t[m.method]||m.method,n.FieldLOGS=e.FieldLogs)}if(e.error){var i=$("<div>").html(e.error.replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"));if(e.log){let t=$('<button class="btn btn-xxs btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');t.on("click",function(){BootstrapDialog.show({message:$('<pre style="max-height: '+($("body").height()-200)+'px; overflow: scroll">').css("font-size","11px").text(JSON.stringify(e.log,null,1)),type:BootstrapDialog.TYPE_DANGER,title:"Лог расчета",buttons:[{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}],draggable:!0,onshown:function(e){e.$modalContent.position({of:window})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:1200})}})}),i.append(" "),i.append(t)}App.notify(i),p.reject(e)}else e.reload?window.location.href=window.location.href:(e.links&&e.links.length>0&&b.showLinks(e),e.interfaceDatas&&e.interfaceDatas.length>0&&b.shoInterfaceDatas(e),e.panels&&e.panels.length>0&&b.showPanels(e)),p.resolve(e)},_=function(e){let t,n;e&&200===e.status?e.responseJSON&&e.responseJSON.error?t=e.responseJSON.error:(t=$("<div>Ошибка выполнения операции  </div>"),a&&a.isCreatorView&&(t.append('<button class="btn danger-backg btn-xs" data-toggle="collapse" data-target="#notify-texh"><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></button>'),t.append($('<div id="notify-texh" class="collapse">').append($("<code>").text(e.responseText))))):!r&&e&&"abort"!=e.statusText&&"error"!=e.statusText?(t=e.statusText,n=200):r&&r.jqXHR&&"abort"!==r.jqXHR.statusText&&(t="Нет соединения с сервером",n=200),t&&(n?setTimeout(function(){App.notify(t)},n):App.notify(t),e.responseText),p.reject(e)},v=function(){if("checkForNotifications"!==s.method){if((new Date).getTime()-l<150)return void setTimeout(v,50);l=(new Date).getTime(),/\?/.test(f)?f+="&":f+="?",f+="rn="+Math.round(1e5*Math.random())+(m.method||"")}$.ajax({url:f,method:e,data:m,dataType:"json",beforeSend:function(e,t){r&&(r.jqXHR=e)}}).then(g).fail(_)};v();let w=function(){o=!1,u=!0,h&&App.fullScreenProcesses.hideCog()};return p.always(function(){setTimeout(w,100)}),p.promise()},delete:function(e){return 0!==e.length&&this.__ajax("post",{delete_ids:JSON.stringify(e),method:"delete"})},duplicate:function(e,t,n){return 0!==e.length&&this.__ajax("post",{duplicate_ids:JSON.stringify(e),data:t,insertAfter:n,method:"duplicate"})},getFieldLog:function(e,t,n){return this.__ajax("post",{field:e,id:t,method:"getFieldLog",rowName:n})},refresh_rows:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_rows"})},refresh_cycles:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_cycles"})},checkUnic:function(e,t){"use strict";return this.__ajax("post",{fieldName:e,fieldVal:t,method:"checkUnic"})},add:function(e){return this.__ajax("post",{data:e,method:"add"})},getValue:function(e,t){return this.__ajax("post",{data:e,method:"getValue",table_id:t})},getNotificationsTable:function(){return this.__ajax("post",{method:"getNotificationsTable"})},__setInProcess:function(e){o=e},get:function(e){return this.__ajax("get",{id:e})},setTableFavorite:function(e){return this.__ajax("post",{status:e,method:"setTableFavorite"})},checkInsertRow:function(e,t){var n={};return $.each(e,function(e,t){void 0!=t&&(n[e]=t)}),this.__ajax("post",{data:n,editedFields:JSON.stringify(t),method:"checkInsertRow"})},checkEditRow:function(e){var t={};return $.each(e,function(e,n){void 0!=n&&(t[e]=n)}),this.__ajax("post",{data:t,method:"checkEditRow"})},checkTableIsChanged:function(){return this.__ajax("post",{method:"checkTableIsChanged",table_id:a.tableRow.id,cycle_id:a.tableRow.cycle_id})},checkForNotifications:function(e,t,n){return this.__ajax("post",{method:"checkForNotifications",periodicity:e,activeIds:t},n)},notificationUpdate:function(e,t){return this.__ajax("post",{method:"notificationUpdate",id:e,type:t})},selectSourceTableAction:function(e,t){return this.__ajax("post",{field_name:e,data:t,method:"selectSourceTableAction"})},saveEditRow:function(e){var t={};return $.each(e,function(e,n){void 0!==n&&(t[e]=n)}),this.__ajax("post",{data:t,method:"saveEditRow"})},getEditSelect:function(e,t,n,i,a){return this.__ajax("post",{data:{item:e,field:t},q:n,parentId:i,method:"getEditSelect"},void 0,!a)},loadPreviewHtml:function(e,t,n){return this.__ajax("post",{data:{item:function(e){let t={};return Object.keys(e).forEach(function(n){/^\$/.test(n)||("id"===n?t[n]=e[n]:null!==e[n]&&"object"==typeof e[n]&&-1!==Object.keys(e[n]).indexOf("v")?t[n]=e[n].v:t[n]=e[n])}),t}(t),field:e,val:n},method:"loadPreviewHtml"},null,!0)},save:function(e){let t={};return e.params&&Object.keys(e.params).some(function(e){if("filter"===a.fields[e].category)return a._filtersBlock.data("cryptoFilters")&&(t.filters=a._filtersBlock.data("cryptoFilters")),!0}),this.__ajax("post",{data:e,method:"edit"},null,null,t)},click:function(e){return this.__ajax("post",{data:e,method:"click"})},csvExport:function(e,t){return this.__ajax("post",{method:"csvExport",sorted_ids:JSON.stringify(e),visibleFields:JSON.stringify(t)})},csvImport:function(e,t){return this.__ajax("post",{csv:e,answers:t,method:"csvImport"})},getTableData:function(e){return this.__ajax("post",{method:"getTableData",tableData:{sess_hash:e}})},refresh:function(e){e=e||function(e){a.table_modify.call(a,e),a.reloaded.call(a)},this.__ajax("post",{method:"refresh"}).then(e)},saveOrder:function(e){return this.__ajax("post",{method:"saveOrder",orderedIds:JSON.stringify(e)})},setCommentsViewed:function(e,t,n){return this.__ajax("post",{method:"setCommentsViewed",nums:e,field_name:t,id:n})},AddEyeGroupSet:function(e,t){return this.__ajax("post",{method:"addEyeGroupSet",name:e,fields:t})},removeEyeGroupSet:function(e){return this.__ajax("post",{method:"removeEyeGroupSet",index:e})},leftEyeGroupSet:function(e){return this.__ajax("post",{method:"leftEyeGroupSet",index:e})},reUser:function(e){return this.__ajax("post",{method:"reuser",userId:e})},printTable:function(e){return this.__ajax("post",{method:"printTable",settings:JSON.stringify(e)})},getAllTables:function(){return this.__ajax("post",{method:"getAllTables"})},calcFieldsLog:function(e,t){return this.__ajax("post",{method:"calcFieldsLog",calc_fields_data:e,name:t})},renameField:function(e){return this.__ajax("post",{method:"renameField",name:e})},buttonsClick:function(e,t){return this.__ajax("post",{method:"linkButtonsClick",hash:e,index:t})}}},addTree=function(e,t,n){let i=$("div.page_content");if(!App.isTopWindow())return i.addClass("tree-minifyed iframed"),!1;let a=screen.width<=window.MOBILE_MAX_WIDTH;a?n=!1:$(window).on("resize",function(){window.innerWidth<=660&&!i.is(".tree-minifyed")&&p(!0)}),$.jstree.defaults.core.dblclick_toggle=!1,$.jstree.defaults.core.expand_selected_onload=!0,$.jstree.defaults.core.force_text=!0,$.jstree.link_prefix=e;let o=localStorage.getItem("tree")||"{}";o=JSON.parse(o),$.each(t,function(e,i){if(t[e].data={type:i.type},i.state&&i.state.selected&&(t[e].li_attr={class:"jstree-selected"}),o[i.id]&&(t[e].state||(t[e].state={}),t[e].state.opened=!0),i.href?t[e].a_attr={href:$.jstree.link_prefix+i.href}:i.link&&(t[e].a_attr={href:i.link}),n)switch(i.type){case"folder":t.push({type:"plus",id:"plus-table"+i.id.substring(4),text:"Таблицу",parent:i.id,li_attr:{class:"jstree-creatorView"}}),t.push({type:"plus",id:"plus-folder"+i.id.substring(4),text:"Папку/Ссылку",parent:i.id,li_attr:{class:"jstree-creatorView"}});break;case"cycle_name":t.push({type:"plus",id:"plus-calcs"+i.parent.substring(4),text:"Таблицу",parent:i.id,li_attr:{class:"jstree-creatorView"}})}});let l=$("#leftTree"),s=$("#LeftTree");const r=function(){l.jstree({state:{key:"leftTree"},core:{check_callback:!0,expand_selected_onload:!0,open_parents:!0,data:t,themes:{name:"default-dark"}},types:{folder:{},plus:{icon:"fa fa-plus"},cycle_name:{icon:"fa fa-dot-circle-o"},text:{icon:"jstree-file"},table:{icon:"jstree-file"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles,table_data:{icon:"jstree-file"}},plugins:["types","themes"]}),d()};l.on("loaded.jstree after_open.jstree",function(e){let t=l.width();if(l.find("a.jstree-anchor").each(function(){let e=$(this),n=e.offset().left;e.width(t-n)}),"loaded"===e.type){let e=localStorage.getItem(c);e&&s.scrollTop(e),d()}}),l.on("select_node.jstree",function(e,t){switch((t.node.data?t.node.data.type:null)||t.node.type){case"plus":let e=t.node.id.substring(5,10);if("calcs"===e){let e=t.node.id.substring(11);t.node.parent.substring(5),new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e},type:{v:"calcs"}}).then(function(e){e&&window.location.reload(!0)})}else if("table"===e){let e=t.node.id.length>10?t.node.id.substring(10):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e}}).then(function(e){e&&window.location.reload(!0)})}else{let e=t.node.id.length>11?t.node.id.substring(11):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(window.TREE_TABLE_ID,BootstrapDialog.TYPE_DANGER,{parent_id:{v:e}}).then(function(e){e&&window.location.reload(!0)})}return!1;case"link":window.location.href=t.node.a_attr.href;case"folder":case"project":return t.node.state.opened?($("#leftTree").jstree("close_node",t.node),o[t.node.id]&&(delete o[t.node.id],localStorage.setItem("tree",JSON.stringify(o)))):($("#leftTree").jstree("open_node",t.node),o[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(o))),!1;default:"#"==t.node.original.parent?window.location.href=t.node.original.href:window.location.href=$.jstree.link_prefix+t.node.original.href}return!1});let c="tree_scroll_part_"+(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1];const d=function(){setTimeout(function(){s.getNiceScroll().resize(),localStorage.setItem(c,s.scrollTop())},250)};s.on("scroll",function(){localStorage.setItem(c,s.scrollTop())}),l.on("open_node.jstree",function(e,t){o[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(o)),d()}),l.on("close_node.jstree",function(e,t){o[t.node.id]&&(delete o[t.node.id],localStorage.setItem("tree",JSON.stringify(o))),d()});let f=localStorage.getItem("TreeMinimizer")||"false";f=JSON.parse(f);let p=function(e){f=e;const t=$("#page-tree");e?($("body>.page_content").addClass("tree-minifyed"),$("#LeftTree").getNiceScroll().resize(),t.length&&(t.append(l),l.trigger("after_open"))):($("body>.page_content").removeClass("tree-minifyed"),t.length&&($(".TreeContainer").append(l),l.trigger("after_open"))),$("#table").data("pctable")&&$("#table").data("pctable").setWidthes(),r(),localStorage.setItem("TreeMinimizer",JSON.stringify(f)),d()};a||s.niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:4}}),$("#TreeMaximizer").on("click",function(){a||window.innerWidth<=660?(App.mobilePanel('<a class="totum-brand" href="/"><span>'+$(".totum-brand span:first").text()+"</span></a>",$("#leftTree"),{onhide:function(){const e=$("#page-tree");1===e.length?(l.appendTo(e),r()):(l.appendTo(".TreeContainer"),r())},cssClass:"mobile-panel mobile-menu"}),l.trigger("after_open")):p(!1)}),$("#TreeMinimizer").on("click",function(){p(!0)}),!0===f?setTimeout(function(){p(f)},1):a?setTimeout(function(){1===$("#page-tree").length&&l.appendTo($("#page-tree")),r()},10):r()};