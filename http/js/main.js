App.blink=function(e,t,n){let i=t||8,a=!0,o=function(){a?e.css("background-color",n):e.css("background-color",""),a=!a,--i>0&&setTimeout(o,300)};setTimeout(o,300)},App.panelTimer=function(e,t,n){let i,a=t,o=$("<div>");o.html(a);let l=BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:e,message:o,buttons:[{action:function(e){i&&clearTimeout(i),e.close()},label:"Отмена"}]}),s=function(){--a<=0?(l.close(),n()):(o.html(a),i=setTimeout(s,1e3))};s()},App.setSessionStorage=function(e,t){sessionStorage.setItem(e,JSON.stringify(t))},BootstrapDialog.BUTTON_SIZES[BootstrapDialog.SIZE_NORMAL]="btn-m",BootstrapDialog.defaultOptions.animate=!1,BootstrapDialog.defaultOptions.closeByBackdrop=!1,function(){let e=0;App.showLInks=function(t,n){t.forEach(function(t){if("top-iframe"===t.target&&window.top!=window)return void window.top.App.showLInks([t],n);let i=function(a){"use strict";if(t.postData){let o,l="_self";if("iframe"===a||"top-iframe"===a){let a="iframe"+ ++e;l=a;let s,r=BootstrapDialog.show({message:s=$('<iframe style="width: 100%; '+(t.width?"":"min-width: 500px;")+' height: 70vh; border: none" name = "'+a+'"></iframe>'),size:BootstrapDialog.SIZE_WIDE,title:t.title,draggable:!0,cssClass:"target-iframe",onhidden:function(){if(t.refresh){$("#table").data("pctable");n.refresh()}},onshown:function(e){if(t.width){let n=500;t.width>n&&(n=t.width),e.$modalDialog.width(n)}let n=s.get(0).contentWindow,i=function(){n.App&&n.App.setSessionStorage?n.App.setSessionStorage.call(n,"linkObject",t):setTimeout(i,200)};i()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){s.get(0).contentWindow.location.reload(),o.detach()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){i("self")}},{label:"Открыть в новой вкладке",cssClass:"btn-m btn-default",action:function(e){s.get(0).contentWindow.sessionStorage.linkObject&&(t=JSON.parse(s.get(0).contentWindow.sessionStorage.linkObject)),i("blank"),e.close()}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}]});s.on("load",function(){s.get(0).contentWindow.closeMe=function(){r.close()}})}else"blank"===a?l="_blank":"parent"===a?l="_parent":"top"===a?l="_top":window.parent!==window&&(sessionStorage.linkObject=JSON.stringify(t));o=$("<form>",{method:"post",action:t.uri,target:l});const s=function(e,t){"boolean"==typeof t&&(t=!0===t?"true":"false"),"string"==typeof t||"number"==typeof t||null===t?o.append($("<input>",{type:"hidden",name:e,value:t})):$.each(t,function(t,n){s(e+"["+t+"]",n)})};$.each(t.postData,function(e,t){s(e,t)}),o.appendTo("body").submit(),o.detach()}else switch(a){case"top":window.top.location.href=t.uri;break;case"parent":window.parent.location.href=t.uri;break;case"blank":let e=$('<a href="'+t.uri+'" target="_blank">link</a>');e.appendTo("body"),e.get(0).click(),e.remove();break;case"iframe":case"top-iframe":let o=t.uri;if(t.elseData){let e=[];!1===t.elseData.header&&e.push("param"),!1===t.elseData.footer&&e.push("footer"),o+="#"+encodeURIComponent(JSON.stringify({wc:e}))}let l=$('<iframe src="'+o+'" style="width: 100%; height: 70vh; border: none"></iframe>'),s=BootstrapDialog.show({message:l,draggable:!0,size:BootstrapDialog.SIZE_WIDE,title:t.title,cssClass:"target-iframe",onhidden:function(){t.refresh&&n.refresh()},onshown:function(e){t.width&&e.$modalDialog.width(t.width);let n=l.get(0).contentWindow,i=function(){n.App&&n.App.setSessionStorage?n.App.setSessionStorage.call(n,"linkObject",t):setTimeout(i,200)};i()},buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(){l.get(0).contentWindow.location.reload()}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){l.get(0).contentWindow.sessionStorage.linkObject&&(t=JSON.parse(l.get(0).contentWindow.sessionStorage.linkObject)),i("self")}},{label:"Открыть в новой вкладке",cssClass:"btn-m btn-default",action:function(e){l.get(0).contentWindow.sessionStorage.linkObject&&(t=JSON.parse(l.get(0).contentWindow.sessionStorage.linkObject)),i("blank"),e.close()}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}]});l.on("load",function(){l.get(0).contentWindow.closeMe=function(){s.close()}});break;default:window.parent!=window&&(sessionStorage.linkObject=JSON.stringify(t)),window.location.href=t.uri}};i(t.target)})},App.showDatas=function(e,n){let i=[],a=this;return e.forEach(function(e){switch(e[0]){case"table":i.push(function(e,n){let i;e.height&&(i=e.height,/^\d+$/.test(e.height)&&(i+="px"));let a=$('<iframe style="width: 100%; height: '+(i||"80vh")+'; border: none;" src="/Table/0/'+e.table_id+"?sess_hash="+e.sess_hash+'">');$("body").append(a);let o=[];o.push({label:"В новой вкладке",cssClass:"btn-m btn-default",action:function(t){window.open("/Table/0/"+e.table_id+"?sess_hash="+e.sess_hash,"_blank");t.close()}});t(e.title,a,e.width,e.refresh,BootstrapDialog.TYPE_SUCCESS,n,o)}(e[1],a));break;case"text":i.push(function(e,n){t(e.title,e.text,e.width,e.refresh,null,n)}(e[1],a));break;case"print":i.push(function(e,t,n){if(App.fullScreenProcesses.showCog(),n){var i=new Blob([atob(n)],{type:"application/pdf"}),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.target="_blank",document.body.appendChild(o),o.click()}else{let n=$('<iframe style="width: 500px; height: 200px; position: absolute; top: -1000px; background: #fff;">').appendTo("body"),i=n[0],a=i.contentWindow?i.contentWindow:i.contentDocument.defaultView;a.document.head.innerHTML="<style>"+t+"</style>",a.document.body.innerHTML=e;let o=a.document.body,l=$.Deferred(),s=0;const r=function(){o.scrollTop=o.scrollHeight+100,++s<100&&o.scrollTop>=o.scrollHeight?setTimeout(r,50):setTimeout(function(){l.resolve()},3e3)},c=function(){++s<100&&o.scrollHeight<200?setTimeout(c,50):(s=0,r())};c(),l.then(function(){App.fullScreenProcesses.hideCog(),setTimeout(function(){a.focus(),a.print()},250),setTimeout(function(){},1e4)})}}(e[1].body,e[1].styles));break;case"notification":if(e[1].text){let t=$.notify({message:"<div>"+e[1].text+"</div>"},{offset:{x:20,y:50},type:"warning",allow_dismiss:!0,delay:0,onClose:function(){a.notificationUpdate(n,"deactivate").then(function(){t.$ele.trigger("hide.bs.modal")})}});t.$ele.find("button.close").before('<button class="timer"><i class="fa fa-clock-o"></i></button>'),t.$ele.on("click",".timer",function(){a.notificationUpdate(n,"later").then(function(){t.$ele.trigger("hide.bs.modal"),t.$ele.remove()})}),i.push({$modal:t.$ele,simpleClose:function(){t.$ele.remove()}})}else i.push(function(e){if(e.table_id){let t=$('<iframe style="width: 100%; height: 100%; border: none;" src="/html.html?rand='+Math.round(1e4*Math.random())+'">'),n=$('<div class="notificationTable"></div>').appendTo("body").append(t).css({width:e.width,height:e.height});return t.on("load",function(){let i=t.get(0).contentWindow;e.ROLESLIST=window.ROLESLIST||$("#table").data("pctable").ROLESLIST,i.data=e,i.closeMe=function(){n.trigger("hide.bs.modal"),n.remove()},t.contents().find("body").append('<div class="page_content tree-minifyed"><div id="table"></div></div><script>let table_id=window.data.table_id; App.getPcTableById(table_id, {sess_hash: window.data.sess_hash}, $("#table"), {beforeSpaceHide: true, ROLESLIST: window.data.ROLESLIST, withoutScrolls: true, data: window.data.data, f: window.data.f, data_params: window.data.data_params, withHeader: !(window.data.elseData && window.data.elseData.header===false), withFooter: !(window.data.elseData && window.data.elseData.footer===false)})<\/script>')}),{$modal:n,simpleClose:function(){n.remove()}}}}(e[1]))}}),i},App.getPcTableById=function(e,t,n,i){let a=$.Deferred();return new App.models.table("/Table/0/"+e.toString(),{},{}).getTableData(t?t.sess_hash:null).then(function(o){if(i&&(!1===i.withHeader||!1===i.withFooter)){Object.values(o.fields).forEach(function(e,t){"param"===e.category&&!1===i.withHeader?delete o.fields[e.name]:"footer"===e.category&&!1===i.withFooter&&delete o.fields[e.name]}),delete i.withHeader,delete i.withFooter}o.model=new App.models.table("/Table/0/"+e.toString(),$.extend({updated:o.updated},t||{})),$.extend(!0,o,i);let l=new App.pcTableMain(n,o);a.resolve(l)}),a.promise()},App.showPanels=function(e){if(window.top!=window)return window.top.App.showPanels.call(window.top,e);let t={},n=$.Deferred();const i=function(){let a=e.shift(),o={};a.id?o.id=a.id:a.field&&(o=a.field);const l=function(t){new EditPanel(t.tableRow.id,BootstrapDialog.TYPE_PRIMARY,o,e.length>0).then(function(t,o){if(t&&a.refresh){$("#table").data("pctable").model.refresh()}else if((t||o)&&e.length)return void i();n.resolve()})};a.uri!==window.location.pathname?t[a.uri]?l(t[a.uri]):new App.models.table(a.uri,{},{}).getTableData().then(function(e){e.model=new App.models.table(a.uri,{updated:e.updated}),t[a.uri]=new App.pcTableMain(null,e),l(t[a.uri])}):l($("#table").data("pctable"))};return i(),n};let t=function(e,t,n,i,a,o,l){return(l=l||[]).push({label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}),BootstrapDialog.show({message:t,title:e,type:a||null,draggable:!0,onhidden:function(){i&&("strong"===i?window.location.reload():o.refresh())},onshown:function(e){n&&e.$modalDialog.width(n)},buttons:l})}}(),String.prototype.hashCode=function(){var e,t=0;if(0===this.length)return t;for(e=0;e<this.length;e++)t=(t<<5)-t+this.charCodeAt(e),t|=0;return t},App.confirmation=function(e,t,n){let i=[];return Object.keys(t).forEach(function(e){i.push({label:e,action:t[e]})}),BootstrapDialog.show({type:"edit",title:n,message:e,buttons:i,draggable:!0,onshow:function(e){e.$modalContent.css({width:"70vw",maxWidth:"800px"})},onshown:function(e){e.$modalContent.position({of:window})}})},App.copyMe=function(e){let t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)},App.dateFormats={base:"DD.MM.YY",db:"YYYY-MM-DD",covert:function(e,t,n){return moment(e,t).format(n)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},App.dateTimeFormats={base:"DD.MM.YY HH:mm",db:"YYYY-MM-DD HH:mm",covert:function(e,t,n){return moment(e,t).format(n)},covertToDb:function(e,t){return t=t||this.base,moment(e,t).format(this.db)},covertFromDb:function(e,t){return t=t||this.base,moment(e,this.db).format(t)},isValid:function(e,t){return t=t||this.base,moment(e,t).isValid()}},Object.equals=function(e,t){let n=[];return function e(t,i){if(t===i)return!0;if(t instanceof Date&&i instanceof Date)return+t==+i;if("object"!=typeof t||"object"!=typeof i||null===i||null===t)return!1;if(function(e,t){for(var i=n.length;i--;)if(!(n[i][0]!==e&&n[i][0]!==t||n[i][1]!==t&&n[i][1]!==e))return!0;return!1}(t,i))return!0;if(n.push([t,i]),Array.isArray(t)!==Array.isArray(i))return!1;if(Array.isArray(t)){if(t.length!==i.length)return!1;let n=t.length;for(;n--;)if(!e(t[n],i[n]))return!1}else{let n=Object.keys(t),a=n.length;if(Object.keys(i).length!==a)return!1;for(;a--;)if(!e(t[n[a]],i[n[a]]))return!1}return!0}(e,t)},function(){let e="fa-cog",t=$("#big_loading i"),n=0;App.fullScreenProcesses={showCog:function(){1===++n&&App.fullScreenProcesses.show("fa-cog",!0)},hideCog:function(){--n<1&&(n=0,App.fullScreenProcesses.hide())}},App.fullScreenProcesses.show=function(n,i){i=i||!1,$("body").addClass("lock"),i&&!t.is(".fa-spin")?t.addClass("fa-spin"):!i&&t.is(".fa-spin")&&t.removeClass("fa-spin"),e!=n&&(t.removeClass(e).addClass(n),e=n),$("#big_loading").show().animate({opacity:1},250)},App.fullScreenProcesses.hide=function(e){$("body").removeClass("lock"),$("#big_loading").animate({opacity:0},250,function(){$("#big_loading").hide()})}}(),App.hexToRGB=function(e,t){var n=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return t?"rgba("+n+", "+i+", "+a+", "+t+")":"rgb("+n+", "+i+", "+a+")"},$.fn.extend({isAttached:function(){return 1===$(this).closest("html").length}}),App.isTopWindow=function(){let e=!1;try{e=window!=window.top||document!=top.document||self.location!=top.location}catch(t){e=!0}return!e},App.logOutput=function(e){let t=$('<div style="overflow-x: auto">'),n=[{label:"Развернуть все",cssClass:"btn-m btn-default",action:function(e){t.jstree("open_all")}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];"string"==typeof e&&n.splice(0,1),window.top.BootstrapDialog.show({message:t,type:BootstrapDialog.TYPE_DANGER,title:"Схема расчета",buttons:n,draggable:!0,onshown:function(n){n.$modalContent.position({of:window.top}),"string"==typeof e?t.html('<div style="color: white; ">'+e+"</div>"):t.jstree({state:{key:"leftTree"},core:{check_callback:!0,open_parents:!0,data:e,themes:{name:"default-dark"}},types:{folder:{},code:{icon:"fa fa-cog"},cogs:{icon:"fa fa-cogs"},error:{icon:"fa fa-exclamation-triangle"},list:{icon:"fa fa-code"},fixed:{icon:"fa fa-hand-rock-o"},param:{icon:"fa fa-hashtag"},execcode:{icon:"fa fa-magic"},recalcs:{icon:"fa fa-recycle"},clocks:{icon:"fa fa-clock-o"},mbs:{icon:"fa fa-database"},selects:{icon:"fa fa-navicon"},"!":{icon:"fa fa-exclamation"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles},plugins:["types","themes"]})},onshow:function(e){let t=.8*window.top.innerWidth;e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:t}),e.$modalContent.find(".modal-body").css("background-color","#333")}})},App.modal=function(e,t,n){var i=$('<div class="modal fade" id="appNotify" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title"></h4> </div> <div class="modal-body"> </div> <div class="modal-footer"> </div> </div> </div> </div>');if((o={body:i.find(".modal-body"),header:i.find(".modal-header"),title:i.find(".modal-title"),footer:i.find(".modal-footer"),block:i}).block.on("hidden.bs.modal",function(){$(this).remove()}),"object"==typeof e&&e instanceof jQuery?o.body.empty().append(e):o.body.html(e),t?o.title.html(t):o.header.hide(),n)if("object"==typeof n){var a=$("<div>"),o=o;$.each(n,function(e,t){if("close"!=t){var n="default";"object"==typeof t&&(t.class&&(n=t.class),t.func&&(t=t.func));var i=$('<button type="button" class="btn btn-'+n+'">'+e+"</button>");a.append(i),t&&"function"==typeof t&&i.on("click",function(){t(o.block)})}else a.append('<button type="button" class="btn btn-default" data-dismiss="modal">'+e+"</button>")}),o.footer.html(a.children())}else o.footer.html(n);else o.footer.hide();return o.block.modal("show").css("z-index","10000"),o.block},$.expr.pseudos.multiincludes=function(e,t,n){let i=$(e).find("a"),a=(i.data("tokens")||i.text()).toString().toUpperCase().replace("ё","е");return!n[3].toUpperCase().replace("ё","е").split(" ").some(function(e){return-1===a.indexOf(e)})},App.notify=function(e,t,n){BootstrapDialog.show({message:e,type:BootstrapDialog.TYPE_DEFAULT,title:t,buttons:[{label:"Закрыть",action:function(e){e.close()}}],onshow:function(e){t||e.$modalHeader.remove()}})},App.topNotify=function(e,t,n){t=t||"",$("#notifies").append('<div class="alert alert-success"><a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><strong>'+t+"</strong>"+e+"</div>")},App.popNotify=function(e,t,n,i,a){let o,l="bottom",s={},r={};return e.isParams&&(s=e,e.element&&(t=e.element),e.timeout&&(n=e.timeout),e.container&&(i=e.container),e.trigger&&(a=e.trigger),e.placement&&(l=e.placement),e.class&&(o=e.class),e=e.$text),n=n||void 0,i=i||t.closest(".pcTable-scrollwrapper, .InsertPanel"),a=a||"manual",r=$.extend(r,{html:!0,content:e,trigger:a,container:i,placement:l,width:"70vw",animation:!1}),"default"==n&&(n=2e3),t.on("shown.bs.popover",function(){let e=t.data("bs.popover"),n=parseInt(e.$tip.css("left")),a=parseInt(e.$arrow.css("left"));if(n<0&&(e.$tip.css("left",0),e.$arrow.css("left",a+n+"px")),"bottom"===l){let n=t.offset().top+t.outerHeight(),a=e.$tip.offset().top,o=i.scrollTop()-i.offset().top;a-n>10&&e.$tip.css("top",n+2+o+(i.is(".InsertPanel")?$(".modal-dialog").offset().top:0))}}),t.popover(r),"manual"==a&&(t.popover("show"),o&&$("#"+t.attr("aria-describedby")).addClass(o)),t.on("remove destroy",function(){t&&t.attr("aria-describedby")&&t.popover("destroy")}),e.on&&e.on("remove destroy",function(){t.length&&t.attr("aria-describedby")&&$("#"+t.attr("aria-describedby")).length&&t.popover("destroy")}),n&&setTimeout(function(){t&&t.attr("aria-describedby")&&t.popover("destroy")},n),t.attr("aria-describedby")},App.ksort=function(e){var t=Object.keys(e).sort(),n={};for(var i in t)n[t[i]]=e[t[i]];return n},App.values=function(e){let t=[];for(let n in e)t.push(e[n]);return t},App.keys=function(e){let t=[];for(let n in e)t.push(n);return t},App.isEmpty=function(e){if(null==e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;if("object"!=typeof e)return!0;for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0},App.filter=function(e,t){let n={};return Object.keys(e).forEach(function(i){t(i,e[i])&&(n[i]=e[i])}),n},App.openInIframe=function(e,t,n){n=n||"newIframe";let i=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+n+'"></iframe>');BootstrapDialog.show({message:i.attr("src",t),size:BootstrapDialog.SIZE_WIDE,title:e,buttons:[{label:"Обновить",cssClass:"btn-m btn-default",action:function(e){let a;a=$('<iframe style="min-width: 500px; width: 100%; height: 70vh; border: none" name = "'+n+'"></iframe>').attr("src",t),i.replaceWith(a),i=a}},{label:"Открыть",cssClass:"btn-m btn-default",action:function(e){$("<a>").attr("href",t).hide().appendTo("body").get(0).click(),e.close()}},{label:"Открыть в новой вкладке",cssClass:"btn-m btn-default",action:function(e){let n=$("<a>").attr("href",t).attr("target","_blank").hide().appendTo("body");n.get(0).click(),n.remove(),e.close()}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}]})},App.aInIframe=function(e){return e=$(e),App.openInIframe(e.text(),e.attr("href")),!1},App.reUserInterface=function(e,t){let n=$("#UserFio");n.css("cursor","pointer"),t&&App.blink(n,10,"#ffe486");const i=function(){let t=$('<div class="tech-table" style="height: 220px; width: 200px;"><div class="select-btn"></div><div></div></div>'),a=$('<select data-size="6" class="open" title="Выберите пользователя" data-style="btn-sm btn-default" data-live-search="true" data-width="100%">');Object.keys(e).forEach(function(t){a.append($("<option>").text(t).data("content",e[t]))});let o=t.find(".tech-table");t.find(".select-btn").append(a),n.popover({html:!0,content:t,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),a.selectpicker("render").selectpicker("toggle"),a.data("container",o),a.on("hide.bs.select",function(){return a.val()&&function(e){let t=App.models.table("/Main/",{},{}),n=$("#table").data("pctable")||{isCreatorView:!0};t.addPcTable(n),t.reUser(e)}(a.val()),$("body").off("click.FioPopover"),!1}),setTimeout(function(){a.selectpicker("render"),n.popover("show"),$("#"+n.attr("aria-describedby")).css("top","45px"),a.data("selectpicker").$searchbox.focus(),$("body").one("click.FioPopover",function(e){void 0!==e.altKey&&(n.popover("destroy"),n.one("click",i))})},50)};n.one("click",i)},App.rgb2hex=function(e){return(e=e.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===e.length?"#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2):""},App.tableTypes={simple:{icon:"fa fa-table",title:"Простая"},version:{icon:"fa fa-calendar",title:"Версионная"},calcs:{icon:"fa fa-calculator",title:"Расчетная в цикле"},globcalcs:{icon:"fa fa-calculator",title:"Расчетная"},tmp:{icon:"fa fa-clock-o",title:"Временная"},cycles:{icon:"fa fa-circle-o",title:"Циклы"}},App.textWithLinks=function(e){return $("<div>").text(e).html().replace(/(https?:\/\/[^\s]+)/g,function(e){return'<a href="'+e+'" target="_blank">'+e+"</a>"})},function(){var e=0;App.getUn=function(){return e++}}(),$.fn.datetimepicker.defaults.icons.close="glyphicon glyphicon-ok",$.fn.datetimepicker.defaults.tooltips.close="Применить и закрыть",function(){window.Hlps||(window.Hlps={});var e=window.Hlps;e.selectpicker={},e.selectpicker.open=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];(t=$(t)).attr("aria-expanded")&&"false"!==t.attr("aria-expanded")||t.click()},e.selectpicker.focus=function(e){var t=function(){var n=e.data("this");if(n&&e.is(".selectpicker")){var i=n.$newElement.children()[0];(i=$(i)).focus()}else{var a=0;setTimeout(function(){if(!(++a<4))return!1;t()},1+100*a)}};t()},e.selectpicker.getButton=function(e){var t=$(e).data("selectpicker").$newElement.children()[0];return t=$(t)}}(),restModel=function(e){return{url:e,create:function(){return $.ajax({url:this.url,method:"post",data:data})},get:function(e){return $.ajax({url:this.url,method:"get",data:{id:e}})},save:function(e,t){return $.ajax({url:this.url,method:"PUT",data:$.extend(t,{id:e})})}}},$(function(){let e=$("#docs-link");const t=function(){let n=$(this).data("type"),i=$('<div class="tech-table" id="DocsPopover" data-type="'+n+'" style="min-height: 250px"></div>');$.post("https://docs.totum.online/index_"+n+".json",function(e){e&&e.length&&e.forEach(function(e){i.append('<div style="'+(e[2]||"")+'"><i class="fa fa-external-link"></i> <a href="http://docs.totum.online'+e[1]+'" target="totum-docs">'+e[0]+"</a></div>")})}),e.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'}),setTimeout(function(){e.popover("show"),$("#"+e.attr("aria-describedby")).css("top","45px"),$("body").one("click.DocsPopover",function(n){void 0!==n.altKey&&(e.popover("destroy"),e.one("click",t))})},50)};e.one("click",t)}),function(e,t){const n="#ee0c1f",i="#3fbf46",a="pcTableInsertRowPanel";var o=0;!function(){let n=App.functions||[],i=[];n.forEach(function(e){e.d||i.push(e.name)});let a={};n.forEach(function(e){a[e.name.toLowerCase()]=[e.t,0,e.p,e.n,e.m]});let o=["where","order","field","sfield","bfield","tfield","preview","parent","section","table","filter"];CodeMirror.defaults.scrollbarStyle="overlay",CodeMirror.defineInitHook(function(n){try{if(!n.options.bigOneDialog){let i,a=t('<i class="fa fa-expand codemirror-expander" style="position: absolute;\n    right: 10px;\n    bottom: 10px;\n    z-index: 10000;\n    font-family: FontAwesome; cursor: pointer"></i>');t(n.display.wrapper).append(a),a.on("click",function(){i=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');let a,o=n.getValue();e.top.BootstrapDialog.show({message:i,type:null,title:"Правка текстового поля",cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){n.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),e.$modalHeader.find("button.close").css("font-size","16px").html('<i class="fa fa-compress"></i>')},onshown:function(t){a=CodeMirror(i.get(0),{mode:n.options.mode,value:o,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t}),n.table&&(a.table=n.table);let l=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=l+"px",i.find(".CodeMirror").css("min-heught",l),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})})}}catch(e){n.setValue(e.message)}});function l(e){if(e.getOption("disableInput")||"totum"!==e.getOption("mode"))return CodeMirror.Pass;var t=e.listSelections(),n=[];let i=!1;for(let r=0;r<t.length;r++){if(!t[r].empty())return CodeMirror.Pass;var o=t[r].head,l=e.getTokenAt(o,!0);if(l.state.inFuncName||"function"==l.type||"error"==l.type){let c,d=l.string.toLowerCase(),f="";if(-1!==d.indexOf("/")?(c=d.substring(0,d.indexOf("/")),f=d.substring(d.indexOf("/"))):c=d.trimRight(),c=a[c]){let e="",t=0;if(f.length){e="(";let n=1,a=!0;f.split("/").forEach(function(t){if(0===t.length);else{a||(e+="; "),a=!1;let i=-1!==t.indexOf(":")&&""!==t.slice(t.indexOf(":")+1).trim();if(e+=t+(-1===t.indexOf(":")?": ":""),1===n&&!i){t.slice(0,t.indexOf(":"));n=e.length}}}),1===n?n=e.length:i=!0,t+=n,e+=")"}else if(e=c[0],/:/.test(e)){let n=e.indexOf(":"),a=e.substring(n),o=a.substring(0,a.indexOf(";")||a.indexOf(")"));t+=n,-1!==o.indexOf("'")?t+=o.indexOf("'")+1:t+=2,i=!0}else t+=e.length;n[r]={text:e,newPos:CodeMirror.Pos(o.line,o.ch-f.length+t),replace:CodeMirror.Pos(o.line,o.ch-f.length)}}else n[r]={text:"()",newPos:CodeMirror.Pos(o.line,o.ch+1),replace:CodeMirror.Pos(o.line,o.ch)};let u=n[r];if(u){e.replaceRange(u.text,u.replace,t[r].anchor,"+insert");var s=e.listSelections().slice(0);s[r]={head:u.newPos,anchor:u.newPos},e.setSelections(s),i&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}}}}CodeMirror.defineMode("totum",function(){return{startState:function(){return{inString:!1,isStart:!0,inFunction:!1,lineName:""}},token:function(e,n){function i(){return e.string.substring(e.start,e.pos)}function l(){"use strict";return e.skipToEnd(),"error"}n.lineNames=[];try{e.lineOracle.doc.cm.getValue().split("\n").forEach(function(e){return 0===e.trim().length||0===e.indexOf("//")?"":n.lineNames.push(e.replace(/^\s*~?\s*([a-zA-Z0-9=]+)\s?:.*/,"$1"))})}catch(e){}if(0===e.pos||!0===n.isStart){if(e.string.match("^[\ts]*//"))return e.skipToEnd(),n.isStart=!1,"comment";let a="start";if(n.isStart=!0,/[\t\n]/.test(e.peek())&&e.next()){for(;/[\t\n]/.test(e.peek())&&e.next(););return"start-tabs"}return e.skipTo(":")?(n.lineName=i().trim(),"~"===n.lineName.substring(0,1)&&(a+=" fixed",n.lineName=n.lineName.substring(1)),/^[a-z0-9_]+\s*$/i.test(n.lineName)||"="===n.lineName||/^f[0-9]+\s*=\s*$/i.test(n.lineName)?(e.next(),t(e.lineOracle.doc.cm.getWrapperElement()).find(".cm-var-not-in").each(function(){let e=t(this).text();(e=e.replace(/\[.*/,""))!=="$"+n.lineName&&e!=="#$"+n.lineName&&e!=="$$"+n.lineName||t(this).removeClass("cm-var-not-in")}),n.lineNames.filter(function(e){return e===n.lineName}).length>1&&(a+=" dubbled"),n.isStart=!1,a):l()):l()}switch(n.isStart=!1,e.peek()){case" ":return e.next(),null;case"{":return e.next(),e.skipTo("}")?(e.next(),"inVars"):l();case'"':let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string"):l();case"#":e.next();let i="db_name";for(;/[a-z0-9_А-Яа-я\[\]\$\#".]/.test(e.peek())&&e.next(););let a=e.string.substring(e.start+1,e.pos);return/[^0-9a-z._]/.test(a)&&(i+=" tmp-error"),""===a?l():("$"===a[0]&&(a=a.replace(/\[.*/g,"").slice(1),-1===n.lineNames.indexOf(a)&&(i+=" var-not-in")),i);case"@":e.next();let o,s=e.peek();for(;/[a-z0-9_.\[\$\#"A-Z\]]/.test(o=e.peek())&&e.next();)s+=o;return/^[a-z0-9_]{3,}\.[a-z0-9_]{2,}(\[[a-zA-Z0-9_\$\#"]+\])*$/i.test(s)?"db_name":l();case"$":if(e.next(),"#"===e.peek()){for(e.next();/[a-z0-9_\[\]\$\#"]/i.test(e.peek())&&e.next(););return"code-var"}{for(;/[a-zA-Z0-9_\[\]\$\#"]/i.test(e.peek())&&e.next(););let t=e.string.substring(e.start,e.pos),i="variable",a=(t=t.replace(/\[.*/g,"")).substring(1);return"$"===a[0]&&(i+=" dollar-dollar",a=a.substring(1)),-1===n.lineNames.indexOf(a)&&(i+=" var-not-in"),i}case"t":if("true"===e.string.substring(e.start,e.start+4))return e.skipTo("e"),e.next(),"boolean";break;case"f":if("false"===e.string.substring(e.start,e.start+5))return e.skipTo("e"),e.next(),"boolean"}if(n.inFuncName=!1,!n.inFunction&&/[a-zA-Z]/.test(e.peek())){if(n.inFuncName=!0,e.skipTo("(")?n.inFunction=!0:e.skipToEnd(),!/^[a-zA-Z]+[0-9]*\s*$/.test(i()))return l();let t=a[i().trim().toLowerCase()];return t?(n.func=t,e.next(),"function"):l()}if(n.inFunction){if(")"===e.peek())return e.next(),n.inFunction=!1,n.functionParam="","function";if(!n.functionParam&&/[a-z_]/.test(e.peek())){if(e.skipTo(":")){let t=e.string.substring(e.start,e.pos);if(/^[a-z_]+\s*$/.test(t)){if(n.functionParam=t,e.next(),-1===n.func[2].indexOf(t))return l();let i="functionParam";return-1!==o.indexOf(t)&&(i+=" fieldParam"),-1!==n.func[3].indexOf(t)&&(i+=" reqParam"),n.func[4]&&-1!==n.func[4].indexOf(t)&&(i+=" multiParam"),i}return l()}return e.skipTo(")")?"error fieldParam":l()}if(!n.functionParam)return l();if(";"===e.peek())return e.next(),n.functionParam="","";if("order"===n.functionParam&&/[ad]/.test(e.peek())){if("asc"===e.string.substring(e.start,e.start+3))return e.next(),e.next(),e.next(),"";if("desc"===e.string.substring(e.start,e.start+4))return e.next(),e.next(),e.next(),e.next(),""}if("'"===e.peek()){let t=e.peek();return e.next(),e.skipTo(t)?(e.next(),"string-name"):l()}}if(/\d|%/.test(e.peek())){for(e.next();/[0-9.%]/.test(e.peek())&&e.next(););return/^\d+(\.\d+)?%?$/.test(e.string.substring(e.start,e.pos))?"number":l()}return/[+-\/*!<>=]/.test(e.peek())?(e.next(),"operator"):l()}}}),CodeMirror.registerHelper("hint","totumVars",function(e,n){return function(e,n,l,r){var f=e.getCursor(),p=l(e,f);if("error"!==p.type&&"string-name"!==p.type&&/\b(?:string|comment)\b/.test(p.type))return;var h=CodeMirror.innerMode(e.getMode(),p.state);if("json"===h.mode.helperType)return;p.state=h.state,p.inString=p.string,p.state.isDb_name=!1,p.state.showAll=!0,r.inStart=!0;let m,b=function(e,t,n){void 0!==n&&null!==n&&(e.replaceRange(n.text||n,t.from,t.to),n.curPos&&e.setCursor({line:t.from.line,ch:n.curPos}),n.showHint&&CodeMirror.showHint(e,CodeMirror.hint.totumVars,{}))};if(n=n.slice(),p.state.isStart||0===f.ch){n=[],p.string=p.string.replace(/^[\t]+/,"");let i="";/^~/.test(p.string)&&(p.string.replace(/^~/,""),i="~"),t(e.getWrapperElement()).find(".cm-var-not-in").each(function(){let e=t(this).text().replace(/^(\#|\$)?\$/,"").replace(/\[.*/,"");n.push({text:i+e+": ",displayText:e})})}else if(/^'.*?'?$/.test(p.string)&&-1!==o.indexOf(p.state.functionParam))if(p.state.showAll=!0,"''"===p.string?(p.end=p.end,p.start+=1,p.string=""):/'[a-z_0-9]+'/.test(p.string)?(p.start+=1,p.string=p.string.slice(1,f.ch-p.start)):(p.string=p.string.slice(1,f.ch-p.start),p.start+=1,p.end=f.ch,"'"===e.getLine(f.line)[f.ch]&&p.end++),"table"===p.state.functionParam){let e=c();n=[],Object.keys(e).forEach(function(t){n.push({text:t+"'",textVis:t,title:e[t].t,render:d,type:"item-string-name",hint:b,tab:!0})})}else{let t,i=e.getLine(f.line),a=i.substring(0,f.ch),o=i.substring(f.ch),l=o.substring(0,o.indexOf(")"));if(a=a.substring(a.lastIndexOf("("))+l,t=a.match(/table:\s*((\$#ntn)|'([a-z_0-9]*)')/)){let i=t[2]?e.table:t[3];n=[],Object.keys(s[i].f).forEach(function(e){n.push({text:e+"'",textVis:e,title:s[i].f[e],render:d,type:"item-string-name",curPos:f.ch+e.length+1,tab:!0})}),n.push({text:"id'",textVis:"id",title:"",render:d,type:"item-string-name",curPos:f.ch+3,tab:!0})}}else if(p.end>f.ch&&(p.end=f.ch,p.string=p.string.slice(0,f.ch-p.start)),0===p.string.indexOf("@")){r.inStart=!1,n=[];let e,t=c();if(p.string=p.string.slice(1,f.ch-p.start),p.start=p.start+1,p.end=f.ch,e=p.string.match(/^([a-z_0-9]+)\./)){let i=e[1];p.start+=(i+".").length,p.string=p.string.slice((i+".").length),t[i]&&t[i]["@"].length&&t[i]["@"].forEach(function(e){n.push({text:e,title:t[i].f[e],render:d,type:"item-db_name"})})}else Object.keys(t).forEach(function(e){t[e]["@"].length&&n.push({text:e+".",textVis:e,title:t[e].t,render:d,type:"item-db_name",showHint:!0,hint:b})})}else if("$#"===p.string.slice(0,2)){n=[{text:"$#lc",title:"Пустой лист",render:d,type:"item-code-var"},{text:"$#nd",title:"дата - Y-m-d",render:d,type:"item-code-var"},{text:"$#ndt",title:"дата-время - Y-m-d H:i",render:d,type:"item-code-var"},{text:"$#ndts",title:"дата-время с секундами - Y-m-d H:i:s",render:d,type:"item-code-var"},{text:"$#nu",title:"id пользователя",render:d,type:"item-code-var"},{text:"$#nr",title:"ids ролей пользователя",render:d,type:"item-code-var"},{text:"$#nti",title:"id таблицы",render:d,type:"item-code-var"},{text:"$#ntn",title:"NAME таблицы",render:d,type:"item-code-var"},{text:"$#nth",title:"HASH врем. таблицы",render:d,type:"item-code-var"},{text:"$#nci",title:"Cycle расчетной таблицы",render:d,type:"item-code-var"},{text:"$#nf",title:"NAME поля",render:d,type:"item-code-var"},{text:"$#nl",title:"Новая строка",render:d,type:"item-code-var"},{text:"$#ids",title:"id отмеченных галочками полей",render:d,type:"item-code-var"},{text:"$#nfv",title:"Значение текущего поля (для селектов/действий/форматов)",render:d,type:"item-code-var"},{text:"$#onfv",title:"Прошлое значение текущего поля",render:d,type:"item-code-var"},{text:"$#nh",title:"Текущий хост-name",render:d,type:"item-code-var"}];const e=function(e){let t=n.slice(),i=[];return t=t.filter(function(t){if(-1===e.indexOf(t.text))return!0;i.push(t)}),t=i.concat(t)};switch(p.state.functionParam){case"table":n=e(["$#ntn"]);break;case"cycle":n=e(["$#nci"]);break;case"field":n=e(["$#nf","$#nfv"])}}else if(m=p.string.match(/^(#?\$)/))n=[],p.string=p.string.slice(m[1].length,f.ch-p.start),p.start=p.start+m[1].length,p.end=f.ch,p.state.lineNames.forEach(function(e){-1===e.indexOf("=")&&n.push(e)});else if(m=p.string.match(/^\#/))n=[],p.string=p.string.slice(1,f.ch-p.start),p.start=p.start+1,p.end=f.ch,(m=p.string.match(/^([a-z]{1,3}\.)/))&&(p.string=p.string.slice(m[1].length),p.start+=m[1].length),e.table&&s[e.table]&&(Object.keys(s[e.table].f).forEach(function(t){n.push({text:t,title:s[e.table].f[t],render:d,type:"item-db-name"})}),n.push({text:"id",title:"",render:d,type:"item-db-name"}));else if(p.state.inFuncName){if(!p.state.inFunction)if(m=p.string.match(/^([a-zA-Z]+)\//)){let e;if(p.state.showAll=!0,e=a[m[1].toLowerCase()]){let t=p.start;p.start=p.start+p.string.lastIndexOf("/")+1,p.string=p.string.slice(p.string.lastIndexOf("/")+1,f.ch-t),p.end=f.ch,n=[],e[2].forEach(function(t){let i="";-1!==e[3].indexOf(t)&&(i+=" item-reqParam"),-1!==e[4].indexOf(t)&&(i+=" item-multiParam"),-1!==o.indexOf(t)&&(i+=" item-fieldParam"),n.push({text:t+": ",textVis:t,title:"",render:d,type:i})})}}else(n=i.slice()).push("true"),n.push("false")}else p.state.func&&("error fieldParam"===p.type||/(\(|;\s*)$/.test(e.getLine(f.line).slice(0,p.start)))?(n=[],p.state.func[2].forEach(function(t){let i="",a="";")"!==e.getLine(f.line).slice(f.ch).trim()&&(a="; "),-1!==p.state.func[3].indexOf(t)&&(i+=" item-reqParam"),-1!==p.state.func[4].indexOf(t)&&(i+=" item-multiParam"),-1!==o.indexOf(t)&&(i+=" item-fieldParam"),n.push({text:t+": "+a,textVis:t,title:"",render:d,type:i,hint:b,curPos:p.start+(t+": "+a).length-a.length})})):(n=["true","false"],"order"===p.state.functionParam&&(n=n.concat(["asc","desc"])));return{list:function(e,t,n){var i=[],a=[],o=e.string.toLowerCase();n&&n.globalScope;if(!e.state.showAll&&""===o)return found;return t.forEach(function(e){let t,l="";"string"==typeof e?t=e.toLowerCase():(t=e.text.toLowerCase(),e.title&&(l=e.title.toLowerCase())),u(i,t)||u(a,t)||(0===t.lastIndexOf(o,0)?i.push(e):0===l.lastIndexOf(o,0)?i.push(e):-1!==l.indexOf(o,0)?a.push(e):n.inStart||-1===t.indexOf(o)||a.push(e))}),1===i.length&&i[0]===o?[]:1===i.length&&i[0].text===o?[]:1===a.length&&a[0]===o?[]:1===a.length&&a[0].text===o?[]:i.concat(a)}(p,n,r),from:CodeMirror.Pos(f.line,p.start),to:CodeMirror.Pos(f.line,p.end)}}(e,f,function(e,t){return e.getTokenAt(t)},n)});let s=[],r=!1;const c=function(){return 0!==s.length||r||(r=!0,t("#table").data("pctable").model.getAllTables().then(function(e){s=e.tables})),s},d=function(e,n,i){t(e).append('<span class="'+i.type+'">'+(i.textVis||i.text)+(""===i.title?"":' <span class="descr">'+i.title+"</span>")+"</span>")};let f=[];function u(e,t){return-1!==e.indexOf(t)}CodeMirror.defineOption("autoCloseFunctions",!1,function(e){if("totum"!==e.getOption("mode"))return!1;c();var n={name:"autoCloseFunctions"};n["'('"]=l,e.addKeyMap(n),e.on("keydown",function(e,t){"9"===(t.keyCode||t.which).toString()&&function(e,t,n){var i=e.getCursor();if(e.getTokenAt(i).state.inFunction){let a,o,l=e.getLine(i.line);if(n){for(";"===l[a=i.ch]&&a--;l[a]&&-1===[";","("].indexOf(l[a]);)a--;for(o=a;l[a]&&-1===[":","("].indexOf(l[a]);)a--;":"===l[a]&&" "===l[++a]&&a++,o=i.ch}else{for(a=i.ch;l[a]&&-1===[":",")"].indexOf(l[a]);)a++;for(":"===l[a]&&" "===l[++a]&&a++," "===l[a]&&a++,o=a;l[o]&&-1===[";",")"].indexOf(l[o]);)o++;t&&(a=i.ch)}return e.setSelection({line:i.line,ch:a},{line:i.line,ch:o}),!0}}(e,t.altKey,t.shiftKey)&&t.preventDefault()}),e.on("keyup",function(e,t){e.options.bigOneDialog&&t.ctrlKey&&"83"===(t.keyCode||t.which).toString()?(t.stopPropagation(),e.options.bigOneDialog.close()):t.ctrlKey&&"191"===(t.keyCode||t.which).toString()&&CodeMirror.commentMe(e),"27"===(t.keyCode||t.which).toString()?(e.state.completionActive&&e.state.completionActive.close(),t.stopPropagation()):{9:"tab",13:"enter",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",38:"up",40:"down",57:"("}[(t.keyCode||t.which).toString()]||CodeMirror.showHint(e,CodeMirror.hint.totumVars,{})}),e.on("dblclick",function(n){var i=e.getCursor(),a=e.getTokenAt(i).state;if(a.isStart&&"="!==a.lineName){t(e.getWrapperElement()).find(".cm-variable").removeClass("light").each(function(){let e=t(this);e.text()==="$"+a.lineName&&e.addClass("light")})}})}),function(){"use strict";function t(e,t,n){this.cm=e,this.getHints=t,this.options=n,this.widget=this.onClose=null}function n(e){return"string"==typeof e?e:e.text}function i(t,i){this.completion=t,this.data=i;var a=this,o=t.cm,l=t.options,s=this.hints=e.top.document.createElement("ul");s.className="CodeMirror-hints",this.selectedHint=0;for(var r=i.list,c=0;c<r.length;++c){var d=s.appendChild(e.top.document.createElement("li")),f=r[c],u="CodeMirror-hint"+(c?"":" CodeMirror-hint-active");null!=f.className&&(u=f.className+" "+u),d.className=u,f.render?f.render(d,i,f):d.appendChild(e.top.document.createTextNode(f.displayText||n(f))),d.hintId=c}var p=o.cursorCoords(!1!==l.alignWithWord?i.from:null),h=p.left,m=p.bottom+3,b=!0;s.style.left=h+"px",s.style.top=m+"px";var g,v=e.innerWidth||Math.max(e.top.document.body.offsetWidth,e.top.document.documentElement.offsetWidth),_=e.innerHeight||Math.max(e.top.document.body.offsetHeight,e.top.document.documentElement.offsetHeight),w=s.getBoundingClientRect(),y=w.right-v,x=w.bottom-_;if(y>0&&(w.right-w.left>v&&(s.style.width=v-5+"px",y-=w.right-w.left-v),s.style.left=(h=p.left-y)+"px"),x>0){var k=w.bottom-w.top;w.top-(p.bottom-p.top)-k>0?(x=k+(p.bottom-p.top),b=!1):k>_&&(s.style.height=_-5+"px",x-=k-_),s.style.top=(m=p.bottom-x)+"px"}((l.container||e.top.document.body).appendChild(s),o.addKeyMap(this.keyMap=function(e,t){var n={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize())},PageDown:function(){t.moveFocus(t.menuSize())},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length)},Enter:t.pick,Tab:t.pick,Esc:t.close},i=e.customKeys?{}:n;function a(e,a){var o;o="string"!=typeof a?function(e){return a(e,t)}:n.hasOwnProperty(a)?n[a]:a,i[e]=o}if(e.customKeys)for(var o in e.customKeys)e.customKeys.hasOwnProperty(o)&&a(o,e.customKeys[o]);if(e.extraKeys)for(var o in e.extraKeys)e.extraKeys.hasOwnProperty(o)&&a(o,e.extraKeys[o]);return i}(l,{moveFocus:function(e){a.changeActive(a.selectedHint+e)},setFocus:function(e){a.changeActive(e)},menuSize:function(){return a.screenAmount()},length:r.length,close:function(){t.close()},pick:function(){a.pick()}})),!1!==l.closeOnUnfocus)&&(o.on("blur",this.onBlur=function(){g=setTimeout(function(){t.close()},100)}),o.on("focus",this.onFocus=function(){clearTimeout(g)}));var C=o.getScrollInfo();return o.on("scroll",this.onScroll=function(){var n=o.getScrollInfo(),i=o.getWrapperElement().getBoundingClientRect(),a=m+C.top-n.top,l=a-(e.pageYOffset||(e.top.document.documentElement||e.top.document.body).scrollTop);if(b||(l+=s.offsetHeight),l<=i.top||l>=i.bottom)return t.close();s.style.top=a+"px",s.style.left=h+C.left-n.left+"px"}),CodeMirror.on(s,"click",function(e){for(var t=e.target||e.srcElement;"SPAN"===t.nodeName;)t=t.parentNode;null!=t.hintId&&(a.changeActive(t.hintId),a.pick())}),CodeMirror.on(s,"mousedown",function(){setTimeout(function(){o.focus()},20)}),CodeMirror.signal(i,"select",r[0],s.firstChild),!0}CodeMirror.showHint=function(e,n,i){if(!e.somethingSelected()&&(null==n&&(n=e.getHelper(e.getCursor(),"hint")),null!=n)){e.state.completionActive&&e.state.completionActive.close();var a=e.state.completionActive=new t(e,n,i||{});if(CodeMirror.signal(e,"startCompletion",e),!a.options.async)return a.showHints(n(e,a.options));n(e,function(e){a.showHints(e)},a.options)}},CodeMirror.commentMe=function(e){var t=e.getCursor(),n=(e.getTokenAt(t).state,e.lineInfo(t.line));let i;(i=n.text.match(/^([\t\s]*)\/\//))?e.replaceRange("",{line:t.line,ch:i[1].length},{line:t.line,ch:i[0].length}):(i=n.text.match(/^[\t\s]*/),e.replaceRange("//",{line:t.line,ch:i[0].length},{line:t.line,ch:i[0].length}))},t.prototype={close:function(){this.active()&&(this.widget&&this.widget.close(),this.onClose&&this.onClose(),this.cm.state.completionActive=null,CodeMirror.signal(this.cm,"endCompletion",this.cm))},active:function(){return this.cm.state.completionActive==this},pick:function(e,t){var i=e.list[t];i.hint?i.hint(this.cm,e,i):this.cm.replaceRange(n(i),e.from,e.to),this.close();this.cm},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.showWidget(e)},showWidget:function(e){this.widget=new i(this,e),CodeMirror.signal(e,"shown");var t,n=null,a=this,o=this.options.closeCharacters||/[\s()\[\]{};:>,]/,l=this.cm.getCursor(),s=this.cm.getLine(l.line).length;function r(){t||(t=!0,a.close(),a.cm.off("cursorActivity",u),CodeMirror.signal(e,"close"))}function c(){return!!t||(a.widget?void 0:(r(),!0))}function d(){c()||(a.options.async?a.getHints(a.cm,f,a.options):f(a.getHints(a.cm,a.options)))}function f(e){if(!c()){if(!e||!e.list.length)return r();a.widget.close(),a.widget=new i(a,e)}}function u(){clearTimeout(n);var e=a.cm.getCursor(),t=a.cm.getLine(e.line);e.line!=l.line||t.length-e.ch!=s-l.ch||e.ch<l.ch||a.cm.somethingSelected()||e.ch&&o.test(t.charAt(e.ch-1))?a.close():n=setTimeout(d,170)}this.cm.on("cursorActivity",u),this.onClose=r}},i.prototype={close:function(){if(this.completion.widget==this){this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;!1!==this.completion.options.closeOnUnfocus&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)}},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(e){if(e=Math.max(0,Math.min(e,this.data.list.length-1)),this.selectedHint!=e){var t=this.hints.childNodes[this.selectedHint];t.className=t.className.replace(" CodeMirror-hint-active",""),(t=this.hints.childNodes[this.selectedHint=e]).className+=" CodeMirror-hint-active",t.offsetTop<this.hints.scrollTop?this.hints.scrollTop=t.offsetTop-3:t.offsetTop+t.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=t.offsetTop+t.offsetHeight-this.hints.clientHeight+3),CodeMirror.signal(this.data,"select",this.data.list[this.selectedHint],t)}},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}}}()}(),function(){const e=function(e){return{doc:e.doc}};CodeMirror.extendMode("css",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t){return/^[;{}]$/.test(t)}}),CodeMirror.extendMode("javascript",{commentStart:"/*",commentEnd:"*/",newlineAfterToken:function(e,t,n,i){return this.jsonMode?/^[\[,{]$/.test(t)||/^}/.test(n):(";"!=t||!i.lexical||")"!=i.lexical.type)&&(/^[;{}]$/.test(t)&&!/^;/.test(n))}}),CodeMirror.extendMode("xml",{commentStart:"\x3c!--",commentEnd:"--\x3e",newlineAfterToken:function(e,t,n){return"tag"==e&&/>$/.test(t)||/^</.test(n)}}),CodeMirror.defineExtension("commentRange",function(e,t,n){var i=this,a=CodeMirror.innerMode(i.getMode(),i.getTokenAt(t).state).mode;i.operation(function(){if(e)i.replaceRange(a.commentEnd,n),i.replaceRange(a.commentStart,t),t.line==n.line&&t.ch==n.ch&&i.setCursor(t.line,t.ch+a.commentStart.length);else{var o=i.getRange(t,n),l=o.indexOf(a.commentStart),s=o.lastIndexOf(a.commentEnd);l>-1&&s>-1&&s>l&&(o=o.substr(0,l)+o.substring(l+a.commentStart.length,s)+o.substr(s+a.commentEnd.length)),i.replaceRange(o,t,n)}})}),CodeMirror.defineExtension("autoIndentRange",function(e,t){var n=this;this.operation(function(){for(var i=e.line;i<=t.line;i++)n.indentLine(i,"smart")})}),CodeMirror.defineExtension("autoFormatRange",function(t,n){var i=this,a=i.getMode(),o=i.getRange(t,n).split("\n"),l=CodeMirror.copyState(a,i.getTokenAt(t).state),s=i.getOption("tabSize"),r="",c=0,d=0==t.ch;function f(){r+="\n",d=!0,++c}for(var u=0;u<o.length;++u){for(var p=new CodeMirror.StringStream(o[u],s,e(i));!p.eol();){var h=CodeMirror.innerMode(a,l),m=a.token(p,l),b=p.current();p.start=p.pos,d&&!/\S/.test(b)||(r+=b,d=!1),!d&&h.mode.newlineAfterToken&&h.mode.newlineAfterToken(m,b,p.string.slice(p.pos)||o[u+1]||"",h.state)&&f()}!p.pos&&a.blankLine&&a.blankLine(l),d||f()}i.operation(function(){i.replaceRange(r,t,n);for(var e=t.line+1,a=t.line+c;e<=a;++e)i.indentLine(e,"smart");i.setSelection(t,i.getCursor(!1))})}),t(function(){})}();let l={};var s={sortable:!1,width:50,icon:"fa-font",editable:!1,required:!0,insertable:!1,type:"string",getPanelVal:e=>e,getEditVal:function(e){var t,n=e.val().trim(),i=!1;(!this.required||void 0!==n&&""!==n&&null!==n||(t="Поле "+this.title+" должно быть заполнено",i=!0),this.regexp&&""!==n)&&(new RegExp(this.regexp).test(n)||(t=this.regexpErrorText||'regexp не проходит - "'+this.regexp+'"',t='Ошибка заполнения поля "'+this.title+'": '+t,i=!0));if(i)throw t;return n},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="text" class="form-control" name="cell_edit" autocomplete="off" autocorrect="off" />');void 0!==s&&r.attr("tabindex",s);var c=this;return n=n.v,r.val(n).on("keyup",function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),c.focusElement(r)}break;case 27:o(t(this),e)}}),r.on("blur",function(e){l(r,e)}),r.select()},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{let t=this.warningEditRegExp.match(/^\/(.*?)\/([a-z]*)$/);return new RegExp(t[1],t[2]).test(e)}catch(e){return!0}},getCellText:function(e){if(!0===this.url&&e){let n=this.openIn||"window";switch(n){case"window":n="_self";break;case"newWindow":n="_blank"}let i=t('<a class="uri" target="'+n+'">').attr("href",e).text(e);return"iframe"===n&&i.attr("onclick","return App.aInIframe(this);"),i}return e},getPanelText:function(e,t,n){return this.getCellText(e,t,n)},getCopyText:function(e,n){let i=this.getPanelText(e.v,null,n);if("string"==typeof i)return i;const a=function(e){if(e&&e.each&&"[object Function]"==={}.toString.call(e.each)){let n="";return e.each(function(){""!==n&&(n+="\n"),n+=t(this).text()}),n}return e};if(null===i)return"";if("object"==typeof i&&!(i instanceof jQuery)){let e=t.Deferred();return i.done(function(t){e.resolve(a(t))}).fail(function(){e.resolve("Не удалось загрузить данные")}),e}return a(i)},focusElement:function(e){e.focus()},isDataModified:function(e,t){return t+="","null"===(e+="")&&(e=""),"null"===t&&(t=""),t===(this.errorText||"ОШБК!")&&(t=""),"undefined"===t&&(t=""),e!==t},getFilterDataByValue:function(e){let t=[];return this.addDataToFilter(t,e),Object.keys(t)[0]},addDataToFilter:function(e,t){let n;e[n=null===t.v?"null".hashCode():t.v.toString().hashCode()]="string"==typeof t.v?t.v.replace(/"/g,"&quot;"):t.v},checkIsFiltered:function(e,t){let n=e.v;var i=!1;return t.forEach(function(e){if(e===(null==n?"null":n.toString()).hashCode().toString())return i=!0,!1}),i},getCellTextInPanel:function(e,t,n){return this.getCellText(e,t,n)}};l.text={width:50,icon:"fa-align-left",type:"Text",isPanelField:!0,getEditVal:function(e){return e.data("val").trim()},getCellText:function(e){if("string"!=typeof e)return"";let n=e.length;return t("<div>").text(e.substring(0,this.viewTextMaxLength)+(n>this.viewTextMaxLength?"...":"")).text()},getValue:function(e,n,i){"use strict";if(i||"string"==typeof e&&e.length<this.viewTextMaxLength){let n=t.Deferred();return setTimeout(function(){e||(e=""),n.resolve({value:e})},20),n}let a={fieldName:this.name};return n.id&&(a.rowId=n.id),this.pcTable.model.getValue(a,this.table_id)},getPanelTextWithLinks:function(e){if("text"===this.textType){let n=t("<div>");n.html(App.textWithLinks(e)),e=n}else e=t("<div>").text(e);return e},getPanelText:function(e,n,i){if("string"!=typeof e)return"";let a=this;if(e.length<=this.viewTextMaxLength)return a.getPanelTextWithLinks.call(a,e);let o=t.Deferred();return this.getValue(e,i,!1).then(function(e){o.resolve(t("<div>").append(a.getPanelTextWithLinks.call(a,e.value)))}).fail(function(){o.reject()}),o.promise()},getEditElement:function(n,i,a,o,l,s,r,c){let d,f=this,u=t("<div>"),p=t("<div>").css("min-height",200),h=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){f.getValue(i,a,!c).then(function(n){let i;if(u.append(h),h.empty().appendTo(p),"json"===f.textType){i=new JSONEditor(h.get(0),{});try{""!==n.value&&i.setText(n.value)}catch(e){App.modal("Ошибка формата JSON ")}h.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){let n=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n);return BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(e){try{i.setText(a.val()),e.close()}catch(e){App.modal("Ошибка формата JSON")}}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});h.find(".jsoneditor-menu").append(a)}else{let e="text";switch(f.textType){case"html":e="text/html";break;case"totum":e="totum";break;case"markdown":e="text/x-markdown";break;case"xml":e="application/xml";break;case"css":e="text/css";break;case"javascript":e="text/javascript"}let o=t("<div>").appendTo(h),l={value:n.value,mode:e,minHeight:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0};"text"===e&&(l.lineNumbers=!1,l.lineWrapping=!0),(i=CodeMirror(o.get(0),l)).on("paste",function(e,t){setTimeout(function(){i.refresh()},1)}),f.pcTable&&"tables"===f.pcTable.tableRow.name&&(i.table=a.name.v||a.name),i.getScrollerElement().style.minHeight="350px"}h.data("editor",i)})};const b=function(e,t,n){"json"===f.textType?u.data("val",JSON.stringify(h.data("editor").get())):u.data("val",h.data("editor").getValue()),n||(o(u,{}),e.close())};d=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},v={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){l(u,{}),e.close()}};-1!==["xml","html"].indexOf(f.textType)&&d.unshift({label:"Форматировать",action:function(){let e=h.data("editor"),t=e.lineCount(),n=e.getValue().length;e.autoFormatRange({line:0,ch:0},{line:t,ch:n})}});let _="Текст поля <b>"+this.title+", "+f.textType+"</b>",w="ctrlS.textedit";if(c){let e=!1;setTimeout(function(){let n=u.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&b(t,0,!0),i.click({}),e=!0,t.close()},d.push(i)}),n.popover("destroy")):(d.push(g),d.push(v)),BootstrapDialog.show({message:p,type:null,title:_,buttons:d,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(n){t("body").off(w),e||s(u,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})},1),u.text("Редактирование в форме").addClass("edit-in-form")}else{u.on("focus click","button",function(){let e=d.splice();e.push(g),e.push(v);var n=t(this).closest("div");BootstrapDialog.show({message:p,type:null,cssClass:"fieldparams-edit-panel",title:_,buttons:e,draggable:!0,onhide:function(e){t("body").off(w),l(n,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),m(),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать текст");r&&e.attr("tabindex",r),u.append(e),setTimeout(function(){if(0!==u.closest(".InsertPanel").length&&""!=i){let e=f.getCellTextInPanel(i,u,a);e.css("padding-bottom","5px"),u.prepend(e)}},10)}return u.data("val",i)},getCellTextInPanel:function(e,n,i){return t("<div>").append(this.getCellText(e,n,i)).css("white-space","pre-wrap")}},l.checkbox={icon:"fa-check-square",getEditVal:function(e){return!!e.is(":checked")},getCellText:function(e){return!0===e?"✓":!1===e?"-":""},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="checkbox" name="cell_edit"/>');s&&r.attr("tabindex",s),r.on("keyup",function(e){13==e.keyCode&&setTimeout(function(){a(r,e)},20)});return!0===n.v&&r.prop("checked",!0),r.on("click",function(e){a(r,e)}),r}},l.string={},l.number={icon:"fa-hashtag",getEditVal:function(e){let t=e.val().trim();if(this.required&&(void 0===t||""===t||null===t))throw"Поле "+this.title+" должно быть заполнено";if(this.regexp&&!new RegExp(this.regexp).test(t))throw'Ошибка заполнения поля "'+this.title+'"';if(""===t)return"";let n=t.replace(/[^\-()\d/*+.,%:\/]/g,"");if(!/^(\+|\*|\%|\/|\:)?(\-?[\d]+((\.|\,)[\d]+)?)%?$/.test(n))throw"Здесь должно быть число";return t=t.replace(/,/,".")},getCopyText:function(e,t,n){return null===e||void 0===e||""===e||null===e.v?"":e.v.toString().replace(/\./g,",")},getCellText:function(e,t,n){if(null===e||void 0===e||""===e)return"";if(this.currency){let t={};return this.dectimalPlaces&&(t.minimumFractionDigits=this.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)}return e}},l.date={icon:"fa-calendar-o",getEditVal:function(e){if(this.required&&""==e.val().trim())throw"Поле должно быть заполнено";if(!e.val().trim())return"";let t=e.data("calendar").data("DateTimePicker").date();return this.getDbString(t)},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="text" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" />');s&&r.attr("tabindex",s);var c=this;let d=this.getFormat();r.data("AppUin",App.getUn()),n=n.v,r.val(this.getViewString(n));let f,u=t("<div>");this.dateTime&&(f="date-popover");var p=t("<div></div>").appendTo(u);let h,m,b;p.on("dp.change",function(e){if(null!==e.oldDate||!c.dateTime||r.val()&&""!==r.val())r.val(e.date.format(d));else{let t=e.date,n=moment();t.format("HH:mm")===n.format("HH:mm")&&(t=t.hours(0).minutes(0)),r.val(t.format(d)),g()}}),r.on("keyup",function(e){h&&clearTimeout(h),13===e.keyCode?(g(),a(t(this),e)):27===e.keyCode?o(t(this),e):e.keyCode>=48&&(h=setTimeout(function(){g()},2e3))});const g=function(){"use strict";let e=r.val();e=e?moment(e,d):"";try{p.data("DateTimePicker").date(e)}catch(e){}};if(setTimeout(function(){let e=r.closest("td").find(".cdiv");e.length>0?(u.append(e.data("bs.popover").options.content),e.popover("destroy"),b=t("#"+App.popNotify({$text:u,element:e,container:c.pcTable._container,isParams:!0,placement:"bottom",class:f})),r.on("focus click",function(){b.show()})):r.on("focus click",function(){b||(m=App.popNotify(u,r),b=t("#"+m)),p.data("DateTimePicker").show(),b.show(),g()})},20),r.on("blur",function(e){setTimeout(function(){b&&b.is(":visible")&&(b.hide(),g(),l(r,e))},200)}),p.datetimepicker({inline:!0,format:d,useCurrent:!1,showClose:!1,locale:"ru",sideBySide:!0,collapse:!1}),n)try{p.data("DateTimePicker").date(c.getMoment(n))}catch(e){}else r.val("");return r.data("calendar",p),r},getCellText:function(e){return e&&null!==e?this.getViewString(e):""},getViewString:function(e){return e?this.dateTime?App.dateTimeFormats.covertFromDb(e,this.getFormat()):App.dateFormats.covertFromDb(e,this.getFormat()):""},getDbString:function(e){return e?this.dateTime?App.dateTimeFormats.covertToDb(e,this.getFormat()):App.dateFormats.covertToDb(e,this.getFormat()):""},getMoment:function(e){return this.dateTime?moment(e,App.dateTimeFormats.db):moment(e,App.dateFormats.db)},addDataToFilter:function(e,t){let n;n=null===t.v?"null".hashCode():t.v.toString().hashCode();let i=this.dateTime?App.dateTimeFormats:App.dateFormats;e[n]="string"==typeof t.v?i.covertFromDb(t.v):t.v},getFormat:function(){let e=this.dateFormat;e||(e=this.dateTime?"d.m.y H:i":"d.m.y");let t={d:"DD",D:"ddd",j:"M",z:"DDD",W:"W",m:"MM",M:"MMM",n:"M",y:"YY",Y:"YYYY",H:"HH",i:"mm",s:"ss"},n="";for(let i=0;i<e.length;i++){let a=e[i];n+=t[a]||a}return n}},l.unic={icon:"fa-fire"},l.file={icon:"fa-file-image-o",getSize:function(e){return e>102400?" "+(Math.round(e/1048576*10)/10).toLocaleString()+"Mb":" "+Math.round(e/1024).toLocaleString()+"Kb"},getCellText:function(e){return e&&null!==e&&0!=e.length?this.multiple&&e.length>1?e.length.toString()+" файлов":t('<a href="/fls/'+e[0].file+'" download="'+t("<div>").text(e[0].name).html()+'">').text(e[0].name):""},getCopyText:function(t,n){if(!(t=t.v)||null===t||0==t.length)return"";let i=this,a="";return t.forEach(function(t){""!==a&&(a+="\n"),a+=t.name+" "+e.location.protocol+"//"+e.location.host+"/fls/"+t.file+" "+i.getSize(t.size)}),a},getPanelText:function(n){if(!n||null===n||0==n.length)return"";let i=t("<div>"),a=this,o="",l=Math.random();return n.forEach(function(n){let s="",r="";-1!==["jpg","png"].indexOf(n.ext)&&(s='<img src="/fls/'+n.file+"_thumb.jpg?rand="+l+'"/>',r="with-img"),t("<div>").addClass(r).appendTo(i).append(t(s+'<br/><a href="/fls/'+n.file+'" download="'+t("<div>").text(n.name).html()+'">').text(n.name)).append(a.getSize(n.size)),""!==o&&(o+="\n"),o+=e.location.protocol+"//"+e.location.host+"/fls/"+n.file}),i.data("text",o)},getEditVal:function(e){if(this.required&&""==e.data("val"))throw"Поле должно быть заполнено";return e.data("val")},getEditElement:function(e,n,i,a,o,l,s,r){let c,d,f=this,u=t("<div>"),p=t("<div>").css("min-height",200),h=n.v||[],m=!1;const b=function(e){let n=t('<div class="filePart"><div><span class="name"></span><span class="size"></span><button class="btn btn-danger btn-xs remove"><i class="fa fa-remove"></i></button></div></div>'),a={name:e.name,type:e.type,tmpfile:e.tmpfile,size:e.size,file:e.file,ext:e.ext},o=new RegExp("^"+f.pcTable.tableRow.id+"_"+(i.id?i.id:""));if(e.file&&!o.test(e.file)&&n.find(".remove").remove(),n.data("file",a),n.find(".name").text(e.name),n.find(".size").text(f.getSize(e.size)),e.file){let i=t("<a>").attr("href","/fls/"+e.file).attr("download",e.name);n.find(".name").wrap(i),-1!==["jpg","png"].indexOf(e.ext)&&(t("<img>").attr("src","/fls/"+e.file+"_thumb.jpg?rand="+Math.random()).insertBefore(n.find(".name")),n.addClass("with-img"))}else n.append('<div class="progressbar">&nbsp;</div>');if(e.tmpfile){n.addClass("addFile"),n.find(".progressbar").text("Требуется сохранение элемента для привязки файла")}return n},g=function(e){d.$modalFooter.find("button:first").prop("disabled",e)},v=function(e){let n=[];e.$modalContent.find(".filePart").each(function(){let e=t(this).data("file");e&&n.push(e)}),u.data("val",n),h=n,m=!0,a(u,{}),e.close()};c=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:v},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];let _="Форма файлов <b>"+this.title+"</b>",w=function(e){d=BootstrapDialog.show({message:p,type:null,cssClass:"fieldparams-edit-panel",title:_,buttons:c,draggable:!0,onhide:function(n){t("body").off("ctrlS.textdialog"),m||o(e,n)},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshown:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:600}),function(){p.empty();let e=t("<div>").appendTo(p),n=t('<button class="btn btn-default btn-sm">Добавить файл'+(f.multiple?"ы":"")+"</button>");e.append(n),n.wrap('<div class="addFilesButton">');const i=function(){f.multiple||(p.find(".filePart").length>0?n.prop("disabled",!0):n.prop("disabled",!1))};h.forEach(function(e){let t=b(e).appendTo(p);t.on("click",".remove",function(){t.remove(),i()})}),i(),n.on("click",function(){let e=t('<input type="file" name = "file" '+(f.multiple?"multiple":"")+' accept="'+f.accept+'" style="display: block; position: absolute; top: -3000px"/>');t("body").append(e),e.click(),e.on("change",function(){if(this.files){let e=[];g(!0);for(let n=0,a=this.files.length;n<a;n++){let a=this.files[n],o=b(a).addClass("addFile").appendTo(p);i();let l=o.find(".progressbar");if(a.size>10485760){l.text("Ошибка - файл больше 10 Mb").css({"box-shadow":"none","background-color":"#ffe486"}),o.on("click",".remove",function(){o.remove(),i()});continue}let s=new XMLHttpRequest,r=t.Deferred();o.on("click",".remove",function(){o.remove(),s.abort(),r.resolve(),i()}),s.upload.onprogress=function(e){l.css("box-shadow","inset "+Math.round(parseInt(l.width())*e.loaded/e.total).toString()+"px 0px 0 0 #85FF82"),e.loaded===e.total&&l.text("Проверка файла сервером")},s.onload=s.onerror=function(e){if(r.resolve(),200===this.status)try{let e=JSON.parse(this.responseText);if(e.fname)return l.text("Готово"),void(o.data("file").tmpfile=e.fname)}catch(e){}o.data("file",null),l.text("Ошибка").css({"box-shadow":"none","background-color":"#ffe486"})},s.open("POST","/Table/",!0);let c=new FormData;c.append("file",a),c.append("method","tmpFileUpload"),s.send(c),e.push(r.promise())}t.when(...e).then(function(){g(!1)})}})})}(),t("body").on("ctrlS.textdialog",function(t){v(e)})}})};if(r)w(u),u.text("Редактирование в форме").addClass("edit-in-form");else{u.on("focus click","button",function(){w(t(this).closest("div"))});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать поле");s&&e.attr("tabindex",s),u.append(e)}return u.data("val",h)},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))}},l.n=t.extend({},l.default,{name:"n",width:52,title:"Порядок",category:"column",hidden:!0,showInWeb:!0,getCellText:function(e,n,i){let a=i.f||{};return n.addClass("n"),!i.id||a.block||a.blockOrder||i.__inserted?"":t('<span class="btns"><button class="btn btn-xxs btn-default"><i class="fa fa-angle-up"></i></button> <button class="btn btn-xxs btn-default"><i class="fa fa-angle-down"></i></button></span>')}}),l.listRow=t.extend({},l.default,{icon:"fa-code",isPanelField:!0,getPanelTextAsTable:function(e){if("object"==typeof e&&null!==e&&e.settings&&e.data&&e.settings.columns&&e.settings.columns.length){const n=t('<table class="json-table">');let i=e.settings,a=i.columns;try{if(i.headRow){const e=t("<tr>").appendTo(n);"boolean"==typeof i.headRow?a.forEach(function(n){t("<td>").text(n).appendTo(e).addClass("head")}):a.forEach(function(n){t("<td>").text(i.headRow[n]).appendTo(e).addClass("head")})}return e.data.forEach(function(e){const o=t("<tr>").appendTo(n);a.forEach(function(n){let i=e[n];"string"==typeof i&&""!==i||(i=JSON.stringify(i));t("<td>").text(i).appendTo(o)}),i.headColumn&&o.find("td:first").addClass("head")}),n}catch(e){console.log(e)}}},getPanelText:function(e,n,i){let a=t.Deferred(),o=this;const l=function(e){let n=o.getPanelTextAsTable.call(o,e);if(n)return n.copyText=JSON.stringify(e),void a.resolve(n);a.resolve(t("<div>").text(JSON.stringify(e,null,2)))};return"string"!=typeof e?l(e):this.getValue(e,i,!1).then(function(e){l(e.value)}).fail(function(){a.reject()}),a.promise()},getValue:function(e,n,i){"use strict";let a=t.Deferred();if(i||"filter"===this.category||"object"==typeof e||!e)return a.resolve({value:e}),a;{let e={fieldName:this.name};n.id&&(e.rowId=n.id),this.pcTable.model.getValue(e,this.table_id).then(function(e){a.resolve(e)})}return a},getEditElement:function(n,i,a,o,l,s,r,c){let d,f=this,u=t("<div>"),p=t("<div>").css("min-height",200),h=t('<div class="HTMLEditor">');i=i.v||"";let m=function(){f.getValue(i,a,!c).then(function(n){let i;u.append(h),h.empty().appendTo(p),i=new JSONEditor(h.get(0),{});try{""!==n.value&&i.setText(JSON.stringify(n.value))}catch(e){App.modal("Ошибка формата JSON ")}h.css("min-height",200);let a=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){let n=t("<div>"),a=t('<textarea class="form-control" style="height: 350px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n);return BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(e){try{i.setText(a.val()),e.close()}catch(e){App.modal("Ошибка формата JSON")}}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});h.find(".jsoneditor-menu").append(a),h.data("editor",i)})};const b=function(e,t,n){u.data("val",h.data("editor").get()),n||(o(u,{}),e.close())};d=[];let g={label:"Сохранить",cssClass:"btn-m btn-warning",action:b},v={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){l(u,{}),e.close()}},_="Текст поля <b>"+this.title+"</b>",w="ctrlS.textedit";if(c){let e=!1;setTimeout(function(){let n=u.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&b(t,0,!0),i.click({}),e=!0,t.close()},d.push(i)}),n.popover("destroy")):(d.push(g),d.push(v)),BootstrapDialog.show({message:p,type:null,title:_,buttons:d,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(n){t("body").off(w),e||s(u,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),m()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})},1),u.text("Редактирование в форме").addClass("edit-in-form")}else{u.on("focus click","button",function(){let e=d.splice();e.push(g),e.push(v);var n=t(this).closest("div");BootstrapDialog.show({message:p,type:null,cssClass:"fieldparams-edit-panel",title:_,buttons:e,draggable:!0,onhide:function(e){t("body").off(w),l(n,e)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),m(),e.$modalContent.css({width:900}),t("body").on(w,function(t){b(e)})}})});let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактировать список/json");r&&e.attr("tabindex",r),u.append(e)}return u.data("val",i)},isDataModified:function(e,t){return""===e&&(e=null),""===t&&(t=null),t!==e&&!Object.equals(e,t)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return"string"!=typeof e?JSON.stringify(e):e}}),l.password={icon:"fa-lock",getEditVal:function(e){var t=e.val().trim(),n=!1;if(void 0!==t&&""!==t&&null!==t||(notify="Поле "+this.title+" должно быть заполнено",n=!0),n)throw notify;return t},getCellText:function(e){return"**PASSWORD**"},getEditElement:function(e,n,i,a,o,l,s){var r=t('<input type="password" name="cell_edit" class="form-control" autocomplete="off" autocorrect="off" placeholder="'+(n?"Поменять пароль":"Новый пароль")+'"/>');r.on("save-me",function(e){a(t(this),e)}),s&&r.attr("tabindex",s);var c=this;n=n.v,r.on("keyup",function(e){switch(e.keyCode){case 13:try{r.data("enterClicked",!0),a(t(this),e)}catch(e){r.data("enterClicked",!1),App.popNotify(e,r,"default"),c.focusElement(r)}break;case 27:o(t(this),e)}});return r.one("blur",function(e){setTimeout(function(){!function(e){l(r,e)}(e)},50)}),r.select()}},l.select={icon:"fa-th-list",getEditVal:function(e){if(e.data("input")){var t=e.data("input").selectpicker("val");return null===t&&this.multiple&&(t=[]),t}},loadPreviewPanel(n,i,a,o){let l=t.Deferred();return n.html('<div class="center"><i class="fa fa-spinner fa-spin"></i></div>'),this.pcTable.model.loadPreviewHtml(i,a,o).then(function(i){if(n){let a=t("<div>");i.previews.forEach(function(n){let i=t('<div class="preview">');switch(n[2]){case"file":e.imgRand=e.imgRand||Math.random(),Array.isArray(n[1])&&n[1].forEach(function(n){-1!==["jpg","png"].indexOf(n.ext)&&i.append(t('<a href="/fls/'+n.file+'" target="_blank">').html('<img src="/fls/'+n.file+"_thumb.jpg?rand="+e.imgRand+'"/><br/>')),i.append(t('<a href="/fls/'+n.file+'" target="_blank">').text(n.name+" "+Math.round(n.size/1024).toLocaleString("ru-RU")+" Kb"))});break;case"html":i.text(n[0]);break;case"text":i.text(App.textWithLinks(n[0]));break;case"currency":case"number":if("currency"===n[2])try{i.text(parseFloat(n[1]).toLocaleString("ru-RU"))}catch(e){i.text(n[1])}else i.text(n[1]);n[3].unitType&&i.append(" "+n[3].unitType);break;case"url":i=t("<div>").append(t('<a target="_blank">').text(n[1]).attr("href",n[1]));break;default:i=t("<div>").text(n[1])}a.append(t('<div class="title">').text(n[0])),a.append(i)}),n.empty().append(a)}l.resolve()}).fail(function(){l.reject()}),l},previewPanel:function(e,n){let i=t('<div id="selectPanel" class="text preview" style="white-space: pre-wrap; height: 200px;">'),a={};a="column"===this.category?e.data("id")?this.pcTable._getItemById(e.data("id")):this.pcTable._insertItem:this.pcTable.data_params,n.popover({html:!0,content:i,trigger:"manual",container:"body",placement:"auto right",animation:!1}).popover("show");let o=t("#"+n.attr("aria-describedby")).css("z-index",1e4);const l=function(){n.attr("aria-describedby")&&o.length&&(n.off(".preview"),o.off(".preview"),o.remove())};n.on("mouseout.preview",function(){setTimeout(function(){o&&!o.is(":hover")&&l()},300)}),o.on("mouseout.preview",function(){o.is(":hover")||!n||n.is(":hover")||l()}),n.one("remove destroy",function(){n.attr("aria-describedby")&&n.popover("destroy")}),this.loadPreviewPanel(i,e.data("field"),a,e.data("val")).then(function(){const e=function(){n&&!n.height()?l():setTimeout(e,500)};e()})},getEditElement:function(e,n,i,a,o,l,s){"use strict";n||(n={});let r,c,d,f=this,u=n.v||null;if(f.multiple&&"string"==typeof u)try{u=JSON.parse(u)}catch(e){u=[]}if(e&&e.data("input"))(r=(c=e).data("input")).data("is-rendered",!0),d=r.data("LISTs");else{const e=function(){let e="-----";return"filter"===f.category?(e="Пустое",f.selectFilterWithEmptyText&&(e=f.selectFilterWithEmptyText)):f.withEmptyVal&&""!==f.withEmptyVal.trim()&&(e=f.withEmptyVal),e};r=t('<select class="form-control" '+(1==this.multiple?"multiple ":"")+' data-size="auto" style="display: none;" name="cell_insert" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-title="'+e()+'">').width(this.width),c=r.wrap("<div>").parent().append('<div class="text-center mark-loading"></div>'),s&&r.attr("tabindex",s),r.data("AppUin",App.getUn()),c.data("input",r),d={isListForLoad:!0,innerList:[],innerIndexed:[],isSliced:!0,isPreview:!1},f.list&&(d=f.list),r.data("LISTs",d)}let p=function(e){let n=t.Deferred(),a={};return Object.keys(i).forEach(function(e){/^\$/.test(e)||("id"===e?a[e]=i[e]:null!==i[e]&&"object"==typeof i[e]&&-1!==Object.keys(i[e]).indexOf("v")?a[e]=i[e].v:a[e]=i[e])}),c.isAttached()&&c.append('<i class="fa fa-cog fa-spin fa-3x loading" style="position: absolute; z-index: 1    right: 1px;    top: 1px;    font-size: 8px;"/>'),f.pcTable.model.getEditSelect(a,f.name,e,null).then(function(t){c.find(".loading").remove(),d.innerList=t.list?t.list:[],d.innerIndexed=t.indexed?t.indexed:{},d.isSliced=t.sliced,d.isPreview=t.previewdata,f.codeSelectIndividual||null!==e&&""!==e&&void 0!==e||d.isSliced||(f.list=d,d.isListForLoad=!1),n.resolve()},function(){n.reject()}),n.promise()};setTimeout(function(){c.length&&c.isAttached()&&c.find(".mark-loading").length&&c.find(".mark-loading").html('<i class="fa fa-spinner"/>')},200);const h=function(e,n){let a={"Выбранное":t('<optgroup label="Выбранное">'),"":t('<optgroup label="">')},o=a["Выбранное"];const l=function(e,n,a,o){o=o?t('<small class="text-muted">').text(o):"";let l=t("<option>").text(e),s=t("<div>").text(null===n||""===n?"["+e+"]":n);if(o&&s.append(o),s=s.html(),a)l.attr("data-content",'<span class="text" style="text-decoration: line-through">'+s+"</span>");else{let n=t('<span class="text" >'+s+"</span>");d.isPreview&&(n.addClass("select-with-preview"),n.attr("data-id",i.id),n.attr("data-field",f.name),n.attr("data-val",e)),l.data("content",n.get(0).outerHTML)}return l};let s=function(){return!0};if(n&&""!==n){let e=n.toLowerCase().replace("ё","е").split(" ");s=function(t){let n=null!==t?t.toString().toLowerCase().replace("ё","е"):"";return!e.some(function(e){return-1===n.indexOf(e)})}}let c,u={};if(e||"filter"===f.category){const t=function(e){null===e&&(e="");let t,n=d.innerIndexed[e];return t=n?l(e,n[0],!1,n[1]):l(e,e,!0,null),o.append(t),u[e]=1,!!n&&(s(n[0])||t.addClass("hidden"),!0)};f.multiple?Array.isArray(e)?(e.forEach(t),c=Object.keys(u)):void 0!==e&&(t(e),c=[e]):(t(e),c=e)}if("onlyVals"!==n){f.multiple||f.withEmptyVal&&""!==f.withEmptyVal.trim()&&"filter"!==f.category&&a[""].append(t("<option>").data("content",f.withEmptyVal).text(""));for(let e in d.innerList){let n=d.innerList[e];if(1===u[n])continue;let i=d.innerIndexed[n];if(!d.isSliced&&!s(i[0]))continue;let o=l(n,i[0]),r=i[1]?i[1]:"";a[r]||(a[r]=t('<optgroup label="'+r+'">')),a[r].append(o)}}if(r.empty(),Object.keys(a).forEach(function(e){r.append(a[e])}),!0===d.isSliced){let e=l(0,"Данные не полны. Воспользуйтесь поиском!");e.prop("disabled",!0),e.css("text-align","center"),r.append(e)}return r.selectpicker("refresh"),r.selectpicker("val",c),c};let m=0;const b=function(){i[f.name]&&i[f.name].replaceViewValue&&d.innerIndexed[i[f.name].v]&&(i[f.name].replaceViewValue(d.innerIndexed[i[f.name].v]),delete i[f.name].replaceViewValue);let e=r.closest("body");if(e&&e.length){c.find(".mark-loading").remove();let e=0===r.closest(".modal-body").length?f.pcTable._container:r.closest(".modal-body");if(r.data("container",e),h(u),!r.data("is-rendered")){let e;r.data("selectpicker").$searchbox.off().on("click.dropdown.data-api focus.dropdown.data-api touchend.dropdown.data-api",function(e){e.stopPropagation()});let n="";r.data("selectpicker").$searchbox.on("keyup",function(i){if("Escape"===i.key)return r.data("selectpicker").$button.click(),!0;let a=t(this).val();n!==a&&(n=a,e&&clearTimeout(e),e=setTimeout(function(){d.isListForLoad||d.isSliced?p.call(f,a).then(function(){h.call(f,u,a)}):h.call(f,u,a)},750))});let i=t(f).closest("td, .cell");if(0===r.closest(".InsertRow, .InsertPanel").length){let e=r.data("container");r.on("remove",function(){e.off("click.selectContainer."+r.data("AppUin")),e.off("keydown.selectContainer."+r.data("AppUin"))}),e.on("click.selectContainer."+r.data("AppUin"),function(e){let n=t(e.target);n.closest("td").is(".editing")||n.closest(".bootstrap-select").length||l(c,e)}),e.on("keydown.selectContainer."+r.data("AppUin"),function(e){if(27===e.keyCode)return r.data("keyPressed","Esc"),o(c,e),!1;if(13===e.keyCode&&r.data("enterPressed",!0),9!==e.keyCode&&16!==e.keyCode&&i.data("edited"),e.altKey||e.shiftKey){let t=e.altKey?"altKey":!!e.shiftKey&&"shiftKey";r.data("keyPressed",t)}}).on("keyup",function(e){r.removeData("keyPressed"),r.removeData("enterPressed")}),f.focusElement(c)}r.on("hidden.bs.select",function(){let e=r.data("changed"),t={},n=r.data("keyPressed");n&&(t[n]=!0),f.multiple?e&&0===r.closest("td.edt").length&&a(c,t):setTimeout(function(){a(c,t)},200),r.data("changed",!1)}),r.on("show.bs.select",function(){h(u)}),r.on("shown.bs.select",function(){let e=r.data("selectpicker");e.$bsContainer.addClass("pcTable-selectpicker"),d.isPreview&&e.$bsContainer.addClass("select-with-preview"),e.$menuInner.height()<100&&e.$menuInner.find("li").length>6&&e.$menuInner.height(300),e.cropped||(e.cropped=!0,r.data("container").is(".pcTable-container")&&e.$menuInner.height(e.$menuInner.height()-4))}),r.on("changed.bs.select",function(){r.data("changed",!0);let e=[];if(u&&u.forEach&&u.forEach(function(t){e.push(t)}),u=r.val(),"filter"===f.category&&f.multiple){let t=u.length;if(e.length>u.length)0===u.length&&u.push("*NONE*");else{let t;u.some(function(n){if(-1===e.indexOf(n))return t=n,!0}),-1!==["*NONE*","*ALL*"].indexOf(t)?u=[t]:["*NONE*","*ALL*"].some(function(e){let t;if(-1!==(t=u.indexOf(e)))return u.splice(t,1),!0})}u.length!==t&&r.selectpicker("val",u)}}),r.on("remove",function(){r.data("selectpicker").$bsContainer.remove(),r.data("container").off("keydown.selectContainer."+r.data("AppUin")).off("click.selectContainer."+r.data("AppUin"))})}}else m<50&&(setTimeout(function(){b(r,u)},10*m+1),m++)};return d.isListForLoad?p().then(function(){b.call(f)}):b(),c},getPanelText:function(e,n,i){let a=this,o=t("<div>"),l=i[a.name].v_;if(!a.multiple&&i[a.name].v_&&(l=[i[a.name].v_]),l)t.each(l,function(e,n){"use strict";let i=t("<div>").text(n[0]);n[1]?i.addClass("deleted_value"):1!==l.length&&i.add("select-item"),o.append(i)});else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let n=e;if(a.multiple||(n=[n]),n||(n=[]),a.list){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t].toString();for(let n=0;n<a.list.length;n++){let i=a.list[n];if(-1!==e.indexOf(i[2].toString())){let n=t("<span>").text(i[0]);i[1]?n.addClass("deleted_value"):1!==e.length&&n.add("select-item"),o.append(n)}}}}return o.children()},getCellText:function(e,n,i){let a=this,o=t("<div>"),l=i[a.name].v_;if(!a.multiple&&i[a.name].v_&&(l=[i[a.name].v_]),l)a.multiple&&l.length>1&&0==a.multySelectView?o.append('<span class="select-item">'+l.length+" элементов<span>"):0===l.length?o.append('<span class="select-item">'+this.getElementString(null)+"</span>"):t.each(l,function(n,i){"use strict";let s=t("<span>"),r=null;e&&(r="object"==typeof e?e[n]:e),s.text(a.getElementString(r,i)),i[1]?s.addClass("deleted_value"):1!==l.length&&s.add("select-item"),o.append(s)});else{if(null===e||""===e)return a.withEmptyVal?a.withEmptyVal:"";let n=e;if(a.multiple||(n=[n]),n||(n=[]),a.list){let e=[];for(let t=0;t<n.length;t++)e[t]=n[t].toString();for(let n=0;n<a.list.length;n++){let i=a.list[n];if(-1!==e.indexOf(i[2].toString())){let n=t("<span>").text(a.getElementString(i[2],i));i[1]?n.addClass("deleted_value"):1!==e.length&&n.add("select-item"),o.append(n)}}}}return o.children()},focusElement:function(e){let t=e.find("button"),n=this;0==t.length?setTimeout(function(){n.focusElement(e)},50):t.focus()},isDataModified:function(e,t){return(-1===[null,""].indexOf(e)||-1===[null,""].indexOf(t))&&(-1!==[null,""].indexOf(e)||-1!==[null,""].indexOf(t)||!Object.equals(t,e))},checkIsFiltered:function(e,t){let n,i;return this.multiple?(n=[],e&&e.v_&&e.v_.length&&e.v_.forEach(function(e){n.push(e[0].hashCode().toString())}),i=function(e){if(-1!==n.indexOf(e))return!0}):(n=(n=null===e.v_[0]?"null":e.v_[0].toString()).hashCode().toString(),i=function(e){if(e===n)return!0}),t.some(i)},checkEditRegExp:function(e){if(!this.warningEditRegExp)return!0;try{return this.multiple&&Array.isArray(e)?e.some(t=>new RegExp(this.warningEditRegExp).test(e)):new RegExp(this.warningEditRegExp).test(e)}catch(e){return!0}},addDataToFilter:function(e,t){const n=function(t){let n,i=t[0];null===i?n="null".hashCode():(n=i.toString().hashCode(),i=i.replace(/"/g,"&quot;")),e[n]=i};this.multiple?t&&t.v_.length&&t.v_.forEach(function(e){n(e)}):n(t.v_)},getElementString:function(e,t){"use strict";return null!==e&&void 0!==e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":t[0]:this.withEmptyVal||""}},l.tree={icon:"fa-tree",FullView:!1,getEditVal:function(e){return e.data("val")},getEditElement:function(e,n,i,a,o,l,s,r){let c,d,f=this,u=e||t("<div>"),p=u.data("dialog")||t("<div>").css("min-height",200);u.data("dialog",p),n=n.v||"";let h=function(e){f.treePanel.call(f,p,i,n,a,o)};const m=function(e,t,n){let i=[];p.data("jstree").jstree("get_selected",!0).forEach(function(e){i.push(e.id)}),f.multiple||(i=i[0]||""),u.data("val",i),n||(a(u,{}),e.close())};c=[];let b={label:"Сохранить",cssClass:"btn-m btn-warning",action:m},g={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){o(u,{}),e.close()}},v="<b>"+this.title+"</b>",_="ctrlS.commentdialog";const w=function(e){e.$modalHeader.css("cursor","pointer"),0===e.$modalBody.find("textarea").length&&h(),e.$modalContent.css({width:.8*t("body").width()>800?800:.8*t("body").width()}),t("body").on(_,function(t){m(e,0,!1)})};if(r){let e=!1;setTimeout(function(){let n=u.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){d=t(this);let n={};n.label=d.data("name"),n.cssClass=d.attr("class").replace("btn-sm","btn-m"),n.icon=d.find("i").attr("class"),n.save=d.data("save"),n.click=d.data("click"),n.action=function(t){n.save&&m(t,0,!0),n.click({}),e=!0,t.close()},c.push(n)}),n.popover("destroy")):(c.push(b),c.push(g)),BootstrapDialog.show({message:p,type:null,title:v,buttons:c,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(n){t("body").off(_),e||l(u,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:w})},1),u.text("Редактирование в форме").addClass("edit-in-form")}else{let e=!1;u.off().on("focus click","button",function(){if(e)return!1;e=!0;let n=c.slice(0);n.push(b),n.push(g);var i=t(this).closest("div");BootstrapDialog.show({message:p,type:null,cssClass:"fieldparams-edit-panel",title:v,buttons:n,draggable:!0,size:BootstrapDialog.SIZE_WIDE,onhide:function(n){e=!1,t("body").off(_),o(i,n)},onshow:w})}),0===u.find("button").length&&(d=t('<button class="btn btn-default btn-sm text-edit-button">').text("Редактирование в форме"),s&&d.attr("tabindex",s),u.append(d))}return u.data("val",n)},treePanel:function(e,n,i,a,o,l){let s=this,r=["themes","json_data","search"];s.multiple&&r.push("checkbox");let c=t('<div class="tree-search"><input class="form-control" type="text"></div>'),d=c.find("input");setTimeout(function(){d.focus()},200);let f=t("<div></div>"),u=0,p=!1,h="";d.keyup(function(){p&&clearTimeout(p),p=setTimeout(function(){if(f.closest("body").length){let e=d.val();h!==e&&(h=e,f.jstree(!0).search(e,0===u))}},750)}),e.append(c).append(f),e.data("jstree",f),!this.multiple&&this.withEmptyVal&&f.on("click",'li.jstree-node[aria-selected="true"]',function(e){return f.jstree(!0).deselect_node(t(this)),!1}),f.on("init.jstree",function(e,t){t.instance.settings.checkbox.cascade=""}).jstree({search:{show_only_matches:!0,case_insensitive:!0,show_only_matches_children:!0,search_callback:function(e,t){if(!t)return!1;let n=e.toLowerCase().replace("ё","е").split(" "),i=t.text.toLowerCase().replace("ё","е");return!n.some(function(e){return-1===i.indexOf(e)})},ajax:function(e,t){var i=this;s.getEditSelect(n,e,null).then(function(e){t.call(i,e[0])})}},massload:function(e,t){var i=this;u-=1,s.getEditSelect(n,"",e).then(function(e){Object.values(e[0]).forEach(function(e){e.forEach(function(e){!0===e.children&&(u+=1)})}),t.call(i,e[0])})},core:{check_callback:!0,open_parents:!0,data:function(e,t){var i=this;u-=1,s.getEditSelect(n,"","#"==e.id?null:e.id).then(function(e){e[0].forEach(function(e){!0===e.children&&(u+=1)}),t.call(i,e[0])})},themes:{icons:!1,name:"default"}},checkbox:{},plugins:r}),s.multiple&&"filter"===s.category&&f.on("select_node.jstree",function(e,t){-1!==["*ALL*","*NONE*"].indexOf(t.node.id)?t.selected.length>1&&t.selected.forEach(function(e){e!==t.node.id&&t.instance.deselect_node(f.jstree(!0).get_node(e))}):["*ALL*","*NONE*"].forEach(function(e){-1!==t.selected.indexOf(e)&&t.instance.deselect_node(f.jstree(!0).get_node(e))})})},getEditSelect:function(e,n,i){let a=this,o=t.Deferred(),l={};return Object.keys(e).forEach(function(t){/^\$/.test(t)||("id"===t||null===e[t]||"object"!=typeof e[t]||-1===Object.keys(e[t]).indexOf("v")?l[t]=e[t]:l[t]=e[t].v)}),this.pcTable.model.getEditSelect(l,this.name,n,i,!0).then(function(e){let t=[e.list,e.indexed];a.codeSelectIndividual||(a.list=t),o.resolve(t)}),o},getPanelText:function(e,t,n){this.FullView=!0;let i=this.getCellText(e,t,n);return delete this.FullView,i},getCellText:function(e,n,i){let a=this,o=i[a.name].v_;if(e){if(a.multiple){if(Array.isArray(e)){if(0===e.length)return a.getElementSpan(null);if(1===e.length)return a.getElementSpan(e[0],o[0]);if("0"!==a.multySelectView||a.FullView){let n=t('<span class="select-item">');return e.forEach((e,t)=>n.append(a.getElementSpan(e,o[t]))),n}return t('<span class="select-item">'+e.length+" эл.<span>")}return a.getElementSpan(e,[e,0])}return a.getElementSpan(e,o)}return a.getElementString(null)},checkIsFiltered:function(e,t){let n,i;return this.multiple?(n=[],e&&e.v_&&e.v_.length&&e.v_.forEach(function(e){n.push(e[0].hashCode().toString())}),i=function(e){if(-1!==n.indexOf(e))return!0}):(n=(n=null===e.v_[0]?"null":e.v_[0].toString()).hashCode().toString(),i=function(e){if(e===n)return!0}),t.some(i)},addDataToFilter:function(e,t){const n=function(t){let n;n=null===t[0]?"null".hashCode():t[0].toString().hashCode(),e[n]=t[0].replace(/"/g,"&quot;")};this.multiple?t&&t.v_.length&&t.v_.forEach(function(e){n(e)}):n(t.v_)},getElementSpan:function(e,n){let i=t("<span>");return null!==e&&(i.text(this.getElementString(e,n)),1===n[1]&&i.addClass("deleted_value")),i},getElementString:function(e,t){"use strict";return null!==e&&void 0!==e||t&&t[0]?null===t[0]||""===t[0]?"["+(this.withEmptyVal||"")+"]":this.FullView&&t[2]||t[0]:this.withEmptyVal||""}},l.json={__addInput:function(e,n,i){var a=(n=n||{}).type||typeof i[e],o=12;"checkbox"==a&&(o=3),n.width&&(o=n.width);var l,s=t('<div class="field form-group">').attr("data-name",e).addClass("col-sm-"+o);switch(a){case"string":l=t("<input>").val(i[e]?i[e]:n.default?n.default:"");break;case"json":l=t('<div class="JSONEditor">').height(300);var r=new JSONEditor(l.get(0),{}),c=t('<a href="#">editText</a>').on("click",function(){var e=t("<div>"),n=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(r.get(),null,2)).appendTo(e);return e.dialog({title:"Содержимое JSON-поля",width:500,height:600,buttons:{"Сохранить":function(){r.setText(n.val()),e.dialog("close")},"Закрыть":function(){e.dialog("close")}}}),!1});l.find(".jsoneditor-menu").append(c),l.data("editor",r),r.set(i[e]?i[e]:n.default?JSON.parse(n.default):{});break;case"html":l=t('<div class="HTMLEditor">').height(300);var d=t("<div>").appendTo(l);r=CodeMirror(d.get(0),{value:i[e]?i[e]:n.default?n.default:"",mode:"text/html",height:"250px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!0,indentWithTabs:!0,autoCloseTags:!0});setTimeout(function(){r.refresh()},20),l.data("editor",r);break;case"integer":l=t("<input>").val(i[e]?i[e]:n.default?n.default:"").attr("type","number"),void 0!==n.min&&l.attr("min",n.min),void 0!==n.max&&l.attr("max",n.max),void 0!==n.step&&l.attr("step",n.step);break;case"checkbox":l=t("<input>").attr("type","checkbox"),i[e]?l.prop("checked",!0):void 0===i[e]&&l.prop("checked",!0);break;case"select":l=t("<select>"),n.values&&t.each(n.values,function(e,n){l.append(t("<option>").attr("value",e).text(n))}),i[e]?l.val(i[e]):void 0===i[e]&&n.default&&l.val(n.default)}"checkbox"==a?(s.prepend(t("<label>").text(n.title?n.title:e).addClass("form-check-label")),l&&(l.data("type",a),s.find("label").prepend(l))):(s.prepend(t("<label>").text(n.title?n.title:e)),l&&l.data("type",a).addClass("form-control"),s.append(l)),s.data("type",a);var f=t(" <span>*</span>");return n.required?f.addClass("text-danger"):(f.text(""),f.addClass("glyphicon glyphicon-remove remove"),f.on("click",function(){var e=t(this).closest(".field");e.data("name");e.remove()})),s.find("label").after(f),s},getEditElement:function(e,n,i,a,o,l){var s,r=this,c=t("<div>"),d=t("<div>").css("min-height",200),f=t('<div class="jsonForm row">').appendTo(d);c.data("form",f),c.data("field",this);var u=this.jsonFields,p=n||{};"string"==typeof p&&(p=JSON.parse(p));var h=function(e){var t=r.__addInput(e,u[e],p);f.append(t)},m=t.extend({},p),b=0,g={"":[]};if(t.each(u,function(e,t){if(1==t.required||1==t.showInForm)h(e),void 0!==m[e]&&delete m[e];else if(void 0===m[e]){var n="";t.fGroup&&(n=t.fGroup,g[t.fGroup]||(g[t.fGroup]=[])),g[n].push(e),b++}}),t.each(m,function(e,t){h(e)}),b){var v=t('<div class="row elseFields">');element=t('<select class="selectpicker form-control dropup" data-size="5" data-title="--Выбрать поле--">'),1==App.keys(g).length?t.each(g[App.keys(g)[0]],function(e,n){element.append(t("<option>").attr("value",n).text(u[n].title?u[n].title:n))}):t.each(g,function(e,n){e=t('<optgroup label="'+e+'">');t.each(n,function(n,i){e.append(t("<option>").attr("value",i).text(u[i].title?u[i].title:i))}),element.append(e)}),v.prepend(t("<label>").text("Добавить поле")),element.addClass("form-control"),v.append(element),element.selectpicker("render"),element.on("change",function(){var e=t(this).val();element.find('option[value="'+e+'"]').remove(),h(e)}),d.append(v.wrap('<div style="padding:10px">').parent())}return s={"Сохранить":function(){var e={},n=f.find(".fullJSONEditor");1==n.length?e=n.data("editor").get():f.find("input, select, textarea, .JSONEditor, .HTMLEditor").not(".JSONEditor *").not(".HTMLEditor *").each(function(){var n=t(this),i=n.closest(".field").data("name");switch(n.closest(".field").data("type")){case"array":try{if(e[i]=n.data("editor").get(),!t.isArray(e[i]))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+i),"Ошибка структуры поля"}break;case"object":case"json":try{if(e[i]=n.data("editor").get(),"object"!=typeof e[i])throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+i),"Ошибка структуры поля"}break;case"html":e[i]=n.data("editor").getValue();break;case"checkbox":case"boolean":e[i]=!!n.is(":checked");break;case"integer":e[i]=parseInt(n.val());break;default:e[i]=n.val()}}),c.data("val",JSON.stringify(e)),a(c,event),d.remove()},"Закрыть":function(){d.dialog("close")},"Редактор":function(){var e=f.height(),n=t('<div class="fullJSONEditor">').height(e+100),i=new JSONEditor(n.get(0),{});i.set(p);var a=t('<a href="#">editText</a>').on("click",function(){var n=t("<div>"),a=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(i.get(),null,2)).appendTo(n);return n.dialog({title:"Содержимое JSON-поля",width:500,height:e+100,buttons:{"Сохранить":function(){i.setText(a.val()),n.dialog("close")},"Закрыть":function(){n.dialog("close")}}}),!1});f.empty().append(n),f.next().empty(),n.data("editor",i),n.find(".jsoneditor-menu").append(a)}},i.id?(d.dialog({title:(i&&i.id?i.id:"")+" "+this.title,width:700,modal:!0,close:function(e){o(c,e),d.remove()},buttons:s}),c.text("Редактирование в форме").addClass("edit-in-form")):(c.on("focus click","button",function(){var e=t(this).closest("div");d.dialog({title:r.title||r.name,width:700,modal:!0,close:function(t){o(e,t),d.remove()},buttons:s})}),c.append(t('<button class="btn btn-default">').text(n||"Редактирование"))),c.data("val",n)},getEditVal:function(e){return e.data("val")},getCellText:function(e){return JSON.stringify(e)},focusElement:function(e){var t=e.find("button"),n=this;0===t.length?setTimeout(function(){n.focusElement(e)},50):t.focus()}},l.fieldParams=t.extend({},l.json,{icon:"fa-code",isPanelField:!0,isDataModified:function(e,t){return!Object.equals(t,e)},getEditElement:function(n,i,a,o,l,s,r,c){let d,f=this,u=t("<div>"),p=t("<div>").css("min-height",200),h=t('<div class="jsonForm">').appendTo(p);u.data("form",h),u.data("field",this);let m=function(e){let n=f.jsonFields;f.getValue(e,a,!c).then(function(e){let i=e.value;"string"==typeof i&&(i=JSON.parse(i));let o=t.extend({},i),l=function(e,t,i){let l=n.fieldSettings[e];if(!l)return!1;if(l.categories&&-1===l.categories.indexOf(a.category.v))return!1;let s={};if(void 0===o[e]||void 0===o[e].isOn?(s.isOn=void 0!==o[e],s.Val=o[e],void 0===s.Val&&(s.Val=l.default),l.parent||"checkbox"!==l.type||!0!==s.Val||(s.isOn=!0),o[e]=s):s=o[e],"codeSelect"===e){let e="=: selectRowListForTree(table: ''; field: ''; order: '' asc; where:  '' = ; parent: ''; disabled:)";"tree"===h.find('div[data-name="type"] select').val()?s.Val===l.default&&(s.Val=e):s.Val===e&&(s.Val=l.default)}let r=!1,c=(n.fieldSettings[l.parent],o[l.parent]);l.parent&&-1!==t.indexOf(l.parent)&&(c&&!0===c.isOnCheck||(r=!0)),s.changed=function(){"use strict";!0===this.isOnCheck?h.find('[data-parent="'+e.toLowerCase()+'"]').show():h.find('[data-parent="'+e.toLowerCase()+'"]').hide().find('input[type="checkbox"]').prop("checked",!1).trigger("change")};let d=f.__addInput.call(f,e,l,s,a);h.append(d),l.parent&&(d.attr("data-parent",l.parent.toLowerCase()),r&&d.hide());let u=i[e]();return d.css("padding-left",19*u),d},s="string";o.type&&(s=o.type.Val||o.type);let r=function(){p.find(".codeEditor, .HTMLEditor").each(function(){t(this).data("editor")&&t(this).data("editor").refresh()})};!function e(i){let s;h.empty(),"2"===a.table_id.v&&("data_src"===a.name.v||"data"===a.name.v)||a.table_name&&"tables_vidgets"===a.table_name.v&&("data_src"===a.name.v||"data"===a.name.v)?(s="data"===a.name.v?["width","showInWeb"]:["width","jsonFields","showInWeb","editable","insertable","required","logging","default","copyOnDuplicate"],i="fieldParams"):s=n.fieldListParams[i];let c={type:function(){return 0}};s.forEach(function(e){let t=n.fieldSettings[e];t.parent&&-1!==s.indexOf(t.parent)?c[e]=function(){return c[t.parent]()+1}:c[e]=function(){return 0}}),o.type={isOn:!0,Val:i},l("type",s,c).find("select").on("change",function(){e(t(this).val())}),s.forEach(function(e){l(e,s,c)}),r()}(s)})};const b=function(e){var n={},i=h.find(".fullJSONEditor");1===i.length?n=i.data("editor").get():h.find("input, select, textarea, .JSONEditor, .HTMLEditor, .codeEditor").not(".JSONEditor *").not(".HTMLEditor *").not(".codeEditor *").not('input[data-type="switcher"]').each(function(){var e=t(this);let i,a=e.closest(".field");var o=a.data("name");switch(e.closest(".field").data("type")){case"code":i=e.data("editor").getValue();break;case"json":try{if("object"!=typeof(i=e.data("editor").get()))throw"Ошибка структуры поля"}catch(e){throw App.notify("Ошибка структуры поля "+o),"Ошибка структуры поля"}break;case"html":i=e.data("editor").getValue();break;case"checkbox":i=!!e.is(":checked");break;case"integer":i=parseInt(e.val());break;default:i=e.val()}let l;isOnCheckbox=a.find('input[data-type="switcher"]'),l=0===isOnCheckbox.length?e.is(":visible"):isOnCheckbox.is(":checked"),n[o]={isOn:l,Val:i}}),u.data("val",n),o(u,event),e.close()};d=[{label:"Сохранить",cssClass:"btn-m btn-warning",action:b},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}];let g="ctrlS.FieldParams";if(c)e.top.BootstrapDialog.show({message:p,type:BootstrapDialog.TYPE_DANGER,title:"Параметры поля <b>"+a.title.v+"</b>",buttons:d,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){l(u,e),t("body").off(g)},onshown:function(e){m(i.v),e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalDialog.width(1e3),t("body").on(g,function(t){b(e)})}}),u.text("Редактирование в форме").addClass("edit-in-form");else{let n=!1;u.on("focus click","button",function(){if(!n){n=!0;var o=t(this).closest("div");e.top.BootstrapDialog.show({message:p,type:BootstrapDialog.TYPE_DANGER,cssClass:"fieldparams-edit-panel",title:"Параметры поля <b>"+a.title.v+"</b>",buttons:d,draggable:!0,size:BootstrapDialog.SIZE_WIDE,onhide:function(e){l(o,e),t("body").off(g),n=!1},onshown:function(e){e.$modalDialog.width(1e3),e.$modalHeader.css("cursor","pointer"),m(i.v),t("body").on(g,function(t){b(e)})}})}});let o=t('<button class="btn btn-danger btn-sm text-edit-button">').text("Редактировать параметры");r&&o.attr("tabindex",r),u.append(o)}return u.data("val",i)},__addInput:function(n,i,a,o){var s=(i=i||{}).type;let r,c;r=a.Val,c=a.isOn;var d,f=t('<div class="field form-group">').attr("data-name",n);switch(s){case"code":d=t('<div class="codeEditor">');var u=t("<div>").appendTo(d);(p=CodeMirror(u.get(0),{value:r||(i.default?i.default:""),mode:"totum",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,gutter:!1,indentWithTabs:!0})).getScrollerElement().style.minHeight="150px",d.data("editor",p),p.table=o.table_name&&o.table_name.v?o.table_name.v:null;break;case"string":d=t("<input>").val(void 0!==r?r:i.default?i.default:"");break;case"json":d=t('<div class="JSONEditor">').height(300);var p=new JSONEditor(d.get(0),{}),h=t('<a href="#" style="padding-top: 5px; display: inline-block; padding-left: 20px;">Вручную</a>').on("click",function(){var n=t("<div>"),i=t('<textarea class="form-control" style="height: 250px;">').val(JSON.stringify(p.get(),null,2)).appendTo(n);return BootstrapDialog.show({message:n,type:null,title:"Ручное изменение json-поля",buttons:[{label:"Сохранить",cssClass:"btn-m btn-warning",action:function(e){try{p.setText(i.val()),e.close()}catch(e){App.modal("Ошибка формата JSON")}}},{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}],cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){},onshown:function(t){t.$modalContent.position({of:e})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:500})}}),!1});d.find(".jsoneditor-menu").append(h),d.data("editor",p);let a="string"==typeof r?JSON.parse(r):r;p.set(a);break;case"html":d=t('<div class="HTMLEditor">');u=t("<div>").appendTo(d);(p=CodeMirror(u.get(0),{value:r||(i.default?i.default:""),mode:"text/html",height:"150px",readOnly:!1,theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0})).getScrollerElement().style.minHeight="150px",d.data("editor",p);break;case"integer":d=t("<input>").val(void 0!==r?r:i.default?i.default:"").attr("type","number"),void 0!==i.min&&d.attr("min",i.min),void 0!==i.max&&d.attr("max",i.max),void 0!==i.step&&d.attr("step",i.step);break;case"checkbox":d=t("<input>").attr("type","checkbox").data("type",s),r&&d.prop("checked",!0);break;case"select":if(d=t("<select>"),i.values){let e,a=i.valIcons||{};i.valuesOrder&&(e=i.valuesOrder.slice(0)),"type"===n&&(355===o.id&&(e=["fieldParams"]),t.each(e,function(e,t){l[t]&&(a[t]="fa "+l[t].icon)}));const s=function(e,n){let i=t("<option>").attr("value",e).text(n);a[e]&&i.data("icon",a[e]),d.append(i)};e?e.forEach(function(e){s(e,i.values[e])}):t.each(i.values,s)}i.multiple&&(d.attr("multiple","multiple"),d.attr("size","2")),setTimeout(function(){d.selectpicker()},20),r?d.val(r):void 0===r&&i.default&&d.val(i.default)}let m;return a.isOnCheck=!0,"checkbox"===s?(f.prepend(t('<label class="field-param-lable">').text(i.title?i.title:n).addClass("form-check-label").prepend(d).append('<a href="http://docs.totum.online/polya#fields-settings-'+n+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),f.addClass("checkbox"),m=d,d.is(":checked")||(a.isOnCheck=!1,f.addClass("disabled"))):(f.prepend(t('<label class="field-param-lable">').text(i.title?i.title:n).append('<a href="http://docs.totum.online/polya#fields-settings-'+n+'" target="_blank"><i class="fa fa-question-circle-o"></i></a>')),d&&d.data("type",s),d.data("editor")||d.addClass("form-control"),f.append(d),!0!==i.required&&(m=t('<input type="checkbox" data-type="switcher"/>'),c?(a.isOnCheck=!0,m.prop("checked",!0)):(a.isOnCheck=!1,f.addClass("disabled")),f.find("label").prepend(m),f.addClass("checkbox"))),m&&m.on("change",function(){t(this).is(":checked")?!0!==a.isOnCheck&&(a.isOnCheck=!0,f.removeClass("disabled"),a.changed()):!1!==a.isOnCheck&&(a.isOnCheck=!1,f.addClass("disabled"),a.changed())}),f.data("type",s),f},getValue:function(e,n,i){"use strict";if(i){let n=t.Deferred();return n.resolve({value:e||{}}),n}let a={fieldName:this.name};return n.id&&(a.rowId=n.id),this.pcTable.model.getValue(a,this.table_id)},getPanelText:function(e){return JSON.stringify(e,null,2)},getCellText:function(e){return"Настройки поля"}}),l.button={icon:"fa-hand-pointer-o",getCellText:function(e,n,i){let a=this,o={};if("column"===this.category?i.id?o=t.extend({},a.pcTable.f||{},i.f||{},i[a.name].f||{}):o.block=!0:o=t.extend({},a.pcTable.f||{},i[a.name].f||{}),o.block||!this.pcTable.control.editing&&!this.pressableOnOnlyRead){let e=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1" disabled>').text(this.buttonText||"Кнопочка");if(o.text&&e.text(o.text),o.comment){let n;n=t('<i class="cell-icon fa fa-info"></i>'),e.prepend(n),n.attr("title",o.comment)}else o.icon&&e.prepend('<i class="cell-icon fa fa-'+o.icon+'"></i>');return e.wrap('<span class="cell-value">').parent()}n&&n.addClass("cell-button");let l=t('<button class="btn btn-default btn-xxs button-field" tabindex="-1">').text(this.buttonText||"Кнопочка");if(o.text&&l.text(o.text),o.comment){let e;e=t('<i class="cell-icon fa fa-info"></i>'),l.prepend(e),e.attr("title",o.comment)}else o.icon&&l.prepend('<i class="cell-icon fa fa-'+o.icon+'"></i>');return l},btnOK:function(e){let t=e.find("button"),n=this;t.text("Выполнено"),e.data("clicked",!0),setTimeout(function(){e.removeData("clicked");let i=n.pcTable._getItemBytd.call(n.pcTable,e);t.replaceWith(n.getCellText.call(n,i[n.name],e,i))},2e3)}},l.link={icon:"fa-link"},l.comments={icon:"far fa-comments-o",getEditVal:function(e){return e.data("val")},getCellText:function(e){if(0===e.n||!e.n)return"";let n=this,i=t("<span>"),a=t('<span class="comments">').text(e.c[0]+" "+e.c[1]+": "+e.c[2]).appendTo(i);return e.notViewed&&(a.addClass("notViewed"),n.decorationColor&&a.css("border-bottom-color",n.decorationColor)),i},getValue:function(e,n,i){"use strict";let a=this,o=t.Deferred();if(i)e||(e=[]),o.resolve({value:e});else if(0===e.n||1===e.n&&!e.cuted&&!e.notViewed)e||(e=[]),o.resolve({value:[e.c]});else{let e={fieldName:this.name};n.id&&(e.rowId=n.id),o=this.pcTable.model.getValue(e,this.table_id)}return o.then(function(e){if(n[a.name].v.notViewed||n[a.name].notViewed){let e=t.Deferred();e.then(function(){let e;delete n[a.name].v.notViewed,delete n[a.name].notViewed,n.id?e=a.pcTable._getTdByFieldName(a.name,a.pcTable.data[n.id].$tr):(e=a.pcTable._paramsBlock.find('td[data-field="'+a.name+'"]')).length||(e=a.pcTable._footersBlock.find('td[data-field="'+a.name+'"]')),e&&e.length&&(e.find(".notViewed-num").remove(),e.find(".notViewed").removeClass("notViewed"))}),n[a.name].notViewed?a.pcTable.model.setCommentsViewed(n[a.name].v.length,a.name,n.id).then(function(){e.resolve()}):e.resolve()}}),o},getPanelText:function(e,n,i){let a=this,o=t.Deferred();return this.getValue(e,i,!1).then(function(e){let n=t('<div class="comments">');t.each(e.value,function(e,t){n.append(a.getCommentLine(t))}),o.resolve(n)}).fail(function(){o.reject()}),o.promise()},getCommentLine:function(e){let n=t('<div class="comments-line">');return n.append(t('<span class="com_dt">').text(e[0])),n.append(" "),n.append(t('<span class="com_author">').text(e[1])),n.append(" "),n.append(t('<span class="com_text">').html(App.textWithLinks(e[2]))),n},getPanelVal(e,t){if(t)return this.getEditVal(t)},getEditElement:function(e,n,i,a,o,l,s,r){let c,d=this,f=e||t("<div>"),u=f.data("dialog")||t("<div>").css("min-height",200);f.data("dialog",u),n=n.v||"";let p=function(e){d.getValue.call(d,n,i,!r).then(function(e){let n=t('<textarea type="text" style="height:90px;resize: vertical" class="form-control"/>');t.each(e.value,function(e,t){u.append(d.getCommentLine(t))}),u.append(t('<div class="comments-input">').append(n)),u.data("input",n),n.focus()})};const h=function(e,t,n){f.data("val",u.find("textarea").val().trim()),n||(a(f,{}),e.close())};c=[];let m={label:"Сохранить",cssClass:"btn-m btn-warning",action:h},b={label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){o(f,{}),e.close()}},g="Комментарии поля <b>"+this.title+"</b>",v="ctrlS.commentdialog";if(r){let e=!1;setTimeout(function(){let n=f.closest("td").find(".cdiv");n.length>0?(n.data("bs.popover").options.content.find(".btn").each(function(){let n=t(this),i={};i.label=n.data("name"),i.cssClass=n.attr("class").replace("btn-sm","btn-m"),i.icon=n.find("i").attr("class"),i.save=n.data("save"),i.click=n.data("click"),i.action=function(t){i.save&&h(t,0,!0),i.click({}),e=!0,t.close()},c.push(i)}),n.popover("destroy")):(c.push(m),c.push(b)),BootstrapDialog.show({message:u,type:null,title:g,buttons:c,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(n){t("body").off(v),e||l(f,{})},onshown:function(e){e.$modalContent.position({of:t("body"),my:"top+50px",at:"top"}),p()},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:900}),t("body").on(v,function(t){h(e,0,!1)})}})},1),f.text("Редактирование в форме").addClass("edit-in-form")}else{let e=!1;if(f.off().on("focus click","button",function(){if(e)return!1;e=!0;let n=c.slice(0);n.push(m),n.push(b);var i=t(this).closest("div");BootstrapDialog.show({message:u,type:null,cssClass:"fieldparams-edit-panel",title:g,buttons:n,draggable:!0,size:BootstrapDialog.SIZE_WIDE,onhide:function(n){e=!1,t("body").off(v),o(i,n)},onshown:function(e){e.$modalHeader.css("cursor","pointer"),0===e.$modalBody.find("textarea").length&&p(),e.$modalContent.css({width:900}),t("body").on(v,function(t){h(e,0,!1)})}})}),0===f.find("button").length){let e=t('<button class="btn btn-default btn-sm text-edit-button">').text("Добавить комментарий");s&&e.attr("tabindex",s),f.append(e)}}return f.data("val",n)}},t.each(l,function(e,n){l[e]=t.extend({},s,n)}),App.pcTableMain=function(e,n){if(n=t.extend({},{tableRow:{},nSorted:!0,isCreatorView:!1,withCsvButtons:!1,withCsvEditButtons:!1,noDataRowClass:"pcTable-noDataRow",contanerClass:"pcTable-container",tableClass:"pcTable-table",width:null,checkIsUpdated:0,_containerId:"",scrollWrapper:null,tableWidth:0,control:{adding:!1,sorting:!1,deleting:!1,duplicating:!1},dataSorted:[],data:[],data_params:null,dataSortedVisible:[],mainFieldName:"id",insertRow:null,_container:null,_content:null,extraClastersBottom:null,extraClastersTop:null,dataSortedClasters:{t:[],m:[],b:[]},ScrollClasterized:null,_innerContainer:null,_header:null,_table:null,LogButton:null,model:null,fields:{},hidedFields:[],fieldCategories:{column:[],params:[],footer:[]},sorted:{field:"",direction:"asc"},_sorting:{},_filterable:!1,filtersClearButton:null,_indexes:{fieldByName:{}},beforeSpaceHide:!0},n),t.extend(this,n,!0),this.hidden_fields=this.hidden_fields||{},0===this.hidden_fields.length&&(this.hidden_fields={}),App.isTopWindow()&&(this.beforeSpaceHide=!1),e){this.refreshArraysFieldCategories(!0);let i=t(e);i.data("pctable",this),this._container=i,this._containerId=this._container.attr("id"),this._containerId||(this._containerId="pcTable"+o++,this._container.attr("id",this._containerId)),this._init(),this.render(n.addVars)}else this.initForPanel(n);return this.model.addPcTable(this),this};let r=0;e.EditPanel=function(n,i,a,o){if(e.top!==e)return e.top.EditPanel.call(e.top,n,i,a,o);let l=t.extend(!0,{},a),s=this;s.pcTable=n,s.panelId="panel"+r++;let c=t.Deferred();this.$panel=t('<div class="InsertPanel">'),this.isNewPanel=!0,this.blockedFields={},this.bootstrapPanel=null;let d=l.id?"checkEditRow":"checkInsertRow",f=l.id?"saveEditRow":"add";return this.panelType=l.id?"edit":"insert",this.editItem=l||{},t("body").trigger("pctable-opened",{type:"panel"}),s.resolved=!1,this.checkRow=function(e,t){s.pcTable.model[d](this.getDataForPost(),e).then(function(e){s.editRow.call(s,e)})},this.saveRow=function(n,i){s.pcTable.model[f](this.getDataForPost()).then(function(n){c.resolve(n),s.resolved=!0,t(e.top.document.body).trigger("pctable-closed",{type:"panel",json:n,method:s.panelType,tableId:s.pcTable.tableRow.id}),s.bootstrapPanel.close()}).fail(function(){if(i.length&&i.isAttached())n.$modal.find(".btn-save").prop("disabled",!1)})},this.editRow=function(e){"use strict";let n=!1;if(s.pcTable.f=e.f||{},s.editItem.f=e.row.f||{},s.pcTable.fieldCategories.column.forEach(function(i,a){if("n"===i.name)return;let o=s.$panel.find('div.cell[data-field-name="'+i.name+'"]'),l=s.editItem[i.name];s.editItem[i.name]=e.row[i.name],s.isEditable(i)&&(n=!0);let r=t.extend({},s.pcTable.f||{},s.editItem.f||{},s.editItem[i.name].f||{});if(o.length)o.data("input")&&!r.block?(!l||i.isDataModified(s.editItem[i.name].v,l.v)||i.codeSelectIndividual)&&s.createCell.call(s,o,i,a,r):s.createCell.call(s,o,i,a,r);else{s.$panel.append(o=s.createCell.call(s,o,i,a,r));let e=o.wrap('<div class="cell-wrapper" style="position: relative">').parent().width(390),n=t('<label style="margin-right: -25px">').text(i.title||i.name).prependTo(e);i.unitType&&n.text(n.text()+", "+i.unitType),i.linkToSelectTable&&e.append(' <a href="'+i.linkToSelectTable.link+'" class="color-primary-primary" style="font-size: 12px" target="_blank">'+i.linkToSelectTable.title+"</a> ")}if(r.hideinpanel?o.parent().css("display","none"):o.parent().css("display",""),o.attr("data-field-name",i.name),"edit"===s.panelType&&-1!==Object.keys(s.editItem[i.name]).indexOf("c")){let e=o.find("button.handled");e.length||(e=t('<button class="btn btn-sm pull-right btn-default handled" style="position: absolute; right: 0px;" tabindex="'+(2*a+2)+'"></button>'),o.prepend(e).css("padding-right",35).css("position","relative"),s.isEditable(i)?(e.on("click",function(){!0===s.editItem[i.name].h?s.editItem[i.name].h=!1:s.editItem[i.name].h=!0,s.checkRow.call(s)}),e.prop("disabled",!1)):(e.prop("disabled","disabled"),s.editItem[i.name].h||e.remove())),e.removeClass("btn-warning").addClass("btn-default"),e.html('<i class="fa fa-hand-grab-o"/>'),s.editItem[i.name].h&&(e.addClass("btn-warning").removeClass("btn-default"),s.editItem[i.name].c!==s.editItem[i.name].v&&e.html('<i class="fa fa-hand-paper-o"/>'))}},s),s.isNewPanel){let t="";if("edit"===this.panelType){let i;if(s.pcTable.tableRow.main_field&&s.pcTable.fields[s.pcTable.tableRow.main_field]){let t=s.pcTable.tableRow.main_field;(i=s.editItem[t]||e.row[t])&&(i=i.v),i=' "'+i+'"'}i=i?"id "+(s.editItem.id||e.row.id)+" "+i:"id "+(s.editItem.id||e.row.id),t=!s.pcTable.control.editing||e.row.f.block&&!n?"Просмотр <b> "+i+"</b> таблицы <b>"+s.pcTable.tableRow.title+"</b>":"Редактирование <b> "+i+"</b> таблицы <b>"+s.pcTable.tableRow.title+"</b>"}else t="Добавление строки в таблицу <b>"+s.pcTable.tableRow.title+"</b>";s.cleateBootstrapPanel.call(s,t,i,"insert"===s.type||n),s.isNewPanel=!1}},this.cleateBootstrapPanel=function(n,i,a){let l=this,r=[];a&&r.push({action:function(e,t){"use strict";let n=e.$modal.find(".btn-save").prop("disabled","disabled");setTimeout(function(){s.pcTable.model.doAfterProcesses(function(){l.saveRow.call(l,e,n)})},250)},cssClass:"btn-warning btn-save",label:"Cохранить"}),o&&r.push({action:function(e){e.close()},label:"Закрыть"}),r.push({action:function(e){c.resolve(void 0,!0),s.resolved=!0,e.close()},label:"Закрыть"+(!0===o?" →":"")}),l.bootstrapPanel=BootstrapDialog.show({type:i||null,size:BootstrapDialog.SIZE_WIDE,message:l.$panel,cssClass:"edit-row-panel",title:n,buttons:r,draggable:!0,onhidden:function(){c.resolve(),s.resolved||t(e.top.document.body).trigger("pctable-closed",{type:"panel"}),t(e.top.document.body).off("."+s.panelId)},onshown:function(e){"use strict";e.indexedButtons[Object.keys(e.indexedButtons)[0]].attr("tabindex",500),2===Object.keys(e.indexedButtons).length&&e.indexedButtons[Object.keys(e.indexedButtons)[1]].attr("tabindex",501)}})},this.createCell=function(n,i,a,o){let l=s.editItem||{};if(l[i.name]=l[i.name]||{},0===n.length&&(n=t("<div>").addClass("cell"),i.code&&n.addClass("with-code")),!this.isEditable(i)){s.blockedFields[i.name]=!0;let e=t('<span class="'+("button"!==i.type?"form-control no-borders":"link")+'">').append(i.getCellTextInPanel.call(i,s.editItem[i.name].v,n,s.editItem,s.pcTable));return i.unitType&&e.append(" "+i.unitType),"button"===i.type&&s.pcTable&&n.on("click",function(){s.pcTable._buttonClick.call(s.pcTable,n,i,l)}),n.html(e).data("input",null),n}s.blockedFields[i.name]=!1;let r=function(e){let t;try{t=i.getEditVal(e)}catch(t){return App.popNotify(t,e,"default"),null}return t},c=!1,d=n.find("input,button").is(":focus"),f=function(e,t,o){c=!0;let l=r(e);null===l?s.FocusIt.call(s,0,a):(o||s.FocusIt.call(s,0,a+1),i.isDataModified(l,s.editItem[i.name].v)&&(s.editItem[i.name].v=l,i.code&&!i.codeOnlyInAdd&&(s.editItem[i.name].h=!0),!0===i.isPanelField&&s.createCell.call(s,n,i,50+a),s.checkRow.call(s,i.name))),c=!1},u=function(e,t){return setTimeout(function(){e&&e.length&&e.isAttached()&&(c?c=!1:f(e,0,!0))},40),!1},p=function(e,t){c=!0;let n=r(e);i.isDataModified(n,s.editItem[i.name].v)&&s.checkRow.call(s)},h=i.getEditElement(n.data("input"),s.editItem[i.name],s.editItem,f,p,u,50+a);if(h.isAttached()||n.html(h),n.data("input",h),d&&i.focusElement(h),"select"===i.type&&i.changeSelectTable){let a=function(){let a={};t.each(s.editItem,function(e,t){"$"!==e.substring(0,1)&&(a[e]=t)});let o=t(this).is(".source-add");o&&(a[i.name]=null);let l=0;t(e.top.document.body).on("pctable-opened.select-"+s.panelId,function(){l++}).on("pctable-closed.select-"+s.panelId,function(e,a){l--;let r=a&&"insert"===a.method&&a.json&&a.json.chdata&&a.json.chdata.rows;setTimeout(function(){if(0===l||r){let e=h;delete i.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),r&&(i.multiple?s.editItem[i.name].v.push(Object.keys(a.json.chdata.rows)[0]):s.editItem[i.name].v=Object.keys(a.json.chdata.rows)[0]),e.replaceWith(h=i.getEditElement(null,s.editItem[i.name],s.editItem,f,p,u)),n.data("input",h),s.checkRow.call(s,i.name),!o&&s.pcTable.isMain&&s.pcTable.model.refresh(function(e){s.pcTable.table_modify.call(s.pcTable,e)}),t("body").off(".select-"+s.panelId)}},100)}),s.pcTable.model.selectSourceTableAction(i.name,a)},o=t('<div class="selectBtns">');n.prepend(o);let l=t('<button class="btn btn-default-primary btn-sm"><i class="fa fa-edit"></i></button>');if(o.prepend(l),l.on("click",a),2===i.changeSelectTable){n.addClass("with-source-add-button");let e=t('<button class="btn btn-default-primary btn-sm source-add"><i class="fa fa-plus"></i></button>');o.append(e),e.on("click",a)}else n.addClass("with-source-edit-button")}return n},this.getDataForPost=function(){let e={};return s.editItem.id&&(e.id=s.editItem.id),s.pcTable.fieldCategories.column.forEach(function(t){if("n"!==t.name)if(s.editItem[t.name]&&s.isEditable(t)){e[t.name]={};"edit"===s.panelType?(e[t.name].v=s.editItem[t.name].v,t.code&&!t.codeOnlyInAdd&&(e[t.name].h=s.editItem[t.name].h||!1),e[t.name].v=t.getPanelVal.call(t,e[t.name].v,s.$panel.find('div.cell[data-field-name="'+t.name+'"]').data("input"))):(e[t.name]=s.editItem[t.name].v,e[t.name]=t.getPanelVal.call(t,e[t.name],s.$panel.find('div.cell[data-field-name="'+t.name+'"]').data("input")))}else a[t.name]&&"insert"===s.panelType&&(e[t.name]=a[t.name].v)}),e},this.isEditable=function(e){if(!s.pcTable.control.editing)return!1;return!0!==t.extend({},s.pcTable.f||{},s.editItem.f||{},s.editItem[e.name].f||{}).block&&("insert"===this.panelType?e.insertable:e.editable)},this.FocusIt=function(e,t){if(0===e)return setTimeout(function(){s.FocusIt.call(s,1,t)},50),!1;let n=!0;if(!s.$panel||!s.$panel.length)return!1;if(s.pcTable.fieldCategories.column.forEach(function(e,i){if("n"!==e.name&&t===i){if(!s.isEditable(e))return void++t;{let t=s.$panel.find(".cell:eq("+i+")").data("input");t&&e.focusElement(t)}return n=!1,!1}}),n){s.bootstrapPanel.indexedButtons[Object.keys(s.bootstrapPanel.indexedButtons)[0]].focus()}},"object"!=typeof s.pcTable?App.getPcTableById(s.pcTable).then(function(e){s.pcTable=e,s.checkRow.call(s,null,!0)}):App.getPcTableById(s.pcTable[0],{sess_hash:s.pcTable[1]}).then(function(e){e.model.setDataRows(s.pcTable[2]),s.pcTable=e,s.checkRow.call(s,null,!0)}),c.promise()},t.extend(App.pcTableMain.prototype,{addScrollsRules:function(){let e=this;this._innerContainer.append(this._table).on("scroll",function(){"use strict";e._removeEditCell()}),e.withoutScrolls||t(function(){e._container.niceScroll({cursorwidth:7,mousescrollstep:90,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:-3}})})},Scroll:function(){let n=this,i={};n._content.offset().top;i.table=void 0;let a=!1,o=0,l=function(){let e=s();a!=(a=i.getClusterNum(e))&&i.insertToDOM(a);let o=t("table.pcTable-table");o.find("thead").height()+o.offset().top-t("#table").offset().top<=0?i.table?i.table.css({top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)}):function(){if(!i.table){i.table=t("<table>").appendTo(n._innerContainer),i.table.width(n.tableWidth),i.table.append(t("table.pcTable-table thead").clone(!0)).attr("class",t("table.pcTable-table").attr("class")),i.table.find("th:not(.id) div, th:not(.id) .btn").remove(),i.table.find('th.id .pcTable-filters button[data-action="checkbox"]').remove(),i.table.find("th").removeClass("with-filter");let e=t('<div class="btn btn-default btn-xxs "><i class="fa fa-arrow-up"></i></div>').on("click",function(){n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top)});if(i.table.find("th.id .pcTable-filters:first").append(e),i.table.find("th.n").length){let e=n._innerContainer.find("th.n").find("i.fa-save").parent().clone(!0);i.table.find("th.n").append(t('<div class="pcTable-filters">').append(e))}}i.table.css({position:"absolute",top:parseInt(t("#table").offset().top)-parseInt(t(".innerContainer").offset().top)})}():i.table&&(i.table.remove(),i.table=void 0,n._content.off("scroll"))},s=function(){try{return n._content.offset().top}catch(e){return 0}};n._container.on("scroll",function(){clearTimeout(o),o=setTimeout(function(){l.call(n)},50)});let r={top_offset:0,bottom_offset:0,rows:t()};return t.extend(i,{rows_in_block:4,item_height:35,getClusterNum:function(e){let t;return t=e>=0?0:Math.floor(-e/this.block_height),Math.max(t,0)},reloadScrollHead:function(){i.table&&(i.table.remove(),i.table=void 0),l.call(n)},generate:function(e){let t=n.dataSortedVisible,i=t.length;if(i<this.rows_in_block)return{top_offset:0,bottom_offset:0,rows:t};let a=Math.max(this.rows_in_block*e,0),o=a+this.rows_in_cluster+3*this.rows_in_block,l=Math.max(a*this.item_height,0),s=Math.max((i-o)*this.item_height,0),r=[];for(let e=a;e<o;e++)t[e]&&r.push(t[e]);return{top_offset:l,conteinerHeight:n._content.height(),i_start:a,bottom_offset:s,cluster_num:e,rows:r}},getRowsHeight:function(){0!==n.dataSortedVisible.length&&(this.block_height=this.item_height*this.rows_in_block,this.rows_in_cluster=Math.floor((e.innerHeight-n._container.offset().top)/this.item_height))},insertToDOM:function(e,t,i){this.rows_in_cluster||this.getRowsHeight(),e||(e=this.getClusterNum(s()));let a=this.generate(e),o=a.rows.join(",");(i||this.checkChanges("data",o,r))&&this.setHtml(a.rows,a.top_offset,a.bottom_offset,i),t&&n._container.getNiceScroll().resize()},setHtml:function(e,i,a,o){n._content.find(".editing").each(function(e){n._removeEditing.call(n,e)});let l=n._content.empty().get(0);if(i&&l.appendChild(t('<tr style="height: '+i+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0)),0===n.dataSorted.length)l.appendChild(n._createNoDataRow().get(0));else if(0===n.dataSortedVisible.length)l.appendChild(n._createNoDataRow("По условиям фильтрации не выбрана ни одна строка").get(0));else for(let t in e){let i=e[t],a=n.data[i];a.$tr&&!o||n._createRow.call(n,a),a.$tr.data("item",a),l.appendChild(a.$tr.get(0))}a&&l.appendChild(t('<tr style="height: '+a+'px;" class="loading-row"><td colspan="'+(n.fieldCategories.column.length+1)+'"></td></tr>').get(0))},checkChanges:function(e,t,n){let i=t!=n[e];return n[e]=t,i}}),i}}),t.extend(App.pcTableMain.prototype,{sort:function(e,t){let n=this,i=e.name,a="number"===e.type,o=n.data;(n.nSorted="n"===e.name)||this._table.addClass("no-correct-n-filtered"),a?n.dataSorted=n.dataSorted.sort(function(e,n){let a,l,s=o[e][i].v,r=o[n][i].v,c=0;if(null===s)c=null===r?0:-t;else if(null===r)c=t;else{try{a=Big(s)}catch(e){a=Big(0)}try{l=Big(r)}catch(e){l=Big(0)}c=a.gt(l)?t:a.eq(l)?0:-t}return c}):"select"===e.type?n.dataSorted=n.dataSorted.sort(function(n,a){let l,s;const r=function(t){let n;return o[t][i].v_?e.multiple?(n="",o[t][i].v_.forEach(function(e){n+=e[0]})):n=o[t][i].v_[0]:n=o[t][i].v,n};return(l=r(n))===(s=r(a))?0:l>s?t:-t}):n.dataSorted=n.dataSorted.sort(function(e,n){let a,l;return(a=o[e][i].v||"")>(l=o[n][i].v||"")?t:a==l?0:-t}),this.dataSortedVisible=[],n.dataSorted.every(function(e){return n.data[e].$visible&&n.dataSortedVisible.push(e),!0}),n._refreshContentTable()}}),App.pcTableMain.prototype.isSelected=function(e,t){return!(!this.selectedCells||!this.selectedCells.ids[e]||-1===this.selectedCells.ids[e].indexOf(t))},App.pcTableMain.prototype._addSelectable=function(){var n=this;n.selectedCells={fieldName:null,ids:{},notRowCell:null,selectPanel:null,lastSelected:null,notRowCellEmpty:function(){if(this.notRowCell){this.notRowCell.removeClass("selected");let e=this.notRowCell.closest(".DataRow");1===e.length&&e.removeClass("selected"),this.notRowCell=null}},empty:function(){this.notRowCellEmpty();let e=this;Object.keys(this.ids).forEach(function(t){e.ids[t].forEach(function(e){let t=n._getItemById(e);t&&t.$tr&&(t.$tr.find(".selected").removeClass("selected"),t.$tr.removeClass("selected"))})}),this.ids={},this.lastSelected=null},getEditedData:function(e,t){let i={},a=!1;return Object.keys(n.selectedCells.ids).length>1&&(a=!0),Object.keys(n.selectedCells.ids).forEach(function(o){n.selectedCells.ids[o].forEach(function(l){let s=n.data[l],r=s[o].f?s[o].f.block:void 0;s.f.block&&!1!==r||r||!n.fields[o].editable||!n.fields[o].editGroup||a&&!n.fields[o].editGroupMultiColumns||(i[l]||(i[l]={}),i[l][o]=t?s[o].v:e)})}),i},remove:function(e,t){let i=this;if(!this.ids[t])return;let a={};this.ids[t].some(function(n,o){if(n==e)return i.ids[t].splice(o,1),0===i.ids[t].length&&delete i.ids[t],a[e]=!0,!0}),Object.keys(a).forEach(function(e){let t=!1;Object.keys(i.ids).some(function(n){if(-1!==i.ids[n].indexOf(parseInt(e)))return t=!0,!0}),t||n.data[e].$tr&&n.data[e].$tr.removeClass("selected")})},add:function(e,t){this.ids[t]||(this.ids[t]=[]),this.ids[t].push(e),n.data[e].$tr&&n.data[e].$tr.addClass("selected")},selectPanelDestroy:function(){let e=this;e.selectPanel&&(e.selectPanel.attr("aria-describedby")&&e.selectPanel.popover("destroy"),e.selectPanel=null),t("body").off(".selectPanelDestroy")},checkIfShowPanel:function(i){"use strict";let a=this;if(this.selectPanelDestroy(),i){let o,l=n._getFieldBytd(i),s=t('<div id="selectPanel" class="text">'),r=200,c=t('<div class="column-name"></div>').text(l.title);l.unitType&&c.append(", "+l.unitType),s.append(c),"text"===l.type&&c.append(", "+l.textType),s.append(c),o="column"===l.category?n._getItemBytd(i):n.data_params;let d="";if("column"===l.category){if(d="["+o.id+"]",n.tableRow.main_field){let e=n.mainFieldName;void 0!==o[e].v_?"array"==typeof o[e].v_?o[e].v_.forEach(function(i,a){let l=t("<span>").text(n.fields[e].getElementString(o[e].v?o[e].v[a]:null,i));i[1]&&l.addClass("deleted_value"),d+=" "+l.html()}):d+=" "+n.fields[e].getElementString(o[e].v,o[e].v_):d+=" "+o[e].v}let e=t('<div class="row-name"></div>').text(d);s.append(e)}let f=o[l.name],u=t("<div>"),p=t('<div class="field-value"><div class="copytext"></div></div>').css("white-space","pre-wrap").height(r);u.append(p).appendTo(s),l.unitType&&null!==f.v&&p.attr("data-unit",l.unitType);let h,m=p.find(".copytext");f.f&&f.f.text&&u.append(t("<div>").text(f.f.text));let b=t('<div class="buttons"></div>');i.is(".edt")&&t('<button class="btn btn-sm btn-default"><i class="fa fa-pencil-square-o"></i></button>').on("click",function(){return i.dblclick(),!1}).appendTo(b),(h=t('<button class="btn btn-sm btn-default copy_me" disabled data-copied-text="Скопировано" title="Копировать "><i class="fa fa-copy"></i></button>')).on("click",function(){m.data("text")?App.copyMe(m.data("text")):App.copyMe(m.text());let e=t(this);return e.width(e.width()),e.button("copied"),setTimeout(function(){e.button("reset")},1e3),e.blur(),!1}),b.append(h),"tmp"!==n.tableRow.type&&l.logButton&&t('<button class="btn btn-sm btn-default" title="Лог ручных изменений по полю">Лог</button>').on("click",function(){let e;n.mainFieldName&&o.id&&(e=o[n.mainFieldName].v),n.model.getFieldLog(l.name,o.id,e);let i=t(this).addClass("disabled");return setTimeout(function(){i.removeClass("disabled")},1e3),!1}).appendTo(b),"column"===l.category&&l.filterable&&(n.isValInFilters.call(n,l.name,f)?t('<button class="btn btn-sm btn-warning" title="Удалить из фильтра"><i class="fa fa-filter"></i></button>').on("click",function(){return a.selectPanelDestroy(),n.removeValueFromFilters.call(n,l.name,f),!1}).appendTo(b):t('<button class="btn btn-sm btn-default" title="Добавить в фильтр"><i class="fa fa-filter"></i></button>').on("click",function(){return a.selectPanelDestroy(),n.addValueToFilters.call(n,l.name,f),n._container.scrollTop(n._filtersBlock.offset().top-n.scrollWrapper.offset().top),n.ScrollClasterized.insertToDOM.call(n.ScrollClasterized,0),!1}).appendTo(b));{let n=t('<button class="btn btn-sm btn-default"><i class="fa fa-expand" style="padding-top: 3px;" aria-hidden="true"></i></button>');n.on("click",function(){e.top.BootstrapDialog.show({message:u,type:null,title:c.text()+(d?" / "+d:""),cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"}),a.selectPanelDestroy()},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})}),b.append(n)}t('<button class="btn btn-sm btn-default" title="Закрыть панель"><i class="fa fa-times"></i></button>').on("click",function(){return a.selectPanelDestroy(),!1}).appendTo(b);const g=function(e){m.text(e),h.prop("disabled",!1)},v=function(e,t){m.html(e),e.data("text")?m.data("text",e.data("text")):m.data("text",t),h.prop("disabled",!1)};let _=l.getPanelText(f.v,s,o);n.isCreatorView&&-1!==["select","tree","date"].indexOf(l.type)&&p.after(t('<div class="creator-select-val">'+JSON.stringify(f.v)+"</div>"));const w=function(e){if("object"==typeof e&&null!==e)if(e instanceof jQuery){let n="";e.copyText?v(e,e.copyText):(e.each(function(){""!==n&&(n+="\n"),n+=t(this).text()}),""===n&&(n=e.text()),v(e,n))}else e.then?e.then(w):g(JSON.stringify(e));else g(e)};if(w(_),n.isCreatorView){let e;n.LOGS&&(e=n.LOGS,o&&o.id&&(e=n.LOGS[o.id]),e&&(e=e[l.name]));let i=t('<div style="padding-top: 10px">');if(e&&e.c){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');n.on("click",function(){App.logOutput(e.c)}),i.append(n)}if(e&&e.s){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> s</i></button>');n.on("click",function(){App.logOutput(e.s)}),i.append(n)}if(e&&e.a){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> a</i></button>');n.on("click",function(){App.logOutput(e.a)}),i.append(n)}if(e&&e.f){let n=t('<button class="btn btn-sm btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> f</i></button>');n.on("click",function(){App.logOutput(e.f)}),i.append(n)}i.children().length&&b.append(i)}this.selectPanel=i.find("span:first"),s.append(b),f.e&&s.append(t('<div style="padding-top: 5px;">').html(t("<span>").text(f.e).text().replace(/\[\[(.*?)\]\]/g,"<b>$1</b>")));let y="right",x=this.selectPanel.offset().left,k=n._container.offset().left;n._container.width()-(x-k)-this.selectPanel.width()<(s.is(".text")?340:240)&&(y="left");let C={isParams:!0,$text:s,element:this.selectPanel,container:n._container,placement:y,trigger:"manual"};if(App.popNotify(C),"select"===l.type){let e=t('<div class="previews">').appendTo(s.find(".field-value"));l.loadPreviewPanel(e,l.name,o,f.v)}t("body").on("click.selectPanelDestroy",function(e){0===t(e.target).closest("#selectPanel").length&&a.selectPanelDestroy()}).on("keyup.selectPanelDestroy",function(e){27==e.which&&a.selectPanelDestroy()})}return!1},copySepected:function(e,n){let i=this,a="",o=[],l=[],s={},r=[];Object.keys(i.selectedCells.ids).forEach(function(e){let t=i.selectedCells.ids[e];o=o.concat(t),l.push(e),t.forEach(function(t){s[t]||(s[t]={});let n=i.fields[e].getCopyText.call(i.fields[e],i.data[t][e],i.data[t]);"object"==typeof n?(r.push(n),n.done(function(n){s[t][e]=n})):s[t][e]=n})}),o=Array.from(new Set(o)),o=i.dataSortedVisible.filter(e=>-1!==o.indexOf(e)),l=Array.from(new Set(l));let c=[];i.fieldCategories.visibleColumns.forEach(function(e){-1!==l.indexOf(e.name)&&c.push(e.name)}),l=c;e&&(a+="id",l.forEach(function(e){a+="\t",a+=i.fields[e].title}));let d=n;t.when(...r).done(function(){o.forEach(function(t){""!==a&&(a+="\n");let n=!0;e&&(a+=t,n=!1),l.forEach(function(e){!0===n?n=!1:a+="\t";let i=s[t][e];void 0===i&&(i=""),"string"==typeof i&&i.replace(/\t/g,"").match(/[\s"]/)&&(i='"'+i.replace(/"/g,'""')+'"'),a+=i})}),console.log(a),App.copyMe(a),setTimeout(d,400)})},click:function(e,i){let a=n._table;if(e.closest("table").is(".pcTable-filtersTable"))return!1;if(!0===a.data("moved"))return a.data("moved",!1),!1;(function(){if(e.is(".val")){if(this.notRowCell&&-1!==this.notRowCell.index(e))n.selectedCells.empty();else{n.selectedCells.empty(),this.notRowCell=e,this.notRowCell.addClass("selected");let t=this.notRowCell.closest(".DataRow");1===t.length&&t.addClass("selected")}return void t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}this.notRowCellEmpty();let a=e.closest("tr"),o=n._getItemByTr(a),l=n._fieldByTd(e,a),s=l.name;if(i.altKey)e.is(".selected")?(n.selectedCells.remove(o.id,s),e.removeClass("selected")):(n.selectedCells.add(o.id,s),e.addClass("selected"),this.lastSelected=[s,o.id]);else if(i.shiftKey&&Object.keys(n.selectedCells.ids).length){let e=this,t=[],i="before";n.dataSortedVisible.some(function(n){if("before"===i){if((n===o.id||n===e.lastSelected[1])&&(i="doIt",t.push(n),o.id===e.lastSelected[1]))return!0}else if("doIt"===i&&(t.push(n),n===o.id||n===e.lastSelected[1]))return!0}),i="before";let a=function(i){t.forEach(function(t){let a=n.data[t];n.isSelected(i.name,t)||(e.add(t,i.name),a.$tr&&n._getTdByFieldName(i.name,a.$tr).addClass("selected"))})};n.fieldCategories.column.some(function(t){if(t.showMeWidth>0)if("before"===i){if((t.name===s||t.name===e.lastSelected[0])&&(i="doIt",a(t),s===e.lastSelected[0]))return!0}else if("doIt"===i&&(a(t),t.name===s||t.name===e.lastSelected[0]))return!0}),this.lastSelected=[s,o.id]}else{let t=n.isSelected(l.name,o.id);n.selectedCells.empty(),t||(n.selectedCells.add(o.id,s),e.addClass("selected"),this.lastSelected=[s,o.id])}let r=Object.keys(n.selectedCells.ids);r.length>1?t("table.pcTable-table").addClass("selected-multi"):1===r.length&&Object.values(n.selectedCells.ids)[0].length>1?t("table.pcTable-table").removeClass("selected-multi").addClass("selected-column"):t("table.pcTable-table").removeClass("selected-multi").removeClass("selected-column")}).call(this)}},this._container.on("contextmenu",".DataRow td:not(.editing,.n,.id), td.val:not(.editing)",function(){let e=t(this);return n.selectedCells.selectPanel&&n.selectedCells.selectPanel.closest("td")[0]==e[0]?n.selectedCells.selectPanelDestroy():(n.selectedCells.selectPanelDestroy(),n.selectedCells.empty(),n.selectedCells.checkIfShowPanel(e),n.selectedCells.click(e,{})),!1}),this._container.on("click",".DataRow td:not(.editing,.id,.n), td.val:not(.editing)",function(e){let i=t(this);if(i.is(".cell-button")){let e=n._getFieldBytd(i);return n._buttonClick.call(n,i,e),!1}i.data("clicked")?i.removeData("clicked"):(i.data("clicked",1),setTimeout(function(){i.data("clicked")&&(i.removeData("clicked"),n.selectedCells.click(i,e))},200))}),this._container.on("click","th.id .for-selected button",function(){let e=t(this),i=e.html();e.text("Скопировано"),n.selectedCells.copySepected.call(n,e.data("names"),function(){e.html(i)})})},App.pcTableMain.prototype.filters={},App.pcTableMain.prototype.__getFilterButton=function(e){var n="btn-default";(this.filters[e]&&this.filters[e].length||this.filters[e+"/h"])&&(n="btn-warning");var i=t('<button class="btn btn-xxs btn-filter"><span class="fa fa-filter"></span></button>').addClass(n);return t('<span class="filter-in-head">').append(i)},App.pcTableMain.prototype.filtersEmpty=function(){this.filters={},this._refreshHead(),this.__applyFilters()},App.pcTableMain.prototype.sessionStorageFilters={url:location.protocol+"//"+location.host+location.pathname,setFilters:function(e){var t={};e=e||{};try{t=JSON.parse(sessionStorage.getItem("pcTableFilters"))||{}}catch(e){}t[this.url]=e,sessionStorage.setItem("pcTableFilters",JSON.stringify(t))},getFilters:function(){var e={};try{e=(e=JSON.parse(sessionStorage.getItem("pcTableFilters")))[this.url]||{}}catch(e){}return e}};let c=!0;App.pcTableMain.prototype.__applyFilters=function(){let e=this;App.fullScreenProcesses.show(),this.filtersClearButton&&("tmp"!==e.tableRow.type&&this.sessionStorageFilters.setFilters(this.filters),this.selectedCells.empty(),Object.equals(this.filters,{})?this.filtersClearButton.addClass("btn-default").removeClass("btn-warning").attr("disabled",!0):(this.filtersClearButton.removeClass("btn-default").addClass("btn-warning").removeAttr("disabled"),c&&(App.blink(e.filtersClearButton,8,"#fff"),c=!1)));let t=this.dataSortedVisible;this.dataSortedVisible=[];for(let e=0;e<this.dataSorted.length;e++){let t=this.dataSorted[e],n=this.data[t];this.__applyFiltersToItem(n),n.$visible&&this.dataSortedVisible.push(t)}this._headCellIdButtonsState(),JSON.stringify(t)!==JSON.stringify(this.dataSortedVisible)&&this._refreshContentTable(!1,!0),App.fullScreenProcesses.hide()},App.pcTableMain.prototype.__applyFiltersToItem=function(e,t){let n=this,i=!0;for(let t in n.filters){let a=n.filters[t];if("id"===t)-1===a.indexOf(e.id.toString())&&(i=!1);else{let o=t.toString().split("/");switch(t=o[0],o[1]||"v"){case"v":n._getFieldbyName(t).checkIsFiltered(e[t],a)||(i=!1);break;case"h":switch(a){case"h":!0!==e[t].h&&(i=!1);break;case"n":!0===e[t].h&&(i=!1);break;case"hf":(!0!==e[t].h||e[t].hasOwnProperty("c"))&&(i=!1);break;case"hc":!0===e[t].h&&e[t].hasOwnProperty("c")||(i=!1)}}}if(!i)break}(e.$visible=i)||this.row_actions_uncheck(e)},App.pcTableMain.prototype.addValueToFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n=this.fields[e];this.filters[e].push(n.getFilterDataByValue.call(n,t)),n.$th.find(".btn-filter").parent().replaceWith(this.__getFilterButton.call(this,e)),this.__applyFilters.call(this)},App.pcTableMain.prototype.isValInFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n=this.fields[e],i=n.getFilterDataByValue.call(n,t);return-1!==this.filters[e].indexOf(i)},App.pcTableMain.prototype.removeValueFromFilters=function(e,t){this.filters[e]||(this.filters[e]=[]);let n,i=this.fields[e],a=i.getFilterDataByValue.call(i,t);for(;-1!==(n=this.filters[e].indexOf(a));)this.filters[e].splice(n,1);0===this.filters[e].length&&delete this.filters[e],i.$th.find(".btn-filter").parent().replaceWith(this.__getFilterButton.call(this,e)),this.__applyFilters.call(this)},App.pcTableMain.prototype.__addFilterable=function(){var e=this,n={};"tmp"!=e.tableRow.type&&(n=e.sessionStorageFilters.getFilters()),e.filters=n||{},this._header.on("click",".pcTable-filters > span button.btn-filter:not(#checkS)",function(n){let i=t(this);if(i.attr("aria-describedby"))return!0;let a=i.closest("th"),o=a.is(".id")?"id":a.data("field"),l=t('<div class="filter-div-button">'),s=t('<select class="selectpicker" data-size="6" multiple title="Выберите значения" data-style="btn-sm btn-default" data-width="css-width" data-live-search="true" data-selected-text-format="count">').appendTo(l);const r=function(){try{i.popover("destroy")}catch(e){}};let c,d=!1;const f=function(n){if(c&&clearTimeout(c),!d){if("filterRemove"===n)return d=!0,r(),delete e.filters[o],i.removeClass("btn-warning").addClass("btn-default"),void e.__applyFilters.call(e);if("setInvertFilters"===n){let e=Object.values(s.selectpicker("val")),n=[];t.each(s.data("options"),function(t,i){-1===e.indexOf(i)&&n.push(i)}),s.selectpicker("val",n)}c=setTimeout(function(){r(),JSON.stringify(e.filters[o]||[])!==JSON.stringify(s.selectpicker("val"))&&(e.filters[o]=s.selectpicker("val"),0===e.filters[o].length&&delete e.filters[o],"id"!==o||i.closest(".pcTable-table").is(".pcTable-table:first")||e._header.find("th.id .btn-filter").parent().replaceWith(e.__getFilterButton.call(e,o)),i.parent().replaceWith(e.__getFilterButton.call(e,o)),e.__applyFilters.call(e))},10)}};l=t('<div class="pcTable-filter-select" style="height: 220px;">').append(l),s.data("container",l);var u={};t.each(e.data,function(t,n){"id"===o?u[t.toString()]=t.toString():e.fields[o].addDataToFilter(u,n[o])});var p={};t.each(u,function(e,t){p[t]=e}),p=App.ksort(p);let h={"Выбранное":t('<optgroup label="Выбранное">'),"":t('<optgroup label="">')};t.each(p,function(t,n){"null"===t&&(t="null "),void 0!==e.filters[o]&&-1!==e.filters[o].indexOf(n.toString())?h["Выбранное"].append('<option data-content="'+t+'">'+n+"</option>"):h[""].append('<option data-content="'+t+' ">'+n+"</option>")}),s.append(h["Выбранное"]),s.append(h[""]),s.data("options",p);var m=i.popover({html:!0,content:l,trigger:"manual",container:e._container,placement:"auto bottom",template:'<div class="popover" role="tooltip" style=""><div class="arrow" style="left: 50%;"></div><div class="popover-content" style=" padding: 3px 5px;"></div></div>'});s.selectpicker("render").selectpicker("toggle");let b=t('<div class="buttons" style="position: absolute; bottom: -4px; width: 100%; text-align: center">');if(t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Прим.</span></span>').appendTo(b).on("click",function(){f("setSelectedFilters")}),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px;">Инверт.</span></span>').appendTo(b).on("click",function(){f("setInvertFilters")}),t('<span class="btn btn-default btn-xxs button-ok" style="margin-right: 4px; margin-top: 3px">Отмен.</span>').appendTo(b).on("click",function(){f("filterRemove")}),e.fields[o]&&e.fields[o].code&&!e.fields[o].codeOnlyInAdd){let n=t('<select data-title="Все" data-style="btn btn-xxs '+(e.filters[o+"/h"]?"btn-warning":"btn-default")+' "><option value="">Все</option><option value="n">Без руки</option><option value="h">С рукой все</option><option value="hf">С рукой как в расчете</option><option value="hc">С рукой отличающиеся</option></select>').appendTo(b).on("change",function(){return e.filters[o+"/h"]=n.selectpicker("val"),""===e.filters[o+"/h"]&&delete e.filters[o+"/h"],r(),i.parent().replaceWith(e.__getFilterButton.call(e,o)),e.__applyFilters.call(e),!1}).wrap('<span id="filterHand">');setTimeout(function(){n.selectpicker("render").selectpicker("val",e.filters[o+"/h"]||"")},100)}b.appendTo(l),s.on("hidden.bs.select",function(){f("setSelectedFilters")}),e.filters[o]&&s.selectpicker("val",e.filters[o]),setTimeout(function(){m&&m.length&&(m.popover("show"),l.on("mouseenter","li",function(){let e=t(this);e.attr("title")||e.attr("title",e.text())}),"id"===o&&t("#"+i.attr("aria-describedby")).position({my:"left top",at:"left-3px bottom+10px",of:i}).find(".arrow").css("left","12px"),s.data("selectpicker")._searchStyle=function(){return"multiincludes"},s.data("selectpicker").$searchbox.focus(),e._container.one("click.filter filterPressed.filter",function(n){0!==t(n.target).closest("#filterHand").length||"filterPressed"!==n.type&&void 0===n.altKey||!t("#"+i.attr("aria-describedby")).is(":visible")||(e._container.off(".filter"),f("setSelectedFilters"))}),e._innerContainer.one("scroll.filter",function(n){t("#"+i.attr("aria-describedby")).is(":visible")&&(e._container.off(".filter"),f("setSelectedFilters"))}))},50),e._container.trigger("filterPressed")})},t.extend(App.pcTableMain.prototype,{_addEditable:function(){var e=this;this._container.on("dblclick","td.val:not(.editing), td.edt:not(.editing), .dataRows td:not(.editing,.id,.n)",function(n){let i=t(this),a=i.closest("tr");if(a.length&&a.is(".InsertRow"))return!1;if(i.is(".footer-name, .id, .footer-empty"))return!1;if(i.is(".edt"))e._createEditCell.call(e,i,!0);else{let e=i.html();i.html("Заблокировано"),setTimeout(function(){i.html(e)},500)}}).on("click",".editCellsBlock .btn",function(e){t(this).data("click")(e)})},goToEditNextCell:function(e){return next},_buttonClick:function(n,i,a){if(n.data("clicked"))return!1;const o=function(){"use strict";let o,s={},r=n.parent();n.data("clicked",!0),"column"===i.category?(a=a||l._getItemBytd(n),o=a.id,s.item=o,s.fieldName=i.name):(s.item="params",s.fieldName=i.name),s.checked_ids=l.row_actions_get_checkedIds(),n.find("button").hide();let c=t('<div class="text-center"><i class="fa fa-spinner"/></div>');n.append(c),l._saving=!0,l.model.click(s).then(function(t){if(l.table_modify.call(l,t),n.length&&n.isAttached())c.remove(),n.find("button").show();else if("column"===i.category){let e=l._getItemById(o).$tr;n=l._getTdByFieldName(i.name,e)}else n=r.find('[data-field="'+i.name+'"]');i.uncheckAfterClick&&l.row_actions_uncheck_all(),i.closeIframeAfterClick&&e.closeMe&&e.closeMe(),i.btnOK.call(i,n)}).fail(function(){n.length&&n.isAttached()&&(c.remove(),n.find("button").show(),n.removeData("clicked"))}).always(function(){l._saving=!1})};let l=this;if(i.warningEditPanel){let e={"Ок":function(e){e.close(),o()},"Отмена":function(e){e.close()}};App.confirmation(i.warningEditText||"Точно изменить?",e,"Подтверждение")}else o()},_saveEdited:function(e,n,i){let a=this;!0!==a._saving&&(a._saving=!0,this.model.save(n).then(function(t){a.table_modify.call(a,t,void 0,e),e.closest("table").length&&e.is("tr.DataRow")&&a.refreshRow(e),i&&i()}).always(function(){a._saving=!1,e.is("tr.DataRow")&&1===e.closest("table").length&&e.find(".editing").length?e.each(function(){a.refreshRow(t(this))}):e.is("td")&&e.find(".fa-spinner").length&&e.closest("table").length>0&&e.each(function(){let e=t(this),n=a._getItemBytd(e),i=a._getFieldBytd(e),o=a._createCell(n,i);"button"===i.type&&i.btnOK.call(i,o),e.replaceWith(o)})}))},_editFocusIndex:0,_editItem:null,_editPanel:null,_row_edit:function(e){let t=this;if(0===e.length)return!1;let n=e.shift();new EditPanel([t.tableRow.id,t.model.tableData.sess_hash,t.data],BootstrapDialog.TYPE_PRIMARY,{id:n},e.length>0).then(function(n,i){(n||i)&&(n&&t.table_modify.call(t,n),t._row_edit.call(t,e))})},_currentEditCellIndex:0,_removeEditing:function(e){e||(e=this._content.find("td.editing"));var t=this._createCell(this._getItemBytd(e),this._getFieldBytd(e));let n;return(n=e.attr("rowspan"))&&t.attr("rowspan",n),(n=e.data("field"))&&t.data("field",n),e.is(".val")&&t.addClass("val"),e.replaceWith(t),t},_saveEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._editCell.data("SaveMe")&&this._editCell.data("SaveMe")()},_removeEditCell:function(){this._editCell&&this._editCell.isAttached()&&this._editCell.is(".editCell")&&this._removeEditing(this._editCell),this._editCell=null},_setEditCell:function(e){this._saveEditCell(),this._editCell=e,e.addClass("editCell")},_setTdSaving:function(e){e.html('<div class="text-center"><i class="fa fa-spinner"/></div>')},_createEditCell:function(i,a,o){let l=this,s=this._getFieldBytd(i);this._setEditCell(i),i.height(i.height());let r=i.closest("tr"),c=l._getColumnIndexByTd(i,r),d=function(e){if(!e)return!1;let t;switch(e){case"right":for(t=l._getTdByColumnIndex.call(l,r,++c);t.length;){if(!0===l._getFieldBytd.call(l,t).editable){t.trigger("dblclick");break}t=t.next("td")}break;case"down":for(t=r.next("tr");t.length&&t.is(".Blocked");)t=t.next("tr");l._getTdByColumnIndex.call(l,t,c).trigger("dblclick")}};if(!s.editable)return!1;let f=(o=o||this._getItemBytd(i)).id,u=t('<div class="editCellsBlock">');i.addClass("editing");let p,h,m=o[s.name],b=!1,g=function(e,t,i){let a=i||e.closest("td"),o=t||{};if(!a.length||!a.closest("tr").length)return!1;var s=l._removeEditing.call(l,a);l._colorizeElement(s,n),d(o.altKey?"right":!!o.shiftKey&&"down")},v=function(e){l._removeEditing.call(l,i),d(e)};l.isSelected(s.name,o.id)?Object.keys(l.selectedCells.ids).length>1?(h=!0,p=!0):l.selectedCells.ids[s.name].length>1&&(p=!0):l.selectedCells.empty();let _=function(e,t,n){if(!n&&s.warningEditPanel&&s.checkEditRegExp.call(s,e))return void App.confirmation(s.warningEditText||"Точно изменить?",{"ОК":function(n){_(e,t,!0),n.close()},"Отменить":function(e){v(),e.close()}},"Предупреждение при изменении");i.html('<div class="text-center"><i class="fa fa-spinner"/></div>');let a={};a[s.name]=e;let r={};o.id?r[o.id]=a:r.params=a,l._saveEdited.call(l,i,r,function(){d(t.altKey?"right":!!t.shiftKey&&"down")})},w=function(e,t){setTimeout(function(){if(b)return b=!1,!1;y(e,t)},150)},y=function(e,n,i){if(b=!0,!(i=i||!1)&&p)return!1;let a,o=e.closest("td");try{a=s.getEditVal(x)}catch(e){return t("#"+App.popNotify(e,o,"default")).css("z-index",1e3),void(b=!1)}let r=l._getItemBytd(o),c=n.altKey?"right":!!n.shiftKey&&"down";s.isDataModified(a,r[s.name].v)?_(a,n):v(c)};var x=s.getEditElement(void 0,m,o,y,g,w,null,a);i.html(x),i.data("SaveMe",function(e){y(x,e=e||{})}),i.data("input",x);var k=t('<div class="cdiv">').css({height:0,width:"100%",position:"absolute",bottom:"0px"});i.append(k);var C=t('<button class="btn btn-sm btn-default" data-save="true" data-name="Сохранить"><i class="fa fa-save"/></button>').data("click",function(e){b=!0,y(x,e,!0)});u.append(C);C=t('<button class="btn btn-sm btn-default" data-name="Закрыть"><i class="fa fa-undo"/></button>').data("click",function(e){b=!0;let t=e.altKey?"right":!!e.shiftKey&&"down";v(t)});if(u.append(C),p&&(h?s.editGroupMultiColumns:s.editGroup)){let e=function(){let e;b=!0;try{e=s.getEditVal(x)}catch(e){return void App.popNotify(e,i,"default")}let t=l._container.find("td.selected");l._setTdSaving(t);let n=l.selectedCells.getEditedData(e);l._saveEdited.call(l,t,n,!1)};(C=t('<button class="btn btn-sm btn-warning" data-save="true" data-name="Применить к выделенным"><i class="fa fa-database" title="Применить к выделенным"/></button>')).data("click",function(){s.warningEditPanel?App.confirmation(s.warningEditText,{"ОК":function(t){e(),t.close()},"Отменить":function(e){v(),e.close()}},"Предупреждение при изменении"):e()}),u.append(C),s.code&&!s.codeOnlyInAdd&&((C=t('<button class="btn btn-sm btn-warning" data-name="Фиксировать выделенные"><i class="fa fa-hand-rock-o" title="Фиксировать"/></button>')).data("click",function(){b=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData(null,!0);l._saveEdited.call(l,e.closest("tr"),t,!1)}),u.append(C),(C=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручные"><i class="fa fa-eraser" title="Сбросить ручные"/></button>')).data("click",function(){b=!0;let e=l._container.find("td.selected");l._setTdSaving(e);let t=l.selectedCells.getEditedData("NULL");t.setValuesToDefaults=!0,l._saveEdited.call(l,e.closest("tr"),t,!1)}),u.append(C))}else o[s.name]&&1==o[s.name].h?((C=t('<button class="btn btn-sm btn-danger" data-name="Сбросить ручное"><i class="fa fa-eraser" title="Сбросить ручное"/></button>')).data("click",function(){b=!0,i.html('<div class="text-center"><i class="fa fa-spinner"/></div>');let e={};parseInt(f)||(f="params"),e[f]={},e[f][s.name]="NULL",e.setValuesToDefaults=!0,l._saveEdited.call(l,i,e,!1)}),u.append(C)):s.code&&!s.codeOnlyInAdd&&((C=t('<button class="btn btn-sm btn-default" data-name="Фиксировать"><i class="fa fa-hand-rock-o" title="Фиксировать"/></button>')).data("click",function(){b=!0,i.html('<div class="text-center"><i class="fa fa-spinner"/></div>');let e={};parseInt(f)||(f="params"),e[f]={},e[f][s.name]="params"===f?l.data_params[s.name].v:l.data[f][s.name].v,l._saveEdited.call(l,i,e,!1)}),u.append(C));if(s.changeSelectTable){let n=function(){b=!0;let n={};t.each(o,function(e,t){"$"!==e.substring(0,1)&&(n[e]=t)}),t(this).data("add-button")&&(n[s.name]=null);let i=0;return t(e.top.document.body).on("pctable-opened.select-"+s.name,function(){i++}).on("pctable-closed.select-"+s.name,function(e,n){i--;let a=n&&"insert"===n.method&&n.json&&n.json.chdata&&n.json.chdata.rows;setTimeout(function(){if(0===i||a){let e=x;delete s.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),o=t.extend(!0,{},o),a&&(s.multiple?o[s.name].v.push(Object.keys(n.json.chdata.rows)[0]):o[s.name].v=Object.keys(n.json.chdata.rows)[0]),a||"column"!==s.category||l.model.refresh(function(e){l.table_modify.call(l,e)}),o[s.name].replaceViewValue=function(e){"column"!=s.category&&(l.data_params[s.name].v_=e)},e.replaceWith(x=s.getEditElement(e,o[s.name],o,y,g,w)),t("body").off(".select-"+s.name)}},100)}),l.model.selectSourceTableAction(s.name,n),!1};(C=t('<button class="btn btn-sm btn-primary"><i class="fa fa-edit" title="Изменить в таблице-источнике"/></button>')).on("click",n),u.append(C),2===s.changeSelectTable&&(C=t('<button class="btn btn-sm btn-primary" data-add-button="true"><i class="fa fa-plus" title="Добавить в таблицу-источник"/></button>'),u.append(C),C.on("click",n))}let T=u.find("button").length;u.width(31*T);let S=t("#"+App.popNotify({$text:u,element:k,container:this._container,isParams:!0,placement:"bottom"})),I=parseInt(S.css("top"))-4;S.css("top",-1e7),setTimeout(function(){S.length&&S.isAttached()&&S.css("top",I)},3),s.focusElement(x)}}),function(e,t){t.extend(App.pcTableMain.prototype,{_orderSaveBtn:void 0,row_actions_add:function(){let e=this;e._table.on("mouseenter",".DataRow .id",function(){e.row_actions_icons_show.call(e,t(this))}),e._table.on("mouseout",".DataRow .id",function(n){let i=t(this);return t(n.target).is(".id")&&(i.is(":hover")?setTimeout(function(){i.is(":hover")||e.row_actions_icons_hide.call(e,i.closest("tr"))},100):e.row_actions_icons_hide.call(e,i.closest("tr"))),!1}),e._table.on("click",".DataRow .id button.dropdown",function(){e.row_dropdown.call(e,t(this))}),e._table.on("click",".DataRow .id .btn.chbox",function(n){return e._row_actions_checkbox_click.call(e,t(this).closest("tr"),n.shiftKey),!1}),e._table.on("mouseleave",function(){return t(this).blur(),!1}),e._container.on("click",".row_delete",function(){e.rows_delete.call(e,t(this).data("tr"))}),e._container.on("click",".row_duplicate",function(){e.row_duplicate.call(e,t(this).data("tr"))}),e._container.on("click",".row_refresh",function(){e.row_refresh.call(e,t(this).data("tr"))}),e._table.on("click",".DataRow .id button.edit",function(){e.rows_edit.call(e,t(this).closest("tr"))}),e.isCreatorView&&"cycles"===e.tableRow.type&&e._container.on("click",".cycle_refresh",function(){e.cycle_refresh.call(e,t(this).data("tr"))})},_idCheckButton:t('<button class="btn btn-xxs chbox btn-default" data-action="checkbox"><span class="fa fa-square-o"></span></button>'),_checkStatusBar:t('<div class="check-status-bar">✓ <span data-name="count_checked_rows">0</span> из <span data-name="count_visible_rows">0</span></div>'),_headCellIdButtonsState:function(){"use strict";let e=this;this.row_actions_get_checkedIds().length>0?t("table.pcTable-table").addClass("with-checks"):t("table.pcTable-table").removeClass("with-checks"),this.dataSortedVisible.length!==this.__checkedRows.length?e._idCheckButton.html('<span class="fa fa-square-o"></span>'):e._idCheckButton.html('<span class="fa fa-check"></span>'),this._refreshCheckedStatus(),e.ScrollClasterized.reloadScrollHead.call(e.ScrollClasterized)},_addCellId:function(e,n){let i=t('<td class="id">'+e.id+"</td>");return i.appendTo(n),!0===e.$checked&&(this.row_actions_icons_add(i),this.row_actions_check(e,!0)),i},_addCellNo:function(e,n){let i=t('<td class="No">--</td>');return i.appendTo(n),i},row_actions_uncheck_all:function(){"use strict";let e=this,t=this.row_actions_get_checkedIds();for(let n=0;n<t.length;n++){let i=e._getItemById(t[n]);e.row_actions_uncheck.call(e,i,!0)}this.__checkedRows=[],this._headCellIdButtonsState()},_refreshCheckedStatus:function(){this._checkStatusBar.find('[data-name="count_checked_rows"]:first').text(this.__checkedRows.length),this._checkStatusBar.find('[data-name="count_visible_rows"]:first').text(this.dataSortedVisible.length)},_row_actions_checkbox_click:function(e,n){let i=this,a=e.closest("tr"),o=this._getItemByTr(a),l=t.extend({},i._lastcheckAction||{});if(i._lastcheckAction={id:o.id,isCheck:!o.$checked},n){let e,t=[];if(l.id&&!o.$checked===l.isCheck&&-1!==(e=i.dataSortedVisible.indexOf(l.id))){let n=i.dataSortedVisible.indexOf(o.id);t=e<n?i.dataSortedVisible.slice(e+1,n+1):i.dataSortedVisible.slice(n,e)}else i.dataSortedVisible.some(function(e){if(i.data[e].$checked?t=[]:t.push(e),e===o.id)return!0});o.$checked?t.forEach(function(e){i.__checkedRows.splice(i.__checkedRows.indexOf(e),1),i.row_actions_uncheck(i.data[e],!0)}):t.forEach(function(e){i.__checkedRows.push(e),i.row_actions_check(i.data[e],!0)}),this._headCellIdButtonsState()}else o.$checked?this.row_actions_uncheck(o):this.row_actions_check(o)},row_actions_get_checkedIds:function(){return this.__checkedRows},row_actions_check:function(e,t){if(e.$checked=!0,e.$tr){let t=e.$tr.find(".id:first");0===t.find("button:first").length&&this.row_actions_icons_add(t),t.find(".chbox").html('<i class="fa fa-check"/>'),t.addClass("checked"),t.is(":hover")||this.row_actions_icons_hide(e.$tr)}t||(this.__checkedRows.push(e.id),this._headCellIdButtonsState())},row_actions_uncheck:function(e,t){e.$checked&&(e.$checked=!1,e.$tr&&($tdId=e.$tr.find(".id"),$tdId.removeClass("checked"),$tdId.find(".chbox i").attr("class","fa fa-square-o"),!t&&$tdId.is(":hover")||this.row_actions_icons_hide(e.$tr)),t||(this.__checkedRows.splice(this.__checkedRows.indexOf(e.id),1),this._headCellIdButtonsState()))},row_actions_icons_add:function(e){"use strict";let n,i;n=this.tableRow.panel?t('<button class="btn btn-default edit"><i class="fa fa-th-large"/></button>').on("mouseleave",function(){return t(this).blur(),!1}).css("margin-left",2):t(),this.control.editing&&(i=t('<button class="btn btn-default btn-xxs dropdown"  tabindex="-1" style=" margin-left: 2px;"><i class="fa fa-caret-down" style="font-size: 10px; width: 7px;"/></button>'));let a=t('<button class="btn btn-default btn-xxs chbox"><i class="fa fa-square-o"/></button>'),o=t('<span class="btn-group-xxs">');e.empty().append(o).append(" ").append(a),i&&o.append(i),n&&o.append(n)},row_actions_icons_show:function(e){e.is(".checked")?e.find(".btn-group-xxs").show():this.row_actions_icons_add(e)},row_actions_icons_hide:function(e){let t=this._getItemByTr(e);t.$checked?e.find(".id").find(".btn-group-xxs").hide():e.find(".id").html(t.id)},table_modify:function(e,n,i){"use strict";let a=this,o=0,l=0,s=i?i.data("field"):void 0;if(n&&(o=a.dataSorted.indexOf(n)+1,l=a.dataSortedVisible.indexOf(n)+1),e.chdata){let i=e.chdata.deleted||[],r=[];if(e.chdata.rows&&(e.refresh&&e.chdata.rows&&Object.keys(a.data).forEach(function(t){void 0===e.chdata.rows[t]&&i.push(parseInt(t))}),t.each(e.chdata.rows,function(e,t){let n=a._getItemById(t.id);void 0===n?r.push(t):a.refreshRow(n.$tr,n,t)}),r.length&&(App.isEmpty(a.data)&&a._content&&a._content.find(".pcTable-noDataRow").remove(),t.each(r,function(e,t){t.$visible=!0,t.$checked=!1,o||!a.tableRow.with_order_field||a.tableRow.new_row_in_sort||(t.__inserted=!0),a.data[t.id]=t;let i=o,s=l;!t.__after||n&&n.id===t.__after||(i=a.dataSorted.indexOf(t.__after)+1,s=a.dataSortedVisible.indexOf(t.__after)+1),a.dataSorted.splice(i,0,t.id),a.dataSortedVisible.splice(s,0,t.id),o++,l++}),n&&setTimeout(function(){t.each(r,function(e,t){a.row_actions_check(a.data[t.id])})},50))),i.length&&(t.each(i,function(e,t){a._deleteItemById.call(a,t)}),App.isEmpty(a.data)&&a._content&&0===a._content.find("."+this.noDataRowClass).length&&a._content.append(a._createNoDataRow())),i.length||r.length||e.chdata.nsorted_ids&&a.nSorted&&!Object.equals(e.chdata.nsorted_ids,a.dataSorted)){if(e.chdata.nsorted_ids&&a.nSorted){let t=a.dataSortedVisible;a.dataSorted=e.chdata.nsorted_ids,t.length===a.dataSorted.length?a.dataSortedVisible=a.dataSorted:(a.dataSortedVisible=[],a.dataSorted.forEach(function(e){-1!==t.indexOf(e)&&a.dataSortedVisible.push(e)}))}this.ScrollClasterized.insertToDOM(void 0,!0)}let c={};if(e.chdata.params&&t.each(e.chdata.params,function(e,t){["v","v_","f","e","h","c"].forEach(function(n){(void 0!==t[n]||a.data_params[e][n])&&(Object.equals(a.data_params[e][n],t[n])&&e!==s||(c[e]=!0,a.data_params[e][n]=t[n]))})}),e.chdata.fields&&t.each(e.chdata.fields,function(e,n){n.list&&!Object.equals(a.fields[e].list,n.list)&&(c[e]=!0,t.extend(a.fields[e],n))}),(e.chdata.params||e.chdata.fields)&&(a._refreshParamsBlock(c,!0),a._refreshFootersBlock(c,!0)),e.chdata.f){let t=e.chdata.f;["blockadd","blockdelete","blockorder","background","blockduplicate","block"].forEach(function(e){(t[e]||a.f[e])&&t[e]!==a.f[e]&&(a.f[e]=t[e],a.__formatFunctions[e]&&a.__formatFunctions[e].call(a))})}App.isEmpty(a.data)&&a._content&&0==a._content.find("."+this.noDataRowClass).length&&a._content.append(this._createNoDataRow())}e.updated&&(a.model.tableData.updated=JSON.parse(e.updated),a._refreshTitle()),e.filtersString&&a._refreshFiltersBlock.call(a,e),a._headCellIdButtonsState()},rows_edit:function(e){"use strict";let t=this,n=this.row_actions_get_checkedIds();return e&&-1===n.indexOf(t._getItemByTr(e).id)&&(this.row_actions_check(t._getItemByTr(e)),n=this.row_actions_get_checkedIds()),t._row_edit.call(t,n.slice()),!1},row_dropdown:function(e){"use strict";let n=this,i=t("<div>"),a=n._getItemByTr(e.closest("tr")),o=a.id;!0!==this.control.duplicating||n.f.blockduplicate||a.f.blockduplicate?i.append(t('<div class="menu-item"><i class="fa fa-clone"/> Дублировать</div>').css("color","gray")):i.append(t('<div class="menu-item row_duplicate"><i class="fa fa-clone"/> Дублировать</div>').attr("data-tr",o)),-1!==["calcs","globcalcs"].indexOf(n.tableRow.type)?i.append(t('<div class="menu-item"><i class="fa fa-refresh"/> Пересчитать</div>').css("color","gray")):i.append(t('<div class="menu-item row_refresh"><i class="fa fa-refresh"/> Пересчитать</div>').attr("data-tr",o)),n.isCreatorView&&"cycles"===n.tableRow.type&&i.append(t('<div class="menu-item cycle_refresh color-danger"><i class="fa fa-refresh"/> Пересчитать цикл</div>').attr("data-tr",o)),!this.control.deleting||this.f.blockdelete||a.f&&(a.f.block||a.f.blockdelete)?i.append(t('<div class="menu-item"><i class="fa fa-times"/> Удалить</div>').css("color","gray")):i.append(t('<div class="menu-item row_delete"><i class="fa fa-times"/> Удалить</div>').attr("data-tr",o));let l=App.popNotify({isParams:!0,$text:i,element:e,container:this._container,trigger:"manual",placement:"bottom"});return t("#"+l).position({my:"left top",at:"left-3px bottom+10px",of:e}).off().on("mouseleave",function(){i.remove(),n.row_actions_icons_hide(e.closest("tr"))}).find(".arrow").css("left","11px").end().find(".popover-content").css("padding","5px"),!1},__getCheckedRowsIds:function(e,n,i){"use strict";let a=this,o=this.row_actions_get_checkedIds();if(e&&-1===o.indexOf(e)){let t=a.data[e];this.row_actions_check(t),o=this.row_actions_get_checkedIds()}if(n){let e=!1;if(o.some(function(t){if(a.data[t].f&&(a.data[t].f.block||a.data[t].f[i]))return e=a.data[t],!0}),e){let n="";"id"!==a.mainFieldName&&(n=' "'+(n=e[a.mainFieldName]._v?e[a.mainFieldName]._v:e[a.mainFieldName].v)+'"');let i=t("<span>").html("Строка <b>id "+e.id+"</b>");if(""!==n){let e=i.find("b");e.text(e.text()+n)}return i.append(" заблокирована"),App.notify(i,"Действие не выполнено"),!1}}return o},row_refresh:function(e){"use strict";let t=this,n=this.__getCheckedRowsIds(e,!1);if(n&&n.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_rows(n).then(function(n){t.table_modify.call(t,n),e.close(),t.row_actions_uncheck_all()})}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+n.length+" строк?",title:"Пересчет",buttons:e,draggable:!0})}},cycle_refresh:function(e){"use strict";let t=this,n=this.__getCheckedRowsIds(e,!1);if(n&&n.length){let e=[{label:"Пересчитать",action:function(e){t.model.refresh_cycles(n).then(function(n){t.table_modify.call(t,n),e.close(),t.row_actions_uncheck_all()})}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно пересчитать "+n.length+" циклов?",title:"Пересчет",buttons:e,draggable:!0})}},row_duplicate:function(e){"use strict";let n=this,i=this.__getCheckedRowsIds(e,!1);if(i&&i.length){let a=[{label:"Дублировать",cssClass:"btn-danger",action:function(a){let o={},l=[],s=[];n.dataSortedVisible.forEach(function(e){-1!==i.indexOf(e)&&s.push(e)}),i=s;const r=function(t){n.model.duplicate(i,o,e).then(function(i){n.table_modify.call(n,i,e),t&&t.close(),a.close(),n.row_actions_uncheck_all()})};for(let e in n.fieldCategories.column){let t=n.fieldCategories.column[e];"unic"===t.type&&l.push(t.name)}if(l.length){let e,s=t('<table class="simpleTable"><thead><tr><td class="id">id</td></tr></thead><tbody></tbody></table>'),c=s.find("thead tr"),d=s.find("tbody");"id"!==n.mainFieldName&&("unic"!==(e=n.fields[n.mainFieldName]).type?c.append(t("<td></td>").text(e.title)):e=null);for(let e in l){let i=n.fields[l[e]];c.append(t("<td></td>").text(i.title))}for(let a in i){let s=i[a],r=n.data[s],c=t("<tr>");o[s]={},c.append(t('<td class="id"></td>').text(s)),e&&c.append(t("<td></td>").text(r[e.name].v));for(let e in l){let i,a=n.fields[l[e]],d=t('<td class="input"></td>'),f=t("<input>").val(r[a.name].v);o[s][a.name]=r[a.name].v,f.on("keyup",function(){let e=t(this).val();o[s][a.name]=e,i&&(clearTimeout(i),i=null),""!==e?i=setTimeout(function(){n.model.checkUnic(a.name,e).then(function(e){e.ok?d.addClass("ok"):d.removeClass("ok")})},300):a.required?d.removeClass("ok"):d.addClass("ok")}),d.html(f),c.append(d)}d.append(c)}let f=[{label:"Дублировать",cssClass:"btn-m btn-warning",action:function(e){r(e)}},{label:"Отмена",action:function(e){e.close(),a.close()}}];BootstrapDialog.show({message:s,title:"Заполните значения для уникальных полей",buttons:f,draggable:!0})}else r()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:"Точно дублировать "+i.length+" строк?",title:"Дублирование",buttons:a,draggable:!0})}},rows_delete:function(e){let t=this,n=this.__getCheckedRowsIds(e,!0,"blockdelete");if(n&&n.length){let e="Точно удалить "+n.length+" строк?",i="Удаление "+n.length+" строк?";if(1==n.length){let a="id-"+n[0];"id"!=t.mainFieldName&&(a=t.data[n[0]][t.mainFieldName],a="id-"+n[0]+' "'+(a.v_&&a.v_[0]?a.v_[0]:a.v)+'"'),e="Точно удалить строку "+a+"?",i="Удаление строки "+a+"?"}let a=[{label:"Удалить",cssClass:"btn-danger",action:function(e){e.close();const a=function(){t.model.delete(n).then(function(e){t.table_modify.call(t,e)})};t.tableRow.delete_timer>0?App.panelTimer(i,t.tableRow.delete_timer,a):a()}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:"Удаление",buttons:a,draggable:!0})}}})}(0,jQuery),t.extend(App.pcTableMain.prototype,{_insertItem:null,_insertRow:null,_insertButtons:null,_currentInsertCellIndex:0,_addInsert:function(e){var t=this;this.control.adding&&(this._insertRow&&this._insertRow.length||(e&&(this._insertItem={},this.fieldCategories.column.forEach(function(n){e[n.name]&&(t._insertItem[n.name]={v:e[n.name]})})),this._insertRow=this._createInsertRow(null,0),this._insertButtonsChangeStatuses(),this._beforebody.prepend(this._insertRow),this._table.addClass("with-adding-row")))},_insertButtonsChangeStatuses:function(){this._insertRow?this._insertButtons.find('[data-action="add"]').removeClass("btn-warning").addClass("btn-default").attr("disabled","disabled"):this._insertButtons.find('[data-action="add"]').addClass("btn-warning").removeClass("btn-default").removeAttr("disabled")},_InsertAddInsertBtnsPanel:function(e){let n,i=this,o={};o['<span id="saveInsertRow" tabindex="'+i.fieldCategories.column.length+'">Сохранить</span>']=function(){n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i,"close").always(function(){n.removeClass("onSaving")})})},o['<i class="fa fa-save"  tabindex="'+(i.fieldCategories.column.length+1)+'"/>']=function(){n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i).then(function(){n.removeClass("onSaving")})})},o['<i class="fa fa-paste"  tabindex="'+(i.fieldCategories.column.length+2)+'"/>']=function(){n.addClass("onSaving"),i.__insertRowActions("saveInsertRow",function(){i._saveInsertRow.call(i,"notClean").then(function(){n.removeClass("onSaving")})})},o['<i class="fa fa-times" tabindex="'+(i.fieldCategories.column.length+3)+'"/>']=function(){i._closeInsertRow.call(i,t(this).closest("#"+a))},n=this._addRowPanel(a,e,o)},__insertRowActionsStack:[],__insertRowActions:function(e,t){"use strict";let n=this;-1!==["saveInsertRow","clickSourceButton"].indexOf(e)&&setTimeout(function(){let e;(e=n.model.getDefferedProcess())?e.then(t):t()},450)},_saveInsertRow:function(e){let n=this,i={},a=t.Deferred();return n.model.doAfterProcesses(function(){t.each(n._insertItem,function(e,t){"n"!==e&&(i[e]=t.v)}),n.model.add(i).then(function(t){switch(n.table_modify.call(n,t),n._currentInsertCellIndex=0,e){case"notClean":break;case"close":n._closeInsertRow();break;default:n._insertItem=null,n._insertRow.html('<td class="id"></td>'),n._createInsertRow(n._insertRow,0)}}).always(function(){a.resolve()})}),a.promise()},_getInsertButtons:function(){let n=this,i=function(){n._addInsert.call(n)},a=function(){n._addInsertWithPanel.call(n)};return"cycles"===this.tableRow.type&&(a=i=function(){n.model.add({}).then(function(t){t.firstTableId?e.location.href=e.location.pathname+"/"+t.chdata.rows[0].id+"/"+t.firstTableId:n.table_modify.call(n,t)})}),this._insertButtons||(this._insertButtons=t("<span>"),t('<button data-action="add" class="btn btn-sm btn-warning">Добавить</button>').width(80).on("click",i).appendTo(this._insertButtons),this.tableRow.panel&&t('<button class="btn btn-warning btn-sm"><i class="fa fa-th-large"/></button>').on("click",a).appendTo(this._insertButtons).css("margin-left",5)),this._insertButtons},_addInsertWithPanel:function(){let e=this;new EditPanel([this.tableRow.id,this.model.tableData.sess_hash],BootstrapDialog.TYPE_PRIMARY,{}).then(function(t){t&&e.table_modify.call(e,t)})},_closeInsertRow:function(){this._insertPanel?this._insertPanel=null:(this._insertRow.find("td").each(function(){t(this).remove()}),this._insertRow.remove(),this._insertRow=null),this._insertItem=null,this._insertButtonsChangeStatuses(),this._currentInsertCellIndex=0,this._table.removeClass("with-adding-row")},_createInsertRow:function(e,n,a){var o=this,l=o._insertItem||(o._insertItem={});e||(this.insertRow=e=t('<tr class="InsertRow" style="height: 35px;"><td class="id"></td></tr>'),this._InsertAddInsertBtnsPanel(e)),o._currentInsertCellIndex||(o._currentInsertCellIndex=0);let s={};t.each(o._insertItem,function(e,t){"n"!==e&&(s[e]=t.v)});let r=[];return o.fieldCategories.visibleColumns.forEach(function(e){r.push(e.name)}),o.model.checkInsertRow(s,a).then(function(n){l=n.row,t.each(o.fieldCategories.column,function(t,n){if(!n.showMeWidth)return void(o._insertItem[n.name]=l[n.name]);let s=r.indexOf(n.name);var c=e.find("td:eq("+(s+1)+")");let d=o._insertItem[n.name],f=o._insertItem[n.name]&&o._insertItem[n.name].force;if(o._insertItem[n.name]=l[n.name],c.length){let t="n"===n.name||o._insertItem[n.name].f&&!0===o._insertItem[n.name].f.block;if(c.data("input")&&!t){n.name;let t=!1;t=!f&&(null===l[n.name].v&&""==d.v||Object.equals(l[n.name].v,d.v)&&!n.codeSelectIndividual),void 0!==d&&t&&"data_src"!=n.name&&"comments"!=n.type||(o._createInsertCell.call(o,c,n,e,s,"td",o._createInsertRow),a===n.name&&o._colorizeElement(c,i))}else c.replaceWith(o._createInsertCell.call(o,null,n,e,s,"td",o._createInsertRow))}else e.append(c=o._createInsertCell.call(o,null,n,e,s,"td",o._createInsertRow))}),o._insertFocusIt.call(o)}),e},_createInsertCell:function(i,a,o,l,s,r){s=s||"td";i=i||t("<"+s+">");var c=this;if(a.code&&i.addClass("with-code"),void 0===c._insertItem[a.name]&&(c._insertItem[a.name]=null),!a.insertable||c._insertItem[a.name].f&&1==c._insertItem[a.name].f.block){let e=c._insertItem[a.name];return e&&(e=e.v),i.empty().append(a.getCellText(e,i,c._insertItem)),i}var d=function(e){var t;try{t=a.getEditVal(e)}catch(t){return App.popNotify(t,e,"default"),null}return t},f=function(e,t){var n=d(e);null===n?c._insertFocusIt.call(c):(c._currentInsertCellIndex=l+1,a.isDataModified(n,c._insertItem[a.name].v)?(c._insertItem[a.name].v=n,!0===a.isPanelField&&c._createInsertCell.call(c,i,a,o,l,s,r),r.call(c,o,c._currentInsertCellIndex,a.name)):c._insertFocusIt.call(c))},u=function(e,t){setTimeout(function(){let t=e.closest("td");if(!t.length||!t.closest("tr").length)return!1;let n=d(e);null===n?c._insertFocusIt.call(c):a.isDataModified(n,c._insertItem[a.name].v)&&(c._insertItem[a.name].v=n,!0===a.isPanelField&&c._createInsertCell.call(c,t,a,o,l,s,r),r.call(c,o,c._currentInsertCellIndex,a.name))},150)},p=function(e,t){let i=e.closest("td");if(!i.length||!i.closest("tr").length)return!1;let f=d(e),u=c._insertItem[a.name].v+"";a.isDataModified(f,u)&&(c._createInsertCell(i,a,o,l,s,r),c._colorizeElement(i,n))};let h=a.getEditElement(i.data("input"),c._insertItem[a.name],c._insertItem,f,p,u);if(i.on("click focus","input,button,select",function(){c._currentInsertCellIndex=l}),i.on("click focus",function(){c._currentInsertCellIndex=l}),h.isAttached()||i.html(h).data("input",h),"select"===a.type&&2===a.changeSelectTable){i.addClass("with-source-add-button");let n=t('<button class="btn btn-default btn-sm source-add" tabindex="-1"><i class="fa fa-plus"></i></button>');i.prepend(n);let l=function(){let n={},l=c._insertItem;t.each(l,function(e,t){"$"!==e.substring(0,1)&&(n[e]=t)});n[a.name]=null;let s=0;return t(e.top.document.body).on("pctable-opened.select-add-"+a.name,function(){s++}).on("pctable-closed.select-add-"+a.name,function(e,n){s--;let d=n&&"insert"===n.method&&n.json&&n.json.chdata&&n.json.chdata.rows;if(0===s||d){let e=h;delete a.list,e.data("input").data("LISTs")&&(e.data("input").data("LISTs").isListForLoad=!0),d&&(a.multiple?l[a.name].v.push(Object.keys(n.json.chdata.rows)[0]):l[a.name].v=Object.keys(n.json.chdata.rows)[0]),e.replaceWith(h=a.getEditElement(e,l[a.name],l,f,p,u)),t("body").off(".select-add-"+a.name),i.data("input",h),r.call(c,o,c._currentInsertCellIndex,a.name)}}),c.model.selectSourceTableAction(a.name,n),!1};n.on("click",function(){c.__insertRowActions("clickSourceButton",l)})}return i},_insertFocusIt:function(e){let n=this;if(!e)return setTimeout(function(){n._insertFocusIt.call(n,1)},10),!1;let i=!0,a=!!this._insertPanel,o=this.insertRow;if(a){if(!n._insertPanel)return!1;o=n._insertPanel.$modalBody}if(!o||!o.length)return!1;if(t.each(n.fieldCategories.visibleColumns,function(e,t){if(n._currentInsertCellIndex==e)return!t.insertable||n._insertItem&&n._insertItem[t.name]&&n._insertItem[t.name].f&&!0===n._insertItem[t.name].f.block?void n._currentInsertCellIndex++:(a?t.focusElement(o.find(".cell:eq("+e+")").data("input")):t.focusElement(n._getTdByColumnIndex(o,e+1).data("input")),i=!1,!1)}),i)if(a){n._insertPanel.indexedButtons[Object.keys(n._insertPanel.indexedButtons)[0]].focus()}else t("#saveInsertRow").parent().focus()}}),t.extend(App.pcTableMain.prototype,{_rerenderColumnsFooter:function(){let e=this._createFootersBlock();this._footersBlock.replaceWith(e[0]),this._footersBlock=e[0]},_renderTable:function(){let n=this;this._table=t("<table>").addClass(this.tableClass),this.notCorrectOrder&&this._table.addClass("no-correct-n-filtered"),this._table.append(this._createHead()).append(this._createFirstBody()).append(this._createBody()).append(this._createAfterBody());let i=this._createFootersBlock();this._footersBlock=i[0],this._footersSubTable=i[1],this._table.append(this._footersBlock),this._popovers=t('<div class="popovers">'),1===this.fieldCategories.column.length&&n._container.addClass("no-fields");let a=this.scrollWrapper=this._container.append('<div class="pcTable-scrollwrapper">').find(".pcTable-scrollwrapper");a.append(this._createBeforeSpace()),this.isCreatorView&&a.append(this._refreshHiddenFieldsBlock()),a.append(this._paramsBlock=this._createParamsBlock()).append(this._createFiltersBlock()),a.append(t('<div class="pcTable-buttonss">').append(this._rowsButtons())).append(this._innerContainer).append(this._footersSubTable).append(this._popovers),n._container.height(e.innerHeight-n._container.offset().top-20),this.addScrollsRules(),this._seeCalcucatedValData(),this._seeSelectPreview(),this._clickstoCopyMe(),this.isCreatorView&&this._hideHell_storage.checkIssetFields.call(this)},_refreshHiddenFieldsBlock:function(){let e=this._hiddenFieldsBlock();return this.HiddenFieldsBlock&&this.HiddenFieldsBlock.replaceWith(e),this.HiddenFieldsBlock=e,this.HiddenFieldsBlock},_hiddenFieldsBlock:function(){let e,n,i=this,a=0,o=t('<div class="pcTable-hiddenFieldsTables">'),l=0;if(this.beforeSpaceHide||!this._hideHell_storage.getOpened.call(this))return o;let s=this._container.width()-100;return t.each(i.hidden_fields||[],function(r,c){a++;let d=c.width>0?c.width:100;(0===l||s<l+d)&&(e&&e.width(l),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),o.append(e),l=0,n=e.find("thead tr")),n.append(i._createHeadCell(r,c)),l+=c.width}),i.isCreatorView&&Object.keys(i.fields).forEach(function(r,c){let d=i.fields[r];if(d.showInWeb&&d.showMeWidth<1&&"n"!==d.name){a++;let r=d.width>0?d.width:100;(0===l||s<l+r)&&(e&&e.width(l),e=t("<table class='pcTable-hiddenFieldsTable'><thead><tr></tr></thead></table>\""),o.append(e),l=0,n=e.find("thead tr")),n.append(i._createHeadCell(c,d)),l+=d.width}}),e&&e.width(l),a?o:t('<div class="pcTable-hiddenFieldsTables">')},_clickstoCopyMe:function(){this._container.on("click",".copy_me",function(){let e=t(this);return!e.data("clicked")&&(e.data("clicked",!0),e.width(e.width()),e.data("text")?App.copyMe(e.data("text")):App.copyMe(e.text()),e.button("copied"),setTimeout(function(){e.button("reset"),e.removeData("clicked")},2e3),e.blur(),!1)})},_clicksToCodeView:function(){let n=this;this._container.on("click","th .roles",function(){let i=t(this);if(i.hasClass(".fa-sun-o")||i.hasClass("fa-certificate")){let a,o=n._getFieldBytd(i.closest("th")),l=t('<div class="HTMLEditor" id="bigOneCodemirror" style="height: 100%;"></div>');BootstrapDialog.show({message:l,type:null,title:"Просмотр кода поля "+o.title,cssClass:"fieldparams-edit-panel",draggable:!0,onhide:function(e){mirror.setValue(a.getValue())},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"})},onshown:function(t){a=CodeMirror(l.get(0),{mode:"totum",value:o.code[0],theme:"eclipse",lineNumbers:!0,indentWithTabs:!0,autoCloseTags:!0,bigOneDialog:t,readOnly:!0}),mirror.table&&(a.table=mirror.table);let n=Math.round(t.$modalContent.height()-t.$modalHeader.outerHeight()-40);a.getScrollerElement().style.minHeight=n+"px",l.find(".CodeMirror").css("min-heught",n),a.focus(),t.$modalContent.position({my:"center top",at:"center top+30px",of:e})}})}})},_seeCalcucatedValData:function(){var e=this;this._container.on("mouseover","td .fa-hand-paper-o",function(){var n=t(this),i=n.closest("td"),a=e._getItemBytd(i),o=e._getFieldBytd(i),l=t("<div>");let s="";null===a[o.name].c||""===a[o.name].c||void 0===a[o.name].c?s="":"select"===o.type?o.multiple?t.each(a[o.name].c,function(e,t){""!==s&&(s+=", "),s+=o.getElementString(a[o.name].c[e],a[o.name].c_[e])}):s=o.getElementString(a[o.name].c,a[o.name].c_):"object"==typeof(s=o.getCellText(a[o.name].c,null,a,e))&&(s=s.text()),l.append(t("<div>Расчетное значение: </div>").append(t("<code>").text(s))),n.one("mouseout",function(){l.length&&(l.remove(),l=null)}),setTimeout(function(){l&&l.length&&App.popNotify(l,n)},500)})},_seeSelectPreview:function(){var e=this;this._container.on("mouseover",".select-with-preview li",function(n){let i=t(this),a=setTimeout(function(){if(i.is(":hover")){let t=i.find("span.select-with-preview");e.fields[t.data("field")]&&e.fields[t.data("field")].previewPanel.call(e.fields[t.data("field")],t,i)}},300);i.one("mouseout",function(){a&&clearTimeout(a)})})},_createBeforeSpace:function(){let n=this;if(n.beforeSpaceHide)return this._beforeSpace=t("<span></span>");this._beforeSpace=t('<div class="pcTable-beforeSpace">'),n.LogButton=t();let i=t('<div class="pcTable-topButtons">'),a=t("#TOTUM_FOOTER");if(a.length&&i.append(a),n.isCreatorView){let e=t('<div class="creator-log-buttons">'),o=t('<button class="btn btn-danger btn-sm"><i class="fa" style="width: 12px"></i> Показать логи</button>').appendTo(e).on("click",function(){let e;const i=function(){let i=[];e.find("input:checked").each(function(e,n){i.push(t(n).attr("name"))}),i.length>0?o.find("i").attr("class","fa fa-check-square-o"):o.find("i").attr("class","fa fa-square-o"),t.cookie("pcTableLogs",JSON.stringify(i),{path:"/"}),n.FullLOGS=[],n.LOGS={},o.popover("destroy")};if(o.is("[aria-describedby]"))e=t("#"+o.attr("aria-describedby")),i();else{let a=t.cookie("pcTableLogs")||"[]";a=JSON.parse(a),(e=t("<div>")).append('<div><input type="checkbox" name="c"/> Код</div>'),e.append('<div><input type="checkbox" name="a"/> Код-действия</div>'),e.append('<div><input type="checkbox" name="s"/> Селекты</div>'),e.append('<div><input type="checkbox" name="f"/> Форматирование</div>'),e.append('<div><input type="checkbox" name="recalcs"/> Пересчеты и селекты</div>');let l=t('<button class="btn btn-xs"><i class="fa fa-table"></i></button>').on("click",function(){n.FieldLOGS?n.model.calcFieldsLog(JSON.stringify(n.FieldLOGS),n.FieldLOGSName||"Расчет вывода таблицы"):App.notify("Лог расчета полей пуст")});e.append(t('<div><input type="checkbox" name="flds"/> Время расчета полей </div>').append(l)),e.append('<div style="padding-top: 10px;"><button class="btn btn-sm btn-default">Применить</button></div>'),e.find("input").each(function(e,n){n=t(n),-1!==a.indexOf(n.attr("name"))&&n.prop("checked","checked")}),e.on("click","button",function(){i()}),o.popover({trigger:"manual",placement:"bottom",content:e,html:!0,animation:!1,container:n._container,onhide:function(){}}).popover("show")}}),l=o.find("i"),s=t.cookie("pcTableLogs")||"[]";(s=JSON.parse(s)).length>0?l.addClass("fa-check-square-o"):l.addClass("fa-square-o");let r=t('<button class="btn btn-danger btn-sm">Лог</button>').appendTo(e);n.LogButton=r,r.on("click",function(){n.FullLOGS&&0!==n.FullLOGS.length?App.logOutput(n.FullLOGS):App.logOutput("Лог пуст. Включите логирование и перегрузите страницу")}),a.length?a.append(e):e.appendTo(i),t('<button class="btn btn-danger btn-sm"><i class="fa fa-eraser" style="width: 13px"></i></button>').on("click",function(){n.FullLOGS=[],n.LOGS={}}).appendTo(e)}let o=t('<span class="common-table-title">');o.append(this.fieldsHiddingGetButton(!0));t('<button class="btn btn-default btn-sm"><i class="fa fa-print"></i></button>').on("click",function(){n._print.call(n)}).appendTo(o);if(n.withCsvButtons){let e=t('<button class="btn btn-default btn-sm">CSV-экспорт</button>').on("click",function(){n._csvExport.call(n)});o.append(e)}if(n.withCsvEditButtons&&this.control.editing){let e=t('<button class="btn btn-default btn-sm">CSV-импорт</button>').on("click",function(){n._csvImportClick.call(n)});o.append(e)}if(this.isCreatorView&&this.isMain){let a=t('<div class="creator-buttons">');t('<button class="btn btn-default btn-xxs field_name copy_me" data-copied-text="Скопировано"/>').text(this.tableRow.name).appendTo(a),t('<button class="btn btn-danger btn-xxs" title="Редактировать настройки таблицы"/>').html('<i class="fa fa-pencil-square-o"/>').on("click",function(){new EditPanel(1,BootstrapDialog.TYPE_DANGER,{id:n.tableRow.id}).then(function(t){t&&e.location.reload(!0)})}).appendTo(a);let o={fl_name:[this.tableRow.id]};if(t('<a href="/Table/'+this.Tables.branchId+"/"+this.Tables.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть список таблиц"/>').html('<i class="fa fa-external-link"/>').appendTo(a),o={f_table_categories:this.tableRow.category,f_table:this.tableRow.id},this.tableRow.__version&&(o.fl_version=this.tableRow.__version),t('<a href="/Table/'+this.Tables.branchId+"/"+this.TableFields.id+"/?"+t.param({f:o})+'" target="_blank" class="btn btn-danger btn-xxs" title="Открыть состав таблиц"/>').html('<i class="fa fa-external-link-square"/>').appendTo(a),"calcs"===this.tableRow.type){a.append(" ");let e=t('<a href="/Table/'+this.TablesVersions.branchId+"/"+this.TablesVersions.id+"/?"+t.param({f:this.TablesVersions.version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Создание версий таблиц"><i class="fa fa-code-fork"></i></a>');a.append(e),a.append(" "),e=t('<a href="/Table/'+this.TablesCyclesVersions.branchId+"/"+this.TablesCyclesVersions.id+"/?"+t.param({f:this.TablesCyclesVersions.version_filters})+'" target="_blank" class="btn btn-danger btn-xxs" title="Изменение версий таблиц цикла"><i class="fa fa-random"></i></a>'),a.append(e)}let l=t('<div class="color-danger creator-table-title">'+ +this.tableRow.sort+' <i class="'+App.tableTypes[this.tableRow.type].icon+'"/> '+App.tableTypes[this.tableRow.type].title+"</div>");if(a.append(l),"calcs"===this.tableRow.type&&l.append(" / Версия "+this.tableRow.__version+" / Цикл "+this.cycle),this.tableRow.description){let n=t('<a class="btn btn-danger btn-sm"><i class="fa fa-info"/></a>'),i=this.tableRow.title;n.appendTo(a);let o=this.tableRow.description;n.on("click",function(){e.top.BootstrapDialog.show({message:t("<div>").html(o),type:null,title:"Описание таблицы "+i,cssClass:"fieldparams-edit-panel",draggable:!0,onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:"90vw",minHeight:"90vh"})},onshown:function(t){t.$modalContent.position({my:"center top",at:"center top+30px",of:e.top})}})})}t('<button class="btn btn-danger btn-sm" id="hide-hell" disabled><i class="fa fa-times"></i></span></button>').on("click",function(){n._hideHell_storage.switchOpened.call(n)}).appendTo(a);a.appendTo(i);t('<button class="btn btn-danger btn-sm">Добавить поле</span></button>').width(113).on("click",function(){let t={table_id:{v:n.tableRow.id}};n.tableRow.__version&&(t.version={v:n.tableRow.__version}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,t).then(function(t){t&&e.location.reload(!0)})}).appendTo(a);a.appendTo(i)}return this._beforeSpace.append(i),this._beforeSpace_title=t('<div class="pcTable-title"><span class="title"/><span class="bttns"/><div class="updated"/></div>').prependTo(this._beforeSpace),this._beforeSpace_title.find(".bttns").append(o),this._beforeSpace},__$rowsButtons:null,_rowsButtons:function(){let e,n=this;if(this.__$rowsButtons?e=this.__$rowsButtons.empty():(e=t('<div class="pcTable-buttons">'),this.__$rowsButtons=e),this.fieldCategories.column.length){this.control.adding&&!this.f.blockadd&&e.append(n._getInsertButtons());let i=t('<button class="btn btn-default btn-sm" style="margin-left: 5px;" disabled>Сбросить <span class="fa fa-filter"></span></button>').width(82).on("click",function(){setTimeout(function(){n.filtersEmpty.call(n)},50)});e.append(i),this.filtersClearButton=i}return e},_refreshContentTable:function(e,t){let n=this._content;t=t||!1,n.data("state","refreshing");App.fullScreenProcesses.showCog();this.ScrollClasterized.insertToDOM(0,t,e),App.fullScreenProcesses.hideCog(),n.data("state","ready"),n.trigger("refreshed"),this._popovers.empty()},_refreshTitle:function(){if(!this.beforeSpaceHide&&(this._beforeSpace_title.find(".title").text(this.tableRow.title),this.model.tableData&&this.model.tableData.updated)){let e=t('<div class="small">').text(moment(this.model.tableData.updated.dt,"YYY-MM-DD HH:mm").format("DD.MM HH:mm")).append(" (code: "+this.model.tableData.updated.code+")");this.tableRow.__blocked?e.append('<div class="">Блокирована'+(this.tableRow.license_error?": "+this.tableRow.license_error:"")+"</div>"):!1===this.control.editing&&e.append('<div class="">Только чтение</div>'),this._beforeSpace_title.find(".updated").html(e)}},_createFiltersBlock:function(){this._filtersBlock=t("<div>");var n=this;if(n.fieldCategories.filter.length){let i,a,o;this._filtersBlock.addClass("pcTable-filtersTables");let l,s=0,r=this._container.width()-100;const c=function(){if(i){a.append("<th></th>");let l=t('<td class="buttons-go">').html('<button class="btn btn-default btn-xs button-go">GO</button> <button class="btn btn-default btn-xs eraser button-go"><i class="fa fa-eraser"></i></button>').appendTo(o);i.width(s+69),l.on("click",".button-go",function(){if(t(this).is(".eraser"))e.location.href="?";else{const i=function(){e.location.href="?"+t.param({f:n._filtersBlock.data("cryptoFilters")||n.filterDataCrypted})};setTimeout(function(){n.model.doAfterProcesses(i)},500)}return!0})}},d=function(e,d){d.hidden||((0===s||r<s+d.width||d.tableBreakBefore)&&(c(),i=t("<table class='pcTable-filtersTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>"),n._filtersBlock.append(i),s=0,a=i.find("thead tr"),o=i.find("tbody tr")),void 0!==d.panelColor&&(l=d.panelColor),a.append(n._createHeadCell(e,d,l)),t("<td>").attr("data-field",d.name).appendTo(o),s+=d.width)};t.each(n.fieldCategories.filter,d),c()}return this._filtersBlock},_refreshFiltersBlock:function(e){let n=this;(e=e||{}).params?(t.each(n.fieldCategories.filter,function(t,i){n.data_params[i.name]=e.params[i.name]}),n._filtersBlock.data("cryptoFilters",e.filtersString)):n.filterData||(n.filterData={},t.each(n.fieldCategories.filter,function(e,i){n.filterData[i.name]=t.extend(!0,{},n.data_params[i.name])}),n.model.addFiltersData({filters:n.filterDataCrypted}));let i=[],a=[];return t.each(n.fieldCategories.filter,function(e,t){if(t.hidden)return;let o=n._createCell(n.data_params,t);n._filtersBlock.find('td[data-field="'+t.name+'"]').replaceWith(o),Object.equals(n.data_params[t.name].v,n.filterData[t.name].v)||i.push(o),"select"!==t.type||!n.data_params[t.name].v||"*NONE*"!==n.data_params[t.name].v&&"*NONE*"!==n.data_params[t.name].v[0]||a.push(o)}),i.length>0?(i.forEach(function(e){e.addClass("warning-backg")}),n._filtersBlock.removeClass("with_danger").addClass("with_changed")):a.length>0?(a.forEach(function(e){e.addClass("danger-backg")}),n._filtersBlock.removeClass("with_changed").addClass("with_danger")):(n._filtersBlock.removeClass("with_danger, with_changed"),n._filtersBlock.find(".danger-backg, .warning-backg").removeClass("danger-backg, warning-backg")),this._filtersBlock},_createParamsBlock:function(){let e=t("<div>"),n=this;if(n.fieldCategories.param){let i,a,o;e.addClass("pcTable-paramsTables");let l,s=0,r=this._container.width()-100;t.each(n.fieldCategories.param,function(c,d){d.showMeWidth&&((0===s||r<s+d.showMeWidth||d.tableBreakBefore)&&(i&&i.width(s),i=t("<table class='pcTable-paramsTable'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>"),e.append(i),s=0,a=i.find("thead tr"),o=i.find("tbody tr")),void 0!==d.panelColor&&(l=d.panelColor),a.append(n._createHeadCell(c,d,l)),o.append('<td data-field="'+d.name+'">'),s+=d.showMeWidth)}),i&&i.width(s)}return e},_refreshParamsBlock:function(e,n){var a=this;return a.fieldCategories.param&&t.each(a.fieldCategories.param,function(t,o){if(!o.showMeWidth||e&&!0!==e[o.name])return!0;let l=a._createCell(a.data_params,o);a._paramsBlock.find('td[data-field="'+o.name+'"]').replaceWith(l),n&&a._colorizeElement(l,i)}),this._paramsBlock},_createFootersBlock:function(){let e,n,i=this;if(i.fieldCategories.footer){e=t("<tbody class='pcTable-footers'></tbody>"),n=t("<div>"),i.columnsFooters={};var a=0;t.each(i.fieldCategories.footer,function(e,t){t.showMeWidth&&(t.column||(t.column=""),i.columnsFooters[t.column]||(i.columnsFooters[t.column]=[]),i.columnsFooters[t.column].push(t),t.column&&a<i.columnsFooters[t.column].length&&(a=i.columnsFooters[t.column].length))});for(var o=t(),l=0,s=0;l<a;){var r=t('<tr><td class="id"></td></tr>'),c=t('<tr><td class="id"></td></tr>').data("pctableitemid","footers").data("pctablettemtndex","footers"+s++);t.each(i.fieldCategories.column,function(e,n){if(n.showMeWidth){let a=t("<td>");if(!i.columnsFooters[n.name]||!i.columnsFooters[n.name][l])return a.attr("rowspan",2),r.append(a),void a.addClass("footer-empty");if(a=i._createHeadCell(e,i.columnsFooters[n.name][l],i.columnsFooters[n.name][l].panelColor).addClass("footer-name"),r.append(a),i.columnsFooters[n.name]&&i.columnsFooters[n.name][l]){let e=i.columnsFooters[n.name][l],t=i._createCell(i.data_params,e);t.attr("data-field",e.name),c.append(t)}}}),o=(o=o.add(r)).add(c),l++}e.html(o);let d,f,u,p,h=0,m=this._container.width()-100;t.each(i.columnsFooters[""],function(e,a){a.showMeWidth&&((0===h||m<h+a.showMeWidth||a.tableBreakBefore)&&(d&&d.width(h),d=t("<table class='pcTable-footers-table'><thead><tr></tr></thead><tbody><tr></tr></tbody></table>\""),n.append(d),h=0,f=d.find("thead tr"),u=d.find("tbody tr")),void 0!==a.panelColor&&(p=a.panelColor),f.append(i._createHeadCell(e,a,p)),u.append('<td data-field="'+a.name+'">'),h+=a.showMeWidth)}),d&&d.width(h)}return[e,n]},_refreshFootersBlock:function(e,n){let a=this,o=a._footersBlock.add(a._footersSubTable);return a.fieldCategories.footer&&t.each(a.fieldCategories.footer,function(t,l){if(!l.showMeWidth||e&&!0!==e[l.name])return!0;let s=a._createCell(a.data_params,l);s.attr("data-field",l.name),o.find('td[data-field="'+l.name+'"]').replaceWith(s),n&&a._colorizeElement(s,i)}),this._paramsBlock},_createHead:function(){return this._header=t("<thead>").append(this._createHeadRow()),this._header},_refreshHead:function(){return this._header.empty().append(this._createHeadRow()),this._header},_createFirstBody:function(){return this._beforebody=t("<tbody class='beforeRows'>").append('<tr class="extra-clasters">'),this.extraClastersTop=this._beforebody.find(".extra-clasters"),this._beforebody},_createAfterBody:function(){return this._afterbody=t("<tbody class='afterRows'>").append('<tr class="extra-clasters">'),this.extraClastersBottom=this._afterbody.find(".extra-clasters"),this._afterbody},_createBody:function(){return this._content=t("<tbody class='dataRows'>"),this._content},_createHeadRow:function(){let e,n=this,i=t("<tr>"),a=60;return n._createHeadCellId().appendTo(i),t.each(this.fieldCategories.visibleColumns,function(t,o){let l;void 0!==o.panelColor&&(e=o.panelColor),(l="n"===o.name?n._createHeadCellNo():n._createHeadCell(t,o,e)).appendTo(i),a+=parseInt(o.showMeWidth)}),this.tableWidth=a,this._table.width(this.tableWidth),i},_createHeadCellId:function(){let e=this,n=t('<th class="id"><span>id</span></th>');if(null===e.tableRow.order_field||"id"===e.tableRow.order_field){let t=n.find("span").css("font-weight","bold");e.isCreatorView&&(!0===e.tableRow.order_desc?t.append(' <i class="fa fa-sort-amount-desc roles"></i>'):t.append(' <i class="fa fa-sort-amount-asc roles"></i>'))}let i=t('<div class="pcTable-filters"></div>'),a=t('<button class="btn btn-default btn-xxs"><i class="fa fa-sort"></i></button>').on("click",function(){e.fieldCategories.visibleColumns.some(function(e){return"n"===e.name})?(e.fieldsHiddingHide.call(e,"n"),a.removeClass("btn-warning")):(e.fieldsHiddingHide.call(e,"n",!0),a.addClass("btn-warning"))});e.fieldCategories.visibleColumns.some(function(e){return"n"===e.name})&&a.addClass("btn-warning");let o=this._getIdFilterButton();return i.append(a).append(" ").append(o).append(" ").append(e._idCheckButton),n.append(this._checkStatusBar),n.append(i),e._idCheckButton.off().on("click",function(){if(e._idCheckButton.find("span").is(".fa-check"))e.row_actions_uncheck_all.call(e),e.__checkedRows=[];else{for(let t=0;t<e.dataSortedVisible.length;t++){let n=e.dataSortedVisible[t],i=e._getItemById(n);e.row_actions_check.call(e,i,!0)}e.__checkedRows=e.dataSortedVisible.slice()}e._headCellIdButtonsState()}),i=t('<div class="pcTable-filters for-selected"><button class="btn btn-default btn-xxs"><i class="fa fa-copy"/></button> <button class="btn btn-default btn-xxs" data-names="true"><i class="fa fa-clone"/></button></div>'),n.append(i),this._refreshCheckedStatus(),n},_getIdFilterButton:function(){let e,n=this,i=t("<span>");return e=t('<button class="btn btn-xxs btn-filter" id="checkS"><span class="fa fa-circle-o"></span></button>').on("click",function(){e.is(".btn-warning")?(e.addClass("btn-default").removeClass("btn-warning").find("span").removeClass("fa-circle").addClass("fa-circle-o"),delete n.filters.id,i.find(".btn-filter:not(#checkS)").parent().replaceWith(n.__getFilterButton("id"))):(e.removeClass("btn-default").addClass("btn-warning").find("span").removeClass("fa-circle-o").addClass("fa-circle"),n.filters.id=n.__checkedRows.slice().map(function(e){return e.toString()})),n.__applyFilters(),n._headCellIdButtonsState()}),n.filters.id&&n.filters.id.length?e.addClass("btn-warning").removeClass("btn-default"):e.addClass("btn-default").removeClass("btn-warning"),i.append(e),i.append(n.__getFilterButton("id")),i},_createHeadCellNo:function(){let e=this,n=e.fields.n,i=t('<span class="cell-title">').text(n.title?n.title:n.name).attr("title",n.title),a=t('<button class="btn btn-default btn-xxs" style="width: 45px"><i class="fa fa-save"></i></button>'),o=t('<th class="n">').width(n.userWidth||n.width).append(i);return e.isCreatorView&&("n"===e.tableRow.order_field&&(!0===e.tableRow.order_desc?i.before('<i class="fa fa-sort-amount-desc roles"></i>'):i.before('<i class="fa fa-sort-amount-asc roles"></i>')),i.before("<br/>")),e._orderSaveBtn=a,!e.tableRow.with_order_field||e.f.blockorder||e.tableRow.__blocked?(a.prop("disabled",!0),this._table.addClass("no-correct-n-filtered")):a.on("click",function(){e.reOrderRowsSave.call(e)}),o.append(t('<div class="pcTable-filters">').append(a))},_createHeadCell:function(n,i,a){let o=this,l=i.showMeWidth||i.width||100,s=t("<th>").data("field",i.name).width(l);o.fields[i.name]&&(o.fields[i.name].$th=s),void 0!==a&&""!==a&&s.css("background-color",a),i.webRoles&&1===i.webRoles.length&&"1"===i.webRoles[0]&&s.addClass("admin-see"),"footer"===i.type&&i.column&&(s=t("<td>"));let r=t('<span class="cell-title">').text(i.title?i.title:i.name).attr("title",i.title?i.title:i.name).appendTo(s);if(o.isCreatorView){if(i.isHiddenField||!i.showMeWidth){let e="";switch(i.category){case"param":e="fa-hand-o-up";break;case"column":e="fa-hand-o-right";break;case"filter":e="fa-hand-o-left";break;case"footer":e="fa-hand-o-down"}r.before('<i class="fa '+e+' roles"></i>')}!i.showInWeb||i.isHiddenField||i.showMeWidth||s.addClass("eye-hidden"),i.linkTableName&&r.before('<i class="fa fa-chain roles"></i>'),r.before('<i class="fa '+i.icon+' roles"></i>');let e=t('<i class="roles">'+i.ord+"</i>");if(r.before(e),"column"===i.category&&o.tableRow.order_field===i.name&&(e.css("font-weight","bold"),!0===o.tableRow.order_desc?r.before('<i class="fa fa-sort-amount-desc roles"></i>'):r.before('<i class="fa fa-sort-amount-asc roles"></i>')),i.codeAction){let e=t('<i class="fa fa-star roles"></i>');r.before(e);let n="";i.CodeActionOnAdd&&(""!==n&&(n+="\n"),n+="При добавлении"),i.CodeActionOnChange&&(""!==n&&(n+="\n"),n+="При изменении"),i.CodeActionOnDelete&&(""!==n&&(n+="\n"),n+="При удалении"),"button"===i.type&&(""!==n&&(n+="\n"),n+="При клике"),""===n&&e.removeClass("fa-star").addClass("fa-star-o"),e.attr("title",n)}i.code&&(i.codeOnlyInAdd?r.before('<i class="fa fa-cog-o roles"></i>'):r.before('<i class="fa fa-cogs roles"></i>'));const n=function(e){let t="";return e.forEach(function(e){""!==t&&(t+="\n"),t+=o.ROLESLIST[e.toString()]}),t};if(i.webRoles&&r.before(t('<i class="fa fa-eye roles"></i>').attr("title",n(i.webRoles))),"button"!==i.type){let e=!1;i.addRoles?r.before(t('<i class="fa fa-plus roles"></i>').attr("title",n(i.addRoles))):i.insertable||("column"===i.category?i.editable?r.before(t('<i class="fa fa-plus roles"></i>').attr("title","Добавление запрещено")):(r.before(t('<i class="fa fa-lock roles"></i>').attr("title","Добавление и редактирование запрещено")),e=!0):i.editable||(r.before(t('<i class="fa fa-lock roles"></i>').attr("title","Редактирование запрещено")),e=!0)),i.editRoles?r.before(t('<i class="fa fa-pencil roles"></i>').attr("title",n(i.editRoles))):i.editable||e||r.before(t('<i class="fa fa-pencil roles"></i>').attr("title","Редактирование запрещено")),i.logRoles&&r.before(t('<i class="fa fa-archive roles"></i>').attr("title",n(i.logRoles)))}if(i.showInXml){let e="";i.xmlRoles&&(e=n(i.xmlRoles)),r.before(t('<i class="fa fa-exchange roles"></i>').attr("title",e))}r.before("<br/>")}i.unitType&&r.append(", "+i.unitType);let c,d=t('<div class="pcTable-filters">');if(i.help&&i.help.length&&o.isCreatorView){(c=t('<span class="btn btn-default field_name btn-xxs" tabindex="-1"><i class="fa fa-info"/></span>')).appendTo(d);let e=t('<div class="i-inner-div">').html(i.help).width(230);c.on("click",function(){let n=t(this);if(!n.data("bs.popover")){let t="bottom",a=300,l=o._container,s=n.offset().top-l.offset().top;s>l.height()/2?(t="top",a=s-40):a=l.height()-s-70,e.css("max-height",a),c.popover({trigger:"manual",content:e,html:!0,placement:t,container:o.scrollWrapper}),n.popover("show"),setTimeout(function(){let e="."+i.name+"-i";o._container.on("click"+e+" escPressed"+e,function(){n.data("bs.popover")&&n.popover("destroy"),o._container.off(e)})},20)}})}if("column"===i.category&&i.filterable&&i.showMeWidth>0&&this.__getFilterButton(i.name).appendTo(d),(o.isCreatorView||!1!==i.dropdownView&&(i.linkToSelectTable||"filter"!==i.category))&&(s.addClass("with-filter"),function(){let n=t("<div>"),a=t('<button class="btn btn-default btn-xxs"  tabindex="-1"><i class="fa fa-caret-down"/></button>');i.pcTable?!1===i.dropdownView&&a.addClass("field_name"):a.addClass("field_name");const l=function(t){t&&e.location.reload()};if(o.isCreatorView){let s=t('<div class="menu-item color-danger">');s.append('<i class="fa fa-pencil-square-o"/> Изменить'),n.append(s);const r=function(){return new EditPanel(2,BootstrapDialog.TYPE_DANGER,{id:i.id}).then(l),!1};s.on("click",r),a.on("contextmenu",r),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-clone"/> Дублировать'),n.append(s),s.on("click",function(){App.getPcTableById(2).then(function(e){e.model.checkEditRow({id:i.id}).then(function(e){let n={};t.each(e.row,function(e,t){"object"==typeof t&&(n[e]=t)}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,n).then(l)})})}),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-plus"/> Вставить после'),n.append(s),s.on("click",function(){App.getPcTableById(2,{afterField:i.ord}).then(function(e){let t={};t.ord={v:i.ord+10},t.category={v:i.category},t.table_id={v:o.tableRow.id},o.tableRow.__version&&(t.version={v:o.tableRow.__version}),new EditPanel(2,BootstrapDialog.TYPE_DANGER,t).then(l)})}),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-refresh"/> Изменить NAME'),n.append(s),s.on("click",function(){o.model.renameField(i.name)}),(s=t('<div class="menu-item color-danger">')).append('<i class="fa fa-times"/> Удалить'),n.append(s),s.on("click",function(){let t=i.title;BootstrapDialog.show({type:BootstrapDialog.TYPE_DANGER,title:"Удалить поле "+t+" из таблицы "+o.tableRow.title+"?",buttons:[{action:function(n,a){"use strict";n.close(),App.getPcTableById(2).then(function(n){App.panelTimer("Удаление поля "+t+" из таблицы "+o.tableRow.title,n.tableRow.delete_timer,function(){n.model.delete(i.id).then(function(){e.location.reload(!0)})})})},cssClass:"btn-warning",label:"Удалить"},{action:function(e){e.close()},label:"Отмена"}],draggable:!0})})}if("filter"!==i.category&&i.pcTable){let e=t('<div class="menu-item">');e.append('<i class="fa fa-eye-slash"/> Скрыть'),e.on("click",function(){a.popover("hide"),o.fieldsHiddingHide.call(o,i.name)}),e.appendTo(n),(e=t('<div class="menu-item">')).append('<i class="fa fa-arrows-h"/> Ширина поля'),e.on("click",function(){a.popover("hide");let e=t('<div><input type="number" class="form-control" value="'+i.showMeWidth+'" style="padding-left: 2px;"/></div>');BootstrapDialog.show({message:e,title:"Ширина поля "+i.title,onshown:function(t){let n=e.find("input");n.focus(),n.on("keydown",function(n){13===n.keyCode&&(i.pcTable.setColumnWidth.call(i.pcTable,i.name,parseInt(e.find("input").val())),t.close())}),t.$modalDialog.width(500)},buttons:[{label:"Применить",action:function(t){let n=parseInt(e.find("input").val());t.close(),i.pcTable.setColumnWidth.call(i.pcTable,i.name,n)}},{label:"Отмена",action:function(e){e.close()}}],draggable:!0})}),e.appendTo(n)}if(i.showMeWidth>0&&"column"===i.category){{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-asc"/> Сортировать А-Я'),n.append(e),e.on("click",function(){o.sort(i,1)})}{let e=t('<div class="menu-item">');e.append('<i class="fa fa-sort-alpha-desc"/> Сортировать Я-А'),n.append(e),e.on("click",function(){o.sort(i,-1)})}if("column"===i.category&&"number"===i.type){let e=t('<div class="menu-item">');e.append('<i class="fa fa-diamond"/> Математические операции'),n.append(e),e.on("click",function(){let e=t("<div>"),n=0,a=0,l=null,s=null,r=0;o.dataSortedVisible.some(function(e){try{let t=Big(o.data[e][i.name].v);n=Big(n).plus(t),++a,null===l?l=t:t.gt(l)&&(l=t),null===s?s=t:t.lt(s)&&(s=t)}catch(e){++r}});let c=t('<table><thead><tr><th style="width: 180px;height: 32px;">Операция</th><th style="width: 200px;">Значение</th></tr></thead>').appendTo(e),d=t("<tbody>").appendTo(c),f=function(e,t){let n="";if(t=t||!1,i.unitType&&!t&&(n=" "+i.unitType),i.currency){let t={};return i.dectimalPlaces&&(t.minimumFractionDigits=i.dectimalPlaces),parseFloat(e).toLocaleString("ru-RU",t)+n}return e+n};t("<tr><td>Сумма</td><td>"+f(n)+"</td></tr>").appendTo(d),t("<tr><td>Кол-во чисел</td><td>"+f(a,!0)+"</td></tr>").appendTo(d),t("<tr><td>Среднее</td><td>"+f(Big(n).div(a).round(i.dectimalPlaces||0))+"</td></tr>").appendTo(d),t("<tr><td>Максимальное</td><td>"+f(l)+"</td></tr>").appendTo(d),t("<tr><td>Минимальное</td><td>"+f(s)+"</td></tr>").appendTo(d),t("<tr><td>Нечисл. элементов</td><td>"+f(r,!0)+"</td></tr>").appendTo(d),BootstrapDialog.show({title:i.title+(i.unitType?", "+i.unitType:""),type:"edit",message:e,draggable:!0,onshown:function(e){e.$modalDialog.width(400)},buttons:[{action:function(e){e.close()},label:"Закрыть"}]})})}}if(i.linkToSelectTable){let a=i.linkToSelectTable,o=t('<div class="menu-item color-primary">');o.append('<i class="fa fa-external-link"/> '+a.title),n.append(o),o.on("click",function(){return e.open(a.link,"_blank").focus(),!1})}return a.popover({html:!0,content:n,trigger:"manual",container:o._container,placement:"auto bottom"}),a.on("click",function(){let e=t(this);e.data("bs.popover").tip().hasClass("in")||(e.popover("show"),setTimeout(function(){o._container.one("click",function(){e.popover("hide")})},20))}),a}().appendTo(d)),d.appendTo(s),this.isCreatorView){let e=t('<div class="th-left-bottom-buttons">').appendTo(s),n=t('<div class="btn  btn-xxs field_name copy_me"  tabindex="-1" data-copied-text="Скопировано">').text(i.name).appendTo(e),a=34;i.filterable&&(a+=15),c&&(a+=14),(i.filterable||c)&&(a+=5,i.filterable&&c&&(c.css("margin-right",-3),a+=2)),"footer"===i.category&&i.column&&this.fields[i.column]&&!o.hidden_fields[i.name]&&(l=this.fields[i.column].width);let r=l-a,d=function(){let e=n.width();if(0==e)return setTimeout(d,30),!1;(e+=10)>r&&n.width(r)};d()}return s},_createNoDataRow:function(e){var n=0;t.each(this.fields,function(e,t){n++});let i=this,a=t();return this.control.adding&&!this.f.blockadd&&(a=t('<button class="btn btn-warning btn-xxs">Добавить строку</button>').width(120).on("click",function(){i._addInsert.call(i)})),e=e||"Таблица пуста ",t("<tr>").addClass(this.noDataRowClass).append('<td class="id">').append(t("<td>").attr("colspan",n).append(e).append(a))},_createRow:function(e,n){n=n||[];let a=this;e.$tr||(e.$tr=t("<tr>"),e.$tr.height(35),e.$tr.data("item",e));let o=e.$tr.empty();o.attr("class","DataRow"),o.attr("data-pctableitemid",e.id),e.e_data&&1==e.e_data.b&&o.addClass("BlockedRow"),e.InsDel&&o.addClass("insDeleted"),this._addCellId(e,o);let l=0,s=this.fieldCategories.visibleColumns.length;if(this.fieldCategories.visibleColumns[l]&&"n"===this.fieldCategories.visibleColumns[l].name){let n=this.fieldCategories.visibleColumns[l],i=t("<td>");o.append(i.append('<span class="cell-value">').append(n.getCellText(null,i,e))),++l}for(;l<s;++l){let t,s=this.fieldCategories.visibleColumns[l];o.append(t=a._createCell(e,s)),n.indexOf(s.name)>-1&&a._colorizeElement(t,i)}},refreshRow:function(e,n,i){if(e&&e.is(".DataRow")||n){n||(n=this._getItemByTr(e));let o=[];if(i){for(var a in i)null!==i[a]&&"object"==typeof i[a]?i[a].changed?(o.push(a),delete i[a].changed):Object.equals(i[a],n[a])||o.push(a):i[a]!=n[a]&&o.push(a),n[a]=i[a];t.extend(n,i)}e&&this._createRow(n,o)}else this._isParamsArea(e)?this._refreshParamsBlock():this._isFootersArea(e)&&this._refreshFootersBlock()},_createCell:function(e,n){let i=this;var a=t("<td>");let o;e[n.name]||(console.log("Не найдено поле "+n.name),console.log(e));try{o=t.extend({},i.f||{},e.f||{},e[n.name].f||{})}catch(t){console.log("test"),console.log(t,e,n.name),o={}}!n.editable||!this.control.editing&&"filter"!==n.category||o.block||(a.addClass("edt"),n.editGroup&&(n.editGroupMultiColumns?a.addClass("e-gm").addClass("e-g"):a.addClass("e-g"))),o.block&&a.addClass("blocked"),"column"!==n.category&&a.attr("data-field",n.name);var l=t('<span class="cell-value">'),s=e[n.name];let r;if(n.code&&!n.codeOnlyInAdd&&a.addClass("with-code"),"column"!==n.category&&a.data("field",n.name).addClass("val"),s){if(r=s.e,s.h){let e;e=void 0!==s.c&&s.v!=s.c?t('<i class="fa fa-hand-paper-o pull-right" aria-hidden="true"></i>'):t('<i class="fa fa-hand-rock-o pull-right" aria-hidden="true"></i>'),a.append(e)}if(s.d&&a.addClass("deleted_value"),s.e)if(n.errorText)l.text(n.errorText);else{let e=t('<i class="fa fa-exclamation-triangle pull-right" aria-hidden="true"></i>').attr("title",s.e);a.append(e)}if(o.text&&"button"!=n.type)l.text(o.text);else if(!s.e||!n.errorText){var c=n.getCellText.call(n,s.v,a,e,i);"object"==typeof c?l.html(c):l.text(c)}}if(l.appendTo(a),o.text||!n.unitType||r||null===s.v||l.attr("data-unit-type"," "+n.unitType),n.css&&a.addClass(n.css),this.isSelected(n.name,e.id)&&a.addClass("selected"),o.background&&a.css("background-color",o.background),o.color&&a.css("color",o.color),o.bold&&a.css("font-weight","bold"),o.align?a.css("text-align",o.align):o.tab&&a.css("padding-left",o.tab+"px"),o.decoration&&a.css("text-decoration",o.decoration),o.italic&&a.css("font-style","italic"),"button"!==n.type)if(o.comment){let e;e=t('<i class="cell-icon fa fa-info"></i>'),a.prepend(e),e.attr("title",o.comment)}else o.icon&&a.prepend('<i class="cell-icon fa fa-'+o.icon+'"></i>');if(o.progress&&o.progresscolor){let e=function(){if(l.isAttached()){let e=Math.round(l.width()*parseInt(o.progress)/100);l.css("box-shadow","inset "+e.toString()+"px 0px 0 0 "+o.progresscolor)}else setTimeout(e,50)};e()}return a},_getLoadingSpinner:function(){return t('<div class="text-center"><i class="fa fa-spinner"/></div>')},_colorizeElement:function(e,t,n){let i=10,a=function(){0===i?e.css("box-shadow",""):(e.css("box-shadow","inset 0 0 100px 100px "+App.hexToRGB(t,i/10)),i--,setTimeout(a,50))};a()},_TmpColorize:function(e,t,n){var i,a=this,o=0;t=t||"#ff0000";"#"!=(n=n||"#ffffff").substr(0,1)&&(n=App.rgb2hex(n));10==++o?i=n:(i=function(e,t,n){var i=parseInt(e.slice(1),16),a=(n=parseInt(n.slice(1),16),t<0?0:n>>16),o=t<0?0:n>>8&255,l=t<0?0:255&n,s=t<0?-1*t:t,r=i>>16,c=i>>8&255,d=255&i;return"#"+(16777216+65536*(Math.round((a-r)*s)+r)+256*(Math.round((o-c)*s)+c)+(Math.round((l-d)*s)+d)).toString(16).slice(1)}(t,.1,n))==t&&(i=n),e.css("background-color",i),i!=n?setTimeout(function(){a._TmpColorize(e,i,n)},50):e.data("backgroundcolor")||e.attr("style",e.attr("style").replace(/(background\-color:[^;"]+;?)/,""))}}),t.extend(App.pcTableMain.prototype,{_addHorizontalDraggable:function(){this._innerContainer.off("mousedown.HorizontalDraggable mouseout").on("mousedown.HorizontalDraggable",function(e){for(var n=e;n;){if(t(e.target).is("input"))return!0;if(n==e.originalEvent)break;n=e.originalEvent}return t(this).data("x",e.clientX).data("scrollLeft",this.scrollLeft),!1}).on("mousemove",function(e){if(1===e.buttons&&0===e.button&&Math.abs(t(this).data("x")-e.clientX)>20){let n;t(this).data("moved",!0),n&&clearTimeout(n),n=setTimeout(function(){t(this).data("moved",!1)},200),this.scrollLeft=t(this).data("scrollLeft")+t(this).data("x")-e.clientX}})}}),App.pcTableMain.prototype._addRowPanel=function(e,n,i){var a=t('<div style="width: 165px;"><div class="buttons"></div></div>');if(void 0!==i){var o=a.find(".buttons").empty();t.each(i,function(e,n){if("function"==typeof n)var i=t('<button class="btn btn-sm btn-default">').html(e).on("click",n);else"object"==typeof n&&"checkbox"==n.type&&(i=t('<input type="checkbox">'),n.id&&i.attr("id",n.id),n.func&&i.on("change",n.func),i=i.wrap('<span style="font-size: 10px; padding-left: 8px;" >').parent().append(' <span style="padding-top: 2px;">'+e+"</span>"));o.append(" "),o.append(i)})}n.on("remove",function(){a.remove()});let l=this;return setTimeout(function(){let e={isParams:!0,$text:a,element:n,container:l._container,placement:"bottom",trigger:"manual"};App.popNotify(e);let i=n.attr("aria-describedby"),o=t("#"+i).addClass("warning-bg");o.find(".arrow").css("left","80%"),l._positionPanel.call(l,o,n),a.show()},50),a},App.pcTableMain.prototype._positionPanel=function(e,t){var n=t.position();this.tableWidth;return this._innerContainer.width()>this.tableWidth?e.position({my:"right top",at:"right+2px bottom+12px",of:t}):e.position({my:"right top",at:"right+2px top+"+(n.top+47)+"px ",of:this._innerContainer})},t.extend(App.pcTableMain.prototype,{_csvExport:function(){"use strict";let e=this;this.model.csvExport(e.dataSortedVisible,Object.keys(App.filter(e.fields,(e,t)=>!!t.showMeWidth))).then(function(t){if(t.csv){let n=new Blob([t.csv],{type:"text/csv;charset=utf-8"});saveAs(n,e.tableRow.title+"."+e.model.tableData.updated.dt+".csv")}})},_csvImportClick:function(){let e=this;t('<input type="file" accept="text/csv">').on("change",function(){if(this.files&&this.files[0]){let t=new FileReader;t.onload=function(t){let n=t.target.result;e._csvImportUpload.call(e,n)},t.onerror=function(e){console.log(e.target.error)},t.readAsDataURL(this.files[0])}}).click()},_csvImportUpload:function(e){let t=this,n={},i=function(){t.model.csvImport(e,n).then(function(e){e.question?App.modal(e.question[1],"Вопрос про csv-загрузку",{"Отменить":"close","Загружаем":function(t){"use strict";t.modal("hide"),n[e.question[0]]=1,i()}}):e.ok&&t.table_modify.call(t,e)})};i()}}),function(){t.extend(App.pcTableMain.prototype,{___fieldsHiddingShowAllButton:null,_hideHell_storage:{isset_fields:!1,opened:null,blinkIt:!1,getOpened:function(){return null===this._hideHell_storage.opened&&(this._hideHell_storage.opened=i.getSavedOpenedVal(this.tableRow),!1===this._hideHell_storage.opened&&(this._hideHell_storage.blinkIt=!0)),this._hideHell_storage.opened},checkIssetFields:function(e){if(this.isCreatorView&&this._beforeSpace){let t=this._hideHell_storage.isset_fields;if(this._hideHell_storage.isset_fields=Object.keys(this.hidden_fields).length||Object.keys(this.fields).some(e=>"n"!==e&&(!this.fields[e].showMeWidth||this.fields[e].showMeWidth<1)),e||t!==this._hideHell_storage.isset_fields){let e=this._beforeSpace.find("#hide-hell").removeClass("btn-contour");this._hideHell_storage.isset_fields?(e.removeAttr("disabled"),this._hideHell_storage.opened?(e.find("i").addClass("fa-arrow-up").removeClass("fa-arrow-down").removeClass("fa-times"),e.addClass("btn-contour")):(e.find("i").removeClass("fa-arrow-up").addClass("fa-arrow-down").removeClass("fa-times"),this._hideHell_storage.blinkIt&&(App.blink(e,8,"#fff"),this._hideHell_storage.blinkIt=!1))):(e.attr("disabled","disabled"),e.find("i").addClass("fa-times").removeClass("fa-arrow-up").removeClass("fa-arrow-down"))}}},switchOpened:function(){this._hideHell_storage.opened=!this._hideHell_storage.opened,this._hideHell_storage.checkIssetFields.call(this,!0),i.saveOpenedVal(this.tableRow,this._hideHell_storage.opened),this._refreshHiddenFieldsBlock()}},fieldsHiddingHide:function(e,t){let n=a.get(this.tableRow)||{};t?n[e]=this.fields[e].width:delete n[e],this.setVisibleFields(n)},setVisibleColumns:function(){let e=this;this.fieldCategories.visibleColumns=[],this.fieldCategories.column.forEach(function(t){t.showMeWidth&&e.fieldCategories.visibleColumns.push(t)})},setColumnWidth:function(e,t){let n=a.get(this.tableRow)||{};n[e]=t,this.setVisibleFields(n)},loadVisibleFields:function(){let e={},t=a.getDate(this.tableRow);!t||""!=this.tableRow.fields_actuality&&this.tableRow.fields_actuality>t?(console.log("visibleFields updated"),this.setVisibleFields(e,!0,moment().format(App.dateTimeFormats.db))):(e=a.get(this.tableRow)||{},this.setVisibleFields(e,!0))},setVisibleFields:function(e,n,i){let o=this;e&&0===Object.keys(e).length?(e={},Object.values(o.fields).forEach(function(t){o.fields[t.name].showMeWidth=t.hidden?0:t.width,e[t.name]=o.fields[t.name].showMeWidth})):Object.values(o.fields).forEach(function(t){"filter"===t.category?o.fields[t.name].showMeWidth=t.width:void 0!==e[t.name]?o.fields[t.name].showMeWidth=parseInt(e[t.name]):o.fields[t.name].showMeWidth=n&&!t.hidden?t.width:0,e[t.name]=o.fields[t.name].showMeWidth}),a.set(e,this.tableRow,i),this.setVisibleColumns(),t.each(this.data,function(e,t){delete o.data[e].$tr}),this._header&&(this._refreshHead(),this._refreshContentTable(!0),this._rerenderColumnsFooter(),this.fieldsHiddingGetButton(),this.isCreatorView&&(this._hideHell_storage.checkIssetFields.call(o),this._refreshHiddenFieldsBlock()),this.setWidthes(),this.ScrollClasterized.insertToDOM(null,!0)),this._insertRow&&this._closeInsertRow()},hideAdminViewFields:function(){let e=this,t=a.get(this.tableRow)||{};Object.keys(t).forEach(function(n){if(t[n]>0){let i=e.fields[n];(!i||i.webRoles&&1===i.webRoles.length&&"1"==i.webRoles[0])&&delete t[n]}}),this.setVisibleFields(t)},setDefaultVisibleFields:function(){let e={};Object.values(this.fields).forEach(function(t){t.hidden?e[t.name]=0:e[t.name]=t.width}),this.setVisibleFields.call(this,e)},fieldsHiddingShowPanel:function(){let e,n,i=this,a=t('<div class="hidding-form">');const l=function(e){e=e||t("#defaultEyeGroups"),s=i.tableRow.fields_sets||[],e.empty().append("<b>Наборы по умолчанию:</b> "),s.forEach(function(n,a){let o=t('<a href="#">').text(n.name).data("index",a);e.append(o.wrap("<span>").parent()),i.isCreatorView&&(a>0&&o.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-arrow-left"></i></button>').data("index",a)),o.parent().append(t('<button class="btn btn-xxs field_name"><i class="fa fa-remove"></i></button>').data("index",a)))}),e.off(),i.isCreatorView&&e.on("click",".btn",function(){if(t(this).find("i").is(".fa-remove")){let e=t(this);i.model.removeEyeGroupSet(e.data("index")).then(function(e){i.tableRow.fields_sets=e.sets,l()})}else{let e=t(this);i.model.leftEyeGroupSet(e.data("index")).then(function(e){i.tableRow.fields_sets=e.sets,l()})}}),e.on("click","a",function(){let e=t(this).data("index"),a=s[e].fields;if(Array.isArray(a)){let e={};a.forEach(function(t){i.fields[t]&&(e[t]=i.fields[t].width)}),a=e}i.setVisibleFields.call(i,a),n.close()})};let s=o.getNames(i.tableRow);if(s&&s.length){let e=t('<div class="fieldsHiddenSets">').appendTo(a);e.append("<b>Наборы:</b> "),s.forEach(function(n){let a=t('<a href="#">').text(n).data("name",n);e.append(a.wrap("<span>").parent());let o=a.parent();o.append(t('<button class="btn btn-xxs" data-action="remove"><i class="fa fa-remove"></i></button>').data("name",n)),i.isCreatorView&&o.append(t('<button class="btn btn-xxs field_name" data-action="addDefaultSet" title="Сохранить как набор по умолчанию"><i class="fa fa-save"></i></button>').data("name",n))}),e.on("click",".btn",function(){let e=t(this),n=e.data("name");if(i.isCreatorView&&"addDefaultSet"===t(this).data("action")){let t=o.get(i.tableRow,n)||[];i.model.AddEyeGroupSet(n,t).then(function(t){i.tableRow.fields_sets=t.sets,l(),o.remove(i.tableRow,n),e.parent().remove()})}else o.remove(i.tableRow,n),e.parent().remove()}),e.on("click","a",function(){let e=t(this).data("name"),a=o.get(i.tableRow,e)||[];i.setVisibleFields.call(i,a),n.close()})}s=i.tableRow.fields_sets||[];let r=t('<div class="fieldsHiddenSets" id="defaultEyeGroups">').appendTo(a);s&&s.length&&l(r),a.on("click",'input[type="checkbox"]',function(n){let i=t(this),a=i.closest(".hidding-form");if(n.shiftKey){a.find("input").index(i);let n=a.find("input").index(t(this));a.find("input").each(function(a){(n<=a&&a<e||n>=a&&a>e)&&t(this).prop("checked",!!i.is(":checked")&&"checked").trigger("change")})}else e=a.find("input").index(t(this))});let c=[{label:"Применить",action:function(e){let n={};a.find("input:checked").each(function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null}),i.setVisibleFields.call(i,n),e.close()}},{label:"По умолчанию",action:function(e){e.close(),i.setDefaultVisibleFields.call(i)}},{label:"Показать все",action:function(e){e.close();let t={};Object.values(i.fields).forEach(function(e){t[e.name]=e.width}),i.setVisibleFields.call(i,t)}},{label:"Создать набор",action:function(e){let n={};a.find("input:checked").each(function(){let e=t(this);n[e.attr("name")]=parseInt(e.closest("div").find('input[type="number"]').val())||null}),i.setVisibleFields.call(i,n),e.close();let l=t("<div></div>");l.append('<div style="padding-top: 10px;"><label>Название набора</label><input type="text" id="fieldsSetName" class="form-control"/></div>'),BootstrapDialog.show({message:l,title:"Сохранить набор полей",buttons:[{label:"Сохранить",action:function(e){let t=l.find("#fieldsSetName");""===t.val().trim()?t.addClass("error"):(o.set(i.tableRow,n,t.val().trim()),e.close())}},{label:"Закрыть",action:function(e){e.close()}}],draggable:!0})}},{label:"Отмена",action:function(e){e.close()}}];i.isCreatorView&&(c[1].label="C админ полями",c[1].icon="fa fa-angle-right",c.splice(1,0,{label:"Без админ полей",icon:"fa fa-angle-double-right",action:function(e){e.close(),i.setDefaultVisibleFields.call(i,!0)}}));let d={param:"Хэдер",column:"Колонки",footer:"Футер"};Object.keys(d).forEach(function(e){i.fieldCategories[e]&&i.fieldCategories[e].length&&(a.append('<div class="category-name">'+d[e]+"</div>"),t.each(i.fieldCategories[e],function(e,n){let i="";n.hidden&&(i=" (Скрыто по умолчанию)");let o=t('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="'+n.name+'" class="form-check-input"> '+n.title+i+'</label> <input type="number" placeholder="'+n.width+'" value="'+(n.showMeWidth&&n.showMeWidth!==n.width?n.showMeWidth:n.width)+'"/></div>');n.showMeWidth&&(o.find("input").prop("checked",!0),o.attr("data-checked",!0)),o.appendTo(a)}))}),a.on("change",'input[type="checkbox"]',function(){let e=t(this).closest("div");t(this).is(":checked")?e.attr("data-checked",!0):e.removeAttr("data-checked")}),n=BootstrapDialog.show({message:a,title:"Видимость полей",buttons:c,draggable:!0,onshow:function(e){i.isCreatorView&&e.$modalContent.css({width:"800px"})}})},fieldsHiddingGetButton:function(e){"use strict";let n=this;if(!this.___fieldsHiddingShowAllButton){let e;this.___fieldsHiddingShowAllButton=t('<button class="btn btn-sm"><span class="fa fa-eye-slash"></span></button>').on("click",function(){n.fieldsHiddingShowPanel.call(n)}).on("contextmenu",function(){return n.isCreatorView?e?(clearTimeout(e),e=null,n.hideAdminViewFields.call(n,!0)):e=setTimeout(function(){n.setDefaultVisibleFields.call(n),e=null},500):n.setDefaultVisibleFields.call(n),!1})}return Object.values(n.fields).some(function(e){if(e.showInWeb&&!e.hidden&&!e.showMeWidth)return!0})?(this.___fieldsHiddingShowAllButton.addClass("btn-warning"),this.___fieldsHiddingShowAllButton.removeClass("btn-default"),e&&App.blink(this.___fieldsHiddingShowAllButton,8,"#fff")):(this.___fieldsHiddingShowAllButton.addClass("btn-default"),this.___fieldsHiddingShowAllButton.removeClass("btn-warning")),this.___fieldsHiddingShowAllButton}});let e="pcTableShowFieldsWithDates",n=function(e){let t=e.id;return"calcs"===e.type&&(t+="$"+e.__version),t},i={saveOpenedVal:function(e,t){localStorage.setItem(this.getKeyString(e),t.toString())},getKeyString:function(e){return e.id+"/"+e.__version},getSavedOpenedVal:function(e){let t=localStorage.getItem(this.getKeyString(e));return!t||JSON.parse(t)}},a={set:function(t,i,a){let o=n(i),l={},s=t||{};try{l=JSON.parse(localStorage.getItem(e))||{}}catch(e){}a||!l[o]?l[o]=[s,a]:l[o][0]=s,localStorage.setItem(e,JSON.stringify(l))},get:function(e){let t=n(e);return a.getInner(t)[0]},getDate:function(e){let t=n(e);return a.getInner(t)[1]},getInner:function(t){let n;try{n=JSON.parse(localStorage.getItem(e))||{}}catch(e){n={}}return n[t]||[]}},o={set:function(e,t,i){let a=[],o="pcTableShowFieldsSets"+n(e),l=t||[];try{a=JSON.parse(localStorage.getItem(o))||{}}catch(e){}a[i]=l,localStorage.setItem(o,JSON.stringify(a))},get:function(e,t){let i,a="pcTableShowFieldsSets"+n(e);try{i=(i=JSON.parse(localStorage.getItem(a)))[t]}catch(e){}return null!==i&&void 0!==i||(i=void 0),i},getNames:function(e){let t,i="pcTableShowFieldsSets"+n(e);try{return t=JSON.parse(localStorage.getItem(i)),Object.keys(t)}catch(e){}return null!==t&&void 0!==t||(t=void 0),t},remove:function(e,t){let i,a="pcTableShowFieldsSets"+n(e);try{delete(i=JSON.parse(localStorage.getItem(a)))[t],localStorage.setItem(a,JSON.stringify(i))}catch(e){}}}}(),App.pcTableMain.prototype._print=function(){"use strict";let e=t('<div class="hidding-form">');const n=function(e){if(e.showMeWidth)return!0};this.fieldCategories.param.length&&this.fieldCategories.param.some(n)&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="params" class="form-check-input" checked="checked"> Параметры</label></div>'),this.fieldCategories.filter.length&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="filters" class="form-check-input" checked="checked"> Фильтры</label></div>'),this.fieldCategories.column.length&&this.fieldCategories.column.some(n)&&this.dataSortedVisible.length&&(e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="rows" class="form-check-input" checked="checked"> Строчную часть</label></div>'),e.append('<div class="form-check no-bold" style="padding-left: 20px;"><label class="form-check-label"><input type="checkbox" name="with-id" class="form-check-input"> с id</label></div>')),this._footersBlock.find(".val").length&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="column-footers" class="form-check-input" checked="checked"> Футеры колонок</label></div>'),this._footersSubTable.find(".val").length&&e.append('<div class="form-check no-bold"><label class="form-check-label"><input type="checkbox" name="other-footers" class="form-check-input" checked="checked"> Футеры вне колонок</label></div>');let i=this,a=[{label:"Печать",action:function(n){let a=[];e.find("input:checked").each(function(){a.push(t(this).attr("name"))}),n.close(),i._printTable.call(i,a)}},{label:"Отмена",action:function(e){e.close()}}];BootstrapDialog.show({message:e,title:"Печать",buttons:a,draggable:!0})},App.pcTableMain.prototype._printTable=function(e){let t=this,n={fields:{}};-1!==e.indexOf("with-id")&&(n.fields.id=50);let i={params:t.fieldCategories.param,filters:t.fieldCategories.filter,rows:t.fieldCategories.column,"column-footers":t.fieldCategories.footer.filter(function(e){return""!==e.column}),"other-footers":t.fieldCategories.footer.filter(function(e){return""===e.column})};Object.keys(i).forEach(function(t){-1!==e.indexOf(t)&&i[t].forEach(function(e){"button"===e.type||e.showMeWidth<1||!e.showMeWidth||(n.fields[e.name]=e.showMeWidth)})}),-1!==e.indexOf("rows")&&(n.ids=t.dataSortedVisible),n.sosiskaMaxWidth=1100,t.model.printTable(n)},App.pcTableMain.prototype.reOrderRows=function(e,n){let i,a=this;if(a.tableRow.with_order_field&&!a.nSorted)return App.notify("Для работы поля порядок перезагрузите таблицу"),!1;let o,l=[];if(0===this.row_actions_get_checkedIds().length){if(l.push(e),(i=this.dataSorted.indexOf(e)+("after"===n?1:-1))<0)return}else{if(-1!==a.row_actions_get_checkedIds().indexOf(e))return App.notify("В качестве якоря для перемещения нужно выбрать не отмеченную строку"),!1;let t=this.row_actions_get_checkedIds().length;this.dataSorted.some(function(e,n){if(0===t)return!0;a.data[e].$checked&&(l.push(e),--t)})}l.forEach(function(e){a.dataSorted.splice(a.dataSorted.indexOf(e),1)}),o=void 0!==i?i:this.dataSorted.indexOf(e)+("after"===n?1:0),a.dataSorted.splice(o,0,...l),this.dataSortedVisible=[],a.dataSorted.forEach(function(e){a.data[e].$visible&&a.dataSortedVisible.push(e)}),a._refreshContentTable(),a.tableRow.with_order_field&&t("table.pcTable-table").addClass("reordered"),a.row_actions_uncheck_all()},App.pcTableMain.prototype.reOrderRowsSave=function(){let e=this;e._orderSaveBtn.prop("disabled",!0).find("i").attr("class","fa fa-cog"),this.model.saveOrder(this.dataSorted).then(function(n){e.table_modify(n),e._orderSaveBtn.prop("disabled",!1).find("i").attr("class","fa fa-save"),t("table.pcTable-table").removeClass("reordered")})},App.pcTableMain.prototype.addReOrderRowBind=function(){let e=this;e._innerContainer.on("click","td.n button",function(n){let i=t(this);e.tableRow.with_order_field&&!e.__getCheckedRowsIds(void 0,!0,"blockorder")||e.reOrderRows.call(e,e._getItemByTr.call(e,i.closest("tr")).id,1===i.find(".fa-angle-up").length?"before":"after")})},App.pcTableMain.prototype.__formatFunctions={blockadd:function(){this._rowsButtons()},blockorder:function(){this._refreshHead()},block:function(){this._refreshParamsBlock(),this._refreshContentTable(!0),this._refreshFootersBlock()}},t.extend(App.pcTableMain.prototype,{setWidthes:function(){"use strict";let n,i=t("body>.page_content:first").is(".tree-minifyed")?5:300;this.width=t("body").width()-i,this._container.width(this.width),this._innerContainer.width(this.width-80),this._paramsBlock.replaceWith(n=this._createParamsBlock()),this._paramsBlock=n,this._refreshParamsBlock(),this._filtersBlock.replaceWith(n=this._createFiltersBlock()),this._filtersBlock=n,this._refreshFiltersBlock(this.data_params);let a=this._createFootersBlock();this._footersSubTable.replaceWith(a[1]),this._footersSubTable=a[1],this._footersBlock.replaceWith(a[0]),this._footersBlock=a[0],this._refreshFootersBlock(),this.tableWidth<this._innerContainer.width()?this.__$rowsButtons.width(this.tableWidth-59):this.__$rowsButtons.width(this._innerContainer.width()),this._container.width()<this._table.width()&&this._addHorizontalDraggable(),this._container.height(e.innerHeight-this._container.offset().top-20)},initForPanel:function(e){t.extend(!0,this,e),this.refreshArraysFieldCategories(!1);let n={};this.__checkedRows=[],this.data.map(function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),n[e.id]=e,n[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)},this),this.data=n,this.model.setDataRows(this.data)},_init:function(){let n=this;this._container.addClass(this.contanerClass).addClass("pcTable-type-"+this.tableRow.type);let i=t("#nav-top-line");i.addClass("pcTable-type-"+this.tableRow.type),"tmp"===this.tableRow.type&&i.text("Будьте внимательны - это временная таблица"),this._innerContainer=t('<div class="innerContainer">'),t("body").on("keyup",function(e){27===e.which&&n._container.trigger("escPressed")}),this._container.append(this._innerContainer),this.addReOrderRowBind();let a,o={};this.__checkedRows=[],this.data.map(function(e){this.dataSorted.push(e.id),this.dataSortedVisible.push(e.id),o[e.id]=e,o[e.id].$checked=-1!==this.__checkedRows.indexOf(e.id)},this),this.data=o,this.model.setDataRows(this.data),t(e).resize(function(){a&&clearTimeout(a),a=setTimeout(function(){n.setWidthes()},500)})},refreshArraysFieldCategories:function(n){"use strict";n=n||!1;let i=this;i.hidden_fields=i.hidden_fields||{},t.each(i.hidden_fields,function(e,n){i.hidden_fields[e]=t.extend({},n,l[n.type],n),i.hidden_fields[e].isHiddenField=!0}),i.mainFieldName="id",i.fieldCategories={},["param","column","filter","footer"].forEach(function(e){i.fieldCategories[e]=[]});let a=[];try{a=(a=JSON.parse(decodeURIComponent(e.location.hash.substring(1))||"[]"))&&a.wc?a.wc:[]}catch(e){}const o=function(e,n){n.pcTable=i,-1===a.indexOf(n.category)&&(n=l[n.type]?t.extend({},s,l[n.type],n):t.extend({},s,n),i.fields[e]=n,n.showInWeb?i.fieldCategories[n.category].push(n):n.name&&(i.hidden_fields[n.name]=n))};if(n){o("n",{type:"n"});let e=t.extend({},this.fields);delete e.n,t.each(e,o)}else t.each(this.fields,o);this.tableRow.main_field&&this.fields[this.tableRow.main_field]&&(i.mainFieldName=this.tableRow.main_field)},render:function(t){let n=this;if(this.loadVisibleFields(),this._renderTable(),this._sorting.addSortable&&this._sorting.addSortable(this),this._addSelectable(),this._addEditable(),this._addSave(),this.row_actions_add(),this.setWidthes(),this.__addFilterable(),this._refreshHead(),this.ScrollClasterized=this.Scroll(),n.checkIsUpdated>0){let e=2e3*parseInt(n.checkIsUpdated);setTimeout(function(){n.checkTableIsChanged.call(n,e)},e)}e.parent===e&&n.checkForNotifications>0&&n.checkForNotificationsFunc.call(n),this.refresh(),this.__applyFilters(),t&&n._addInsert(t)},_addSave:function(){t("body").on("keyup",function(e){(e.ctrlKey||e.metaKey)&&"s"===String.fromCharCode(e.which).toLowerCase()&&0===t("#bigOneCodemirror").length&&t("body").trigger("ctrlS")})},reloaded:function(){let e=t("#refresh-notify");e.length&&(e.closest(".alert").remove(),this.checkTableIsChanged(2e3*parseInt(this.checkIsUpdated)))},checkForNotificationsFunc:function(){let e=this,n={},i={};const a=function(){switch(document.visibilityState){case"hidden":n.jqXHR&&n.jqXHR.abort&&n.jqXHR.abort(),n={};break;case"visible":e.model.checkForNotifications(e.checkForNotifications,Object.keys(i),n).then(function(n){if(n.notifications&&n.notifications.length){i[n.notification_id]=App.showDatas.call(e.model,n.notifications,n.notification_id);let a=[];i[n.notification_id].forEach(function(e){if(e){let n=t.Deferred();e.$modal.on("hide.bs.modal",function(){n.resolve()}),a.push(n)}}),t.when(...a).then(function(){delete i[n.notification_id]})}n.deactivated&&n.deactivated.forEach&&n.deactivated.forEach(function(e){i[e]&&(i[e].forEach(function(e){e.simpleClose()}),delete i[e])}),a.call(e)})}};document.addEventListener("visibilitychange",a),a()},checkTableIsChanged:function(e){let n=this;document.hidden?setTimeout(function(){n.checkTableIsChanged.call(n,e)},1e3):n.model.checkTableIsChanged.call(n.model).then(function(i){if(i.no||n.model.tableData.updated.code===i.code)n.checkTableIsChanged.call(n,e);else{let a=function(){n.model.tableData.updated.code===i.code?n.checkTableIsChanged.call(n,e):(t.notify({message:'<div id="refresh-notify"><button class="btn btn-warning btn-sm" style="margin-right: 20px;">Обновить</button> <span>Таблица была изменена пользователем <b>'+i.username+"</b> в <b>"+App.dateFormats.covert(i.dt,"YY-MM-DD HH:mm","HH:mm DD.MM")+"</b> </span></div>"},{type:"warning",allow_dismiss:!1,delay:0}),t("#refresh-notify button").on("click",function(){n.model.refresh()}))};n.model.doAfterProcesses(function(){setTimeout(a,200)})}})},_getTableMainFieldName:function(e,t){let n;return Object.keys(e).some(function(i){let a=e[i];if(a.id==t)return n=a.name,!0}),n},_getFieldbyName:function(e){return this.fields[e]},_getColumnIndexByTd:function(e,t){return(t=t||e.closest("tr")).find("td").index(e)},_fieldByTd:function(e,t){let n=this._getColumnIndexByTd(e,t);return this.fieldCategories.visibleColumns[n-1]},_getRowIndexById:function(e){let t=this;for(let n in t.data)if(t.data[n].id==e)return n;return null},_getFieldBytd:function(e){return e.closest("tr").is(".DataRow")?this.fieldCategories.visibleColumns[e.closest("tr").find(e.prop("tagName")).index(e)-1]:this.fields[e.data("field")]},_isParamsArea:function(e){return e.closest("table").is(".pcTable-paramsTable")},_isFootersArea:function(e){return e.closest("tbody").is(".pcTable-footers")},_getItemBytd:function(e){let t=e.closest("tr");return this._getItemByTr(t)},_getItemByTr:function(e){return e.is(".DataRow")?this.data[e.data("pctableitemid")]:this.data_params},_getItemById:function(e){return this.data[e]},_deleteItemById:function(e){let t=this._getItemById(e);t&&t.$tr&&t.$tr.remove(),["dataSorted","dataSortedVisible","__checkedRows"].some(function(t){let n=this[t].indexOf(e);-1!==n&&this[t].splice(n,1)},this),delete this.data[e]},_getTdByFieldName:function(e,t){let n=0;return this.fieldCategories.visibleColumns.every(function(t,i){return e!=t.name||(n=i,!1)}),this._getTdByColumnIndex(t,n+1)},_getTdByColumnIndex:function(e,t){return e.find("td:eq("+t+")")},refresh:function(){this._refreshTitle(),this._refreshParamsBlock(),this._refreshFiltersBlock(this.data_params),this._refreshFootersBlock(),this._refreshContentTable()}})}(window,jQuery),App.models||(App.models={}),App.models.table=function(e,t,n){let i,a,o=!1,l=null;return n=n||{},{setDataRows:function(e){i=e},addFiltersData:function(e){"use strict";n=$.extend(!0,{},n,e)},tableData:t,url:e,isInProcess:function(){return o},doAfterProcesses:function(e){let t=this;setTimeout(function(){let n;(n=t.getDefferedProcess())?n.then(e):e()},50)},getDefferedProcess:function(){if(!o)return!1;let e=$.Deferred();const t=function(){o?setTimeout(t,50):e.resolve()};return t(),e.promise()},showLinks:function(e){App.showLInks(e.links,a.model),delete e.links},shoInterfaceDatas:function(e){App.showDatas.call(a.model,e.interfaceDatas),delete e.interfaceDatas},showPanels:function(e){App.showPanels(e.panels),delete e.panels},addPcTable:function(e){a=e},__ajax:function(e,s,r,c,d){"use strict";let f=this.url,u=$.Deferred();d=d||{};let p=!1,h=!1,m=$.extend(!0,{},s,{tableData:t,ajax:!0},n,d);"checkTableIsChanged"===s.method||"checkForNotifications"===s.method?("checkForNotifications"===s.method&&(f="/nobuffer/index.php"),m=$.extend({},s,{code:t.updated.code,ajax:!0},n),t.sess_hash&&(m.tableData={sess_hash:t.sess_hash})):(o=!0,c||setTimeout(function(){p||(App.fullScreenProcesses.showCog(),h=!0)},1e3)),void 0!==m.data&&"object"==typeof m.data&&(m.data=JSON.stringify(m.data)),i&&(m.ids=JSON.stringify(Object.keys(i)));let b=this,g=function(e){let t={edit:"Изменение",checkInsertRow:"Предварительное добавление",duplicate:"Дублирование",refresh_rows:"Пересчет строк",getTableData:"Загрузка информации о таблице",refresh:"Обновление данных таблицы",checkEditRow:"Предварительный расчет панели",saveEditRow:"Сохранение панели",save:"Изменение поля",click:"Нажатие кнопки",selectSourceTableAction:"Вызов панели",add:"Добавление строки",getEditSelect:"Загрузка селекта",delete:"Удаление"},n=$("#table").data("pctable");if(n){if(e.LOGS&&(n.LOGS||(n.LOGS={}),n.LOGS=$.extend(n.LOGS,e.LOGS)),e.FullLOGS){n.FullLOGS||(n.FullLOGS=[]);let i={text:t[m.method]||m.method};i.children=e.FullLOGS,e.FullLOGS.length&&(n.FullLOGS.push(i),App.blink(n.LogButton,8,"#fff"))}e.FieldLogs&&(n.FieldLOGSName=t[m.method]||m.method,n.FieldLOGS=e.FieldLogs)}if(e.error){var i=$("<div>").html(e.error.replace(/\[\[(.*?)\]\]/g,"<b>$1</b>"));if(e.log){let t=$('<button class="btn btn-xxs btn-danger"><i class="fa fa-info" style="padding-top: 3px;" aria-hidden="true"> c</i></button>');t.on("click",function(){BootstrapDialog.show({message:$('<pre style="max-height: '+($("body").height()-200)+'px; overflow: scroll">').css("font-size","11px").text(JSON.stringify(e.log,null,1)),type:BootstrapDialog.TYPE_DANGER,title:"Лог расчета",buttons:[{label:"Закрыть",cssClass:"btn-m btn-default",action:function(e){e.close()}}],draggable:!0,onshown:function(e){e.$modalContent.position({of:window})},onshow:function(e){e.$modalHeader.css("cursor","pointer"),e.$modalContent.css({width:1200})}})}),i.append(" "),i.append(t)}App.notify(i),u.reject()}else e.reload?window.location.href=window.location.href:(e.links&&e.links.length>0&&b.showLinks(e),e.interfaceDatas&&e.interfaceDatas.length>0&&b.shoInterfaceDatas(e),e.panels&&e.panels.length>0&&b.showPanels(e)),u.resolve(e)},v=function(e){let t,n;e&&200===e.status?e.responseJSON&&e.responseJSON.error?t=e.responseJSON.error:(t=$("<div>Ошибка выполнения операции  </div>"),a&&a.isCreatorView&&(t.append('<button class="btn danger-backg btn-xs" data-toggle="collapse" data-target="#notify-texh"><i class="fa fa-angle-down"></i><i class="fa fa-angle-up"></i></button>'),t.append($('<div id="notify-texh" class="collapse">').append($("<code>").text(e.responseText))),e.responseText||console.log(e,r))):!r&&e&&"abort"!=e.statusText&&"error"!=e.statusText?(t=e.statusText,n=200):r&&r.jqXHR&&"abort"!==r.jqXHR.statusText&&(t="Нет соединения с сервером",n=200),t&&(n?setTimeout(function(){App.notify(t)},n):App.notify(t)),u.reject(e)},_=function(){if(!/^\/nobuffer/.test(f)){if((new Date).getTime()-l<150)return void setTimeout(_,50);l=(new Date).getTime(),/\?/.test(f)?f+="&":f+="?",f+="rn="+Math.round(1e5*Math.random())+(m.method||"")}$.ajax({url:f,method:e,data:m,dataType:"json",beforeSend:function(e,t){r&&(r.jqXHR=e)}}).then(g).fail(v)};_();let w=function(){o=!1,p=!0,h&&App.fullScreenProcesses.hideCog()};return u.always(function(){setTimeout(w,100)}),u.promise()},delete:function(e){return 0!==e.length&&this.__ajax("post",{delete_ids:JSON.stringify(e),method:"delete"})},duplicate:function(e,t,n){return 0!==e.length&&this.__ajax("post",{duplicate_ids:JSON.stringify(e),data:t,insertAfter:n,method:"duplicate"})},getFieldLog:function(e,t,n){return this.__ajax("post",{field:e,id:t,method:"getFieldLog",rowName:n})},refresh_rows:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_rows"})},refresh_cycles:function(e){return 0!==e.length&&this.__ajax("post",{refreash_ids:JSON.stringify(e),method:"refresh_cycles"})},checkUnic:function(e,t){"use strict";return this.__ajax("post",{fieldName:e,fieldVal:t,method:"checkUnic"})},add:function(e){return this.__ajax("post",{data:e,method:"add"})},getValue:function(e,t){return this.__ajax("post",{data:e,method:"getValue",table_id:t})},__setInProcess:function(e){o=e},get:function(e){return this.__ajax("get",{id:e})},checkInsertRow:function(e,t){var n={};return $.each(e,function(e,t){void 0!=t&&(n[e]=t)}),this.__ajax("post",{data:n,savedFieldName:t,method:"checkInsertRow"})},checkEditRow:function(e){var t={};return $.each(e,function(e,n){void 0!=n&&(t[e]=n)}),this.__ajax("post",{data:t,method:"checkEditRow"})},checkTableIsChanged:function(){return this.__ajax("post",{method:"checkTableIsChanged",table_id:a.tableRow.id,cycle_id:a.tableRow.cycle_id})},checkForNotifications:function(e,t,n){return this.__ajax("post",{method:"checkForNotifications",periodicity:e,activeIds:t},n)},notificationUpdate:function(e,t){return this.__ajax("post",{method:"notificationUpdate",id:e,type:t})},selectSourceTableAction:function(e,t){return this.__ajax("post",{field_name:e,data:t,method:"selectSourceTableAction"})},saveEditRow:function(e){var t={};return $.each(e,function(e,n){void 0!==n&&(t[e]=n)}),this.__ajax("post",{data:t,method:"saveEditRow"})},getEditSelect:function(e,t,n,i,a){return this.__ajax("post",{data:{item:e,field:t},q:n,parentId:i,method:"getEditSelect"},void 0,!a)},loadPreviewHtml:function(e,t,n){return this.__ajax("post",{data:{item:function(e){let t={};return Object.keys(e).forEach(function(n){/^\$/.test(n)||("id"===n?t[n]=e[n]:null!==e[n]&&"object"==typeof e[n]&&-1!==Object.keys(e[n]).indexOf("v")?t[n]=e[n].v:t[n]=e[n])}),t}(t),field:e,val:n},method:"loadPreviewHtml"},null,!0)},save:function(e){let t={};return e.params&&Object.keys(e.params).some(function(e){if("filter"===a.fields[e].category)return a._filtersBlock.data("cryptoFilters")&&(t.filters=a._filtersBlock.data("cryptoFilters")),!0}),this.__ajax("post",{data:e,method:"edit"},null,null,t)},click:function(e){return this.__ajax("post",{data:e,method:"click"})},csvExport:function(e,t){return this.__ajax("post",{method:"csvExport",sorted_ids:JSON.stringify(e),visibleFields:JSON.stringify(t)})},csvImport:function(e,t){return this.__ajax("post",{csv:e,answers:t,method:"csvImport"})},getTableData:function(e){return this.__ajax("post",{method:"getTableData",tableData:{sess_hash:e}})},refresh:function(e){e=e||function(e){a.table_modify.call(a,e),a.reloaded.call(a)},this.__ajax("post",{method:"refresh"}).then(e)},saveOrder:function(e){return this.__ajax("post",{method:"saveOrder",orderedIds:JSON.stringify(e)})},setCommentsViewed:function(e,t,n){return this.__ajax("post",{method:"setCommentsViewed",nums:e,field_name:t,id:n})},AddEyeGroupSet:function(e,t){return this.__ajax("post",{method:"addEyeGroupSet",name:e,fields:t})},removeEyeGroupSet:function(e){return this.__ajax("post",{method:"removeEyeGroupSet",index:e})},leftEyeGroupSet:function(e){return this.__ajax("post",{method:"leftEyeGroupSet",index:e})},reUser:function(e){return this.__ajax("post",{method:"reuser",userId:e})},printTable:function(e){return this.__ajax("post",{method:"printTable",settings:JSON.stringify(e)})},getAllTables:function(){return this.__ajax("post",{method:"getAllTables"})},calcFieldsLog:function(e,t){return this.__ajax("post",{method:"calcFieldsLog",calc_fields_data:e,name:t})},renameField:function(e){return this.__ajax("post",{method:"renameField",name:e})}}},addTree=function(e,t,n){if(!App.isTopWindow())return $("div.page_content").addClass("tree-minifyed iframed"),!1;$.jstree.defaults.core.dblclick_toggle=!1,$.jstree.defaults.core.expand_selected_onload=!0,$.jstree.defaults.core.force_text=!0,$.jstree.link_prefix=e;let i=localStorage.getItem("tree")||"{}";i=JSON.parse(i),$.each(t,function(e,a){if(t[e].data={type:a.type},a.state&&a.state.selected&&(t[e].li_attr={class:"jstree-selected"}),i[a.id]&&(t[e].state||(t[e].state={}),t[e].state.opened=!0),a.href?t[e].a_attr={href:$.jstree.link_prefix+a.href}:a.link&&(t[e].a_attr={href:a.link}),n)switch(a.type){case"folder":t.push({type:"plus",id:"plus-table"+a.id.substring(4),text:"Таблицу",parent:a.id,li_attr:{class:"jstree-creatorView"}}),t.push({type:"plus",id:"plus-folder"+a.id.substring(4),text:"Папку/Ссылку",parent:a.id,li_attr:{class:"jstree-creatorView"}});break;case"cycle_name":t.push({type:"plus",id:"plus-calcs"+a.parent.substring(4),text:"Таблицу",parent:a.id,li_attr:{class:"jstree-creatorView"}})}});let a=$("#leftTree"),o=$("#LeftTree");a.on("loaded.jstree after_open.jstree",function(e){let t=a.width();if(a.find("a.jstree-anchor").each(function(){let e=$(this),n=e.offset().left;e.width(t-n)}),"loaded"===e.type){let e=localStorage.getItem(l);e&&o.scrollTop(e)}}).jstree({state:{key:"leftTree"},core:{check_callback:!0,expand_selected_onload:!0,open_parents:!0,data:t,themes:{name:"default-dark"}},types:{folder:{},plus:{icon:"fa fa-plus"},cycle_name:{icon:"fa fa-dot-circle-o"},text:{icon:"jstree-file"},table:{icon:"jstree-file"},table_simple:App.tableTypes.simple,table_version:App.tableTypes.version,table_calcs:App.tableTypes.calcs,table_tmp:App.tableTypes.tmp,table_globcalcs:App.tableTypes.globcalcs,table_cycles:App.tableTypes.cycles,table_data:{icon:"jstree-file"}},plugins:["types","themes"]}),a.on("select_node.jstree",function(e,t){switch((t.node.data?t.node.data.type:null)||t.node.type){case"plus":let e=t.node.id.substring(5,10);if("calcs"===e){let e=t.node.id.substring(11);t.node.parent.substring(5),new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e},type:{v:"calcs"}}).then(function(e){e&&window.location.reload(!0)})}else if("table"===e){let e=t.node.id.length>10?t.node.id.substring(10):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(1,BootstrapDialog.TYPE_DANGER,{tree_node_id:{v:e}}).then(function(e){e&&window.location.reload(!0)})}else{let e=t.node.id.length>11?t.node.id.substring(11):window.location.pathname.match(/^\/.*\/(\d+)\//)[1];new EditPanel(3,BootstrapDialog.TYPE_DANGER,{parent_id:{v:e}}).then(function(e){e&&window.location.reload(!0)})}return!1;case"link":window.location.href=t.node.a_attr.href;case"folder":case"project":return t.node.state.opened?($("#leftTree").jstree("close_node",t.node),i[t.node.id]&&(delete i[t.node.id],localStorage.setItem("tree",JSON.stringify(i)))):($("#leftTree").jstree("open_node",t.node),i[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(i))),!1;default:"#"==t.node.original.parent?window.location.href=t.node.original.href:window.location.href=$.jstree.link_prefix+t.node.original.href}return!1});let l="tree_scroll_part_"+(window.location.pathname.match(/\/Table\/(\d+)/)||{1:0})[1];const s=function(){setTimeout(function(){o.getNiceScroll().resize(),localStorage.setItem(l,o.scrollTop())},250)};o.on("scroll",function(){localStorage.setItem(l,o.scrollTop())}),a.on("open_node.jstree",function(e,t){i[t.node.id]=!0,localStorage.setItem("tree",JSON.stringify(i)),s()}),a.on("close_node.jstree",function(e,t){i[t.node.id]&&(delete i[t.node.id],localStorage.setItem("tree",JSON.stringify(i))),s()});let r=localStorage.getItem("TreeMinimizer")||"false";r=JSON.parse(r);let c=function(e){r=e,e?($("body>.page_content").addClass("tree-minifyed"),$("#LeftTree").getNiceScroll().resize()):$("body>.page_content").removeClass("tree-minifyed"),$("#table").data("pctable")&&$("#table").data("pctable").setWidthes(),localStorage.setItem("TreeMinimizer",JSON.stringify(r)),s()};o.niceScroll({cursorwidth:7,mousescrollstep:190,mousescroll:190,autohidemode:!1,enablekeyboard:!1,cursoropacitymin:1,railoffset:{left:4}}),$("#TreeMaximizer").on("click",function(){c(!1)}),$("#TreeMinimizer").on("click",function(){c(!0)}),!0===r&&c(r)},LOGINJS=function(){let e=$('<div><div class="form-group"><label>Email:</label><input id="elseEmail"  type="text"\n                                                                      name="login"\n                                                                      value=""\n                                                                      class="form-control"\n                /></div></div>');if($("body").on("click","#recover",function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="recover" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Новый пароль",buttons:t,draggable:!0})}),$("body").on("click","#register",function(){let t=[{action:function(e){if(""==$("#elseEmail").val().trim())return void $("#elseEmail").addClass("error");let t=$('<form method="post"><input type="hidden" name="login" value=""><input type="hidden" name="register" value="true"></form>');t.find('[name="login"]').val($("#elseEmail").val()),t.appendTo("body"),t.submit(),e.close()},label:"Зарегистрировать и отправить пароль на email"},{action:function(e){e.close()},label:"Отмена"}];BootstrapDialog.show({message:e,title:"Регистрация",buttons:t,draggable:!0})}),sessionStorage.getItem("browserConfirm")||navigator.userAgent.match(/(chrome|safari|firefox|yandex(?=\/))\/?\s*(\d+)/i)&&!navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i))$("#auth_form").show();else{let e=$("#auth_form");$("body").html('<div style="width: 600px; margin: auto; padding-top: 50px; font-size: 16px; text-align: center;" id="comeinBlock"><img src="/imgs/start.png" alt=""><div style="padding-bottom: 10px;">Сервис оптимизирован под десктопные броузеры Chrome, Safari, Yandex, FireFox последних версий.</div><div><a href="#" id="comein" class="btn-default btn">Все равно хочу посмотреть</a></div></div>'),$("#comein").on("click",function(){sessionStorage.setItem("browserConfirm",!0),$("#comeinBlock").remove(),$("body").html(e),e.show()})}};